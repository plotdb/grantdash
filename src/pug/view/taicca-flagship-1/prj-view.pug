//- view
extends /base.pug
block vars
  - ctrl.navtop.shown = !simple;
block head
  style(type="text/css"): :stylus
    .pre
      white-space: pre-line
    .quote
      border-left: 3px solid #eee
      padding-left: .5em

mixin item(key,val)
  .m-4
    .font-weight-bold.mb-1= key
    .quote
      if Array.isArray(val)
        ul
        each v in val
          li.pre= v
      else
        p.pre= val

block body
  div(ld-scope="prj-detail")

    - var info = ["計畫名稱","計畫摘要"]
    each key in info
      - var val = locals.prj.detail.custom.raw[key]
      +item(key,val)
    .m-4
      .font-weight-bold.mb-1 註
      textarea.form-control.mb-1(ld="note",rows="10",disabled)
      .btn.btn-primary.d-none(ld="update-note") 更新

         
    each val, key in locals.prj.detail.custom.raw || {}
     if !~info.indexOf(key) 
       +item(key,val)

block script
  +register-locals()
  script: :lsc
    ldc.register <[viewLocals auth ldNotify error notify]>, ({viewLocals, auth, error, notify}) ->
      lc = {}
      raw = viewLocals.prj.{}detail.{}custom.{}raw
      slug = viewLocals.prj.slug
      ldld = new ldLoader className: 'ldld full'
      auth.get!then (g) ->
        lc.global = g

        view = new ldView do
          root: '[ld-scope=prj-detail]'
          action:
            click:
              "update-note": ->
                json = {slug: slug, note: raw["註"]}
                ldld.on!
                debounce 1000
                  .then -> ld$.fetch "/dash/api/flagship-1/prj", {method: "POST"}, {json}
                  .finally -> ldld.off!
                  .then -> notify.send \success, "已更新"
                  .catch -> error! it
            input:
              note: ({node}) ->
                raw["註"] = node.value or ''
          handler:
            "update-note": ({node}) -> node.classList.remove \d-none
            note: ({node}) ->
              node.value = raw["註"] or ''
              node.setAttribute \disabled, false
              node.disabled = false

