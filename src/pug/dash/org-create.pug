extends /base.pug
block vars
  - ctrl.navtop.placeholder = true;
  - ctrl.navtop.shown = true;
  - ctrl.navtop.className = "navbar-light"
  // include /design/data/sample.pug
block head
  +css("https://cdn.jsdelivr.net/npm/tail.datetime@0.4.13/css/tail.datetime-harx-light.min.css")
block body
  //include /activity/mixins/index.pug
  //include /design/mixins/index.pug
  style(type="text/css"): :stylus
    body { background: radial-gradient(#f1f2f3,#999) fixed top center; background-size: cover }
  +nbr(2)
  .w-640.mx-auto
    +scope("org-basic").card.mb-4.shadow-lg: .card-body: .p-4
      h3 建立組織
      p.text-sm.text-muted 在我們進行下一步之前，先填妥組織的基本資訊吧
      hr
      .row.align-items-center.mb-4
        .col-md-3.text-right 組織名稱
        .col-md
          .form-group.mb-0.ld-ext-right
            .ld.ld-spin.ld-spinner.text-primary
            input.form-control.border-bottom.rounded-0(name="name",style="border:0")
            .invalid-feedback.position-absolute 組織必須要有名字
      .row.align-items-center.mb-4
        .col-md-3.text-right
          span 組織代碼
          p.text-muted.text-sm 用於網址的短代碼
        .col-md
          .form-group.mb-0.ld-ext-right
            .ld.ld-spin.ld-spinner.text-primary
            input.form-control.border-bottom.rounded-0(name="slug",placeholder="僅接受英文字母、數字或連字符號",style="border:0")
            .invalid-feedback.position-absolute 已經有其它組織使用這個代碼了，請換一個
      .row.align-items-start.mb-4
        .col-md-3.text-right 組織摘要
        .col-md: textarea.form-control(name="description",rows="4",placeholder="20個字以上")

      .row.align-items-start.mb-4
        .col-md-3.text-right 組織主圖
        .col-md: .w-100: .aspect-ratio.ratio-2by1.bg-secondary.rounded.overflow-hidden
          .bg-semi-dark.bg.bg-cover.bg-portrait
            .w-100.h-100.bg-semi-dark.vertical-center
              .w-100.text-center: .btn.btn-outline-light.btn-upload 上傳 #[input(name="thumbnail",type="file")]

      //-.row.align-items-center.mb-4
        .col-md-3.text-right 連絡信箱
        .col-md
          input.form-control.border-bottom.rounded-0(name="email",style="border:0")
      .row.align-items-center.mb-4.pt-4
        .col-md-3
        .col-md: .btn.btn-lg.btn-primary.disabled(ld="submit") 立刻建立
  +script("https://cdn.jsdelivr.net/npm/tail.datetime@0.4.13/js/tail.datetime-full.min.js")

block script
  script: :lsc
    ldld = new ldLoader className: "ldld full"
    notify = new ldNotify root: '.ldNotify', classIn: <[ld-fall-ttb-in]>
    slugs = {}
    tail.DateTime("input[name=starttime]")
    tail.DateTime("input[name=endtime]")
    slug-check = debounce 500, (n,v,e) -> 
      p = ld$.parent(form.fields[n], '.form-group')
      p.classList.add \running
      ld$.fetch '/d/o/slug-check', {method: \POST}, {json: {slug: v}, type: \json}
        .finally -> debounce 1000 .then -> p.classList.remove \running
        .then (r = {}) -> slugs[v] = (if r.result == \free => false else true)
        .catch -> slugs[v] = true
        .then -> form.check {n: 'slug'}


    form = new ldForm do
      root: "[ld-scope='org-basic']"
      submit: "[ld='submit']"
      afterCheck: (s, f) ->
        if f.thumbnail.value =>
          if !( p = ld$.parent(f.thumbnail, '.bg') ) => return
          ldFile.fromFile f.thumbnail.files.0, \dataurl
            .then (r) -> p.style.backgroundImage = "url(#{r.result})"
        s.all = if <[name slug description]>.reduce(((a,b) -> a and s[b] == 0),true) => 0 else 2
      verify: (n,v,e) ->
        if n in <[slug]> =>
          if slugs[v]? => return if slugs[v] => 2 else 0
          slug-check n,v,e

          return 1
        return if !!v => 0 else 2
    view = new ldView do
      root: "[ld-scope='org-basic']"
      action: click: submit: ({node}) ->
        ldld.on!
        fd = form.getfd!
        ld$.fetch \/d/o/, {method: \POST, body: fd}, {type: \json}
          .then (r) -> 
            notify.send \success, '建立完成，將您導向組織主控台 ...'
            debounce 1000 .then -> window.location.href = "/o/#{r.key}/admin"
          .catch ->
            debounce 1000 .then -> ldld.off!
