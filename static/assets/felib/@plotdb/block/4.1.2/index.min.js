!function(){var win,doc,rescope,csscope,proxise,fetch,e404,_fetch,rid,parseNameString,sanitize,pubsub,block,slice$=[].slice;function import$(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}console.log("okok"),rescope="undefined"!=typeof window&&null!==window?window.rescope:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("@plotdb/rescope"):null,csscope="undefined"!=typeof window&&null!==window?window.csscope:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("@plotdb/csscope"):null,proxise="undefined"!=typeof window&&null!==window?window.proxise:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("proxise"):null,fetch="undefined"!=typeof window&&null!==window?window.fetch:"undefined"!=typeof module&&null!==module&&"undefined"!=typeof require&&null!==require?require("node-fetch"):null,e404=function(e){var t;return Promise.reject(((t=new Error).name="lderror",t.id=404,t.message=e,t))},_fetch=function(e,t){return fetch(e,t).then(function(o){var e;return o&&o.ok?o.text():o?o.clone().text().then(function(e){var t,n=o.status||404,r=new Error(n+" "+e);r.name="lderror",r.id=n,r.message=e,r=r;try{(t=JSON.parse(e))&&"lderror"===t.name&&(import$(r,t).json=t)}catch(e){0}return Promise.reject(r)}):Promise.reject(((e=new Error("404")).name="lderror",e.id=404,e))})},rid=function(){for(var e;e="b-"+Math.random().toString(36).substring(2),rid.hash[e];);return rid.hash[e]=!0,e},rid.hash={},parseNameString=function(e){var t;return{name:e=(t=(e=e.split("@"))[0]?[e[0],e[1]]:["@"+e[1],e[2]])[0],version:t[1]}},sanitize=function(e){return e||""},pubsub=function(){return this.subs={},this},pubsub.prototype=import$(Object.create(Object.prototype),{fire:function(e){for(var t,n,r=[],o=1,i=arguments.length;o<i;++o)r.push(arguments[o]);return t=r,Promise.all(((n=this.subs)[e]||(n[e]=[])).map(function(e){return e.apply(null,t)}))},on:function(e,t){var n;return((n=this.subs)[e]||(n[e]=[])).push(t)}}),block={env:function(e){e=[e,e.document];if(win=e[0],doc=e[1],rescope.env&&rescope.env(win),rescope.env)return csscope.env(win)},i18n:{module:{lng:"en",t:function(e){for(var t,n,r,o,i=Array.isArray(e)?e:[e],s=this.lng,c=0,l=i.length;c<l;++c)if(i[o=c]&&(t=(r=i[o].split(":"))[0],n=(n=slice$.call(r,1)).join(":"),r=((r=(o=this.res)[s]||(o[s]={}))[t]||(r[t]={}))[n]))return r;return n||t||e[e.length-1]},changeLanguage:function(e){return this.lng=e||"en"},addResourceBundle:function(e,t,n,r,o){var i;return((i=this.res)[e]||(i[e]={}))[t]=n},res:{}},use:function(e){return this.module=e},addResourceBundle:function(e,t,n,r,o){return block.i18n.module.addResourceBundle(e,t,n,r=null==r?!0:r,o=null==o?!0:o)},changeLanguage:function(e){return block.i18n.module.changeLanguage(e)}},global:{csscope:{hash:{},apply:function(e){var t=this;if((e=e.filter(function(e){return!t.hash[e.id||e.url]}).map(function(e){return t.hash[e.id||e.url]=e.scope})).length)return doc.body.classList.add.apply(doc.body.classList,e)}}}},block.init=proxise.once(function(){if(block._rescope)return block._rescope.init()}),block.rescope=function(){return block._rescope||(block._rescope=new rescope({global:null!=win?win:global})),block._rescope},block.csscope=function(){return block._csscope||(block._csscope=new csscope.manager),block._csscope},block.manager=function(e){var t=this;return null==e&&(e={}),this.hash={},this.proxy={},this.running={},this._ver={map:{}},this._chain=e.chain||null,this._fetch=e.fetch||null,this.init=proxise.once(function(){return t._init()}),this.rescope=e.rescope instanceof rescope?e.rescope:block.rescope(),this.csscope=e.csscope instanceof csscope?e.csscope:block.csscope(),e.registry&&this.registry(e.registry),this.init(),this},block.manager.prototype=import$(Object.create(Object.prototype),{_init:function(){return(this.rescope===block.rescope()?block:this.rescope).init()},chain:function(e){return this._chain=e},registry:function(e){var t;if(null!=(e="string"==(t=typeof e)||"function"===t||e.fetch&&e.url?{lib:e,block:e}:e).lib&&(this.rescope===block.rescope()&&(this.rescope=new rescope({global:win})),this.csscope===block.csscope()&&(this.csscope=new csscope.manager),this.rescope.registry(e.lib),this.csscope.registry(e.lib)),null!=e.block&&(this._reg=e.block||"","string"==typeof this._reg&&this._reg&&"/"!==(t=this._reg)[t.length-1]))return this._reg+="/"},set:function(e){var i=this;return null==e&&(e={}),e=Array.isArray(e)?e:[e],Promise.all(e.map(function(e){var t=e.name,n=e.version,r=e.path,o=e instanceof block.class?e:e.block;return((t=(e=i.hash)[t]||(e[t]={}))[n]||(t[n]={}))[r||"index.html"]=o}))},getUrl:function(e){var t=e.name,n=e.version,r=e.path,e=this._reg.url||this._reg;return"function"==typeof e?e({name:t,version:n,path:r,type:"block"}):(this._reg||"")+"/assets/block/"+t+"/"+(n||"main")+"/"+(r||"index.html")},fetch:function(e){var t;return e.type="block",this._fetch?Promise.resolve(this._fetch(e)):(t=this._reg.fetch?this._reg.fetch(e):this.getUrl(e)).then?t:t?_fetch(t,{method:"GET"}).then(function(e){return{content:e}}):e404(e)},_get:function(t){var e,n,r,o=this,i=[t.name,t.version||"main",t.path||"index.html"],s=i[0],c=i[1],l=i[2],u={name:s,version:c,path:l};if(!s||!c)return Promise.reject(((i=new Error).name="lderror",i.id=1015,i));if((i=this.hash)[s]||(i[s]={}),/[^0-9.]/.exec(c)&&!t.force){if(this._ver.map[s]&&this._ver.map[s][c]&&(n=((i=this.hash[s])[n=this._ver.map[s][c]]||(i[n]={}))[l]))return n;for(e in i=(n=this.hash)[s]||(n[s]={}))if(r=i[e],semver.fit(e,c))return Promise.resolve(r[l])}return null==((i=this.hash[s])[c]||(i[c]={}))[l]||t.force?!0!==((i=(n=this.running)[s]||(n[s]={}))[c]||(i[c]={}))[l]?(this.running[s][c][l]=!0,this.fetch({name:t.name,version:t.version,path:t.path}).then(function(e){var t;return e?(e.version&&(u.version!==e.version&&(((t=o._ver.map)[s]||(t[s]={}))[u.version]=e.version),u.version=e.version),e.content||e):e404(u)}).catch(function(e){return o._chain?o._chain.get(t):Promise.reject(e)}).then(function(e){e=new block.class((u.code=e=null==e?{}:e,u.manager=o,u));return o.set((u.block=e,u)),e}).then(function(e){return o.proxy[s][c][l].resolve(e),e}).finally(function(){return o.running[s][c][l]=!1}).catch(function(e){return o.proxy[s][c][l].reject(e),Promise.reject(e)})):void 0:Promise.resolve(this.hash[s][c][l])},get:function(t){var e,s=this;return null==t&&(t={}),e=Array.isArray(t)?t:[t],Promise.all(e.map(function(e){var t,n,r=(t=[(e="string"==typeof(e=null==e?{}:e)?parseNameString(e):e).name,e.version||"main",e.path||"index.html"])[0],o=t[1],i=t[2];return((t=(n=s.proxy)[r]||(n[r]={}))[o]||(t[o]={}))[i]||(s.proxy[r][o][i]=proxise(function(e){return s._get(e)})),s.proxy[r][o][i](e)})).then(function(e){return Array.isArray(t)?e:e[0]})},bundle:function(opt){var mgr,hash,_;return null==opt&&(opt={}),mgr=opt.manager||this,hash={},_=function(list,blocks,deps){var bd,id;return(null==blocks&&(blocks=[]),null==deps&&(deps={js:[],css:[]}),list.length)?(bd=list.splice(0,1)[0],id=bd.name+"@"+(bd.version||"")+":"+(bd.path||"index.html"),hash[id]?Promise.resolve().then(function(){return _(list,blocks,deps)}):_fetch(mgr.getUrl(bd),{method:"GET"}).then(function(it){var node,ref$,js,css,ret,b,node=doc.createElement("div");return node.innerHTML=it,1<node.childNodes.length&&console.warn("DOM definition of a block should contain only one root."),ref$=["script","style"].map(function(e){return Array.from(node.querySelectorAll(e)).map(function(e){return e.parentNode.removeChild(e),e.textContent}).join("\n")}),js=ref$[0],css=ref$[1],node.childNodes[0].setAttribute("block",id),ret=eval("(function(module){"+(js||"")+";return module.exports;})({})"),ret instanceof Function&&(ret=ret()),ret=ret||{},(ret.pkg||(ret.pkg={})).extend&&list.push((ret.pkg||(ret.pkg={})).extend),deps.js=deps.js.concat(((ret.pkg||(ret.pkg={})).dependencies||[]).filter(function(e){return"js"===e.type||/\.js/.exec(e.path||e||"")})),deps.css=deps.css.concat(((ret.pkg||(ret.pkg={})).dependencies||[]).filter(function(e){return"css"===e.type||/\.css/.exec(e.path||e||"")})),js="((function(module){"+(js||"")+";return module.exports;})({}))",blocks.push(b={js:js,css:css,html:node.innerHTML,bd:bd,id:id}),hash[id]=b,_(list,blocks,deps)})):Promise.resolve({blocks:blocks,deps:deps})},_(opt.blocks||(opt.blocks=[])).then(function(e){var i=e.blocks,s=e.deps;return Promise.all([mgr.csscope.bundle(s.css),mgr.rescope.bundle(s.js)]).then(function(e){var t,n=e[0],r=e[1],o=i.map(function(e){return'"'+e.id+'":'+(e.js||'""')});return o="document.currentScript.import({"+o.join(",\n")+"});",t=s.css.map(function(e){return"csscope.cache("+JSON.stringify((e.inited=!0,e.scope=csscope.scope(e),e))+")"}).join(";"),e=i.map(function(e){var t=csscope.scope(e);return csscope({rule:"*[scope~="+t+"]",name:t,css:e.css||"",scopeTest:"[scope]"})}).join("\n"),"<template>\n  "+i.map(function(e){return e.html||""}).join("\n")+'\n  <style type="text/css">'+e+n+'</style>\n  <script type="text/javascript">'+o+r+";"+t+"<\/script>\n</template>"})})},debundle:function(e){var s=(e=null==e?{}:e).manager||this,c={};return(e.root?Promise.resolve("string"==typeof e.root?doc.querySelector(e.root):e.root):(e.url?_fetch(e.url,{method:"GET"}):Promise.resolve(e.code)).then(function(e){var t;return block.debundleNode||document.body.appendChild(block.debundleNode=doc.createElement("div")),block.debundleNode.appendChild(t=doc.createElement("div")),t.innerHTML=e,t.querySelector("template")})).then(function(e){var n,t,r,o,i=[];for(t in e.content&&(e=e.content),n=[{},{}][0],Array.from(e.childNodes).map(function(e){var t;if(e.nodeType===doc.ELEMENT_NODE)return"SCRIPT"===e.nodeName?c.script=e.cloneNode(!0):"STYLE"===e.nodeName?c.style=e.cloneNode(!0):(t=e.getAttribute("block"))?n[t]=e:void 0}),c.script&&((e=doc.createElement("script")).textContent=c.script.textContent,c.script=e,c.script.import=function(e){return c.codes="function"==typeof e?e():e},c.script.setAttribute("type","text/javascript"),doc.body.appendChild(c.script)),c.style&&(c.style.setAttribute("type","text/css"),doc.body.appendChild(c.style)),n)o=n[t],r=[(r=/^(@?[^@]+)@([^:]+)(:.+)?/.exec(t))[1],r[2],(r[3]||"").replace(/^:/,"")||""],o=new block.class({manager:s,name:r[0],version:r[1],path:r[2],code:{script:c.codes[t],dom:o,style:""}}),i.push(s.set(o));return i})}}),block.class=function(e){var t,n,r,o,i,s,c=this;if(this.opt=e=null==e?{}:e,this.scope=e.scope||null,this._ctx={},this.csscopes={global:[],local:[]},this.name=e.name,this.version=e.version,this.path=e.path,this.manager=e.manager,this.manager||console.warn("manager is mandatory when constructing block.class"),t=e.code,e.root?n="string"==typeof e.root?doc.querySelector(e.root):e.root:"string"==typeof(t="function"==typeof t?t():t)?(t=sanitize(t),(r=doc.createElement("div")).innerHTML=(t||"").trim(),1<r.childNodes.length&&console.warn("DOM definition of a block should contain only one root.")):"object"==typeof t&&(this.script=t.script,this.style=t.style,this.style=t.style,this.script=t.script,(e=t.dom instanceof Function?t.dom():t.dom)instanceof win.Element?n=e:(t=sanitize(e),(r=doc.createElement("div")).innerHTML=t,1<r.childNodes.length&&console.warn("DOM definition of a block should contain only one root."))),["script","style","link"].map(function(e){var t=Array.from((n||r).querySelectorAll(e)).map(function(e){return e.parentNode.removeChild(e),e.textContent}).join("\n");return c[e]=null!=t&&t?t:c[e]||""}),!n&&r)for(o=0,i=r.childNodes.length;o<i&&(s=o,(n=r.childNodes[s]).nodeType!==win.Element.ELEMENT_NODE);++o);return(n=n||doc.createElement("div")).nodeType!==win.Element.ELEMENT_NODE&&console.log(warn("root of DOM definition of a block should be an Element")),this.node=n,this.init=proxise.once(function(){return c._init()}),this},block.class.prototype=import$(Object.create(Object.prototype),{_init:function(){var this$=this;return block.init().then(function(){var v,ref$,ret;return this$.interface=this$.script instanceof Function?this$.script():"object"==typeof this$.script?this$.script:(v=eval("(function(module){"+(this$.script||"")+";return module.exports;})({})"))instanceof Function?v():v||{},this$.interface||(this$.interface={}),(ref$=this$.interface).pkg||(ref$.pkg={}),this$.name||(this$.name=this$.interface.pkg.name),this$.version||(this$.version=this$.interface.pkg.version),this$.path||(this$.path=this$.interface.pkg.path),this$.id=(this$.name||rid())+"@"+(this$.version||rid())+":"+(this$.path||"index.html"),this$._id_t=this$.id.replace(/:/g,"="),this$.scope||(this$.scope=csscope.scope(this$)),this$.style&&(doc.body.appendChild(this$.styleNode=doc.createElement("style")),this$.styleNode.setAttribute("type","text/css"),this$.styleNode.textContent=ret=csscope({rule:"*[scope~="+this$.scope+"]",name:this$.scope,css:this$.style,scopeTest:"[scope]"})),this$.factory=function(){for(var e=[],t=0,n=arguments.length;t<n;++t)e.push(arguments[t]);return this},this$.factory.prototype=import$((ref$=Object.create(Object.prototype),ref$.init=function(){},ref$.destroy=function(){},ref$),this$.interface)}).then(function(){if(this$.extends=[],this$.interface.pkg.extend)return this$.manager?this$.manager.get(this$.interface.pkg.extend).then(function(e){return this$.extend=e,this$.extendDom=!(null!=this$.interface.pkg.extend.dom)||this$.interface.pkg.extend.dom,this$.extendStyle=!(null!=this$.interface.pkg.extend.style)||this$.interface.pkg.extend.style,this$.extend.init()}).then(function(){return this$.extends=[this$.extend].concat(this$.extend.extends)}):new Error("no available manager to get extended block")}).then(function(){var e,t,n=[],r=this$.interface.pkg.i18n||{};for(e in r)t=r[e],n.push(block.i18n.module.addResourceBundle(e,this$._id_t,t,!0,!0));return n}).then(function(){var n,r;return this$.dependencies=Array.isArray(this$.interface.pkg.dependencies)?this$.interface.pkg.dependencies:function(){var e,t=[];for(n in e=this.interface.pkg.dependencies||{})r=e[n],t.push(r);return t}.call(this$),this$.dependencies.map(function(e){if(!e.type)return!/\.js$/.exec(e.url||e.path||e)&&/\.css$/.exec(e.url||e.path||e)?e.type="css":e.type="js"}),this$.extend?this$._ctx=this$.extend.context():rescope.dualContext?this$._ctx=rescope.dualContext():rescope.proxin&&(this$._ctx=new rescope.proxin),this$.manager.rescope.load(this$.dependencies.filter(function(e){return!e.type||"js"===e.type}),this$._ctx)}).then(function(){return this$.manager.csscope.load(this$.dependencies.filter(function(e){return"css"===e.type&&!0===e.global}).map(function(e){return e.url||e}))}).then(function(e){return this$.csscopes.global=e||[],this$.manager.csscope.load(this$.dependencies.filter(function(e){return"css"===e.type&&!0!==e.global}).map(function(e){return e.url||e}))}).then(function(e){if(this$.csscopes.local=e||[],this$.extend)return(e=this$.csscopes).global=e.global.concat(this$.extend.csscopes.global||[]),!0===this$.extendStyle?(e=this$.csscopes).local=e.local.concat(this$.extend.csscopes.local||[]):"overwrite"===this$.extendDom?(e=this$.csscopes).local=e.local.concat(this$.extend.csscopes.local.slice(1)):void 0}).catch(function(e){return console.error("[@plotdb/block] init block {name: "+this$.name+", version: "+this$.version+", path: "+(this$.path||"")+"}",e),doc.createElement("div").innerText="failed",this$.interface={},this$.styleNode={},this$.factory=function(){return this},this$.dependencies=[],this$})},context:function(){return this._ctx},dom:function(){return this.node},i18n:function(t){var e=this._id_t;return block.i18n.module.t([e+":"+t].concat(this.extends.map(function(e){return e.id+":"+t}),[t+""]))},create:function(t){var n=this;return null==t&&(t={}),this.init().then(function(){var e=new block.instance({block:n,name:n.name,version:n.version,data:t.data});return e.init().then(function(){return e})})},resolvePlugAndCloneNode:function(n,e){var t;return(e=null==e?!1:e)?t=n:(t=this.dom().cloneNode(!0),n&&Array.from(t.querySelectorAll("plug")).map(function(e){var t=e.getAttribute("name"),t=n.querySelector(":scope :not([plug]) [plug="+t+"], :scope > [plug="+t+"]");if(t)return e.replaceWith(t)})),this.extend&&!1!==this.extendDom?"overwrite"===this.extendDom?this.extend.resolvePlugAndCloneNode(t,!0):this.extend.resolvePlugAndCloneNode(t):t}}),block.instance=function(e){var t=this;return this.name=(e=null==e?{}:e).name,this.version=e.version,this.block=e.block,this.data=e.data,this.init=proxise.once(function(){return t._init()}),this},block.instance.prototype=import$(Object.create(Object.prototype),{_init:function(){return this.block.init()},attach:function(e){var t,n,r,o,i,s,c,l;if((e=null==e?{}:e).data&&(this.data=e.data),t=(t=e.root)?"string"==typeof t?doc.querySelector(t):t:null,block.global.csscope.apply(this.block.csscopes.global),t){for(n=this.dom(e.root),r=[this.block].concat(this.block.extends),o=[this.block.scope],i=0,s=r.length-1;i<s;++i)if("overwrite"!==(l=r[c=i].extendStyle)){if(!1===l)break;o.push(r[c+1].scope)}n.setAttribute("scope",o.join(" ")),n.classList.add.apply(n.classList,this.block.csscopes.local.map(function(e){return e.scope}).concat(this.block.csscopes.global.map(function(e){return e.scope}))),e.before&&t.insertBefore(n,e.before),t.appendChild(n)}else n=null;return this.run({node:n,type:"init"})},detach:function(){var e=this.dom();return e.parentNode.removeChild(e),this.run({node:e,type:"destroy"})},interface:function(){for(var e,t,n=this.obj.length;0<=n;--n)if(e=n,t=(this.obj[e]||{}).interface)return t instanceof Function?t.apply(this.obj[e]):t;return null},update:function(e){return this.datadom.update(e)},_transform:function(e){var l=this,u=function(e){var t,n,r,o,i,s,c=[];if(e.nodeType===win.Element.TEXT_NODE)return e.parentNode.setAttribute("t",e.textContent),e.parentNode.replaceChild(doc.createTextNode(l.i18n(e.textContent)),e);for(t=0,n=e.attributes.length;t<n;++t)r=t,i=(o=e.attributes[r]).name,o=o.value,(i=/^t-(.+)$/.exec(i))&&e.setAttribute(i[1],l.i18n(o||""));if(s=e.getAttribute("t"))return e.textContent=l.i18n(s);for(t=0,n=e.childNodes.length;t<n;++t)r=t,c.push(u(e.childNodes[r]));return c};return Array.from(e.querySelectorAll("[t]")).filter(function(e){return e.hasAttribute("t")}).map(u),e},transform:function(e){if("i18n"===e)return this._transform(this.node)},dom:function(e){var t;return(t=this.node)?t:(this.node=this.block.resolvePlugAndCloneNode(e),this._transform(this.node))},i18n:function(e){return this.block.i18n(e)},run:function(e){var a=this,h=e.node,p=e.type,t=[],d=[],n=this.block;for(this.obj||(this.obj=[]),this.pubsub||(this.pubsub=new pubsub);n;)t=[n].concat(t),n=n.extend;return new Promise(function(c,l){var u=function(e,t,n,r){var o,i,s;return null==t&&(t=0),null==n&&(n={}),(e=null==e?[]:e).length<=t?Promise.all(d).then(function(e){return c(e)}).catch(function(e){return l(e)}):(o=e[t],i=o._ctx.ctx?o._ctx.ctx():(i=o._ctx).local||(i.local={}),import$(n,i),i={root:h,parent:r,manager:a.block.manager,ctx:n,context:n,pubsub:a.pubsub,i18n:{addResourceBundles:function(e){var t,n,r=[];for(t in e=null==e?{}:e)n=e[t],r.push(block.i18n.addResourceBundle(t,a.block._id_t,n));return r},t:function(e){return a.block.i18n(e)}},t:function(e){return a.block.i18n(e)},data:a.data},"init"===p&&a.obj.push(s=new o.factory(i)),d.push((s=a.obj[t])?a.obj[t][p](i):null),u(e,t+1,n,s))};return u(t,0,{})})}}),block.env("undefined"!=typeof self&&null!==self?self:globalThis),"undefined"!=typeof module&&null!==module?module.exports=block:"undefined"!=typeof window&&null!==window&&(window.block=block)}.call(this);
