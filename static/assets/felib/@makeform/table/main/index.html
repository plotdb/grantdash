<div><div plug="widget"><table class="table"><tr><th ld-each="head"></th><th class="m-edit">&nbsp;</th></tr><tr ld="no-data"><td class="text-muted" colspan="99" t>無資料</td></tr><tr ld-each="row"><td style="vertical-align:middle;" ld-each="editor-field"></td><td class="m-edit"><div class="btn btn-block btn-outline-secondary text-nowrap" t ld="delete">刪除</div></td></tr><tr class="m-edit"><td ld-each="adder-field"></td><td><div class="btn btn-block btn-outline-secondary text-nowrap" t ld="add">加入</div></td></tr></table><div class="mt-2"><div class="text-danger" ld-each="error"></div></div></div><style type="text/css">label{white-space:nowrap}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"@makeform/table",extend:{name:"@makeform/common"},dependencies:[{name:"ldcover"},{name:"ldcover",type:"css",global:true}],i18n:{en:{"加入":"Add","刪除":"Delete","無資料":"No data"},zh:{"加入":"加入","刪除":"刪除","無資料":"無資料"}}},init:function(e){return e.pubsub.fire("subinit",{mod:mod(e)})}};mod=function(e){var t,n,r,i,o,l,a,s;t=e.root,n=e.ctx,r=e.data,i=e.parent,o=e.t,l=e.manager;a=n.ldview,s=n.ldcover;return{init:function(){var d,f,i,u,c=this;d=this.mod.child;d.data=[];d.editor=[];d.adder={fields:[]};this.on("change",function(e){e==null&&(e=[]);d.data=e;return d.view.render()});this.on("mode",function(){return this.mod.child.view.render()});f=function(){return c.value(d.data).then(function(){d.view.render();return c.mod.info.view.render()})};i=this.mod.child.getkey=function(e,t){return e.alias||e.key||e.title||t};u=function(e){var t;e.proxise=t=proxise(function(e){if(Array.isArray(e)){return t._list=e,t._hash={},t}if(in$(e,t._list||(t._list=[]))){t._hash[e]=true}if(t._list.filter(function(e){return!t._hash[e]}).length){return}t.resolve();return Promise.resolve()});return e.proxise(e.list.map(function(e){return e.key}))};return this.mod.child.view=new a({root:t,init:{"popup-input":function(e){var t;t=e.node;return d.popupInput=new s({root:t,resident:true,inPlace:false})}},action:{click:{"popup-input-toggle":function(){return d.popupInput.get()},add:function(e){var t,n,r;t=e.views;d.data.push(n={list:c.mod.info.config.fields.map(function(e,t){var n;n=i(e,t);return{key:n,value:d.adder.fields[n].itf.value()}}),key:Math.round(Date.now()+Math.random()*65535).toString(36).substring(2)});r=u(n);t[0].render();return r.then(function(){c.mod.info.config.fields.map(function(e,t){return d.adder.fields[i(e,t)].itf.value(null)});f();return t[0].render()})}}},handler:{"no-data":function(e){var t;t=e.node;return t.classList.toggle("d-none",d.data&&d.data.length)},head:{list:function(){return c.mod.info.config.fields.map(function(e,t){return{cfg:e,key:i(e,t)}})},key:function(e){return e.key},text:function(e){var t;t=e.data;return o(t.cfg.meta.title||"untitled")}},row:{list:function(){return d.data},key:function(e){return e.key},view:{action:{click:{delete:function(e){var t,n,r;t=e.views,n=e.ctx;r=d.data.map(function(e){return e.key}).indexOf(n.key);if(r===-1){return}d.data.splice(r,1);f();return t[1].render()}}},text:{delete:function(){return o("刪除")}},handler:{"editor-field":{list:function(e){var t;t=e.ctx;return t.list},key:function(e){return e.key},view:{init:{"@":function(e){var t,o,a,n,r,i,u;t=e.node,o=e.ctx,a=e.ctxs;n=c.mod.child.metamap;r=n[o.key]||{},i=r.type,u=r.meta;if(!u){return}return l.from({name:i},{root:t,data:u}).then(function(e){var t,n,r,i,u;t=((t=d.editor)[n=a[0].key]||(t[n]={}))[o.key]={bi:e.instance,itf:e["interface"]},r=t.bi,i=t.itf;i.value(o.value);i.on("change",function(){var e,t;e=d.data.filter(function(e){return e.key===a[0].key})[0]||{};t=(e.list||(e.list=[])).filter(function(e){return e.key===o.key})[0];if(!t){return}t.value=i.value();return f()});if(u=a[0].proxise){return u(o.key)}})}},handler:{"@":function(e){var t,n,r,i,u,o;t=e.ctx,n=e.ctxs;r=c.mod.child.metamap;if(!(i=((u=d.editor)[o=n[0].key]||(u[o]={}))[t.key])){return}if(!i.itf){return}return i.itf.deserialize(r[t.key].meta||{}).then(function(){i.bi.transform("i18n");return i.itf.value(t.value,{fromSource:true})}).then(function(){i.itf.validate();return i.itf.mode(c.mode())})}}}}}}},"adder-field":{list:function(){return c.mod.info.config.fields.map(function(e,t){return{cfg:e,key:i(e,t)}})},key:function(e){return e.key},view:{init:{"@":function(e){var t,n,r,i,u;t=e.ctx,n=e.node;r=t.cfg,i=r.type,u=r.meta;return l.get({name:i||"input"}).then(function(e){return e.create()}).then(function(e){return e.attach({root:n,data:u}).then(function(){return d.adder.fields[t.key]={bi:e,itf:e["interface"]()}})})}},handler:{"@":function(e){var t,n,r,i;t=e.ctx;n=d.adder.fields[t.key]||{},r=n.bi,i=n.itf;if(!i){return}return i.deserialize(t.cfg.meta).then(function(){r.transform("i18n");return i.render()})}}}}}})},render:function(){var n=this;this.mod.child.metamap=Object.fromEntries(this.mod.info.config.fields.map(function(e,t){return[n.mod.child.getkey(e,t),e]}));return this.mod.child.view.render()},isEmpty:function(e){return!Array.isArray(e)||!e.length},validate:function(n){var u,o=this;n==null&&(n={});u=[];if(this.mod.info.meta.isRequired&&this.isEmpty()){this._errors=["required"];this.status(n.init?1:2);this.render();return Promise.resolve(this._errors)}this.mod.child.data.map(function(i){return i.list.map(function(e){var t,n,r;if(t=((n=o.mod.child.editor)[r=i.key]||(n[r]={}))[e.key]){return u.push(t.itf)}})});return Promise.all(u.map(function(e){return e.validate(n)})).then(function(){var e,t;e=(t=Math.max.apply(Math,u.map(function(e){return e.status()})))>1?t:1;if(!n.init&&e===1){e=o.mod.info.isRequired?2:0}o.status(e);return o._errors=e===2?["error"]:[]})}}};function in$(e,t){var n=-1,r=t.length>>>0;while(++n<r)if(e===t[n])return true;return false}</script></div>