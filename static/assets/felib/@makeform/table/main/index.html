<div><div plug="widget"><table class="table"><tr><th ld-each="head"></th><th>&nbsp;</th></tr><tr ld="no-data"><td class="text-muted" colspan="99" t>無資料</td></tr><tr ld-each="row"><td style="vertical-align:middle;" ld-each="editor-field"></td><td><div class="btn btn-block btn-outline-secondary text-nowrap" t ld="delete">刪除</div></td></tr><tr><td ld-each="adder-field"></td><td><div class="btn btn-block btn-outline-secondary text-nowrap" t ld="add">加入</div></td></tr></table></div><style type="text/css">label{white-space:nowrap}</style><script type="@plotdb/block">var mod;module.exports={pkg:{name:"@makeform/table",extend:{name:"@makeform/common"},i18n:{en:{"加入":"Add","刪除":"Delete","無資料":"No data"},zh:{"加入":"加入","刪除":"刪除","無資料":"無資料"}}},init:function(t){return t.pubsub.fire("subinit",{mod:mod(t)})}};mod=function(t){var e,n,r,i,a,l,u;e=t.root,n=t.ctx,r=t.data,i=t.parent,a=t.t,l=t.manager;u=n.ldview;return{init:function(){var d,f,r,c=this;d=this.mod.child;d.data=[];d.editor=[];d.adder={fields:[]};this.on("change",function(t){t==null&&(t=[]);d.data=t;return d.view.render()});f=function(){return c.value(d.data)};r=this.mod.child.getkey=function(t,e){return t.alias||t.key||t.title||e};return this.mod.child.view=new u({root:e,action:{click:{add:function(t){var e;e=t.views;d.data.push({list:c.mod.info.config.fields.map(function(t,e){var n;n=r(t,e);return{key:n,value:d.adder.fields[n].itf.value()}}),key:Math.round(Date.now()+Math.random()*65535).toString(36).substring(2)});c.mod.info.config.fields.map(function(t,e){return d.adder.fields[r(t,e)].itf.value(null)});f();return e[0].render()}}},handler:{"no-data":function(t){var e;e=t.node;return e.classList.toggle("d-none",d.data&&d.data.length)},head:{list:function(){return c.mod.info.config.fields.map(function(t,e){return{cfg:t,key:r(t,e)}})},key:function(t){return t.key},text:function(t){var e;e=t.data;return a(e.cfg.meta.title||"untitled")}},row:{list:function(){return d.data},key:function(t){return t.key},view:{action:{click:{delete:function(t){var e,n,r;e=t.views,n=t.ctx;r=d.data.map(function(t){return t.key}).indexOf(n.key);if(r===-1){return}d.data.splice(r,1);f();return e[1].render()}}},handler:{"editor-field":{list:function(t){var e;e=t.ctx;return e.list},key:function(t){return t.key},view:{init:{"@":function(t){var e,a,u,n,r,i,o;e=t.node,a=t.ctx,u=t.ctxs;n=c.mod.child.metamap;r=n[a.key]||{},i=r.type,o=r.meta;if(!o){return}return l.from({name:i},{root:e,data:o}).then(function(t){var e,n,r,i;e=((e=d.editor)[n=u[0].key]||(e[n]={}))[a.key]={bi:t.instance,itf:t["interface"]},r=e.bi,i=e.itf;i.value(a.value);return i.on("change",function(){a.value=i.value();return f()})})}},handler:{"@":function(t){var e,n,r,i,a,u;e=t.ctx,n=t.ctxs;r=c.mod.child.metamap;if(!(i=((a=d.editor)[u=n[0].key]||(a[u]={}))[e.key])){return}if(!i.itf){return}return i.itf.deserialize(r[e.key].meta||{}).then(function(){i.bi.transform("i18n");return i.itf.value(e.value,{fromSource:true})})}}}}}}},"adder-field":{list:function(){return c.mod.info.config.fields.map(function(t,e){return{cfg:t,key:r(t,e)}})},key:function(t){return t.key},view:{init:{"@":function(t){var e,n,r,i,a;e=t.ctx,n=t.node;r=e.cfg,i=r.type,a=r.meta;return l.get({name:i||"input"}).then(function(t){return t.create()}).then(function(t){return t.attach({root:n,data:a}).then(function(){return d.adder.fields[e.key]={bi:t,itf:t["interface"]()}})})}},handler:{"@":function(t){var e,n,r,i;e=t.ctx;n=d.adder.fields[e.key]||{},r=n.bi,i=n.itf;if(!i){return}return i.deserialize(e.cfg.meta).then(function(){r.transform("i18n");return i.render()})}}}}}})},render:function(){var n=this;this.mod.child.metamap=Object.fromEntries(this.mod.info.config.fields.map(function(t,e){return[n.mod.child.getkey(t,e),t]}));return this.mod.child.view.render()},isEmpty:function(t){return!Array.isArray(t)||!t.length},validate:function(n){var a,u=this;a=[];this.mod.child.data.map(function(i){return i.list.map(function(t){var e,n,r;if(e=((n=u.mod.child.editor)[r=i.key]||(n[r]={}))[t.key]){return a.push(e.itf)}})});return Promise.all(a.map(function(t){return t.validate(n)})).then(function(){var t,e;t=(e=Math.max.apply(Math,a.map(function(t){return t.status()})))>1?e:1;if(!n.init&&t===1){t=u.mod.info.isRequired?2:0}u.status(t);return t===2?["error"]:[]})}}};</script></div>