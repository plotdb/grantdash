function import$(t,n){var e,r={}.hasOwnProperty;for(e in n)r.call(n,e)&&(t[e]=n[e]);return t}function in$(t,n){for(var e=-1,r=n.length>>>0;++e<r;)if(t===n[e])return!0;return!1}ldc.register("discussView",["discussEdit","auth","error"],function(t){var e=t.discussEdit,r=t.auth,s=t.error,t=function(t){var n,o=this,i=new ldLoader({className:"full ldld"});return this.opt=t,this.markedOptions=t.marked||{},this.root=n="string"==typeof t.root?document.querySelector(t.root):t.root,this.data=import$({url:window.location.pathname},t.data),this.edit=new e({root:ld$.find(n,"[ld-scope=edit]",0)}),this.comments=[],this.edit.init(),this.edit.on("new-comment",function(t){return t.distance=o.comments.length,t.state="active",o.comments.push(t),o.view.render()}),this.view=new ldView({initRender:!1,root:this.root,handler:{loading:function(t){var n=t.node,t=t.names;return n.classList.toggle("d-none",!(!o.loading!=!(t=in$("off",t))&&(o.loading||t)))},title:function(t){var n=t.node,t=o.discuss?o.discuss.title:"";return n.innerText=t||"未命名的討論串"},comment:{list:function(){return o.comments.filter(function(t){return!t.delete})},handler:function(t){return t.local.view.render()},init:function(t){var n=t.local,e=t.node,r=t.data,t=t.idx;return e.classList.add("ld","ld-float-ltr-in","xp35"),e.style.animationDelay=.1*t+"s",n.view=new ldView({root:e,action:{click:{delete:function(t){t.node;return i.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/discuss/"+r.key,{method:"DELETE"})}).finally(function(){return i.off()}).then(function(){return r.deleted=!0,o.view.render()}).catch(s())}}},handler:{delete:function(t){return t.node.classList.toggle("d-none",!(r.owner===o.global.user.key||o.global.user.staff))},avatar:function(t){return t.node.style.backgroundImage="url(/dash/s/avatar/"+r.owner+".png)"},author:function(t){return t.node.innerText=r.displayname},role:function(t){t=t.node;return t.classList.toggle("d-none",!r.role),ld$.find(t,"span",0).innerText=r.role},date:function(t){return t.node.innerText=moment(r.createdtime).tz("Asia/Taipei").format("YYYY/MM/DD hh:mm:ss")},content:function(t){var n=t.node;return(t=ld$.parent(n,".comment"))&&t.classList.toggle("d-none",r.deleted),((t=r.content).config||(t.config={})).useMarkdown?n.innerHTML=marked(r.content.body):n.innerText=r.content.body}}})}}}}),this};return t.prototype=import$(Object.create(Object.prototype),{init:function(){var t,n=this;return this.global={user:{}},r.get().then(function(t){return n.global=t,n.view.render()}),this.loading=!0,t=this.data.slug?{slug:this.data.slug}:{url:this.data.url},ld$.fetch("/dash/api/discuss",{method:"GET"},{params:t,type:"json"}).finally(function(){return n.loading=!1}).then(function(t){return n.comments=t.comments,n.discuss=t.discuss,n.comments=t.comments||[],n.discuss=t.discuss||{},n.view.render()})}}),t});