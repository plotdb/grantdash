function import$(t,n){var e,o={}.hasOwnProperty;for(e in n)o.call(n,e)&&(t[e]=n[e]);return t}function in$(t,n){for(var e=-1,o=n.length>>>0;++e<o;)if(t===n[e])return!0;return!1}ldc.register("discussView",["discussEdit","auth","error"],function(t){var e=t.discussEdit,o=t.auth,i=t.error,t=function(t){var n,o=this,r=new ldLoader({className:"full ldld"});return this.opt=t,this.markedOptions=t.marked||{},this.root=n="string"==typeof t.root?document.querySelector(t.root):t.root,this.data=import$({url:window.location.pathname},t.data),this.edit=new e({root:ld$.find(n,"[ld-scope=edit]",0)}),this.comments=[],this.edit.init(),this.edit.on("new-comment",function(t){return t.distance=o.comments.length,t.state="active",o.comments.push(t),o.view.render()}),this.view=new ldView({initRender:!1,root:this.root,handler:{loading:function(t){var n=t.node,t=t.names;return n.classList.toggle("d-none",!(!o.loading!=!(t=in$("off",t))&&(o.loading||t)))},title:function(t){var n=t.node,t=o.discuss?o.discuss.title:"";return n.innerText=t||"未命名的討論串"},comment:{list:function(){return o.comments},init:function(t){var n=t.node,e=t.data,t=t.idx;return n.classList.add("ld","ld-float-ltr-in","xp35"),n.style.animationDelay=.1*t+"s",new ldView({root:n,action:{click:{delete:function(t){t.node;return r.on(),debounce(500).then(function(){return ld$.fetch("/api/discuss/"+e.key,{method:"DELETE"})}).finally(function(){return r.off()}).catch(i())}}},handler:{delete:function(t){return t.node.classList.toggle("d-none",!(e.owner===o.global.user.key||o.global.user.staff))},avatar:function(t){return t.node.style.backgroundImage="url(/dash/s/avatar/"+e.owner+".png)"},author:function(t){return t.node.innerText=e.displayname},role:function(t){t=t.node;return t.classList.toggle("d-none",!e.role),ld$.find(t,"span",0).innerText=e.role},date:function(t){return t.node.innerText=moment(e.createdtime).tz("Asia/Taipei").format("YYYY/MM/DD hh:mm:ss")},content:function(t){var n=t.node;return((t=e.content).config||(t.config={})).useMarkdown?n.innerHTML=marked(e.content.body):n.innerText=e.content.body}}})}}}}),this};return t.prototype=import$(Object.create(Object.prototype),{init:function(){var t,n=this;return this.global={user:{}},o.get().then(function(t){return n.global=t,n.view.render()}),this.loading=!0,t=this.data.slug?{slug:this.data.slug}:{url:this.data.url},ld$.fetch("/dash/api/discuss",{method:"GET"},{params:t,type:"json"}).finally(function(){return n.loading=!1}).then(function(t){return n.comments=t.comments,n.discuss=t.discuss,n.comments=t.comments||[],n.discuss=t.discuss||{},n.view.render()})}}),t});