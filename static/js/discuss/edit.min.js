function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}var slice$=[].slice;ldc.register("discussEdit",["auth","error"],function(e){var t,n,r;return t=e.auth,n=e.error,r=function(e){var t,r,i=this;return this.opt=e,this.markedOptions=e.marked||{},this.root=t="string"==typeof e.root?document.querySelector(e.root):e.root,this.data=import$({content:{},url:window.location.pathname,reply:null},e.data),this.preview=!1,this.useMarkdown=!1,this.ready=!1,this.ldld=null,this.evtHandler={},this.view=r=new ldView({initRender:!1,root:t,action:{input:{"use-markdown":function(e){var t,n;return t=e.node,((n=i.data.content).config||(n.config={})).useMarkdown=i.useMarkdown=t.checked,r.render()},"toggle-preview":function(e){var t;return t=e.node,i.preview=!!t.checked,r.render()},input:function(e){var t;return t=e.node,i.data.content.body=t.value,r.render("post")},title:function(e){var t;return t=e.node,i.data.title=t.value,r.render("post")}},click:{post:function(e){var t,o,a;if(!(t=e.node).classList.contains("running")&&!t.classList.contains("disabled")&&i.isReady())return o={url:(a=i.data).url,reply:a.reply,content:a.content,slug:a.slug,key:a.key,title:a.title},i.ldld.on(),debounce(1e3).then(function(){return ld$.fetch("/dash/api/discuss",{method:o.key?"PUT":"POST"},{type:"json",json:o})}).finally(function(){return i.ldld.off()}).then(function(e){var t;return i.fire("new-comment",(t=import$({owner:i.global.user.key,displayname:i.global.user.displayname},o),t.key=e.key,t.slug=e.slug,t)),r.get("input").value="",r.get("panel").innerHTML="",i.preview=!1,r.render()}).catch(n())}}},init:{post:function(e){var t;return t=e.node,i.ldld=new ldLoader({root:t})}},handler:{avatar:function(e){var t;return t=e.node,t.style.backgroundImage="url(/dash/s/avatar/"+i.global.user.key+".png)"},preview:function(e){var t,n,r,o;return t=e.node,n=in$("off",t.getAttribute("ld").split(" ")),r=!(o=!(i.preview&&i.useMarkdown))!=!n&&(o||n),t.classList.toggle("d-none",r)},panel:function(e){var t;if(t=e.node,i.preview)return t.innerHTML=marked(i.data.content.body||"",i.markedOptions)},post:function(e){return e.node.classList.toggle("disabled",!i.isReady())},"edit-panel":function(e){return e.node.classList.toggle("d-none",!!i.preview)},"if-markdown":function(e){return e.node.classList.toggle("d-none",!i.useMarkdown)}}}),this},r.prototype=import$(Object.create(Object.prototype),{init:function(){var e=this;return t.get().then(function(t){return e.global=t,e.view.render()})},edit:function(e){return null==e&&(e={}),import$(this.data,e),this.view.render()},isReady:function(){var e;return e=this.view.get("title"),this.ready=!!(this.data.content.body||"").trim().length&&(!e||(this.data.title||"").trim().length)},on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){var t,n,r,i,o,a=[];for(t=slice$.call(arguments,1),n=0,i=(r=this.evtHandler[e]||[]).length;n<i;++n)o=r[n],a.push(o.apply(this,t));return a}}),r});