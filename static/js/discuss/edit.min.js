function import$(e,n){var t={}.hasOwnProperty;for(var r in n)t.call(n,r)&&(e[r]=n[r]);return e}function in$(e,n){for(var t=-1,r=n.length>>>0;++t<r;)if(e===n[t])return!0;return!1}var slice$=[].slice;ldc.register("discussEdit",["auth","error"],function(e){var n,t,r;return n=e.auth,t=e.error,r=function(e){var n,r,o=this;return this.opt=e,this.markedOptions=e.marked||{},this.root=n="string"==typeof e.root?document.querySelector(e.root):e.root,this.data=import$({content:{},url:window.location.pathname,reply:null},e.data),this.preview=!1,this.useMarkdown=!1,this.ready=!1,this.ldld=null,this.evtHandler={},this.view=r=new ldView({initRender:!1,root:n,action:{input:{"use-markdown":function(e){var n,t;return n=e.node,((t=o.data.content).config||(t.config={})).useMarkdown=o.useMarkdown=n.checked,r.render()},"toggle-preview":function(e){var n;return n=e.node,o.preview=!!n.checked,r.render()},input:function(e){var n;return n=e.node,o.data.content.body=n.value,o.ready=!!(o.data.content.body||"").trim().length,r.render("post")}},click:{post:function(e){var n,i;if(!e.node.classList.contains("running"))return n={url:(i=o.data).url,reply:i.reply,content:i.content,slug:i.slug,key:i.key},o.ldld.on(),debounce(1e3).then(function(){return ld$.fetch("/dash/api/discuss",{method:n.key?"PUT":"POST"},{type:"json",json:n})}).finally(function(){return o.ldld.off()}).then(function(){return o.fire("new-comment",import$({owner:o.global.user.key,displayname:o.global.user.displayname},n)),r.get("input").value="",r.get("panel").innerHTML="",o.preview=!1,r.render()}).catch(t())}}},init:{post:function(e){var n;return n=e.node,o.ldld=new ldLoader({root:n})}},handler:{avatar:function(e){var n;return n=e.node,n.style.backgroundImage="url(/dash/s/avatar/"+o.global.user.key+".png)"},preview:function(e){var n,t,r,i;return n=e.node,t=in$("off",n.getAttribute("ld").split(" ")),r=!(i=!(o.preview&&o.useMarkdown))!=!t&&(i||t),n.classList.toggle("d-none",r)},panel:function(e){var n;if(n=e.node,o.preview)return n.innerHTML=marked(o.data.content.body||"",o.markedOptions)},post:function(e){return e.node.classList.toggle("disabled",!o.ready)},"edit-panel":function(e){return e.node.classList.toggle("d-none",!!o.preview)},"if-markdown":function(e){return e.node.classList.toggle("d-none",!o.useMarkdown)}}}),this},r.prototype=import$(Object.create(Object.prototype),{init:function(){var e=this;return n.get().then(function(n){return e.global=n,e.view.render()})},edit:function(e){return null==e&&(e={}),import$(this.data,e),this.view.render()},on:function(e,n){var t;return((t=this.evtHandler)[e]||(t[e]=[])).push(n)},fire:function(e){var n,t,r,o,i,a=[];for(n=slice$.call(arguments,1),t=0,o=(r=this.evtHandler[e]||[]).length;t<o;++t)i=r[t],a.push(i.apply(this,n));return a}}),r});