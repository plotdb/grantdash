function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}var slice$=[].slice;ldc.register("discussEdit",["auth","error"],function(e){var t,n,r;return t=e.auth,n=e.error,r=function(e){var r,i,o=this;return this.opt=e,this.markedOptions=e.marked||{},this.root=r="string"==typeof e.root?document.querySelector(e.root):e.root,this.data=import$({content:{},url:window.location.pathname,reply:null},e.data),this.preview=!1,this.useMarkdown=!1,this.ready=!1,this.ldld=null,this.evtHandler={},this.view=i=new ldView({initRender:!1,root:r,action:{input:{"use-markdown":function(e){var t,n;return t=e.node,((n=o.data.content).config||(n.config={})).useMarkdown=o.useMarkdown=t.checked,i.render()},"toggle-preview":function(e){var t;return t=e.node,o.preview=!!t.checked,i.render()},input:function(e){var t;return t=e.node,o.data.content.body=t.value,i.render("post")},title:function(e){var t;return t=e.node,o.data.title=t.value,i.render("post")}},click:{post:function(e){var r,a,u;if(!(r=e.node).classList.contains("running")&&!r.classList.contains("disabled")&&o.isReady())return a={url:(u=o.data).url,reply:u.reply,content:u.content,slug:u.slug,key:u.key,title:u.title},o.ldld.on(),debounce(1e3).then(function(){return t.recaptcha.get()}).then(function(e){return a.recaptcha=e,ld$.fetch("/dash/api/discuss",{method:a.key?"PUT":"POST"},{type:"json",json:a})}).finally(function(){return o.ldld.off()}).then(function(e){var t;return o.fire("new-comment",(t=import$({owner:o.global.user.key,displayname:o.global.user.displayname},a),t.key=e.key,t.slug=e.slug,t)),i.get("input").value="",i.get("panel").innerHTML="",o.preview=!1,i.render()}).catch(n())}}},init:{post:function(e){var t;return t=e.node,o.ldld=new ldLoader({root:t})}},handler:{avatar:function(e){var t;return t=e.node,t.style.backgroundImage="url(/dash/s/avatar/"+o.global.user.key+".png)"},preview:function(e){var t,n,r,i;return t=e.node,n=in$("off",t.getAttribute("ld").split(" ")),r=!(i=!(o.preview&&o.useMarkdown))!=!n&&(i||n),t.classList.toggle("d-none",r)},panel:function(e){var t;if(t=e.node,o.preview)return t.innerHTML=marked(o.data.content.body||"",o.markedOptions)},post:function(e){return e.node.classList.toggle("disabled",!o.isReady())},"edit-panel":function(e){return e.node.classList.toggle("d-none",!!o.preview)},"if-markdown":function(e){return e.node.classList.toggle("d-none",!o.useMarkdown)}}}),this},r.prototype=import$(Object.create(Object.prototype),{init:function(){var e=this;return t.get().then(function(t){return e.global=t,e.view.render()})},edit:function(e){return null==e&&(e={}),import$(this.data,e),this.view.render()},isReady:function(){var e;return e=this.view.get("title"),this.ready=!!(this.data.content.body||"").trim().length&&(!e||(this.data.title||"").trim().length)},on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){var t,n,r,i,o,a=[];for(t=slice$.call(arguments,1),n=0,i=(r=this.evtHandler[e]||[]).length;n<i;++n)o=r[n],a.push(o.apply(this,t));return a}}),r});