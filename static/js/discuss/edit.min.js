var slice$=[].slice;function import$(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}ldc.register("discussEdit",["auth","error"],function(e){var o=e.auth,a=e.error,e=function(e){var t,r,i=this;return this.opt=e,this.markedOptions=e.marked||{},this.root=t="string"==typeof e.root?document.querySelector(e.root):e.root,this.data=import$({content:{},url:window.location.pathname,reply:null},e.data),this.preview=!1,this.useMarkdown=!1,this.ready=!1,this.ldld=null,this.evtHandler={},this.view=r=new ldView({initRender:!1,root:t,action:{input:{"use-markdown":function(e){var t=e.node;return((e=i.data.content).config||(e.config={})).useMarkdown=i.useMarkdown=t.checked,r.render()},"toggle-preview":function(e){e=e.node;return i.preview=!!e.checked,r.render()},input:function(e){e=e.node;return i.data.content.body=e.value,r.render("post")},title:function(e){e=e.node;return i.data.title=e.value,r.render("post")}},click:{post:function(e){var n,e=e.node;if(!e.classList.contains("running"))return i.global.user.key?e.classList.contains("disabled")?void 0:(n={url:(e=i.data).url,reply:e.reply,content:e.content,slug:e.slug,key:e.key,title:e.title},o.ensure().then(function(){if(i.isReady())return i.ldld.on(),debounce(1e3)}).then(function(){return o.recaptcha.get()}).then(function(e){return n.recaptcha=e,ld$.fetch("/dash/api/discuss",{method:n.key?"PUT":"POST"},{type:"json",json:n})}).finally(function(){return i.ldld.off()}).then(function(e){var t;return i.fire("new-comment",((t=import$({owner:i.global.user.key,displayname:i.global.user.displayname},n)).key=e.key,t.slug=e.slug,t)),r.get("input").value="",r.get("panel").innerHTML="",i.preview=!1,r.render()}).catch(a())):o.ensure()}}},init:{post:function(e){e=e.node;return i.ldld=new ldLoader({root:e})}},handler:{avatar:function(e){return e.node.style.backgroundImage="url(/dash/s/avatar/"+i.global.user.key+".png)"},preview:function(e){var t=e.node,n=in$("off",t.getAttribute("ld").split(" ")),n=!(e=!(i.preview&&i.useMarkdown))!=!n&&(e||n);return t.classList.toggle("d-none",n)},input:function(e){e=e.node;return i.global.user.key?e.removeAttribute("disabled"):e.setAttribute("disabled","")},panel:function(e){e=e.node;if(i.preview)return e.innerHTML=marked(i.data.content.body||"",i.markedOptions)},post:function(e){e=e.node;return e.classList.toggle("disabled",!(i.isReady()&&i.global.user.key)),e.innerText=i.global.user.key?"送出留言":"請先登入"},"edit-panel":function(e){return e.node.classList.toggle("d-none",!!i.preview)},"if-markdown":function(e){return e.node.classList.toggle("d-none",!i.useMarkdown)}}}),this};return e.prototype=import$(Object.create(Object.prototype),{init:function(){var t=this;return o.get().then(function(e){return t.global=e,t.view.render()}),o.on("auth.change",function(e){return t.global=e,t.view.render()})},edit:function(e){return import$(this.data,e=null==e?{}:e),this.view.render()},isReady:function(){var e=this.view.get("title");return this.ready=!!(this.data.content.body||"").trim().length&&(!e||(this.data.title||"").trim().length)},on:function(e,t){var n;return((n=this.evtHandler)[e]||(n[e]=[])).push(t)},fire:function(e){for(var t,n,r=[],i=slice$.call(arguments,1),o=0,a=(t=this.evtHandler[e]||[]).length;o<a;++o)n=t[o],r.push(n.apply(this,i));return r}}),e});