function import$(e,r){var t={}.hasOwnProperty;for(var n in r)t.call(r,n)&&(e[n]=r[n]);return e}var slice$=[].slice;ldc.register("prjForm",["error","ldcvmgr","prjFormCriteria","prjFormBlock","prjFormValidation","prjViewSimple","sdbAdapter"],function(e){var r,t,n,i,o,a,d;return e.error,r=e.ldcvmgr,t=e.prjFormCriteria,n=e.prjFormBlock,i=e.prjFormValidation,o=e.prjViewSimple,a=e.sdbAdapter,d=function(e){var a,d,s,l,u,c,f,p,v,h,m,b,g=this;return this.opt=e,this.root=a="string"==typeof e.root?document.querySelector(e.root):e.root,this.evtHandler={},this.node={src:ld$.find(a,"[ld=blocksrc]",0),list:ld$.find(a,"[ld=form-list]",0),answer:ld$.find(a,"[ld-scope=form-answer]",0)},this.viewMode=d=e.viewMode,this.obj=s={list:[],value:{answer:{}}},this.brd=e.brd,this.prj=e.prj,this.viewMode&&e.form&&(this.obj.list=(e.form||(e.form={})).list,this.obj.purpose=e.form.purpose,l={name:"form-short-answer",title:"提案名稱",key:"title",config:{required:!0}},u={name:"form-long-answer",title:"提案簡介",key:"description",config:{required:!0}},s.purpose.description||(this.obj.list=[u].concat(this.obj.list)),s.purpose.title||(this.obj.list=[l].concat(this.obj.list))),c={view:!1},this.hub=f={updateDeb:debounce(200,function(e){return f.update()}),update:function(e){var t,n,i;try{return d&&e?(s.value.answer[e.key]=e.value,t=(n=s.value).info||(n.info={}),t.title=(s.value.answer[(s.purpose||(s.purpose={})).title||"title"]||{}).content,t.description=(s.value.answer[(s.purpose||(s.purpose={})).description||"description"]||{}).content,t.category=((s.value.answer[(s.purpose||(s.purpose={})).category||"category"]||{}).list||[])[0],t.tag=(s.value.answer[(s.purpose||(s.purpose={})).tag||"tag"]||{}).list,g.opsOut(function(){return s.value}),g.validate(e)):g.opsOut(function(){return{list:g.obj.list,purpose:g.obj.purpose}})}catch(e){return i=e,console.log(i),r.get("not-sync")}},renderDeb:debounce(200,function(){return f.render()}),render:function(){if(v.render(),m)return m.render()},move:function(e,r){var t;if(!((t=s.list.indexOf(e))+r<0||t+r>=s.list.length))return s.list.splice(t,1),s.list.splice(t+r,0,e),this.update(),this.render()},delete:function(e){return s.list.splice(s.list.indexOf(e),1),this.update(),this.render()},clone:function(e){var r;return r=JSON.parse(JSON.stringify(e)),r.key=suuid(),s.list.splice(s.list.indexOf(e),0,r),this.update(),this.render()}},p={get:function(e){return new Promise(function(r,t){var n,i;return(n=ld$.find(a,"[ld=form-sample] [data-name="+e+"]",0))||t(new Error("block not found")),(i=ld$.create({name:"div",attr:{draggable:!0}})).appendChild(n.cloneNode(!0)),r(i)})}},this.validateAll=debounce(function(e){if(s.list.map(function(r){var t;return t=e||!(!r.value||!r.value.content&&!r.value.list),r.valid=i.validate(r,t)}),v.render(),m)return m.render()}),this.validate=debounce(function(e){if(e.valid=i.validate(e),v.render(),m)return m.render()}),v=new ldView({root:this.node.list,handler:{block:{key:function(e){return e.key},list:function(){return s.list},init:function(e){e.node,e.data},handler:function(e){var r,t;return r=e.node,t=e.data,(r.block?Promise.resolve():p.get(t.name).then(function(e){return(e=e.childNodes[0]).parentNode.removeChild(e),r.setAttribute("id","block-"+t.key),r.innerHTML="",r.appendChild(e),r.block=new n({root:r,data:t,viewMode:d,hub:f,form:s,prj:g.prj})})).then(function(){if(r.block)return r.block.setData(t),r.block.render()})}}}}),this.node.src&&new ldView({root:this.node.src,action:{dragstart:{block:function(e){var r;return r=e.node,e.evt.dataTransfer.setData("text/plain",r.getAttribute("data-name")+"")}}}}),new reblock({name:"form",root:this.node.list,blockManager:p,action:{afterInject:function(e){var r,n,i,o,a,d,l,u,c;return r=e.node,n=e.name,i=t.schema,o={key:suuid(),name:n,title:"問題的標題",desc:"一些關於這個問題的簡單描述、說明或介紹",config:{required:!0},criteria:[{enabled:!0,type:"number",op:"between"}]},(a=i.support[n][0])?(d=function(){var e=[];for(l in i.ops[i.types[a].ops]||{})e.push(l);return e}()[0],(u=o.criteria[0]).type=a,u.op=d):o.criteria=[],r._data=o,c=Array.from(r.parentNode.childNodes).indexOf(r),(s.list||(s.list=[])).splice(c,0,o),v.bindEachNode({name:"block",container:r.parentNode,node:r}),v.render(),f.update()},afterMoveNode:function(e){var r,t,n,i,o;if(r=e.src,e.des,t=e.ib,r.parentNode.hasAttribute("hostable")){for(n=r.parentNode;n&&!n._data;)n=n.parentNode;return n?(n._data.data=Array.from(r.parentNode.childNodes).filter(function(e){return 1===e.nodeType}).map(function(e){return e._data}).filter(function(e){return e&&!e.other}),"form-checkpoint"===n._data.name&&(((o=n._data).value||(o.value={})).list=n._data.data),n.view.module&&n.view.module.render(),f.update()):(i=s.list.indexOf(r._data),s.list.splice(i,1),t=t?s.list.indexOf(t._data):s.list.length,s.list.splice(t,0,r._data),f.updateDeb(),void f.render())}}}}),d&&(h=function(){var e,r,t,n;return e=s.list.filter(function(e){return(e.valid||(e.valid={})).result||!(e.value&&e.value.content&&e.value.list)&&!e.config.required}).length,r=s.list.length,t=e/s.list.length,n=r-e,{remain:n,done:e,total:r,percent:t}},m=new ldView({root:a,initRender:!1,action:{input:{history:function(){return r.toggle("prj-diff")}},click:{viewing:function(){return c.view=!c.view,m.render(),b.render()},invalid:function(){var e,r;if(g.validateAll(!0),(e=s.list.filter(function(e){return e.valid&&!e.valid.result})[0])&&e)return(r=ld$.find(g.node.list,"#block-"+e.key,0))?ldui.scrollTo({node:r,jump:!0}):void 0},submit:function(e){if(!e.node.classList.contains("disabled"))return g.fire("submit",g.obj.value)}}},handler:{nview:function(e){return e.node.classList.toggle("d-none",c.view)},view:function(e){return e.node.classList.toggle("d-none",!c.view)},progress:function(e){var r;return r=e.node,r.style.width=100*h().percent+"%"},invalid:function(e){return e.node.classList.toggle("d-none",0===h().remain)},valid:function(e){return e.node.classList.toggle("d-none",h().remain>0)},remain:function(e){var r;return r=e.node,r.innerText=h().remain},"to-fix":function(e){return e.node.classList.toggle("d-none",!h().remain)},"to-publish":function(e){var r,t;return r=e.node,t=JSON.stringify(g.obj.value)!==JSON.stringify(g.prj.detail),r.classList.toggle("d-none",!t||h().remain)},submit:function(e){return e.node.classList.toggle("disabled",h().remain>0)},"brd-name":function(r){var t;return t=r.node,t.innerText=e.brd?e.brd.name||"":"未定的活動"},"grp-name":function(r){var t,n;return t=r.node,t.innerText=e.grp?((n=e.grp).info||(n.info={})).name||"":"未定的分組"},"owner-avatar":function(e){var r;return r=e.node,ld$.find(r,"div",0).style.backgroundImage="url(/dash/s/avatar/"+g.prj.owner+".png)"},"owner-name":function(e){var r;return r=e.node,r.innerText=g.prj.ownername}}}),b=new o({root:this.node.answer,prj:this.prj.slug,brd:this.brd.slug,org:this.brd.org,form:e.form,answer:s.value.answer}),new ldView({root:"[ld-scope=prj-diff] .card-body",handler:{diffs:{list:function(){return s.list.map(function(e){return{old:{},cur:e.value,block:e}})},handler:function(e){var r,t;return r=e.node,t=e.data,r.view?r.view.render():r.view=new ldView({root:r,handler:{title:function(e){var r;return r=e.node,r.innerText=t.block.title||""},desc:function(e){var r;return r=e.node,r.innerText=t.block.desc||""},row:function(e){var r,n,i,o,a,d,s;return r=e.node,n=[t.old||{},t.cur||{}].map(function(e){return suuid()}),i=n[0],o=n[1],a=Diff.diffChars(o,i),d={old:"",cur:""},s=ld$.find(r,".value"),a.map(function(e){var r;if(r=e.added?"text-added":e.removed?"text-removed":"",!e.removed)return d.old+="<span class='"+r+"'>"+e.value+"</span>"}),(a=Diff.diffChars(i,o)).map(function(e){var r;if(r=e.added?"text-removed":e.removed?"text-added":"",!e.removed)return d.cur+="<span class='"+r+"'>"+e.value+"</span>"}),s[0].innerHTML=DOMPurify.sanitize(d.old),s[1].innerHTML=DOMPurify.sanitize(d.cur)}}})}}}})),this},d.prototype=import$(import$(Object.create(Object.prototype),a.interface),{on:function(e,r){var t;return((t=this.evtHandler)[e]||(t[e]=[])).push(r)},fire:function(e){var r,t,n,i,o,a=[];for(r=slice$.call(arguments,1),t=0,i=(n=this.evtHandler[e]||[]).length;t<i;++t)o=n[t],a.push(o.apply(this,r));return a},opsIn:function(e){var r;if(r=e.data,e.ops,!e.source)return r=JSON.parse(JSON.stringify(r||{})),this.viewMode?(this.obj.value=r,this.obj.list.map(function(e){return e.value=(r.answer||(r.answer={}))[e.key]}),this.validateAll()):(this.obj.list=r.list||[],this.obj.purpose=r.purpose||{}),this.hub.renderDeb()},render:function(){return this.hub.render()}}),d});