function in$(e,n){for(var t=-1,r=n.length>>>0;++t<r;)if(e===n[t])return!0;return!1}function import$(e,n){var t={}.hasOwnProperty;for(var r in n)t.call(n,r)&&(e[r]=n[r]);return e}ldc.register("prjForm",["ldcvmgr","prjFormCriteria","prjFormBlock","prjFormValidation","sdbAdapter"],function(e){var n,t,r,i,o;return n=e.ldcvmgr,e.prjFormCriteria,t=e.prjFormBlock,r=e.prjFormValidation,i=e.sdbAdapter,o=function(e){var i,o,a,d,l,u,s,c,f,v,p,h=this;return this.opt=e,this.root=i="string"==typeof e.root?document.querySelector(e.root):e.root,this.node={src:ld$.find(i,"[ld=blocksrc]",0),list:ld$.find(i,"[ld=form-list]",0),answer:ld$.find(i,"[ld=form-answer]",0)},this.viewMode=o=e.viewMode,this.obj=a={list:[],value:{}},this.viewMode&&e.form&&(this.obj.list=e.form),d={view:!1},this.hub=l={updateDeb:debounce(200,function(e){return l.update()}),update:function(e){return o&&e?(a.value[e.key]=e.value,h.opsOut(function(){return a.value}),h.validate(e)):h.opsOut(function(){return{list:h.obj.list}})},renderDeb:debounce(200,function(){return l.render()}),render:function(){if(s.render(),f)return f.render()},delete:function(e){return a.list.splice(a.list.indexOf(e),1),this.update(),this.render()},clone:function(e){var n;return n=JSON.parse(JSON.stringify(e)),n.key=Math.random().toString(36).substring(2),a.list.splice(a.list.indexOf(e),0,n),this.update(),this.render()}},u={get:function(e){return new Promise(function(n,t){var r,o;return(r=ld$.find(i,"[ld=form-sample] [data-name="+e+"]",0))||t(new Error("block not found")),(o=ld$.create({name:"div",attr:{draggable:!0}})).appendChild(r.cloneNode(!0)),n(o)})}},this.validateAll=debounce(function(){if(a.list.map(function(e){return e.valid=r.validate(e)}),s.render(),f)return f.render()}),this.validate=debounce(function(e){if(e.valid=r.validate(e),s.render(),f)return f.render()}),s=new ldView({root:this.node.list,handler:{block:{key:function(e){return e.key},list:function(){return a.list},init:function(e){e.node,e.data},handler:function(e){var n,r;return n=e.node,r=e.data,(n.block?Promise.resolve():u.get(r.name).then(function(e){return(e=e.childNodes[0]).parentNode.removeChild(e),n.innerHTML="",n.appendChild(e),n.block=new t({root:n,data:r,viewMode:o,hub:l})})).then(function(){if(n.block)return n.block.setData(r),n.block.render()})}}}}),this.node.src&&new ldView({root:this.node.src,action:{dragstart:{block:function(e){var n;return n=e.node,e.evt.dataTransfer.setData("text/plain",n.getAttribute("data-name")+"")}}}}),new reblock({name:"form",root:this.node.list,blockManager:u,action:{afterInject:function(e){var n,t,r,i;return n=e.node,t=e.name,r={key:Math.random().toString(36).substring(2),name:t,title:"提問的標題1",desc:"提問的描述",config:{required:!0},criteria:[{type:"number",op:"between",input1:10,input2:20,invalid:"應介於 10 ~ 20 之間"}]},n._data=r,i=Array.from(n.parentNode).indexOf(n),(a.list||(a.list=[])).splice(i,0,r),s.bindEachNode({name:"block",container:n.parentNode,node:n}),s.render(),l.update()},afterMoveNode:function(e){var n,t,r,i,o;if(n=e.src,e.des,t=e.ib,n.parentNode.hasAttribute("hostable")){for(r=n.parentNode;r&&!r._data;)r=r.parentNode;return r?(r._data.data=Array.from(n.parentNode.childNodes).filter(function(e){return 1===e.nodeType}).map(function(e){return e._data}).filter(function(e){return e&&!e.other}),"form-checkpoint"===r._data.name&&(((o=r._data).value||(o.value={})).list=r._data.data),r.view.module&&r.view.module.render(),l.update()):(i=a.list.indexOf(n._data),a.list.splice(i,1),t=t?a.list.indexOf(t._data):a.list.length,a.list.splice(t,0,n._data),l.updateDeb(),void l.render())}}}}),o&&(c=function(){var e,n,t,r;return e=a.list.filter(function(e){return(e.valid||(e.valid={})).result}).length,n=a.list.length,t=e/a.list.length,r=n-e,{remain:r,done:e,total:n,percent:t}},f=new ldView({root:i,action:{input:{history:function(){return n.toggle("prj-diff")}},click:{viewing:function(){return d.view=!d.view,f.render(),p.render()},invalid:function(){var e,n,t,r,i,o,d;n=[];for(t in a.value)n.push(t);for(e=n,r=0,i=a.list.length;r<i&&(o=r,in$(a.list[o].key+"",e));++r);if(d=ld$.find(h.node.list,"#block-"+a.list[o].key,0))return scrollto(d)}}},handler:{nview:function(e){return e.node.classList.toggle("d-none",d.view)},view:function(e){return e.node.classList.toggle("d-none",!d.view)},progress:function(e){var n;return n=e.node,n.style.width=100*c().percent+"%"},invalid:function(e){return e.node.classList.toggle("d-none",0===c().remain)},valid:function(e){return e.node.classList.toggle("d-none",c().remain>0)},remain:function(e){var n;return n=e.node,n.innerText=c().remain},submit:function(e){return e.node.classList.toggle("disabled",c().remain>0)}}}),v={"form-checkpoint":function(e){var n,t,r;return n=e.node,t=e.data,e.block,r=(t.list||[]).map(function(e){return'<div class="item">\n<div class="title">'+e.title+"</div>\n<p>"+e.desc+"</p>\n</div>"}).join(""),n.innerHTML='<div class="timeline-list">'+r+"</div>"},"form-radio":function(e){var n,t;return n=e.node,t=e.data,n.innerText=(t.list||[]).concat(t.other?[t.otherValue||""]:[]).join(", ")},"form-checkbox":function(e){var n,t;return n=e.node,t=e.data,n.innerText=(t.list||[]).concat(t.other?[t.otherValue||""]:[]).join(", ")},"form-long-answer":function(e){var n,t;return n=e.node,t=e.data,n.innerHTML=DOMPurify.sanitize(marked(t.content||""))}},p=new ldView({root:this.node.answer,handler:{answer:{list:function(){return a.list},handler:function(e){var n,t;return n=e.node,t=e.data,n.view?n.view.render():n.view=new ldView({root:n,handler:{title:function(e){var n;return n=e.node,n.innerText=t.title||""},desc:function(e){var n;return n=e.node,n.innerText=t.desc||""},content:function(e){var n;return n=e.node,v[t.name]?v[t.name]({node:n,block:t,data:a.value[t.key]||{}}):n.innerText=(a.value[t.key]||{}).content||""}}})}}}}),new ldView({root:"[ld-scope=prj-diff] .card-body",handler:{diffs:{list:function(){return a.list.map(function(e){return{old:{},cur:e.value,block:e}})},handler:function(e){var n,t;return n=e.node,t=e.data,n.view?n.view.render():n.view=new ldView({root:n,handler:{title:function(e){var n;return n=e.node,n.innerText=t.block.title||""},desc:function(e){var n;return n=e.node,n.innerText=t.block.desc||""},row:function(e){var n,r,i,o,a,d,l;return n=e.node,console.log(t),r=[t.old||{},t.cur||{}].map(function(e){return Math.random().toString(36).substring(2)}),i=r[0],o=r[1],console.log(i,o),a=Diff.diffChars(o,i),d={old:"",cur:""},l=ld$.find(n,".value"),a.map(function(e){var n;if(n=e.added?"text-added":e.removed?"text-removed":"",!e.removed)return d.old+="<span class='"+n+"'>"+e.value+"</span>"}),(a=Diff.diffChars(i,o)).map(function(e){var n;if(n=e.added?"text-removed":e.removed?"text-added":"",!e.removed)return d.cur+="<span class='"+n+"'>"+e.value+"</span>"}),l[0].innerHTML=DOMPurify.sanitize(d.old),l[1].innerHTML=DOMPurify.sanitize(d.cur)}}})}}}})),this},o.prototype=import$(import$(Object.create(Object.prototype),i.interface),{opsIn:function(e){var n;if(n=e.data,e.ops,!e.source)return n=JSON.parse(JSON.stringify(n||{})),this.viewMode?(this.obj.value=n,this.obj.list.map(function(e){return e.value=n[e.key]}),this.validateAll()):this.obj.list=n.list||[],this.hub.renderDeb()}}),o});