function import$(e,n){var t={}.hasOwnProperty;for(var r in n)t.call(n,r)&&(e[r]=n[r]);return e}var slice$=[].slice;ldc.register("prjForm",["error","ldcvmgr","prjFormCriteria","prjFormBlock","prjFormValidation","sdbAdapter"],function(e){var n,t,r,i,o,a;return e.error,n=e.ldcvmgr,t=e.prjFormCriteria,r=e.prjFormBlock,i=e.prjFormValidation,o=e.sdbAdapter,a=function(e){var o,a,d,l,s,u,c,f,p,v,h,m,b,w=this;return this.opt=e,this.root=o="string"==typeof e.root?document.querySelector(e.root):e.root,this.evtHandler={},this.node={src:ld$.find(o,"[ld=blocksrc]",0),list:ld$.find(o,"[ld=form-list]",0),answer:ld$.find(o,"[ld=form-answer]",0)},this.viewMode=a=e.viewMode,this.obj=d={list:[],value:{answer:{}}},this.brd=e.brd,this.prj=e.prj,this.viewMode&&e.form&&(this.obj.list=(e.form||(e.form={})).list,this.obj.purpose=e.form.purpose,l={name:"form-short-answer",title:"提案名稱",key:"title",config:{required:!0}},s={name:"form-long-answer",title:"提案簡介",key:"description",config:{required:!0}},d.purpose.description||(this.obj.list=[s].concat(this.obj.list)),d.purpose.title||(this.obj.list=[l].concat(this.obj.list))),u={view:!1},this.hub=c={updateDeb:debounce(200,function(e){return c.update()}),update:function(e){var t,r,i;try{return a&&e?(d.value.answer[e.key]=e.value,t=(r=d.value).info||(r.info={}),t.title=(d.value.answer[(d.purpose||(d.purpose={})).title||"title"]||{}).content,t.description=(d.value.answer[(d.purpose||(d.purpose={})).description||"description"]||{}).content,t.category=((d.value.answer[(d.purpose||(d.purpose={})).category||"category"]||{}).list||[])[0],t.tag=(d.value.answer[(d.purpose||(d.purpose={})).tag||"tag"]||{}).list,w.opsOut(function(){return d.value}),w.validate(e)):w.opsOut(function(){return{list:w.obj.list,purpose:w.obj.purpose}})}catch(e){return i=e,console.log(i),n.get("not-sync")}},renderDeb:debounce(200,function(){return c.render()}),render:function(){if(p.render(),h)return h.render()},move:function(e,n){var t;if(!((t=d.list.indexOf(e))+n<0||t+n>=d.list.length))return d.list.splice(t,1),d.list.splice(t+n,0,e),this.update(),this.render()},delete:function(e){return d.list.splice(d.list.indexOf(e),1),this.update(),this.render()},clone:function(e){var n;return n=JSON.parse(JSON.stringify(e)),n.key=suuid(),d.list.splice(d.list.indexOf(e),0,n),this.update(),this.render()}},f={get:function(e){return new Promise(function(n,t){var r,i;return(r=ld$.find(o,"[ld=form-sample] [data-name="+e+"]",0))||t(new Error("block not found")),(i=ld$.create({name:"div",attr:{draggable:!0}})).appendChild(r.cloneNode(!0)),n(i)})}},this.validateAll=debounce(function(e){if(d.list.map(function(n){var t;return t=e||!(!n.value||!n.value.content&&!n.value.list),n.valid=i.validate(n,t)}),p.render(),h)return h.render()}),this.validate=debounce(function(e){if(e.valid=i.validate(e),p.render(),h)return h.render()}),p=new ldView({root:this.node.list,handler:{block:{key:function(e){return e.key},list:function(){return d.list},init:function(e){e.node,e.data},handler:function(e){var n,t;return n=e.node,t=e.data,(n.block?Promise.resolve():f.get(t.name).then(function(e){return(e=e.childNodes[0]).parentNode.removeChild(e),n.setAttribute("id","block-"+t.key),n.innerHTML="",n.appendChild(e),n.block=new r({root:n,data:t,viewMode:a,hub:c,form:d,prj:w.prj})})).then(function(){if(n.block)return n.block.setData(t),n.block.render()})}}}}),this.node.src&&new ldView({root:this.node.src,action:{dragstart:{block:function(e){var n;return n=e.node,e.evt.dataTransfer.setData("text/plain",n.getAttribute("data-name")+"")}}}}),new reblock({name:"form",root:this.node.list,blockManager:f,action:{afterInject:function(e){var n,r,i,o,a,l,s,u,f;return n=e.node,r=e.name,i=t.schema,o={key:suuid(),name:r,title:"問題的標題",desc:"一些關於這個問題的簡單描述、說明或介紹",config:{required:!0},criteria:[{enabled:!0,type:"number",op:"between"}]},(a=i.support[r][0])?(l=function(){var e=[];for(s in i.ops[i.types[a].ops]||{})e.push(s);return e}()[0],(u=o.criteria[0]).type=a,u.op=l):o.criteria=[],n._data=o,f=Array.from(n.parentNode).indexOf(n),(d.list||(d.list=[])).splice(f,0,o),p.bindEachNode({name:"block",container:n.parentNode,node:n}),p.render(),c.update()},afterMoveNode:function(e){var n,t,r,i,o;if(n=e.src,e.des,t=e.ib,n.parentNode.hasAttribute("hostable")){for(r=n.parentNode;r&&!r._data;)r=r.parentNode;return r?(r._data.data=Array.from(n.parentNode.childNodes).filter(function(e){return 1===e.nodeType}).map(function(e){return e._data}).filter(function(e){return e&&!e.other}),"form-checkpoint"===r._data.name&&(((o=r._data).value||(o.value={})).list=r._data.data),r.view.module&&r.view.module.render(),c.update()):(i=d.list.indexOf(n._data),d.list.splice(i,1),t=t?d.list.indexOf(t._data):d.list.length,d.list.splice(t,0,n._data),c.updateDeb(),void c.render())}}}}),a&&(v=function(){var e,n,t,r;return e=d.list.filter(function(e){return(e.valid||(e.valid={})).result||!(e.value&&e.value.content&&e.value.list)&&!e.config.required}).length,n=d.list.length,t=e/d.list.length,r=n-e,{remain:r,done:e,total:n,percent:t}},h=new ldView({root:o,initRender:!1,action:{input:{history:function(){return n.toggle("prj-diff")}},click:{viewing:function(){return u.view=!u.view,h.render(),b.render()},invalid:function(){var e,n;if(w.validateAll(!0),(e=d.list.filter(function(e){return e.valid&&!e.valid.result})[0])&&e)return(n=ld$.find(w.node.list,"#block-"+e.key,0))?ldui.scrollTo({node:n,jump:!0}):void 0},submit:function(e){if(!e.node.classList.contains("disabled"))return w.fire("submit",w.obj.value)}}},handler:{nview:function(e){return e.node.classList.toggle("d-none",u.view)},view:function(e){return e.node.classList.toggle("d-none",!u.view)},progress:function(e){var n;return n=e.node,n.style.width=100*v().percent+"%"},invalid:function(e){return e.node.classList.toggle("d-none",0===v().remain)},valid:function(e){return e.node.classList.toggle("d-none",v().remain>0)},remain:function(e){var n;return n=e.node,n.innerText=v().remain},"to-fix":function(e){return e.node.classList.toggle("d-none",!v().remain)},"to-publish":function(e){var n,t;return n=e.node,t=JSON.stringify(w.obj.value)!==JSON.stringify(w.prj.detail),n.classList.toggle("d-none",!t||v().remain)},submit:function(e){return e.node.classList.toggle("disabled",v().remain>0)},"brd-name":function(n){var t;return t=n.node,t.innerText=e.brd?e.brd.name||"":"未定的活動"},"grp-name":function(n){var t,r;return t=n.node,t.innerText=e.grp?((r=e.grp).info||(r.info={})).name||"":"未定的分組"},"owner-avatar":function(e){var n;return n=e.node,ld$.find(n,"div",0).style.backgroundImage="url(/dash/s/avatar/"+w.prj.owner+".png)"},"owner-name":function(e){var n;return n=e.node,n.innerText=w.prj.ownername}}}),m={"form-checkpoint":function(e){var n,t,r;return n=e.node,t=e.data,e.block,r=(t.list||[]).map(function(e){return'<div class="item">\n<div class="title">'+e.title+"</div>\n<p>"+e.desc+"</p>\n</div>"}).join(""),n.innerHTML='<div class="timeline-list">'+r+"</div>"},"form-radio":function(e){var n,t;return n=e.node,t=e.data,n.innerText=(t.list||[]).concat(t.other?[t.otherValue||""]:[]).join(", ")},"form-checkbox":function(e){var n,t;return n=e.node,t=e.data,n.innerText=(t.list||[]).concat(t.other?[t.otherValue||""]:[]).join(", ")},"form-long-answer":function(e){var n,t;return n=e.node,t=e.data,n.innerHTML=DOMPurify.sanitize(marked(t.content||""))}},b=new ldView({root:this.node.answer,handler:{answer:{list:function(){return d.list},handler:function(e){var n,t;return n=e.node,t=e.data,n.view?n.view.render():n.view=new ldView({root:n,handler:{title:function(e){var n;return n=e.node,n.innerText=t.title||""},desc:function(e){var n;return n=e.node,n.innerText=t.desc||""},content:function(e){var n;return n=e.node,m[t.name]?m[t.name]({node:n,block:t,data:d.value.answer[t.key]||{}}):n.innerText=(d.value.answer[t.key]||{}).content||""}}})}}}}),new ldView({root:"[ld-scope=prj-diff] .card-body",handler:{diffs:{list:function(){return d.list.map(function(e){return{old:{},cur:e.value,block:e}})},handler:function(e){var n,t;return n=e.node,t=e.data,n.view?n.view.render():n.view=new ldView({root:n,handler:{title:function(e){var n;return n=e.node,n.innerText=t.block.title||""},desc:function(e){var n;return n=e.node,n.innerText=t.block.desc||""},row:function(e){var n,r,i,o,a,d,l;return n=e.node,r=[t.old||{},t.cur||{}].map(function(e){return suuid()}),i=r[0],o=r[1],a=Diff.diffChars(o,i),d={old:"",cur:""},l=ld$.find(n,".value"),a.map(function(e){var n;if(n=e.added?"text-added":e.removed?"text-removed":"",!e.removed)return d.old+="<span class='"+n+"'>"+e.value+"</span>"}),(a=Diff.diffChars(i,o)).map(function(e){var n;if(n=e.added?"text-removed":e.removed?"text-added":"",!e.removed)return d.cur+="<span class='"+n+"'>"+e.value+"</span>"}),l[0].innerHTML=DOMPurify.sanitize(d.old),l[1].innerHTML=DOMPurify.sanitize(d.cur)}}})}}}})),this},a.prototype=import$(import$(Object.create(Object.prototype),o.interface),{on:function(e,n){var t;return((t=this.evtHandler)[e]||(t[e]=[])).push(n)},fire:function(e){var n,t,r,i,o,a=[];for(n=slice$.call(arguments,1),t=0,i=(r=this.evtHandler[e]||[]).length;t<i;++t)o=r[t],a.push(o.apply(this,n));return a},opsIn:function(e){var n;if(n=e.data,e.ops,!e.source)return n=JSON.parse(JSON.stringify(n||{})),this.viewMode?(this.obj.value=n,this.obj.list.map(function(e){return e.value=(n.answer||(n.answer={}))[e.key]}),this.validateAll()):(this.obj.list=n.list||[],this.obj.purpose=n.purpose||{}),this.hub.renderDeb()},render:function(){return this.hub.render()}}),a});