// Generated by LiveScript 1.3.0
ldc.register('prjFormValidation', ['prjFormCriteria'], function(arg$){
  var prjFormCriteria, validator;
  prjFormCriteria = arg$.prjFormCriteria;
  validator = {
    number: {
      type: function(v, i, j){
        return !(isNaN(v) || (i != null && isNaN(i)) || (j != null && isNaN(j)));
      },
      convert: function(v, i, j){
        return [+v, +(i || 0), +(j || 0)];
      },
      gte: function(v, i){
        return v >= i;
      },
      lte: function(v, i){
        return v <= i;
      },
      ge: function(v, i){
        return v > i;
      },
      le: function(v, i){
        return v < i;
      },
      eq: function(v, i){
        return v === i;
      },
      ne: function(v, i){
        return v !== i;
      },
      between: function(v, i, j){
        return v >= i && v <= j;
      }
    },
    string: {
      type: function(v, i){
        return v != null && i != null;
      },
      convert: function(v, i){
        return [v + "", i + ""];
      },
      include: function(v, i){
        return ~v.indexOf(i);
      },
      exclude: function(v, i){
        return !~v.indexOf(i);
      },
      email: function(v, i){
        return /^[-a-z0-9~!$%^&*_=+}{\'?]+(\.[-a-z0-9~!$%^&*_=+}{\'?]+)*@([a-z0-9_][-a-z0-9_]*(\.[-a-z0-9_]+)*\.[a-z]{2,}|([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}))(:[0-9]{1,5})?$/i.exec(v);
      },
      url: function(v, i){
        return /^\s*http(s):\/\/[a-zA-Z0-9-]+/.exec(v);
      }
    },
    count: {
      type: function(v, i, j){
        return v != null && i != null && j != null;
      },
      convert: function(v, i, j){
        var len;
        len = Array.isArray(v)
          ? v.length
          : v != null ? v.length || (v + "").length : 0;
        return [len, +(i || 0), +(j || 0)];
      },
      gte: function(v, i){
        return v >= i;
      },
      lte: function(v, i){
        return v <= i;
      },
      eq: function(v, i){
        return v === i;
      },
      between: function(v, i, j){
        return v >= i && v <= j;
      }
    },
    regex: {
      match: function(v, i){
        return new RegExp(i).exec(v);
      },
      "not-match": function(v, i){
        return !new RegExp(i).exec(v);
      }
    },
    smaller: {
      type: function(v, i, j){
        return !(isNaN(v) || (i != null && isNaN(i)) || (j != null && isNaN(j)));
      },
      convert: function(v, i, j){
        return [+v, +(i || 0), +(j || 0)];
      },
      le: function(v, i){
        return v < i;
      }
    }
  };
  return {
    validate: function(block, force){
      var ref$, value, config, isEmpty, data, i$, len$, c, type, vtr, ref1$, v, i, j;
      force == null && (force = false);
      ref$ = [block.value || (block.value = {}), block.config || (block.config = {}), false], value = ref$[0], config = ref$[1], isEmpty = ref$[2];
      if (block.name === 'form-checkpoint') {
        data = value.list || (value.list = []);
        isEmpty = !data.length || data.filter(function(it){
          return it.title && it.desc && it.date;
        }).length !== data.length;
      } else if (block.name === 'form-datetime') {
        data = value;
        isEmpty = !(value.start && (!config.rangeEnabled || value.end));
      } else if ((ref$ = block.name) === 'form-checkbox' || ref$ === 'form-radio') {
        data = (value.list || []).concat(value.other
          ? [value.otherValue]
          : []);
        isEmpty = !data.filter(function(it){
          return it;
        }).length;
      } else if (value.content) {
        data = value.content;
        isEmpty = !data;
      } else if (value.list) {
        data = value.list;
        isEmpty = !(data && data.length);
      } else {
        ref$ = [null, true], data = ref$[0], isEmpty = ref$[1];
      }
      if (isEmpty && ((config.required && block.touched) || force)) {
        return {
          result: false,
          criteria: {
            invalid: "此為必填項目"
          }
        };
      }
      if (isEmpty) {
        return {};
      } else {
        block.touched = true;
      }
      for (i$ = 0, len$ = (ref$ = block.criteria || []).length; i$ < len$; ++i$) {
        c = ref$[i$];
        if (!c.enabled) {
          continue;
        }
        type = prjFormCriteria.schema.types[c.type];
        if (!(c.type && type)) {
          continue;
        }
        vtr = validator[type.ops];
        if (!vtr[c.op]) {
          continue;
        }
        ref1$ = vtr.convert(data, c.input1, c.input2), v = ref1$[0], i = ref1$[1], j = ref1$[2];
        if (!(vtr.type(v, i, j) && vtr[c.op](v, i, j))) {
          return {
            result: false,
            criteria: c
          };
        }
      }
      return {
        result: true
      };
    }
  };
});