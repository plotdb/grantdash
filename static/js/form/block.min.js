function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}ldc.register("prjFormBlock",["ldcvmgr","error","prjFormCriteria"],function(e){var t,n,r,i,o,a,l,u,c,d,s;return e.ldcvmgr,t=e.error,n=e.prjFormCriteria,r=n.schema,i=function(e,t){if(e.innerText!==t)return e.innerText=t},o={},a={moduleInit:function(){var e=this;if(this.viewing)return this.view.module=new ldView({context:{},root:this.root,init:{"input-file":function(n){var r,i,o,a;return r=n.node,i=n.local,o=n.context,"form-thumbnail"===e.block.name&&r.setAttribute("accept","image/*"),o.loading=!1,i.ldf=a=new ldFile({root:r}),a.on("load",function(n){var i,a,l,u;if("form-thubmnail"===e.block.name&&(n=n.filter(function(e){return/^image\//.exec(e.type)&&/\.(gif|png|jpg|jpeg)$/.exec(e.name)})),r.value="",n.length){if(i=new FormData,"form-thumbnail"===e.block.name)i.append("thumb[]",n[0].file),i.append("files",JSON.stringify([{name:"thumb",type:"thumb"}]));else{for(a=0,l=n.length;a<l;++a)u=a,i.append("file[]",n[u].file);i.append("files",JSON.stringify([{name:"file",type:"form"}]))}return i.append("prj",e.prj.slug),o.loading=!0,e.view.module.render(),ld$.xhr("/dash/api/upload",{method:"POST",body:i},{type:"json",progress:function(t){var n;return n=t.percent,o.percent=n,e.view.module.render()}}).then(function(t){var r,i;if(t[0])return r=t[0].files||[],((i=e.block).value||(i.value={})).list=n.map(function(e,t){var n,i;return i={key:t,path:r[t]},i.name=(n=e.file).name,i.size=n.size,i.type=n.type,i}),e.update()}).finally(function(){return debounce(1e3).then(function(){return o.loading=!1,e.view.module.render()})}).catch(t())}})}},handler:{loading:function(e){var t;return t=e.context,e.node.classList.toggle("d-none",!t.loading)},bar:function(e){var t,n;return t=e.context,n=e.node,n.style.width=100*(t.percent||0)+"%"},"bar-label":function(e){var t,n;return t=e.context,n=e.node,n.innerText=100*(t.percent||0)+"%"},file:{list:function(){var t,n;return(t=(n=e.block).value||(n.value={})).list||(t.list=[])},init:function(e){var t,n,r;return t=e.node,n=e.data,r=e.local,t.classList.toggle("d-none",!1),r.view=new ldView({context:n,root:t,handler:{name:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.name},type:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.type},size:function(e){var t,r;return t=e.node,e.context,r=Math.round(10*n.size/1048576)/10,t.innerText=r+"MB"}}})},handler:function(e){return e.node,e.data,e.local.view.render()}}}})}},import$(o,{"form-file":a,"form-thumbnail":a}),l={moduleInit:function(){var e,t,n=this;return"form-checkpoint"===this.block.name&&this.viewing&&(((e=this.block).value||(e.value={})).list?this.block.data=this.block.value.list:((e=this.block).value||(e.value={})).list=(e=this.block).data||(e.data=[]),ld$.find(this.root,".timeline-list",0).addEventListener("input",function(){var e;return((e=n.block).value||(e.value={})).list=n.block.data,n.update()})),this.view.module=t=new ldView({root:this.root,action:{click:{"list-add":function(){var e;return((e=n.block).data||(e.data=[])).push({title:"新項目",desc:"關於這個項目的描述 ... ",key:suuid()}),n.update(),n.render()}}},handler:{list:{key:function(e){return e.key},list:function(){var e,t;return e=n.block.data||[],!((t=n.block).config||(t.config={})).otherEnabled&&n.viewing||(e=e.concat([{other:!0,key:"other"}])),e},init:function(e){var t,r;if(t=e.node,r=e.data,!t.hasAttribute("data-user-editable")&&n.viewing&&t.removeAttribute("draggable"),r.other&&"form-checkpoint"===n.block.name)return t.classList.add("d-none")},action:{click:this.viewing?function(e){var r,i,o,a,l,u,c;if(e.node,r=e.data,i=e.evt,"form-checkpoint"!==n.block.name&&"INPUT"!==i.target.nodeName)return o="form-radio"===n.block.name,a=(l=n.block).value||(l.value={}),r.other?(u=!!o||!a.other,a.other=u,u&&o&&(a.list=[])):(c=a.list||[],u=!!o||!in$(r.title,c),o&&(c=[]),u?(c.push(r.title),o&&(a.other=!1)):c.splice(c.indexOf(r.title),1),a.list=c),t.render(),n.update()}:function(){}},handler:function(e){var t,r,o;return t=e.node,r=e.data,o=t.hasAttribute("data-user-editable"),t.view?t.view.render():t.view=new ldView({root:t,init:{data:function(e){var t;if((t=e.node).setAttribute("data-name",t.getAttribute("editable")),!o&&n.viewing)return t.removeAttribute("editable")}},action:{input:{"other-value":function(e){var t,r;return t=e.node,((r=n.block).value||(r.value={})).otherValue=t.value},data:function(e){var t;return t=e.node,r[t.getAttribute("data-name")]=editableInput(t),n.update()}},click:{"other-enabled":function(e){var t,r;return t=e.node,e.evt,((r=n.block).config||(r.config={})).otherEnabled=!((r=n.block).config||(r.config={})).otherEnabled,t.classList.toggle("on",((r=n.block).config||(r.config={})).otherEnabled),n.update(),n.render()},delete:function(e){var t;return e.node,t=e.evt,n.block.data.splice(n.block.data.indexOf(r),1),n.update(),n.render(),t.stopPropagation()}}},handler:{drag:function(e){return e.node.classList.toggle("invisible",!!(n.viewing&&!o||r.other))},state:function(e){var t,i,o,a;return t=e.node,i=(o=n.block).value||(o.value={}),a=r.other&&i.other||!r.other&&in$(r.title,i.list||(i.list=[])),t.classList.toggle("active",a)},"other-value":function(e){var t,r;return t=e.node,t.value=((r=n.block).value||(r.value={})).otherValue||"",((r=n.block).config||(r.config={})).otherEnabled?t.removeAttribute("readonly"):t.setAttribute("readonly","")},delete:function(e){return e.node.classList.toggle("d-none",!!(n.viewing&&!o||r.other))},"other-enabled":function(e){var t,i;return(t=e.node).classList.toggle("d-none",n.viewing||!r.other),t.classList.toggle("on",((i=n.block).config||(i.config={})).otherEnabled)},other:function(e){return e.node.classList.toggle("d-none",!r.other)},data:function(e){var t;return t=e.node,r.other&&(t.removeAttribute("editable"),t.classList.toggle("flex-grow-1",!1)),i(t,(r.other?"其它":r[t.getAttribute("data-name")])||"")}}})}}}})}},import$(o,{"form-radio":l,"form-checkbox":l,"form-checkpoint":l}),u={moduleInit:function(){var e,t=this;return this.view.module=e=new ldView({root:this.root,action:{input:{"use-markdown":function(n){var r,i;return r=n.node,((i=t.block).value||(i.value={})).useMarkdown=r.checked,t.update(),e.render()},"input-field":function(e){var n,r;return n=e.node,((r=t.block).value||(r.value={})).content=n.value,t.update()},"toggle-preview":function(n){var r;return r=n.node,t.preview=!!r.checked,e.render()}}},handler:{"input-field":function(e){var n,r;return n=e.node,n.value=((r=t.block).value||(r.value={})).content||""},"preview-panel":function(e){var n,r;if((n=e.node).classList.toggle("d-none",!t.preview),t.preview)return n.innerHTML=DOMPurify.sanitize(marked(((r=t.block).value||(r.value={})).content||""))},"edit-panel":function(e){return e.node.classList.toggle("d-none",!!t.preview)},"if-markdown":function(e){var n;return e.node.classList.toggle("d-none",!((n=t.block).value||(n.value={})).useMarkdown)}}})}},import$(o,{"form-long-answer":u,"form-short-answer":u}),o["form-tag"]={moduleInit:function(){var e=this;return this.view.module=new ldView({root:this.root,action:{change:{"input-field":function(t){var n,r;return t.node,n=t.local,((r=e.block).value||(r.value={})).list=n.tagify.value.map(function(e){return e.value}),e.update()}}},init:{"input-field":function(t){var n,r,i;return n=t.node,r=t.local,r.tagify=new Tagify(n,{delimiters:/[,.:;，。：； ]/}),r.tagify.addTags(((i=e.block).value||(i.value={})).list||[])}}})}},c={title:["form-short-answer"],description:["form-short-answer","form-long-answer"],thumb:["form-thumbnail"],category:["form-radio"],tag:["form-tag"]},d=function(e,t){return in$(t,c[e])},s=function(e){var t,n=this;return this.opt=e,this.viewing=e.viewMode,this.root=t="string"==typeof e.root?document.querySelector(e.root):e.root,this.hub=e.hub,this.prj=e.prj,this.view=this.root.view={},this.block=e.data,this.form=e.form||{},this.view.block=new ldView({root:t,action:{input:{title:function(e){var t;return t=e.node,e.evt,n.block.title=editableInput(t),n.update()},desc:function(e){var t;return t=e.node,e.evt,n.block.desc=editableInput(t),n.update()}},click:{switch:function(e){var t,r;return t=e.node,e.evt,t.classList.toggle("on"),((r=n.block).config||(r.config={}))[t.getAttribute("data-name")]=t.classList.contains("on"),n.update()},delete:function(e){return e.node,e.evt,n.delete()},clone:function(e){return e.node,e.evt,n.clone()},"move-up":function(){return n.move(-1)},"move-down":function(){return n.move(1)},purpose:function(e){var t,r,i,o,a;if(t=e.node,r=t.getAttribute("data-name"),d(r,n.block.name)){if(((i=n.form).purpose||(i.purpose={}))[r]=o=((i=n.form).purpose||(i.purpose={}))[r]===n.block.key?null:n.block.key,o)for(a in n.form.purpose)a!==r&&n.form.purpose[a]===o&&(n.form.purpose[a]=null);return n.update(),n.view.block.render()}}}},init:{"purpose-menu":function(e){var t;return t=e.node,new Dropdown(t)}},handler:{"purpose-menu":function(e){var t,r,i,o,a,l;return t=e.node,r={title:"標題",description:"簡介",thumb:"縮圖",category:"分類",tag:"標籤"},i=function(){var e,t,n=[];for(o in e=(t=this.form).purpose||(t.purpose={}))a=e[o],n.push({k:o,v:a});return n}.call(n).filter(function(e){return e.v===n.block.key}).map(function(e){return r[e.k]}).join(" / "),l=ld$.find(t,".btn",0),l.innerText=i?i+"":"用途"},purpose:function(e){var t,r,i;return t=e.node,r=t.getAttribute("data-name"),t.classList.toggle("disabled",!d(r,n.block.name)),ld$.find(t,"i",0).classList.toggle("d-none",((i=n.form).purpose||(i.purpose={}))[r]!==n.block.key)},invalid:function(e){var t,r,o;return t=e.node,(r=!(null!=((o=n.block).valid||(o.valid={})).result)||n.block.valid.result)||i(t,n.block.valid.criteria.invalid||"這個欄位格式不符"),t.classList.toggle("d-none",r)},block:function(e){var t,r,i;return t=e.node,r=!(null!=((i=n.block).valid||(i.valid={})).result)||n.block.valid.result,t.classList.toggle("invalid",!r)},title:function(e){var t;if(t=e.node,i(t,n.block.title||""),n.viewing)return t.removeAttribute("editable")},desc:function(e){var t,r;if(t=e.node,i(t,n.block.desc||""),n.viewing&&t.removeAttribute("editable"),n.viewing&&!((r=n.block).config||(r.config={}))["show-desc"])return t.classList.add("d-none")},switch:function(e){var t,r;return(t=e.node).classList.toggle("on",!!((r=n.block).config||(r.config={}))[t.getAttribute("data-name")])},"edit-only":function(e){var t;if(t=e.node,n.viewing)return t.remove()},"list-input":function(e){return e.node.setAttribute("name","input-"+n.block.key)}}}),this.viewing||(this.view.criteria=new ldView({root:this.root,action:{click:{add:function(){var e;return((e=n.block).criteria||(e.criteria=[])).push({type:"number"}),n.view.criteria.render()}}},handler:{"has-criteria":function(e){var t;return e.node.classList.toggle("d-none",!((t=n.block).criteria||(t.criteria=[])).length)},criteria:{list:function(){var e;return(e=n.block).criteria||(e.criteria=[])},action:{click:function(e){var t,r,i,o,a;if(t=e.node,r=e.data,i=e.evt,o=e.local,a=ld$.parent(i.target,".dropdown-item",t))return a.type&&(r.type=a.type),a.op&&(r.op=a.op),n.update(),o.view.render()}},init:function(e){var t,o,a,l,u;return t=e.node,o=e.data,a=e.local,l=function(){return o.type||r.support[n.block.name][0]||"number"},u=function(){var e,t,n;return e=r.ops[r.types[l()].ops],t=function(){var r,i=[];for(n in r=e)t=r[n],i.push(t);return i}()[0],e[o.op]||t||{name:""}},ld$.find(t,".dropdown .dropdown-toggle").map(function(e){return new Dropdown(e)}),a.view=new ldView({context:o,root:t,action:{click:{enabled:function(e){var t,r;return t=e.node,r=e.context,t.classList.toggle("on"),r.enabled=t.classList.contains("on"),n.update(),a.view.render()}},input:{input1:function(e){var t,r;return t=e.node,r=e.context,r.input1=ld$.find(t,"input",0).value,n.update()},input2:function(e){var t,r;return t=e.node,r=e.context,r.input2=ld$.find(t,"input",0).value,n.update()},"input-invalid":function(e){var t,r;return t=e.node,r=e.context,r.invalid=t.value,n.update()}}},handler:{enabled:function(e){var t,n;return t=e.node,n=e.context,t.classList.toggle("on",!!n.enabled)},input1:function(e){var t,n,r;return t=e.node,n=e.context,r=ld$.find(t,"input",0),r.value=n.input1||"",n.enabled?r.removeAttribute("disabled"):r.setAttribute("disabled","")},input2:function(e){var t,n,r;return t=e.node,n=e.context,t.classList.toggle("d-none",(u().field||1)<2),r=ld$.find(t,"input",0),r.value=n.input2||"",n.enabled?r.removeAttribute("disabled"):r.setAttribute("disabled","")},"input-invalid":function(e){var t,n;return t=e.node,(n=e.context).enabled?t.removeAttribute("disabled"):t.setAttribute("disabled",""),t.value=n.invalid||""},type:function(e){var t,n;return t=e.node,n=e.context,t.classList.toggle("disabled",!n.enabled),i(t,r.types[l()].name)},op:function(e){var t,n;return t=e.node,n=e.context,t.classList.toggle("disabled",!n.enabled),t.innerHTML=u().name},types:{list:function(){return r.support[n.block.name]},handler:function(e){var t,n;return t=e.node,n=e.data,i(t,r.types[n].name),t.type=n}},ops:{list:function(){var e,t,n,i=[];for(e in t=r.ops[r.types[l()].ops])n=t[e],i.push([e,n]);return i},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerHTML=n[1].name,t.op=n[0]}}}})},handler:function(e){var t,n;return e.node,t=e.data,(n=e.local).view.setContext(t),n.view.render()}}}})),o[this.block.name]&&(this.moduleInit=o[this.block.name].moduleInit,this.moduleInit()),this},s.prototype=import$(Object.create(Object.prototype),{setData:function(e){return this.block=e},render:function(){if(this.view.block.render(),this.view.module&&this.view.module.render(),this.view.criteria)return this.view.criteria.render()},update:function(){return this.hub.update(this.block)},delete:function(){return this.hub.delete(this.block)},clone:function(){return this.hub.clone(this.block)},move:function(e){return this.hub.move(this.block,e)},schema:r}),s});