// Generated by LiveScript 1.3.0
(function(){
  ldc.register('prjForm', ['prjFormCriteria', 'prjFormBlock'], function(arg$){
    var prjFormCriteria, prjFormBlock, viewMode, bmgr, blocksView, n, reb;
    prjFormCriteria = arg$.prjFormCriteria, prjFormBlock = arg$.prjFormBlock;
    viewMode = true;
    bmgr = {
      get: function(name){
        return new Promise(function(res, rej){
          var n, div;
          n = ld$.find("[data-name=" + name + "]", 0);
          if (!n) {
            rej(new Error("block not found"));
          }
          div = ld$.create({
            name: "div",
            attr: {
              draggable: true
            }
          });
          div.appendChild(n.cloneNode(true));
          return res(div);
        });
      }
    };
    blocksView = new ldView({
      root: '#form',
      handler: {
        block: {
          list: function(){
            return sampleBlocks;
          },
          init: function(arg$){
            var node, data;
            node = arg$.node, data = arg$.data;
            return bmgr.get(data.name).then(function(n){
              n = n.childNodes[0];
              n.parentNode.removeChild(n);
              node.innerHTML = "";
              node.appendChild(n);
              prjFormBlock.render({
                node: node,
                data: data,
                viewMode: viewMode
              });
              if (!viewMode) {
                return prjFormCriteria.render({
                  node: node,
                  data: data
                });
              }
            });
          }
        }
      }
    });
    if (n = ld$.find('[ld-scope=blocksrc]', 0)) {
      new ldView({
        root: n,
        action: {
          dragstart: {
            block: function(arg$){
              var node, evt;
              node = arg$.node, evt = arg$.evt;
              return evt.dataTransfer.setData('text/plain', node.getAttribute('data-name') + "");
            }
          }
        }
      });
    }
    return reb = new reblock({
      root: '#form',
      blockManager: bmgr,
      action: {
        afterMoveNode: function(arg$){
          var src, des, ib, n;
          src = arg$.src, des = arg$.des, ib = arg$.ib;
          if (src.parentNode.hasAttribute('hostable')) {
            n = src.parentNode;
            while (n && !n._data) {
              n = n.parentNode;
            }
            if (!n) {
              return;
            }
            n._data.data = Array.from(src.parentNode.childNodes).filter(function(it){
              return it.nodeType === 1;
            }).map(function(it){
              return it._data;
            }).filter(function(it){
              return it;
            });
            return n.view.list.render();
          }
        }
      }
    });
  });
  return ldc.app('prjForm');
})();