function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}ldc.register("judgeFinalAll",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,n,r,a;return e.notify,t=e.judgeBase,n=e.error,e.loader,e.auth,r=e.ldcvmgr,e.sdbAdapter,a=function(e){var n,r,a=this;return import$(this,n=new t(e)),this.judgeBase=n,this.data={prj:{}},this.active=null,this.progress={total:1,done:0},this.cfg={heatmap:!0},r=function(e){var t,n;return t=e>=.5?255:0,n=e<.5?255:0,e=Math.abs(e-.5),"rgba("+t+","+n+",0,"+e+")"},this.ldcv={"judge-comment":new ldCover({root:ld$.find(this.root,"[ld=judge-comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)})},this.view.local=new ldView({initRender:!1,root:this.root,action:{click:{sort:function(e){var t;return t=e.node,a.sort(t.getAttribute("data-name"))},"toggle-heatmap":function(){return a.cfg.heatmap=!a.cfg.heatmap,a.view.local.render("toggle-heatmap"),a.view.local.render("project")},"download-csv":function(){var e,t,n,r,i,o;return e=a.judge.map(function(e,t){return["評審"+(t+1)+"分數","評審"+(t+1)+"排名","評審"+(t+1)+"評論"]}).reduce(function(e,t){return e.concat(t)},[]),t=["提案名稱","提案單位"].concat(e,["平均分","總排名"],a.judge.map(function(e,t){return"評審"+t+"評論"})),n=a.prjs.map(function(e){var t,n;return t=a.judge.map(function(t){return[t.score[e.key],t.rank[e.key]]}).reduce(function(e,t){return e.concat(t)},[]),n=a.judge.map(function(t){var n;return((n=a.data.user[t.key]).prj||(n.prj={}))[e.key].comment||""}),[e.name,e.info.teamname||e.ownername||""].concat(t,[e.total,e.rank],n).map(function(e){return'"'+(""+e).replace('"','\\"')+'"'}).join(",")}).join("\n"),r=t+"\n"+n,i=URL.createObjectURL(new Blob([r],{type:"text/csv"})),o=ld$.create({name:"a",attr:{href:i,download:"result.csv"}}),document.body.appendChild(o),o.click(),document.body.removeChild(o)}}},handler:{"toggle-heatmap":function(e){var t;return t=e.node,ld$.find(t,".switch",0).classList.toggle("on",!!a.cfg.heatmap)},"comment-name":function(e){var t;return t=e.node,t.innerText=a.active&&a.active.name||""},"detail-name":function(e){var t;return t=e.node,t.innerText=a.active&&a.active.name||""},"judge-comment":{list:function(){return a.active?a.judge.map(function(e){var t,n,r;return{judge:e,comment:((t=(n=a.data.user)[r=e.key]||(n[r]={})).prj||(t.prj={}))[a.active.key].comment}}).filter(function(e){return e.comment}).sort(function(e,t){return(null!=t.comment?t.comment.length:0)-(null!=e.comment?e.comment.length:0)}):[]},handler:function(e){var t,n,r,a;return t=e.node,n=e.data,r=ld$.find(t,"[ld=name]",0),a=ld$.find(t,"[ld=comment]",0),r.innerText=n.judge.name,a.innerText=n.comment}},detail:{list:function(){var e,t,n,r,i,o;if(!a.active)return[];e=[];for(t in n=((r=a.criteriaResult).data||(r.data={})).user||{})i=(r=n[t].prj)[o=a.active.key]||(r[o]={}),e.push({user:t,name:a.usermap[t].displayname,comment:i.comment||"",criteria:a.criteria.map(function(e){return{name:e.name,value:null!=(i.v||(i.v={}))[e.key]?i.v[e.key]:1}})});return e.sort(function(e,t){return(null!=t.comment?t.comment.length:0)-(null!=e.comment?e.comment.length:0)})},init:function(e){var t,n,r;return t=e.node,n=e.local,r=e.data,n.view=new ldView({root:t,context:r,text:{name:function(e){return e.context.name||"(未命名)"}},handler:{comment:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.comment||"( 沒有評論 )",t.classList.toggle("text-muted",!n.comment)},avatar:function(e){var t,n;return t=e.node,n=e.context,t.style.backgroundImage="url(/dash/s/avatar/"+n.user+".png)"},criteria:{list:function(e){return e.context.criteria},handler:function(e){var t,n,r,a;return t=e.node,n=e.data,ld$.find(t,"[ld=name]",0).innerText=n.name,r=ld$.find(t,"[ld=value]",0),a=ld$.find(r,"i",0),r.classList.remove("text-success","text-secondary","text-danger"),r.classList.add(["text-success","text-secondary","text-danger"][n.value]),a.classList.remove("i-close","i-circle","i-check"),a.classList.add(["i-check","i-circle","i-close"][n.value])}}}})}},judge:{list:function(e){return e.context,a.judge},handler:function(e){var t,n,r,i,o,c;return t=e.node,n=e.data,r=e.idx,i=((o=(c=a.grpinfo).judge||(c.judge={})).final||(o.final={})).anonymous?"評審"+(r+1):n.name,ld$.find(t,"div",0).innerText=i},action:{click:function(e){var t,n,r;if(e.node,t=e.data,(n=e.evt).target&&(r=n.target.getAttribute("data-name")))return a.sort("judge-"+r,t)}}},project:{key:function(e){return e.slug},list:function(){return a.prjs},init:function(e){var t,n,i;return t=e.node,n=e.local,i=e.data,t,t.classList.remove("d-none"),n.view=new ldView({initRender:!1,root:t,context:i,action:{click:{detail:function(e){var t;return e.node,t=e.context,a.active=t,a.view.local.render("detail"),a.ldcv.detail.toggle(),a.view.local.render("detail-name")},"judge-comment":function(e){var t;return e.node,t=e.context,a.active=t,a.view.local.render("detail-name"),a.view.local.render("judge-comment"),a.ldcv["judge-comment"].toggle()}}},handler:{"judge-comment":function(e){var t,n;return t=e.node,n=e.context,t.classList.toggle("text-primary",n.hasComment)},name:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.name,t.setAttribute("href","/dash/prj/"+n.slug)},key:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.key||""},total:function(e){var t,n,r;return t=e.node,null==(n=e.context).total?t.innerText="-":(r=Math.round(10*n.total)/10,t.innerText=r.toFixed(1),t.style.background=a.cfg.heatmap?"#fff":"#eee")},rank:function(e){var t,n;return t=e.node,n=e.context,t.innerText=null!=n.rank?n.rank:"-",t.style.background=a.cfg.heatmap?r(+(n.rank||0)/(a.prjs.length||1)):"#eee"},criteria:function(e){var t,n,r;return t=e.node,n=e.context,r=t.getAttribute("data-name"),t.innerText=({0:"+",2:"-"}[r]||"")+(n.criteria||(n.criteria={}))[r]},judge:{key:function(e){return e.key},list:function(e){return e.context,a.judge},init:function(e){e.local,e.node,e.context,e.data},handler:function(e){var t,n,i,o,c;return t=e.node,n=e.context,i=e.data,o=ld$.find(t,"[ld=score]",0),c=ld$.find(t,"[ld=rank]",0),o.innerText=i.score[n.key]||0,c.innerText=i.rank[n.key]||0,c.style.background=a.cfg.heatmap?r(+(i.rank[n.key]||0)/(a.prjs.length||1)):"#fff"}}}})},handler:function(e){var t,n;return e.node,t=e.local,n=e.data,t.view.setContext(n),t.view.render()}}}}),this},a.prototype=import$(import$({},t.prototype),{opsIn:function(e){var t,n;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.rerank(),this.view.base.render(),this.view.local.render()},reconnect:function(){var e=this;return this.getdoc().then(function(){return e.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var e=this;return Promise.resolve().then(function(){return e.auth()}).then(function(){return e.initView()}).then(function(){return e.fetchInfo()}).then(function(){var t,n;return e.judge=(t=(n=e.grpinfo).judgePerm||(n.judgePerm={})).list||(t.list=[])}).then(function(){return e.grpinfo.grade?e.grade=e.grpinfo.grade.entries:r.get("judge-grade-missing")}).then(function(){return e.fetchPrjs()}).then(function(){return e.fetchCriteriaResult()}).then(function(){return e.sharedb()}).then(function(){return e.reconnect()}).catch(function(e){return 1012===ldError.id(e)||"forbidden"===e.message?r.toggle("access-denied"):n()(e)})},fetchCriteriaResult:function(){var e=this;return ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/judge/criteria/result",{method:"GET"},{type:"json"}).then(function(t){var n,r;return null==t&&(t={}),e.criteriaResult=t.data,e.getDisplayname(function(){var e=[];for(n in this.criteriaResult.data.user)e.push(n);return e}.call(e)),r=e.criteriaResult.data.user,e.prjs.map(function(t){var n,a,i,o=[];t.criteria={0:0,1:0,2:0};for(n in a=r)i=a[n],o.push(e.criteria.map(function(e){var n,r,a,o;return null==(n=((r=(a=i.prj||(i.prj={}))[o=t.key]||(a[o]={})).v||(r.v={}))[e.key])&&(n=1),t.criteria[n]++}));return o})})},rerank:function(){var e,t,n=this;if(this.prjs)return this.prjs.map(function(e){return e.hasComment=!!n.judge.filter(function(t){var r,a,i,o,c,u;return((r=(i=(o=(u=n.data).user||(u.user={}))[c=t.key]||(o[c]={})).prj||(i.prj={}))[a=e.key]||(r[a]={})).comment}).length}),this.judge.map(function(e,t){var r,a,i;return r=n.data.user[e.key]||{},e.score={},e.rank={},a=n.prjs.map(function(t,a){var i,o,c;return(i=r.prj||(r.prj={}))[o=t.key]||(i[o]={}),c=n.grade.reduce(function(e,n){var a,i,o;return+(((a=(i=r.prj||(r.prj={}))[o=t.key]||(i[o]={})).v||(a.v={}))[n.key]||0)+e},0),e.score[t.key]=c,[t.key,c]}),i={},a.sort(function(e,t){return t[1]-e[1]}),a.map(function(t,n){return i.value!==t[1]&&(i.value=t[1],i.rank=n+1),e.rank[t[0]]=i.rank})}),(e=this.prjs.map(function(e,t){return e.total=n.judge.reduce(function(t,n){return+(n.score[e.key]||0)+t},0)/n.judge.length,[e,e.total]})).sort(function(e,t){return t[1]-e[1]}),t={},e.map(function(e,n){return t.value!==e[1]&&(t.value=e[1],t.rank=n+1),e[0].rank=t.rank})}}),new a({root:document.body}).init()});