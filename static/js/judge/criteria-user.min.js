function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}ldc.register("judgeCriteriaUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,n,r,i,a,o,c,u;return t=e.notify,n=e.judgeBase,r=e.error,i=e.loader,e.auth,e.ldcvmgr,e.sdbAdapter,a=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],o=function(e,t){var n,r;return n=a[t],(r=Array.from(e.classList)).length&&e.classList.remove.apply(e.classList,r),e.classList.add.apply(e.classList,n)},c=function(e){var t,r=this;return import$(this,new n(e)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},this.view=t=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(e){var t,n,i;if(t=e.node,r.active)return((n=r.data.prj)[i=r.active.slug]||(n[i]={})).comment=t.value,r.update({debounced:300}),r.view.render({name:"project",key:r.active.slug})}},click:{detail:function(e){return e.node,r.ldcv.detail.toggle()},criteria:function(e){return e.node,r.ldcv.criteria.toggle()},sort:function(e){var t;return t=e.node,r.sort(t.getAttribute("data-name"))}}},text:{count:function(e){var t;return t=e.node,r.progress[t.getAttribute("data-name")]||0},reviewer:function(e){if(e.node,r.user)return r.user.displayname}},handler:{"comment-name":function(e){var t;if(t=e.node,r.active)return t.innerText=r.active.name||""},progress:function(e){var t,n,i,a;return t=e.node,n=e.names,i=r.progress,in$("progress-bar",n)?(a=t.getAttribute("data-name"),t.style.width=100*i[a]/i.total+"%"):in$("progress-percent",n)?t.innerText=Math.round(100*i.done/i.total):void 0},"header-criteria":{list:function(){return r.criteria},action:{click:function(e){var t;return e.node,t=e.data,r.sort("criteria",t.name)}},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.name}},project:{key:function(e){return e.slug},list:function(){return r.prjs},init:function(e){var n,i,a,c;return n=e.node,i=e.local,a=e.data,c=n,n.classList.remove("d-none"),i.view=new ldView({initRender:!1,root:n,context:a,action:{click:{detail:function(e){return e.node,e.context,r.ldcv.detail.toggle()},comment:function(e){var n,i,a;return e.node,n=e.context,r.active=n,t.get("comment").value=((i=r.data.prj)[a=r.active.slug]||(i[a]={})).comment||"",r.ldcv.comment.toggle(),r.view.render("comment-name")},name:function(e){var n;return e.node,n=e.context,t.get("iframe").setAttribute("src","/prj/"+n.slug+"?simple"),t.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=c,this.activeNode.classList.add("active")}}},text:{"count-accept":function(e){var t;return e.node,((t=e.context).reviewCount?t.reviewCount[0]:0)||0},"count-todo":function(e){var t;return e.node,((t=e.context).reviewCount?t.reviewCount[1]:0)||0},"count-reject":function(e){var t;return e.node,((t=e.context).reviewCount?t.reviewCount[2]:0)||0}},handler:{"has-comment":function(e){var t,n,i,a;return t=e.node,n=e.context,t.classList.toggle("invisible",!((i=r.data.prj)[a=n.slug]||(i[a]={})).comment)},state:function(e){var t,n;return t=e.node,n=e.context,o(t,r.getState(n))},name:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.name},key:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.key||""},criteria:{list:function(e){return e.context,r.criteria},init:function(e){var t,n;return t=e.node,n=e.local,n.icon=ld$.find(t,"i",0)},action:{click:function(e){var t,n,a,o,c,u;return e.node,t=e.data,n=e.context,a=((o=(c=r.data.prj)[u=n.slug]||(c[u]={})).value||(o.value={}))[t.name],a=null!=a?a:1,a=(a+2)%3,((o=r.data.prj)[u=n.slug]||(o[u]={})).value[t.name]=a,r.getProgress(),i.view.render(),r.view.render("progress"),r.update({debounced:10})}},handler:function(e){var t,n,i,a,c,u,s;return t=e.local,n=e.data,i=e.context,a=((c=(u=r.data.prj)[s=i.slug]||(u[s]={})).value||(c.value={}))[n.name],a=null!=a?a:1,o(t.icon,a)}}}})},handler:function(e){var t,n;return e.node,t=e.local,n=e.data,t.view.setContext(n),t.view.render()}}}}),this},c.prototype=import$(import$({},n.prototype),{opsIn:function(e){var t,n;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.getProgress(),this.view.render()},fetchCriteria:function(){return console.log("fetch criteria ... "),this.criteria=[{name:"開源",key:1},{name:"協作",key:2},{name:"參與",key:3}]},init:function(){var e=this;return Promise.resolve().then(function(){return u.auth()}).then(function(){return u.fetchCriteria()}).then(function(){return u.fetchPrjs()}).then(function(){return u.sharedb()}).then(function(){return u.getdoc()}).then(function(){return e.sort("name",null,!1)}).then(function(){return console.log("initied.")}).catch(r)},sort:function(e,n,r){var a,o,c,u=this;return null==r&&(r=!0),r&&i.on(),a=e+""+(null!=n?"-"+n:""),this.sort.inversed||(this.sort.inversed={}),o=this.sort.inversed[a]?1:-1,c={name:n||{name:"名稱",state:"狀態",comment:"評論長度"}[e],dir:o>0?"順向":"逆向"},r&&t.send("success","重新將表格依 "+c.name+" 做 "+c.dir+" 排序"),debounce(100).then(function(){var t;return u.sort.inversed[a]=!u.sort.inversed[a],t=[2,0,1],"state"===e?u.prjs.sort(function(e,n){return o*(t[u.getState(e)]-t[u.getState(n)])}):"name"===e?u.prjs.sort(function(e,t){return o*(e.name>t.name?1:e.name<t.name?-1:0)}):"comment"===e?u.prjs.sort(function(e,t){var n,r;return o*((((n=u.data.prj)[r=e.slug]||(n[r]={})).comment||"").length-(((n=u.data.prj)[r=t.slug]||(n[r]={})).comment||"").length)}):"criteria"===e&&u.prjs.sort(function(e,r){var i,a,c;return e=((i=(a=u.data.prj)[c=e.slug]||(a[c]={})).value||(i.value={}))[n],r=((i=(a=u.data.prj)[c=r.slug]||(a[c]={})).value||(i.value={}))[n],e=null!=e?e:1,r=null!=r?r:1,o*(t[e]-t[r])}),r&&i.off(),u.render()})},getState:function(e){var t=this;return this.criteria.reduce(function(n,r){var i,a,o,c;return i=((a=(o=t.data.prj)[c=e.slug]||(o[c]={})).value||(a.value={}))[r.name],Math.max(n,null!=i?i:1)},0)},getProgress:function(){var e,t=this;return e={0:0,1:0,2:0},this.prjs.map(function(n){var r;return r=t.criteria.reduce(function(e,r){var i,a,o,c;return i=((a=(o=t.data.prj)[c=n.slug]||(o[c]={})).value||(a.value={}))[r.name],Math.max(e,null!=i?i:1)},0),e[r]++}),this.progress={accept:e[0],pending:e[1],reject:e[2],done:e[0]+e[2],total:this.prjs.length||1}}}),(u=new c({root:document.body})).init()});