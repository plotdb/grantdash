function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}ldc.register("judgeCriteriaUser",["error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,n,r,o,i,a,u;return e.error,t=e.loader,n=e.auth,r=e.ldcvmgr,o=e.sdbAdapter,i=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],a=function(e,t){var n,r;return n=i[t],(r=Array.from(e.classList)).length&&e.classList.remove.apply(e.classList,r),e.classList.add.apply(e.classList,n)},u=function(e){var n,r,o=this;return this.loader=t,this.brd=e.brd,this.grp=e.grp,this.root=n="string"==typeof e.root?document.querySelector(e.root):e.root,this.prjs=[],this.data={},this.progress={},this.user=e.user,this.forAll=!e.user,this.criteria=[{name:"開源",key:1},{name:"協作",key:2},{name:"參與",key:3}],this._update=debounce(function(){if(o.user)return o.opsOut(function(){return o.data})}),this.ldcv={comment:new ldCover({root:ld$.find(n,"[ld=comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(n,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(n,"[ld=criteria-ldcv]",0)})},this.view=r=new ldView({root:n,action:{input:{comment:function(e){var t,n,r;if(t=e.node,o.active)return((n=o.data)[r=o.active.slug]||(n[r]={})).comment=t.value,o.update({debounced:!0})}},click:{detail:function(e){return e.node,o.ldcv.detail.toggle()},criteria:function(e){return e.node,o.ldcv.criteria.toggle()}}},text:{"count-total":function(e){return e.node,o.prjs.length||0},"count-accept":function(e){return e.node,o.progress[0]||0},"count-reject":function(e){return e.node,o.progress[2]||0},"count-todo":function(e){return e.node,o.progress[1]||0},reviewer:function(e){if(e.node,o.user)return o.user.displayname}},handler:{"for-one":function(e){return e.node.classList.toggle("d-none",o.forAll)},"for-all":function(e){return e.node.classList.toggle("d-none",!o.forAll)},"comment-name":function(e){var t;if(t=e.node,o.active)return t.innerText=o.active.name||""},"progress-accept":function(e){var t;return t=e.node,t.style.width=100*(o.progress[0]||0)/(o.prjs.length||1)+"%"},"progress-reject":function(e){var t;return t=e.node,t.style.width=100*(o.progress[2]||0)/(o.prjs.length||1)+"%"},progress:function(e){var t;return t=e.node,t.innerText=Math.round(100*((o.progress[0]||0)+(o.progress[2]||0))/(o.prjs.length||1))},"header-criteria":{list:function(){return o.forAll?[]:o.criteria},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.name}},project:{list:function(){return o.prjs},init:function(e){var t,n,i,u;return t=e.node,n=e.local,i=e.data,u=t,t.classList.remove("d-none"),n.view=new ldView({initRender:!1,root:t,context:i,action:{click:{detail:function(e){return e.node,e.context,o.ldcv.detail.toggle()},comment:function(e){var t,n,i;return e.node,t=e.context,o.active=t,r.get("comment").value=((n=o.data)[i=o.active.slug]||(n[i]={})).comment||"",o.ldcv.comment.toggle(),o.view.render("comment-name")},name:function(e){var t;return e.node,t=e.context,r.get("iframe").setAttribute("src","/prj/"+t.slug+"?simple"),r.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=u,this.activeNode.classList.add("active")}}},text:{"count-accept":function(e){var t;return e.node,((t=e.context).reviewCount?t.reviewCount[0]:0)||0},"count-todo":function(e){var t;return e.node,((t=e.context).reviewCount?t.reviewCount[1]:0)||0},"count-reject":function(e){var t;return e.node,((t=e.context).reviewCount?t.reviewCount[2]:0)||0}},handler:{"for-all":function(e){return e.node.classList.toggle("d-none",!o.forAll)},"for-one":function(e){return e.node.classList.toggle("d-none",o.forAll)},"has-comment":function(e){var t,n;return t=e.node,n=e.context,t.classList.toggle("invisible",!o.data[n.slug].comment)},state:function(e){var t,n,r;return t=e.node,n=e.context,r=o.criteria.reduce(function(e,t){var r,i,a,u;return r=((i=(a=o.data)[u=n.slug]||(a[u]={})).value||(i.value={}))[t.key],Math.max(e,null!=r?r:1)},0),a(t,r)},name:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.name},key:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.key},criteria:{list:function(e){return e.context,o.forAll?[]:o.criteria},init:function(e){var t,n;return t=e.node,n=e.local,n.icon=ld$.find(t,"i",0)},action:{click:function(e){var t,r,i,a,u,c;return e.node,t=e.data,r=e.context,i=((a=(u=o.data)[c=r.slug]||(u[c]={})).value||(a.value={}))[t.key],i=null!=i?i:1,i=(i+2)%3,o.data[r.slug].value[t.key]=i,o.update(),n.view.render()}},handler:function(e){var t,n,r,i,u,c,s;return t=e.local,n=e.data,r=e.context,i=((u=(c=o.data)[s=r.slug]||(c[s]={})).value||(u.value={}))[n.key],i=null!=i?i:1,a(t.icon,i)}}}})},handler:function(e){var t,n;return e.node,t=e.local,n=e.data,n.reviewCount=o.getCount(n.slug),t.view.setContext(n),t.view.render()}}}}),this},u.prototype=import$(import$(Object.create(Object.prototype),o.interface),{render:function(){return this.getProgress(),this.view.render()},update:function(e){return null==e&&(e={}),e.debounced?this._update():this._update().now()},fetch:function(){var e=this;return ld$.fetch("/dash/api/brd/sch001/list",{method:"GET"},{type:"json"}).then(function(t){return e.prjs=t,e.render()})},sharedb:function(){var e,t=this;return console.log("prepare sharedb ..."),this.sdb=e=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hub=new Hub({sdb:e}),e.on("error",function(){return r.toggle("not-sync")}),e.on("close",function(){return r.toggle("offline-retry",!0),e.reconnect().then(function(){return t.getdoc()}).then(function(){return t.adapt()}).then(function(){return console.log("admin initialized.")}).then(function(){return r.toggle("offline-retry",!1)})}),e.ready()},getdoc:function(){var e=this;return this.hub.doc=null,this.sdb.get({id:"brd/"+this.brd+"/grp/"+this.grp+"/judge/criteria",watch:function(t,n){return e.hub.fire("change",{ops:t,source:n})},create:function(){return{}}}).then(function(t){return e.hub.doc=t,t.on("op",function(){return e.render()}),e.user?e.adapt({hub:e.hub,path:["user",e.user.key]}):e.adapt({hub:e.hub,path:[]})}).catch(function(e){return console.log("getdoc failed.",e)})},getCount:function(e){var t,n,r,o,i,a;t=[0,0,0];for(n in this.data.user)for(r=this.data.user[n][e].value,o=0,a=(i=this.criteria).length;o<a;++o)t[r[i[o].key]||1]++;return t},getState:function(){var e=this;return this.criteria.reduce(function(t,n){var r,o,i,a;return r=((o=(i=e.data)[a=context.slug]||(i[a]={})).value||(o.value={}))[n.key],Math.max(t,null!=r?r:1)},0)},getProgress:function(){var e,t=this;return e={0:0,1:0,2:0},this.prjs.map(function(n){var r;return r=t.criteria.reduce(function(e,r){var o,i,a,u;return o=((i=(a=t.data)[u=n.slug]||(a[u]={})).value||(i.value={}))[r.key],Math.max(e,null!=o?o:1)},0),e[r]++}),this.progress=e},opsIn:function(e){var t;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),this.render()}}),n.get().then(function(e){var t;return t=new u({root:document.body,brd:"sch001",grp:"4rFUP+03IS05ZD09ku03KMlsh"}),Promise.resolve().then(function(){return t.sharedb()}).then(function(){return t.getdoc()}).then(function(){return t.fetch()})})});