function import$(e,t){var r={}.hasOwnProperty;for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e}ldc.register("judgeCriteriaUser",["error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,r,n,o,i,a,c;return e.error,t=e.loader,r=e.auth,n=e.ldcvmgr,o=e.sdbAdapter,i=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],a=function(e,t){var r,n;return r=i[t],(n=Array.from(e.classList)).length&&e.classList.remove.apply(e.classList,n),e.classList.add.apply(e.classList,r)},c=function(e){var r,n,o=this;return this.loader=t,this.brd=e.brd,this.grp=e.grp,this.root=r="string"==typeof e.root?document.querySelector(e.root):e.root,this.prjs=[],this.data={},this.progress={},this.user=e.user,this.criteria=[{name:"開源",key:1},{name:"協作",key:2},{name:"參與",key:3}],this._update=debounce(function(){return o.opsOut(function(){return o.data})}),this.ldcv={comment:new ldCover({root:ld$.find(r,"[ld=comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(r,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(r,"[ld=criteria-ldcv]",0)})},this.view=n=new ldView({root:r,action:{input:{comment:function(e){var t,r,n;if(t=e.node,o.active)return((r=o.data)[n=o.active.slug]||(r[n]={})).comment=t.value,o.update({debounced:!0})}},click:{detail:function(e){return e.node,o.ldcv.detail.toggle()},criteria:function(e){return e.node,o.ldcv.criteria.toggle()}}},text:{"count-total":function(e){return e.node,o.prjs.length||0},"count-accept":function(e){return e.node,o.progress[0]||0},"count-reject":function(e){return e.node,o.progress[2]||0},"count-todo":function(e){return e.node,o.progress[1]||0},reviewer:function(e){return e.node,o.user.displayname}},handler:{"comment-name":function(e){var t;if(t=e.node,o.active)return t.innerText=o.active.name||""},"progress-accept":function(e){var t;return t=e.node,t.style.width=100*(o.progress[0]||0)/(o.prjs.length||1)+"%"},"progress-reject":function(e){var t;return t=e.node,t.style.width=100*(o.progress[2]||0)/(o.prjs.length||1)+"%"},progress:function(e){var t;return t=e.node,t.innerText=Math.round(100*((o.progress[0]||0)+(o.progress[2]||0))/(o.prjs.length||1))},"header-criteria":{list:function(){return o.criteria},handler:function(e){var t,r;return t=e.node,r=e.data,t.innerText=r.name}},project:{list:function(){return o.prjs.map(function(){}),o.prjs},init:function(e){var t,r,i;return t=e.node,r=e.local,i=e.data,t.classList.remove("d-none"),r.view=new ldView({root:t,context:i,action:{click:{comment:function(e){var t,r,i;return e.node,t=e.context,o.active=t,n.get("comment").value=((r=o.data)[i=o.active.slug]||(r[i]={})).comment||"",o.ldcv.comment.toggle(),o.view.render("comment-name")}}},handler:{"has-comment":function(e){var t,r;return t=e.node,r=e.context,t.classList.toggle("invisible",!o.data[r.slug].comment)},state:function(e){var t,r,n;return t=e.node,r=e.context,n=o.criteria.reduce(function(e,t){var n,i,a,c;return n=((i=(a=o.data)[c=r.slug]||(a[c]={})).value||(i.value={}))[t.key],Math.max(e,null!=n?n:1)},0),a(t,n)},name:function(e){var t,r;return t=e.node,r=e.context,t.innerText=r.name},key:function(e){var t,r;return t=e.node,r=e.context,t.innerText=r.key},criteria:{list:function(e){return e.context,o.criteria},init:function(e){var t,r;return t=e.node,r=e.local,r.icon=ld$.find(t,"i",0)},action:{click:function(e){var t,n,i,a,c,u;return e.node,t=e.data,n=e.context,i=((a=(c=o.data)[u=n.slug]||(c[u]={})).value||(a.value={}))[t.key],i=null!=i?i:1,i=(i+2)%3,o.data[n.slug].value[t.key]=i,o.update(),r.view.render()}},handler:function(e){var t,r,n,i,c,u,s;return t=e.local,r=e.data,n=e.context,i=((c=(u=o.data)[s=n.slug]||(u[s]={})).value||(c.value={}))[r.key],i=null!=i?i:1,a(t.icon,i)}}}})},handler:function(e){var t,r;return t=e.local,r=e.data,t.view.setContext(r),t.view.render()}}}}),this},c.prototype=import$(import$(Object.create(Object.prototype),o.interface),{render:function(){return this.getProgress(),this.view.render()},update:function(e){return null==e&&(e={}),e.debounced?this._update():this._update().now()},fetch:function(){var e=this;return ld$.fetch("/dash/api/brd/sch001/list",{method:"GET"},{type:"json"}).then(function(t){return e.prjs=t,e.render()})},sharedb:function(){var e,t=this;return console.log("prepare sharedb ..."),this.sdb=e=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hub=new Hub({sdb:e}),e.on("error",function(){return n.toggle("not-sync")}),e.on("close",function(){return t.loader.on(),e.reconnect().then(function(){return t.getdoc()}).then(function(){return t.adapt()}).then(function(){return console.log("admin initialized.")}).then(function(){return t.loader.off()})})},getdoc:function(){var e=this;return this.hub.doc=null,this.sdb.get({id:"brd/"+this.brd+"/grp/"+this.grp+"/judge/criteria",watch:function(t,r){return e.hub.fire("change",{ops:t,source:r})},create:function(){return{}}}).then(function(t){return e.hub.doc=t,t.on("op",function(){return e.render()}),e.adapt({hub:e.hub,path:["user",e.user.key]})}).catch(function(e){return console.log("getdoc failed.",e)})},getProgress:function(){var e,t=this;return e={0:0,1:0,2:0},this.prjs.map(function(r){var n;return n=t.criteria.reduce(function(e,n){var o,i,a,c;return o=((i=(a=t.data)[c=r.slug]||(a[c]={})).value||(i.value={}))[n.key],Math.max(e,null!=o?o:1)},0),e[n]++}),this.progress=e},opsIn:function(e){var t;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),this.render()}}),r.get().then(function(e){var t;return t=new c({user:e.user,root:document.body,brd:"sch001",grp:"4rFUP+03IS05ZD09ku03KMlsh"}),Promise.resolve().then(function(){return t.sharedb()}).then(function(){return t.getdoc()}).then(function(){return t.fetch()})})});