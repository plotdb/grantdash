// Generated by LiveScript 1.3.0
ldc.register('judgeCriteriaAll', ['notify', 'judgeBase', 'error', 'loader', 'auth', 'ldcvmgr', 'sdbAdapter'], function(arg$){
  var notify, judgeBase, error, loader, auth, ldcvmgr, sdbAdapter, Ctrl, ctrl;
  notify = arg$.notify, judgeBase = arg$.judgeBase, error = arg$.error, loader = arg$.loader, auth = arg$.auth, ldcvmgr = arg$.ldcvmgr, sdbAdapter = arg$.sdbAdapter;
  Ctrl = function(opt){
    var obj, view, this$ = this;
    import$(this, obj = new judgeBase(opt));
    this.data = {
      prj: {}
    };
    this.active = null;
    this.ldcv = {
      detail: new ldCover({
        root: ld$.find(this.root, '[ld=detail-ldcv]', 0)
      }),
      criteria: new ldCover({
        root: ld$.find(this.root, '[ld=criteria-ldcv]', 0)
      })
    };
    this.view.local = view = new ldView({
      initRender: false,
      root: this.root,
      action: {
        click: {
          criteria: function(arg$){
            var node;
            node = arg$.node;
            return this$.ldcv.criteria.toggle();
          },
          sort: function(arg$){
            var node;
            node = arg$.node;
            return this$.sort(node.getAttribute('data-name'), node.getAttribute('data-value'));
          }
        }
      },
      text: {
        count: function(arg$){
          var node;
          node = arg$.node;
          return this$.progress[node.getAttribute('data-name')] || 0;
        }
      },
      handler: {
        "comment-name": function(arg$){
          var node;
          node = arg$.node;
          if (this$.active) {
            return node.innerText = this$.active.name || '';
          }
        },
        progress: function(arg$){
          var node, names, p, n;
          node = arg$.node, names = arg$.names;
          p = this$.progress;
          if (in$('progress-bar', names)) {
            n = node.getAttribute('data-name');
            return node.style.width = 100 * p[n] / p.total + "%";
          } else if (in$('progress-percent', names)) {
            return node.innerText = Math.round(100 * p.done / p.total);
          }
        },
        comment: {
          list: function(){
            var k, v;
            return (function(){
              var ref$, ref1$, results$ = [];
              for (k in ref$ = (ref1$ = this.prj || {}).comments || (ref1$.comments = {})) {
                v = ref$[k];
                results$.push({
                  user: k,
                  comment: v
                });
              }
              return results$;
            }.call(this$)).filter(function(it){
              return it.comment;
            });
          },
          init: function(arg$){
            var node, local, data;
            node = arg$.node, local = arg$.local, data = arg$.data;
            return local.view = new ldView({
              root: node,
              context: data,
              text: {
                name: function(arg$){
                  var context;
                  context = arg$.context;
                  return this$.usermap[context.user].displayname;
                },
                comment: function(arg$){
                  var context;
                  context = arg$.context;
                  return context.comment;
                }
              }
            });
          },
          render: function(arg$){
            var local, data;
            local = arg$.local, data = arg$.data;
            local.view.setContext(data);
            return local.view.render();
          }
        },
        project: {
          key: function(it){
            return it.slug;
          },
          list: function(){
            return this$.prjs;
          },
          init: function(arg$){
            var node, local, data, root;
            node = arg$.node, local = arg$.local, data = arg$.data;
            root = node;
            node.classList.remove('d-none');
            return local.view = new ldView({
              initRender: false,
              root: node,
              context: data,
              action: {
                click: {
                  detail: function(arg$){
                    var node, context;
                    node = arg$.node, context = arg$.context;
                    this$.prj = context;
                    this$.view.local.render('comment');
                    return this$.ldcv.detail.toggle();
                  },
                  name: function(arg$){
                    var node, context;
                    node = arg$.node, context = arg$.context;
                    view.get("iframe").setAttribute('src', "/dash/prj/" + context.slug + "?simple");
                    view.get("iframe-placeholder").classList.add('d-none');
                    if (this.activeNode) {
                      this.activeNode.classList.remove('active');
                    }
                    this.activeNode = root;
                    return this.activeNode.classList.add('active');
                  }
                }
              },
              handler: {
                count: function(arg$){
                  var node, context, n, html, i$, ref$, len$, user, displayname, ref1$;
                  node = arg$.node, context = arg$.context;
                  n = node.getAttribute('data-name');
                  html = "";
                  for (i$ = 0, len$ = (ref$ = context.count[n]).length; i$ < len$; ++i$) {
                    user = ref$[i$];
                    displayname = this$.usermap ? ((ref1$ = this$.usermap)[user] || (ref1$[user] = {})).displayname : '';
                    html += "<div style=\"width:.3em;display:inline-block\">\n<div class=\"rounded-circle bg-cover bg-portrait bg-dark border border-light has-tips\"\nstyle=\"width:1.5em;height:1.5em;margin-left:-.6em;background-image:url(/dash/s/avatar/" + user + ".png);\">\n<div class=\"hover-tip bottom tip-sm\">" + displayname + "</div>\n</div></div>";
                  }
                  return node.innerHTML = html;
                },
                detail: function(arg$){
                  var node, context, hasComment, k, v, icon;
                  node = arg$.node, context = arg$.context;
                  hasComment = (function(){
                    var ref$, results$ = [];
                    for (k in ref$ = context.comments) {
                      v = ref$[k];
                      results$.push(v);
                    }
                    return results$;
                  }()).filter(function(it){
                    return it;
                  }).length;
                  if (!(icon = ld$.find(node, 'i', 0))) {
                    return;
                  }
                  return icon.classList.toggle('d-none', !hasComment);
                },
                state: function(arg$){
                  var node, context, span, icon, state, cls;
                  node = arg$.node, context = arg$.context;
                  span = ld$.find(node, 'span', 0);
                  icon = ld$.find(node, 'i', 0);
                  state = context.state != null ? context.state : 1;
                  icon.classList.remove.apply(icon.classList, icon.classList);
                  icon.classList.add(['i-check', 'i-circle', 'i-close'][state]);
                  node.classList.remove.apply(node.classList, node.classList);
                  cls = [['bg-success', 'text-white'], ['bg-light', 'text-secondary'], ['bg-danger', 'text-white']];
                  node.classList.add.apply(node.classList, (cls[state] || []).concat(['rounded']));
                  return span.innerText = ['通過', '待查', '不符'][state];
                },
                name: function(arg$){
                  var node, context;
                  node = arg$.node, context = arg$.context;
                  return node.innerText = context.name;
                },
                key: function(arg$){
                  var node, context;
                  node = arg$.node, context = arg$.context;
                  return node.innerText = context.key || '';
                }
              }
            });
          },
          handler: function(arg$){
            var node, local, data;
            node = arg$.node, local = arg$.local, data = arg$.data;
            local.view.setContext(data);
            this$.getCount(data);
            return local.view.render();
          }
        }
      }
    });
    return this;
  };
  Ctrl.prototype = import$(import$({}, judgeBase.prototype), {
    opsIn: function(arg$){
      var data, ops, source, userkeys, res$, k, ref$, this$ = this;
      data = arg$.data, ops = arg$.ops, source = arg$.source;
      if (source) {
        return;
      }
      this.data = JSON.parse(JSON.stringify(data));
      res$ = [];
      for (k in (ref$ = this.data).user || (ref$.user = {})) {
        res$.push(k);
      }
      userkeys = res$;
      return this.getDisplayname(userkeys).then(function(){
        this$.prjs.map(function(p){
          var k, ref$, ref1$, v, key$, ref2$, results$ = [];
          p.comments = {};
          for (k in ref$ = (ref1$ = this$.data).user || (ref1$.user = {})) {
            v = ref$[k];
            results$.push(p.comments[k] = ((ref1$ = (ref2$ = v || {}).prj || (ref2$.prj = {}))[key$ = p.key] || (ref1$[key$] = {})).comment || '');
          }
          return results$;
        });
        return this$.render();
      });
    },
    render: function(){
      this.getProgress();
      this.view.base.render();
      return this.view.local.render();
    },
    reconnect: function(){
      var this$ = this;
      return this.getdoc().then(function(){
        return this$.sort('name', null, false);
      }).then(function(){
        return console.log("initied.");
      });
    },
    init: function(){
      var this$ = this;
      return Promise.resolve().then(function(){
        return this$.auth();
      }).then(function(){
        return this$.initView();
      }).then(function(){
        return this$.fetchInfo();
      }).then(function(){
        return this$.fetchPrjs();
      }).then(function(){
        return this$.sharedb();
      }).then(function(){
        return this$.reconnect();
      })['catch'](error());
    },
    getCount: function(context){
      var count, k, ref$, ref1$, user, val, results$ = [], this$ = this;
      context.count = count = {
        accept: [],
        pending: [],
        reject: []
      };
      for (k in ref$ = (ref1$ = this.data).user || (ref1$.user = {})) {
        user = ref$[k];
        val = this.criteria.reduce(fn$, 0);
        count[['accept', 'pending', 'reject'][val]].push(k);
        results$.push(context.state = count.reject.length
          ? 2
          : count.accept.length ? 0 : 1);
      }
      return results$;
      function fn$(a, b){
        var v, ref$, ref1$, key$;
        v = ((ref$ = (ref1$ = user.prj)[key$ = context.key] || (ref1$[key$] = {})).v || (ref$.v = {}))[b.key];
        return Math.max(a, v != null ? v : 1);
      }
    },
    getDisplayname: function(list){
      var payload, this$ = this;
      if (this.usermap && !list.filter(function(it){
        return !this$.usermap[it];
      }).length) {
        Promise.resolve();
      }
      payload = {
        userkeys: list
      };
      return ld$.fetch("/dash/api/usermap/", {
        method: 'PUT'
      }, {
        json: payload,
        type: 'json'
      }).then(function(ret){
        ret == null && (ret = []);
        this$.usermap = {};
        return ret.map(function(it){
          return this$.usermap[it.key] = it;
        });
      })['catch'](error());
    },
    getProgress: function(){
      var val, this$ = this;
      val = {
        0: 0,
        1: 0,
        2: 0
      };
      this.prjs.map(function(p){
        if (!(p.state != null)) {
          this$.getCount(p);
        }
        return val[p.state]++;
      });
      return this.progress = {
        accept: val[0],
        pending: val[1],
        reject: val[2],
        done: val[0] + val[2],
        total: this.prjs.length || 1
      };
    }
  });
  ctrl = new Ctrl({
    root: document.body
  });
  return ctrl.init();
});
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}