function import$(e,t){var r={}.hasOwnProperty;for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e}function in$(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}ldc.register("judgeFinalUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,r,n,a,i;return e.notify,t=e.judgeBase,r=e.error,e.loader,e.auth,n=e.ldcvmgr,e.sdbAdapter,a=function(e){var r,n=this;return import$(this,new t(e)),this.data={prj:{}},this.active=null,this.sortDir={},this.view.local=r=new ldView({initRender:!1,root:this.root,text:{count:function(e){var t;return t=e.node,n.progress[t.getAttribute("data-name")]||0}},handler:{"comment-name":function(e){var t;if(t=e.node,n.active)return t.innerText=n.active.name||""},progress:function(e){var t,r,a,i;return t=e.node,r=e.names,a=n.progress,in$("progress-bar",r)?(i=t.getAttribute("data-name"),t.style.width=100*a[i]/a.total+"%"):in$("progress-percent",r)?t.innerText=Math.round(100*a.done/a.total):void 0},"header-criteria":{list:function(){return n.criteria},action:{click:function(e){var t;return e.node,t=e.data,n.sort("criteria",t.key)}},handler:function(e){var t,r;return t=e.node,r=e.data,t.innerText=r.name}},project:{key:function(e){return e.slug},list:function(){return n.prjs},init:function(e){var t,a,i,o;return t=e.node,a=e.local,i=e.data,o=t,t.classList.remove("d-none"),a.view=new ldView({initRender:!1,root:t,context:i,action:{click:{option:function(e){var t,r,i,o,s;return t=e.node,r=e.context,i=t.getAttribute("data-name"),((o=n.data.prj)[s=r.slug]||(o[s]={})).value=i,a.view.render(),n.getProgress(),n.view.local.render(["progress"]),n.update({debounced:10})},name:function(e){var t;return e.node,t=e.context,r.get("iframe").setAttribute("src","/dash/prj/"+t.slug+"?simple"),r.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=o,this.activeNode.classList.add("active")}}},text:{name:function(e){return e.context.name||""},ownername:function(e){var t;return(t=e.context).info.teamname||t.ownername||""},key:function(e){return e.context.key||""},budget:function(e){var t;return(t=e.context).info.budget?Math.round(t.info.budget/1e4)+"萬":""}},handler:{"has-comment":function(e){var t,r,a,i;return t=e.node,r=e.context,t.classList.toggle("invisible",!((a=n.data.prj)[i=r.slug]||(a[i]={})).comment)},option:function(e){var t,r,a,i,o,s,u;return t=e.node,e.local,r=e.context,a=t.getAttribute("data-name"),i={accept:"bg-success",pending:"bg-warning",reject:"bg-danger"}[a],o=((s=n.data.prj)[u=r.slug]||(s[u]={})).value===a?"add":"remove",t.classList[o].apply(t.classList,[i,"text-white"])}}})},handler:function(e){var t,r;return e.node,t=e.local,r=e.data,t.view.setContext(r),n.getState(r),t.view.render()}}}}),this},a.prototype=import$(import$({},t.prototype),{opsIn:function(e){var t,r,n,a=this;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),(r=this.data).prj||(r.prj={}),(n=this.prjs.map(function(e,t){return a.grade.map(function(t,r){var n,i,o;return((n=(i=a.data.prj)[o=e.key]||(i[o]={})).v||(n.v={}))[t.key]||0})})).length||(n=[[]]),this.sheet.populateFromArray(1,3,n),this.render()},render:function(){return this.getProgress(),this.view.base.render(),this.view.local.render(),this.sheet},initSheet:function(){var e,t=this;return console.log("init sheet ... "),this.sheet=i({root:edit,afterChange:function(e){var r,n,a,i;return null==e&&(e=[]),r=[],n=[],a=t.sheet?t.sheet.getSourceData():[[]],e.map(function(e){var i,o,s,u,c,d,h,l,p;if(i=e[0],o=e[1],s=e[2],u=e[3],i>0&&o>2&&o<3+t.grade.length)return c=t.prjkeymap[a[i][0]].key,d=t.grade[o-3].key,s=((h=(l=t.data.prj)[c]||(l[c]={})).v||(h.v={}))[d],((h=(l=t.data.prj)[c]||(l[c]={})).v||(h.v={}))[d]=u,p=t.grade.map(function(e){var r,n;return((r=(n=t.data.prj)[c]||(n[c]={})).v||(r.v={}))[e.key]}).reduce(function(e,t){return e+ +t},0),n.push([i,3+t.grade.length,p]),r.push({p:["prj",c,"v",d],od:s}),r.push({p:["prj",c,"v",d],oi:u})}),t.sheet&&n.length&&(t.sheet.setDataAtCell(n),(a=(a=t.sheet.getSourceData(1,3+t.grade.length,t.prjs.length,3+t.grade.length)).map(function(e,t){return[e[0],t+1]})).sort(function(e,t){return t[0]-e[0]}),i=[],a.map(function(e,r){return i.push([e[1],3+t.grade.length+1,r+1])}),t.sheet.setDataAtCell(i)),t.update({ops:r})}}),this.sheet.addHook("beforeOnCellMouseDown",function(e,r){var n,a,i,o;if(t.sheet&&!(r.row>=0))return n=r.col,a=t.sheet?t.sheet.getSourceData():[[]],i=a.splice(0,1)[0],t.sortDir[n]=o=1-(t.sortDir[n]||0),a.sort(function(e,t){return(2*o-1)*(t[n]>e[n]?1:t[n]<e[n]?-1:0)}),a.splice(0,0,i),t.sheet.loadData(a)}),this.prjs.sort(function(e,t){return e.key-t.key}),e=this.prjs.map(function(e,r){return[e.key,"",e.name].concat(t.grade.map(function(){return 0}),[0,1,""])}),e=[["編號","評論","名稱"].concat(this.grade.map(function(e){return e.name}),["總分","排名","評論"])].concat(e),this.sheet.loadData(e),this.sheet.render(),this.render()},init:function(){var e=this;return Promise.resolve().then(function(){return e.auth()}).then(function(){return e.initView()}).then(function(){return e.user=e.global.user}).then(function(){return e.fetchInfo()}).then(function(){return e.grpinfo.grade?e.grade=e.grpinfo.grade.entries:n.get("judge-grade-missing")}).then(function(){return e.fetchPrjs()}).then(function(){return e.initSheet()}).then(function(){return e.sharedb()}).then(function(){return e.getdoc()}).then(function(){return console.log("initied.")}).catch(r())},getState:function(e){var t=this;return e.state=this.criteria.reduce(function(r,n){var a,i,o,s;return a=((i=(o=t.data.prj)[s=e.slug]||(o[s]={})).value||(i.value={}))[n.key],Math.max(r,null!=a?a:1)},0)},getProgress:function(){var e,t=this;return this.progress=e={done:0,accept:0,pending:0,reject:0,total:this.prjs.length||1},this.prjs.map(function(r){var n,a,i;if(n=((a=t.data.prj)[i=r.slug]||(a[i]={})).value)return e[n]++}),e.done=e.accept+e.pending+e.reject||0}}),new a({root:document.body}).init(),i=function(e){return Handsontable.renderers.registerRenderer("myrenderer",function(e,t,r,n,a,i,o){return Handsontable.renderers.TextRenderer.apply(this,arguments)}),new Handsontable(e.root,import$({rowHeaders:!0,colHeaders:!0,filters:!0,dropdownMenu:!0,rowHeights:25,colWidths:[40,50,220,50,50,50,50,50,250],minRows:50,minCols:15,stretchH:"all",fixedRowsTop:1,fixedColumnsLeft:3,cells:function(e,t){return{renderer:"myrenderer"}}},e))}});