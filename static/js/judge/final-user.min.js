function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}ldc.register("judgeFinalUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(t){var e,n,r,a;return t.notify,e=t.judgeBase,n=t.error,t.loader,t.auth,r=t.ldcvmgr,t.sdbAdapter,a=function(t){var n,r=this;return import$(this,new e(t)),this.data={prj:{}},this.active=null,this.progress={total:1,done:0},this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0),escape:!1}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)})},this.view.local=n=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(t){var e,n,a;if(e=t.node,r.active)return((n=r.data.prj)[a=r.active.key]||(n[a]={})).comment=e.value,r.update({debounced:300}),r.view.local.render({name:"project",key:r.active.slug})}},click:{sort:function(t){var e;return e=t.node,r.sort(e.getAttribute("data-name"))},"toggle-total":function(){return r.totalEditable=!r.totalEditable,r.view.local.render("toggle-total")}}},handler:{"toggle-total":function(t){var e;return e=t.node,ld$.find(e,".switch",0).classList.toggle("on",r.totalEditable),ld$.find(r.root,"input[ld=total]").map(function(t){return r.totalEditable?t.removeAttribute("readonly"):t.setAttribute("readonly",null),t.classList.toggle("bg-light",!r.totalEditable)})},"comment-name":function(t){var e;return e=t.node,e.innerText=r.active&&r.active.name||""},"progress-percent":function(t){var e;return e=t.node,e.innerText=Math.floor(100*r.progress.done/r.progress.total)},"progress-bar":function(t){var e;return e=t.node,e.style.width=100*r.progress.done/r.progress.total+"%"},count:function(t){var e,n;return e=t.node,"total"===(n=e.getAttribute("data-name"))?e.innerText=r.progress.total||0:"pending"===n?e.innerText=r.progress.total-r.progress.done||0:void 0},detail:{list:function(){var t,e,n,a,i,o;if(!r.active)return[];t=[];for(e in n=((a=r.criteriaResult).data||(a.data={})).user||{})i=(a=n[e].prj)[o=r.active.key]||(a[o]={}),t.push({user:e,name:r.usermap[e].displayname,comment:i.comment||"",criteria:r.criteria.map(function(t){return{name:t.name,value:null!=(i.v||(i.v={}))[t.key]?i.v[t.key]:1}})});return t.sort(function(t,e){return(null!=e.comment?e.comment.length:0)-(null!=t.comment?t.comment.length:0)})},init:function(t){var e,n,r;return e=t.node,n=t.local,r=t.data,n.view=new ldView({root:e,context:r,text:{name:function(t){return t.context.name}},handler:{comment:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.comment||"( 沒有評論 )",e.classList.toggle("text-muted",!n.comment)},avatar:function(t){var e,n;return e=t.node,n=t.context,e.style.backgroundImage="url(/dash/s/avatar/"+n.user+".png)"},criteria:{list:function(t){return t.context.criteria},handler:function(t){var e,n,r,a;return e=t.node,n=t.data,ld$.find(e,"[ld=name]",0).innerText=n.name,r=ld$.find(e,"[ld=value]",0),a=ld$.find(r,"i",0),r.classList.remove("text-success","text-secondary","text-danger"),r.classList.add(["text-success","text-secondary","text-danger"][n.value]),a.classList.remove("i-close","i-circle","i-check"),a.classList.add(["i-check","i-circle","i-close"][n.value])}}}})}},"total-max":function(t){var e;return e=t.node,e.innerText="0 ~ "+r.grade.reduce(function(t,e){return t+ +e.percent},0)},grade:{list:function(t){return t.context,r.grade},handler:function(t){var e,n;return e=t.node,n=t.data,ld$.find(e,"span",0).innerText=n.name,ld$.find(e,"div",0).innerText="0 ~ "+n.percent},action:{click:function(t){var e;return t.node,e=t.data,r.sort("grade",e)}}},project:{key:function(t){return t.slug},list:function(){return r.prjs},init:function(t){var e,a,i,o;return e=t.node,a=t.local,i=t.data,o=e,e.classList.remove("d-none"),a.view=new ldView({initRender:!1,root:e,context:i,action:{click:{detail:function(t){var e;return t.node,e=t.context,r.active=e,r.view.local.render("detail"),r.ldcv.detail.toggle()},comment:function(t){var e,a,i;return t.node,e=t.context,r.active=e,n.get("comment").value=((a=r.data.prj)[i=r.active.key]||(a[i]={})).comment||"",r.ldcv.comment.toggle(),r.view.local.render("comment-name")},name:function(t){var e;return t.node,e=t.context,n.get("iframe").setAttribute("src","/dash/prj/"+e.slug+"?simple"),n.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=o,this.activeNode.classList.add("active")}}},init:{total:function(t){var e,n,a;return e=t.node,n=t.context,a=function(){var t,a;if(n.total!==(t=+e.value))return isNaN(t)?e.value=n.total:(n.total=t,a=r.grade.reduce(function(t,e){return t+ +e.percent},0),r.grade.map(function(e){var i,o,c;return((i=(o=r.data.prj)[c=n.key]||(o[c]={})).v||(i.v={}))[e.key]=e.percent*t/a}),r.view.local.render("project"))},e.addEventListener("input",a),e.addEventListener("change",a),e.addEventListener("keyup",a)}},handler:{comment:function(t){var e,n,a,i;return e=t.node,n=t.context,e.classList.toggle("text-primary",!!((a=r.data.prj)[i=n.key]||(a[i]={})).comment)},name:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.name},key:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.key||""},total:function(t){var e,n;return e=t.node,n=t.context,e.value=null!=n.total?n.total:"-"},rank:function(t){var e,n;return e=t.node,n=t.context,e.value=null!=n.rank?n.rank:"-"},criteria:function(t){var e,n,r;return e=t.node,n=t.context,r=e.getAttribute("data-name"),e.innerText=({0:"+",2:"-"}[r]||"")+(n.criteria||(n.criteria={}))[r]},grade:{key:function(t){return t.key},list:function(t){return t.context,r.grade},init:function(t){var e,n,a,i,o,c,u,d,l,s;return e=t.local,n=t.node,a=t.context,i=t.data,e.input=o=ld$.find(n,"input",0),o.value=((c=(u=r.data.prj)[d=a.key]||(u[d]={})).v||(c.v={}))[i.key]||"",l=debounce(300,function(){return r.rerank(),r.view.local.render("project"),r.opsOut(function(){return r.data})}),s=function(){return r.data.prj[a.key].v[i.key]=+o.value,e.render(i),l()},e.render=function(t){var n,i,c,u;return e.input.value=((n=(i=r.data.prj)[c=a.key]||(i[c]={})).v||(n.v={}))[t.key]||"",u=+e.input.value,["bg-danger","text-white"].map(function(e){return o.classList.toggle(e,u>t.percent)}),r.view.local.render(["progress-bar","progress-percent","count"])},o.addEventListener("input",s),o.addEventListener("keyup",s),o.addEventListener("change",s)},handler:function(t){var e,n;return e=t.local,t.context,n=t.data,e.render(n)}}}})},handler:function(t){var e,n;return t.node,e=t.local,n=t.data,e.view.setContext(n),e.view.render()}}}}),this},a.prototype=import$(import$({},e.prototype),{opsIn:function(t){var e,n;if(e=t.data,t.ops,!t.source)return this.data=JSON.parse(JSON.stringify(e)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.rerank(),this.view.base.render(),this.view.local.render()},reconnect:function(){var t=this;return this.getdoc().then(function(){return t.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var t=this;return Promise.resolve().then(function(){return t.auth()}).then(function(){return t.initView()}).then(function(){return t.user=t.global.user}).then(function(){return t.fetchInfo()}).then(function(){return t.grpinfo.grade?t.grade=t.grpinfo.grade.entries:r.get("judge-grade-missing")}).then(function(){return t.fetchPrjs()}).then(function(){return t.fetchCriteriaResult()}).then(function(){return t.sharedb()}).then(function(){return t.reconnect()}).catch(n())},fetchCriteriaResult:function(){var t=this;return ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/judge/criteria/result",{method:"GET"},{type:"json"}).then(function(e){var n,r;return null==e&&(e={}),t.criteriaResult=e.data,t.getDisplayname(function(){var t=[];for(n in this.criteriaResult.data.user)t.push(n);return t}.call(t)),r=t.criteriaResult.data.user,t.prjs.map(function(e){var n,a,i,o=[];e.criteria={0:0,1:0,2:0};for(n in a=r)i=a[n],o.push(t.criteria.map(function(t){var n,r,a;return null==(n=((r=i.prj||(i.prj={}))[a=e.key]||(r[a]={})).v[t.key])&&(n=1),e.criteria[n]++}));return o})})},rerank:function(){var t,e,n,r,a,i,o,c,u,d,l,s;e=[];for(n in r=(a=this.data).prj||(a.prj={}))if(i=r[n],o=this.prjkeymap[n]){for(c=0,u=0,d=(a=this.grade).length;u<d;++u)l=a[u],c+=+((i.v||(i.v={}))[l.key]||0);o.total=c,e.push([o,c])}return t=e,s={idx:1,value:null},t.sort(function(t,e){return e[1]-t[1]}),t.map(function(t,e){var n;return s.value!==t[1]&&(n=[t[1],e+1],s.value=n[0],s.idx=n[1]),t[0].rank=s.idx}),this.getProgress()},getProgress:function(){var t=this;return this.progress={total:this.prjs.length||1,done:this.prjs.filter(function(e){return!t.grade.filter(function(n){var r,a,i;return null==((r=(a=t.data.prj)[i=e.key]||(a[i]={})).v||(r.v={}))[n.key]}).length}).length}}}),new a({root:document.body}).init()});