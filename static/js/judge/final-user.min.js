function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}ldc.register("judgeFinalUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,n,r,a;return e.notify,t=e.judgeBase,n=e.error,e.loader,e.auth,r=e.ldcvmgr,e.sdbAdapter,a=function(e){var n,r=this;return import$(this,new t(e)),this.data={prj:{}},this.active=null,this.progress={total:1,done:0},this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0),escape:!1}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)})},this.view.local=n=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(e){var t,n,a;if(t=e.node,r.active)return((n=r.data.prj)[a=r.active.key]||(n[a]={})).comment=t.value,r.update({debounced:300}),r.view.local.render({name:"project",key:r.active.slug})}},click:{sort:function(e){var t;return t=e.node,r.sort(t.getAttribute("data-name"))}}},handler:{"comment-name":function(e){var t;return t=e.node,t.innerText=r.active&&r.active.name||""},"progress-percent":function(e){var t;return t=e.node,t.innerText=Math.floor(100*r.progress.done/r.progress.total)},"progress-bar":function(e){var t;return t=e.node,t.style.width=100*r.progress.done/r.progress.total+"%"},detail:{list:function(){var e,t,n,a,o,i;if(!r.active)return[];e=[];for(t in n=r.review||{})a=(o=n[t].prj)[i=r.active.key]||(o[i]={}),e.push({user:t,name:r.usermap[t].displayname,comment:a.comment||"",criteria:r.criteria.map(function(e){return{name:e.name,value:null!=(a.v||(a.v={}))[e.key]?a.v[e.key]:1}})});return e.sort(function(e,t){return(null!=t.comment?t.comment.length:0)-(null!=e.comment?e.comment.length:0)})},init:function(e){var t,n,r;return t=e.node,n=e.local,r=e.data,n.view=new ldView({root:t,context:r,text:{name:function(e){return e.context.name}},handler:{comment:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.comment||"( 沒有評論 )",t.classList.toggle("text-muted",!n.comment)},avatar:function(e){var t,n;return t=e.node,n=e.context,t.style.backgroundImage="url(/dash/s/avatar/"+n.user+".png)"},criteria:{list:function(e){return e.context.criteria},handler:function(e){var t,n,r,a;return t=e.node,n=e.data,ld$.find(t,"[ld=name]",0).innerText=n.name,r=ld$.find(t,"[ld=value]",0),a=ld$.find(r,"i",0),r.classList.remove("text-success","text-secondary","text-danger"),r.classList.add(["text-success","text-secondary","text-danger"][n.value]),a.classList.remove("i-close","i-circle","i-check"),a.classList.add(["i-check","i-circle","i-close"][n.value])}}}})}},grade:{list:function(e){return e.context,r.grade},handler:function(e){var t,n;return t=e.node,n=e.data,ld$.find(t,"span",0).innerText=n.name,ld$.find(t,"div",0).innerText=n.percent+"%"},action:{click:function(e){var t;return e.node,t=e.data,r.sort("grade",t)}}},project:{key:function(e){return e.slug},list:function(){return r.prjs},init:function(e){var t,a,o,i;return t=e.node,a=e.local,o=e.data,i=t,t.classList.remove("d-none"),a.view=new ldView({initRender:!1,root:t,context:o,action:{click:{detail:function(e){var t;return e.node,t=e.context,r.prj=t,r.view.local.render("detail"),r.ldcv.detail.toggle()},comment:function(e){var t,a,o;return e.node,t=e.context,r.active=t,n.get("comment").value=((a=r.data.prj)[o=r.active.key]||(a[o]={})).comment||"",r.ldcv.comment.toggle(),r.view.local.render("comment-name")},name:function(e){var t;return e.node,t=e.context,n.get("iframe").setAttribute("src","/dash/prj/"+t.slug+"?simple"),n.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=i,this.activeNode.classList.add("active")}}},init:{total:function(e){var t,n,a;return t=e.node,n=e.context,a=function(){var e;return n.total=e=+t.value,r.grade.map(function(t){var a,o,i;return((a=(o=r.data.prj)[i=n.key]||(o[i]={})).v||(a.v={}))[t.key]=t.percent*e/100}),r.view.local.render({name:"project",key:n.slug})},t.addEventListener("input",a),t.addEventListener("change",a),t.addEventListener("keyup",a)}},handler:{comment:function(e){var t,n,a,o;return t=e.node,n=e.context,t.classList.toggle("text-primary",!!((a=r.data.prj)[o=n.key]||(a[o]={})).comment)},name:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.name},key:function(e){var t,n;return t=e.node,n=e.context,t.innerText=n.key||""},total:function(e){var t,n;return t=e.node,n=e.context,t.value=null!=n.total?n.total:"-"},rank:function(e){var t,n;return t=e.node,n=e.context,t.value=null!=n.rank?n.rank:"-"},grade:{key:function(e){return e.key},list:function(e){return e.context,r.grade},init:function(e){var t,n,a,o,i,c,u,d,s;return t=e.local,n=e.node,a=e.context,o=e.data,t.input=i=ld$.find(n,"input",0),i.value=((c=(u=r.data.prj)[d=a.key]||(u[d]={})).v||(c.v={}))[o.key]||"",s=function(e){return r.data.prj[a.key].v[o.key]=+i.value,t.render(o),r.view.local.render({name:"project",key:a.slug}),r.opsOut(function(){return r.data})},t.render=function(e){var n,o,c,u;return t.input.value=n=((o=(c=r.data.prj)[u=a.key]||(c[u]={})).v||(o.v={}))[e.key]||"",["bg-danger","text-white"].map(function(t){return i.classList.toggle(t,n>e.percent)}),r.view.local.render(["progress-bar","progress-percent"]),r.rerank()},i.addEventListener("input",s),i.addEventListener("keyup",s),i.addEventListener("change",s)},handler:function(e){var t,n;return t=e.local,e.context,n=e.data,t.render(n)}}}})},handler:function(e){var t,n;return e.node,t=e.local,n=e.data,t.view.setContext(n),t.view.render()}}}}),this},a.prototype=import$(import$({},t.prototype),{opsIn:function(e){var t,n;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.rerank(),this.view.base.render(),this.view.local.render()},reconnect:function(){var e=this;return this.getdoc().then(function(){return e.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var e=this;return Promise.resolve().then(function(){return e.auth()}).then(function(){return e.initView()}).then(function(){return e.user=e.global.user}).then(function(){return e.fetchInfo()}).then(function(){return e.grpinfo.grade?e.grade=e.grpinfo.grade.entries:r.get("judge-grade-missing")}).then(function(){return e.fetchPrjs()}).then(function(){return e.sharedb()}).then(function(){return e.reconnect()}).catch(n())},rerank:function(){var e,t,n,r,a,o,i,c,u,d,s,l;t=[];for(n in r=(a=this.data).prj||(a.prj={}))if(o=r[n],i=this.prjkeymap[n]){for(c=0,u=0,d=(a=this.grade).length;u<d;++u)s=a[u],c+=+((o.v||(o.v={}))[s.key]||0);i.total=c,t.push([i,c])}return e=t,l={idx:1,value:null},e.sort(function(e,t){return t[1]-e[1]}),e.map(function(e,t){var n;return l.value!==e[1]&&(n=[e[1],t+1],l.value=n[0],l.idx=n[1]),e[0].rank=l.idx}),this.getProgress()},getProgress:function(){return this.progress={total:this.prjs.length||1,done:this.prjs.filter(function(e){return e.total}).length}}}),new a({root:document.body}).init()});