// Generated by LiveScript 1.3.0
ldc.register('judgePrimaryAll', ['notify', 'judgeBase', 'error', 'loader', 'auth', 'ldcvmgr', 'sdbAdapter'], function(arg$){
  var notify, judgeBase, error, loader, auth, ldcvmgr, sdbAdapter, typemap, clsmap, clsset, Ctrl, ctrl;
  notify = arg$.notify, judgeBase = arg$.judgeBase, error = arg$.error, loader = arg$.loader, auth = arg$.auth, ldcvmgr = arg$.ldcvmgr, sdbAdapter = arg$.sdbAdapter;
  typemap = {
    0: "accept",
    1: "pending",
    2: "reject"
  };
  clsmap = [['i-check', 'text-success'], ['i-circle', 'text-secondary'], ['i-close', 'text-danger']];
  clsset = function(node, val){
    var newcls, oldcls;
    newcls = clsmap[val];
    oldcls = Array.from(node.classList);
    if (oldcls.length) {
      node.classList.remove.apply(node.classList, oldcls);
    }
    return node.classList.add.apply(node.classList, newcls);
  };
  Ctrl = function(opt){
    var obj, view, this$ = this;
    import$(this, obj = new judgeBase(opt));
    this.data = {
      prj: {}
    };
    this.active = null;
    this.ldcv = {
      comment: new ldCover({
        root: ld$.find(this.root, '[ld=comment-ldcv]', 0)
      }),
      detail: new ldCover({
        root: ld$.find(this.root, '[ld=detail-ldcv]', 0)
      }),
      criteria: new ldCover({
        root: ld$.find(this.root, '[ld=criteria-ldcv]', 0)
      })
    };
    this.view.local = view = new ldView({
      initRender: false,
      root: this.root,
      action: {
        input: {
          comment: function(arg$){
            var node, ref$, key$;
            node = arg$.node;
            if (!this$.active) {
              return;
            }
            ((ref$ = this$.data.prj)[key$ = this$.active.key] || (ref$[key$] = {})).comment = node.value;
            this$.update({
              debounced: 300
            });
            return this$.view.local.render({
              name: 'project',
              key: this$.active.slug
            });
          }
        },
        click: {
          detail: function(arg$){
            var node;
            node = arg$.node;
            return this$.ldcv.detail.toggle();
          },
          criteria: function(arg$){
            var node;
            node = arg$.node;
            return this$.ldcv.criteria.toggle();
          },
          sort: function(arg$){
            var node;
            node = arg$.node;
            return this$.sort(node.getAttribute('data-name'), node.getAttribute('data-value'));
          },
          "download-csv": function(){
            var head, body, data, href, n;
            head = '"名稱","提案單位","入選標記","推薦票數","面議票數","汰除票數","推薦佔例"';
            body = this$.prjs.map(function(p){
              var ref$, key$, ref1$;
              return [p.name, p.info.teamname || p.ownername || '', ((ref$ = (ref1$ = this$.data).prj || (ref1$.prj = {}))[key$ = p.key] || (ref$[key$] = {})).picked ? 'O' : '', p.count.accept, p.count.pending, p.count.reject, p.rate].map(function(it){
                return "\"" + ('' + it).replace('"', '\\"') + "\"";
              }).join(',');
            }).join('\n');
            data = head + "\n" + body;
            href = URL.createObjectURL(new Blob([data], {
              type: "text/csv"
            }));
            n = ld$.create({
              name: 'a',
              attr: {
                href: href,
                download: 'result.csv'
              }
            });
            document.body.appendChild(n);
            n.click();
            return document.body.removeChild(n);
          }
        }
      },
      text: {
        count: function(arg$){
          var node;
          node = arg$.node;
          return this$.progress[node.getAttribute('data-name')] || 0;
        }
      },
      handler: {
        option: function(arg$){
          var node, v, jinfo, ref$, ref1$, type;
          node = arg$.node;
          v = node.getAttribute('data-value');
          jinfo = ((ref$ = (ref1$ = this$.grpinfo).judge || (ref1$.judge = {})).primary || (ref$.primary = {})) || {};
          type = jinfo["option-type"];
          return node.classList.toggle('d-none', v === '1' && type === '2way' ? true : false);
        },
        "show-budget": function(arg$){
          var node, ref$;
          node = arg$.node;
          return node.classList.toggle('d-none', !((ref$ = this$.grpinfo.form).purpose || (ref$.purpose = {})).budget);
        },
        "comment-name": function(arg$){
          var node;
          node = arg$.node;
          if (this$.active) {
            return node.innerText = this$.active.name || '';
          }
        },
        progress: function(arg$){
          var node, names, p, n;
          node = arg$.node, names = arg$.names;
          p = this$.progress;
          if (in$('progress-bar', names)) {
            n = node.getAttribute('data-name');
            return node.style.width = 100 * p[n] / p.total + "%";
          } else if (in$('progress-percent', names)) {
            return node.innerText = Math.round(100 * p.done / p.total);
          }
        },
        "header-criteria": {
          list: function(){
            return this$.criteria;
          },
          action: {
            click: function(arg$){
              var node, data;
              node = arg$.node, data = arg$.data;
              return this$.sort('criteria', data.key);
            }
          },
          handler: function(arg$){
            var node, data;
            node = arg$.node, data = arg$.data;
            return node.innerText = data.name;
          }
        },
        project: {
          key: function(it){
            return it.slug;
          },
          list: function(){
            return this$.prjs;
          },
          init: function(arg$){
            var node, local, data, root;
            node = arg$.node, local = arg$.local, data = arg$.data;
            root = node;
            node.classList.remove('d-none');
            return local.view = new ldView({
              initRender: false,
              root: node,
              context: data,
              action: {
                click: {
                  name: function(arg$){
                    var node, context;
                    node = arg$.node, context = arg$.context;
                    view.get("iframe").setAttribute('src', "/dash/prj/" + context.slug + "?simple");
                    view.get("iframe-placeholder").classList.add('d-none');
                    if (this.activeNode) {
                      this.activeNode.classList.remove('active');
                    }
                    this.activeNode = root;
                    return this.activeNode.classList.add('active');
                  },
                  pick: function(arg$){
                    var node, context, obj, ref$, key$, ref1$;
                    node = arg$.node, context = arg$.context;
                    obj = (ref$ = (ref1$ = this$.data).prj || (ref1$.prj = {}))[key$ = context.key] || (ref$[key$] = {});
                    obj.picked = !obj.picked;
                    local.view.render();
                    return this$.update({
                      debounced: 10
                    });
                  }
                }
              },
              text: {
                budget: function(arg$){
                  var context, b, total;
                  context = arg$.context;
                  if (!(b = context.info.budget)) {
                    return '';
                  }
                  total = (b.self || 0) + (b.subsidy || 0);
                  return Math.round(total / 10000) + "萬";
                },
                subsidy: function(arg$){
                  var context, b, total;
                  context = arg$.context;
                  if (!(b = context.info.budget)) {
                    return '';
                  }
                  total = b.subsidy || 0;
                  return Math.round(total / 10000) + "萬";
                },
                name: function(arg$){
                  var context;
                  context = arg$.context;
                  return context.name || '(未命名)';
                },
                ownername: function(arg$){
                  var context;
                  context = arg$.context;
                  return context.info.teamname || context.ownername || '';
                },
                key: function(arg$){
                  var context;
                  context = arg$.context;
                  return context.key || '';
                }
              },
              handler: {
                rate: function(arg$){
                  var node, context;
                  node = arg$.node, context = arg$.context;
                  return node.innerText = (context.rate * 100).toFixed(1) + "%";
                },
                option: function(arg$){
                  var node, v, jinfo, ref$, ref1$, span, type;
                  node = arg$.node;
                  v = node.getAttribute('data-value');
                  jinfo = ((ref$ = (ref1$ = this$.grpinfo).judge || (ref1$.judge = {})).primary || (ref$.primary = {})) || {};
                  span = ld$.find(node, 'span', 0);
                  type = jinfo["option-type"];
                  return node.classList.toggle('d-none', v === '1' && type === '2way' ? true : false);
                },
                "show-budget": function(arg$){
                  var node, ref$;
                  node = arg$.node;
                  return node.classList.toggle('d-none', !((ref$ = this$.grpinfo.form).purpose || (ref$.purpose = {})).budget);
                },
                pick: function(arg$){
                  var node, context, cls, obj, ref$, key$, ref1$, cl, icon;
                  node = arg$.node, context = arg$.context;
                  cls = [['text-white', 'bg-success'], ['text-secondary', 'bg-light']];
                  obj = (ref$ = (ref1$ = this$.data).prj || (ref1$.prj = {}))[key$ = context.key] || (ref$[key$] = {});
                  cl = node.classList;
                  cl.add.apply(cl, obj.picked
                    ? cls[0]
                    : cls[1]);
                  cl.remove.apply(cl, obj.picked
                    ? cls[1]
                    : cls[0]);
                  cls = [['i-check'], ['i-circle']];
                  icon = ld$.find(node, 'i', 0);
                  cl = icon.classList;
                  cl.add.apply(cl, obj.picked
                    ? cls[0]
                    : cls[1]);
                  return cl.remove.apply(cl, obj.picked
                    ? cls[1]
                    : cls[0]);
                },
                "has-comment": function(arg$){
                  var node, context, ref$, key$;
                  node = arg$.node, context = arg$.context;
                  return node.classList.toggle('invisible', !((ref$ = this$.data.prj)[key$ = context.key] || (ref$[key$] = {})).comment);
                },
                progress: function(arg$){
                  var node, context, n;
                  node = arg$.node, context = arg$.context;
                  n = node.getAttribute('data-name');
                  return node.style.width = 100 * (context.count || (context.count = {}))[n] / ((context.count || (context.count = {})).total || 1) + "%";
                },
                count: function(arg$){
                  var node, context, n;
                  node = arg$.node, context = arg$.context;
                  n = node.getAttribute('data-name');
                  return node.innerText = (context.count || (context.count = {}))[n] || 0;
                }
              }
            });
          },
          handler: function(arg$){
            var node, local, data;
            node = arg$.node, local = arg$.local, data = arg$.data;
            local.view.setContext(data);
            return local.view.render();
          }
        }
      }
    });
    return this;
  };
  Ctrl.prototype = import$(import$({}, judgeBase.prototype), {
    opsIn: function(arg$){
      var data, ops, source, ref$;
      data = arg$.data, ops = arg$.ops, source = arg$.source;
      if (source) {
        return;
      }
      this.data = JSON.parse(JSON.stringify(data));
      (ref$ = this.data).prj || (ref$.prj = {});
      return this.render();
    },
    render: function(){
      this.getProgress();
      this.getCount();
      this.view.base.render();
      return this.view.local.render();
    },
    reconnect: function(){
      var this$ = this;
      return this.getdoc().then(function(){
        return this$.sort('name', null, false);
      }).then(function(){
        return console.log("initied.");
      });
    },
    init: function(){
      var this$ = this;
      return Promise.resolve().then(function(){
        return this$.auth();
      }).then(function(){
        return this$.initView();
      }).then(function(){
        return this$.fetchInfo();
      }).then(function(){
        var ref$, ref1$;
        return this$.judge = (ref$ = (ref1$ = this$.grpinfo).judgePerm || (ref1$.judgePerm = {})).list || (ref$.list = []);
      }).then(function(){
        return this$.fetchPrjs();
      }).then(function(){
        return this$.sharedb();
      }).then(function(){
        return this$.reconnect();
      })['catch'](error());
    },
    getCount: function(){
      var len, this$ = this;
      len = this.judge.length;
      return this.prjs.map(function(p, i){
        var count;
        p.count = count = {
          accept: 0,
          pending: 0,
          reject: 0,
          total: len
        };
        this$.judge.map(function(j){
          var u, v, ref$, key$;
          if (!(u = this$.data.user[j.key])) {
            return;
          }
          if ((v = ((ref$ = u.prj)[key$ = p.key] || (ref$[key$] = {})).v) != null) {
            return count[typemap[v]]++;
          }
        });
        return p.rate = count.accept / (count.total || 1);
      });
    },
    getProgress: function(){
      var ret, this$ = this;
      this.progress = ret = {
        done: 0,
        accept: 0,
        pending: 0,
        reject: 0,
        total: this.prjs.length || 1
      };
      this.prjs.map(function(p){
        var v, ref$, key$;
        if (v = ((ref$ = this$.data.prj)[key$ = p.key] || (ref$[key$] = {})).v) {
          return ret[v]++;
        }
      });
      return ret.done = ret.accept + ret.pending + ret.reject || 0;
    }
  });
  ctrl = new Ctrl({
    root: document.body
  });
  return ctrl.init();
});
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}