function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}ldc.register("judgePrimaryAll",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(t){var e,n,r,i,o;return t.notify,e=t.judgeBase,n=t.error,t.loader,t.auth,t.ldcvmgr,t.sdbAdapter,r={0:"accept",1:"pending",2:"reject"},i=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],function(t,e){var n,r;return n=i[e],(r=Array.from(t.classList)).length&&t.classList.remove.apply(t.classList,r),t.classList.add.apply(t.classList,n)},o=function(t){var n,r=this;return import$(this,new e(t)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},this.view.local=n=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(t){var e,n,i;if(e=t.node,r.active)return((n=r.data.prj)[i=r.active.key]||(n[i]={})).comment=e.value,r.update({debounced:300}),r.view.local.render({name:"project",key:r.active.slug})}},click:{detail:function(t){return t.node,r.ldcv.detail.toggle()},criteria:function(t){return t.node,r.ldcv.criteria.toggle()},sort:function(t){var e;return e=t.node,r.sort(e.getAttribute("data-name"),e.getAttribute("data-value"))},"download-csv":function(){var t,e,n,i,o;return t='"名稱","提案單位","入選標記","推薦票數","面議票數","汰除票數","推薦佔例"',e=r.prjs.map(function(t){var e,n,i;return[t.name,t.info.teamname||t.ownername||"",((e=(i=r.data).prj||(i.prj={}))[n=t.key]||(e[n]={})).picked?"O":"",t.count.accept,t.count.pending,t.count.reject,t.rate].map(function(t){return'"'+(""+t).replace('"','\\"')+'"'}).join(",")}).join("\n"),n=t+"\n"+e,i=URL.createObjectURL(new Blob([n],{type:"text/csv"})),o=ld$.create({name:"a",attr:{href:i,download:"result.csv"}}),document.body.appendChild(o),o.click(),document.body.removeChild(o)}}},text:{count:function(t){var e;return e=t.node,r.progress[e.getAttribute("data-name")]||0}},handler:{option:function(t){var e,n,i,o,a,c;return e=t.node,n=e.getAttribute("data-value"),i=(o=(a=r.grpinfo).judge||(a.judge={})).primary||(o.primary={})||{},ld$.find(e,"span",0),c=i["option-type"],i=(o=(a=r.grpinfo).judge||(a.judge={})).primary||(o.primary={})||{},e.classList.toggle("d-none","1"===n&&"2way"===c)},"show-budget":function(t){var e;return t.node.classList.toggle("d-none",!((e=r.grpinfo.form).purpose||(e.purpose={})).budget)},"comment-name":function(t){var e;if(e=t.node,r.active)return e.innerText=r.active.name||""},progress:function(t){var e,n,i,o;return e=t.node,n=t.names,i=r.progress,in$("progress-bar",n)?(o=e.getAttribute("data-name"),e.style.width=100*i[o]/i.total+"%"):in$("progress-percent",n)?e.innerText=Math.round(100*i.done/i.total):void 0},"header-criteria":{list:function(){return r.criteria},action:{click:function(t){var e;return t.node,e=t.data,r.sort("criteria",e.key)}},handler:function(t){var e,n;return e=t.node,n=t.data,e.innerText=n.name}},project:{key:function(t){return t.slug},list:function(){return r.prjs},init:function(t){var e,i,o,a;return e=t.node,i=t.local,o=t.data,a=e,e.classList.remove("d-none"),i.view=new ldView({initRender:!1,root:e,context:o,action:{click:{name:function(t){var e;return t.node,e=t.context,n.get("iframe").setAttribute("src","/dash/prj/"+e.slug+"?simple"),n.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=a,this.activeNode.classList.add("active")},pick:function(t){var e,n,o,a,c;return t.node,e=t.context,n=(o=(c=r.data).prj||(c.prj={}))[a=e.key]||(o[a]={}),n.picked=!n.picked,i.view.render(),r.update({debounced:10})}}},text:{budget:function(t){var e,n,r;return e=t.context,(n=e.info.budget)?(r=(n.self||0)+(n.subsidy||0),Math.round(r/1e4)+"萬"):""},subsidy:function(t){var e,n,r;return e=t.context,(n=e.info.budget)?(r=n.subsidy||0,Math.round(r/1e4)+"萬"):""},name:function(t){return t.context.name||""},ownername:function(t){var e;return(e=t.context).info.teamname||e.ownername||""},key:function(t){return t.context.key||""}},handler:{rate:function(t){var e,n;return e=t.node,n=t.context,e.innerText=(100*n.rate).toFixed(1)+"%"},option:function(t){var e,n,i,o,a,c;return e=t.node,n=e.getAttribute("data-value"),i=(o=(a=r.grpinfo).judge||(a.judge={})).primary||(o.primary={})||{},ld$.find(e,"span",0),c=i["option-type"],e.classList.toggle("d-none","1"===n&&"2way"===c)},"show-budget":function(t){var e;return t.node.classList.toggle("d-none",!((e=r.grpinfo.form).purpose||(e.purpose={})).budget)},pick:function(t){var e,n,i,o,a,c,d,u,s;return e=t.node,n=t.context,i=[["text-white","bg-success"],["text-secondary","bg-light"]],o=(a=(d=r.data).prj||(d.prj={}))[c=n.key]||(a[c]={}),(u=e.classList).add.apply(u,o.picked?i[0]:i[1]),u.remove.apply(u,o.picked?i[1]:i[0]),i=[["i-check"],["i-circle"]],s=ld$.find(e,"i",0),(u=s.classList).add.apply(u,o.picked?i[0]:i[1]),u.remove.apply(u,o.picked?i[1]:i[0])},"has-comment":function(t){var e,n,i,o;return e=t.node,n=t.context,e.classList.toggle("invisible",!((i=r.data.prj)[o=n.key]||(i[o]={})).comment)},progress:function(t){var e,n,r;return e=t.node,n=t.context,r=e.getAttribute("data-name"),e.style.width=100*(n.count||(n.count={}))[r]/((n.count||(n.count={})).total||1)+"%"},count:function(t){var e,n,r;return e=t.node,n=t.context,r=e.getAttribute("data-name"),e.innerText=(n.count||(n.count={}))[r]||0}}})},handler:function(t){var e,n;return t.node,e=t.local,n=t.data,e.view.setContext(n),e.view.render()}}}}),this},o.prototype=import$(import$({},e.prototype),{opsIn:function(t){var e,n;if(e=t.data,t.ops,!t.source)return this.data=JSON.parse(JSON.stringify(e)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.getProgress(),this.getCount(),this.view.base.render(),this.view.local.render()},reconnect:function(){var t=this;return this.getdoc().then(function(){return t.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var t=this;return Promise.resolve().then(function(){return t.auth()}).then(function(){return t.initView()}).then(function(){return t.fetchInfo()}).then(function(){var e,n;return t.judge=(e=(n=t.grpinfo).judgePerm||(n.judgePerm={})).list||(e.list=[])}).then(function(){return t.fetchPrjs()}).then(function(){return t.sharedb()}).then(function(){return t.reconnect()}).catch(n())},getCount:function(){var t,e=this;return t=this.judge.length,this.prjs.map(function(n,i){var o;return n.count=o={accept:0,pending:0,reject:0,total:t},e.judge.map(function(t){var i,a,c,d;if(i=e.data.user[t.key])return null!=(a=((c=i.prj)[d=n.key]||(c[d]={})).v)?o[r[a]]++:void 0}),n.rate=o.accept/(o.total||1)})},getProgress:function(){var t,e=this;return this.progress=t={done:0,accept:0,pending:0,reject:0,total:this.prjs.length||1},this.prjs.map(function(n){var r,i,o;if(r=((i=e.data.prj)[o=n.key]||(i[o]={})).v)return t[r]++}),t.done=t.accept+t.pending+t.reject||0}}),new o({root:document.body}).init()});