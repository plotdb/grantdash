function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}ldc.register("judgePrimaryUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(t){var e,n,r,o;return t.notify,e=t.judgeBase,n=t.error,t.loader,t.auth,t.ldcvmgr,t.sdbAdapter,r=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],function(t,e){var n,o;return n=r[e],(o=Array.from(t.classList)).length&&t.classList.remove.apply(t.classList,o),t.classList.add.apply(t.classList,n)},o=function(t){var n,r,o=this;return import$(this,new e(t)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0),escape:!1}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},n=debounce(function(){return o.view.local.render({name:"project",key:o.active.slug})}),this.view.local=r=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(t){var e,r,i;if(e=t.node,o.active)return((r=o.data.prj)[i=o.active.slug]||(r[i]={})).comment=e.value,o.update({debounced:1e3}),n()}},click:{detail:function(t){return t.node,o.ldcv.detail.toggle()},criteria:function(t){return t.node,o.ldcv.criteria.toggle()},sort:function(t){var e;return e=t.node,o.sort(e.getAttribute("data-name"),e.getAttribute("data-value"))}}},text:{count:function(t){var e;return e=t.node,o.progress[e.getAttribute("data-name")]||0}},handler:{"show-budget":function(t){var e;return t.node.classList.toggle("d-none",!((e=o.grpinfo.form).purpose||(e.purpose={})).budget)},"comment-name":function(t){var e;if(e=t.node,o.active)return e.innerText=o.active.name||""},progress:function(t){var e,n,r,i;return e=t.node,n=t.names,r=o.progress,in$("progress-bar",n)?(i=e.getAttribute("data-name"),e.style.width=100*r[i]/r.total+"%"):in$("progress-percent",n)?e.innerText=Math.round(100*r.done/r.total):void 0},"header-criteria":{list:function(){return o.criteria},action:{click:function(t){var e;return t.node,e=t.data,o.sort("criteria",e.key)}},handler:function(t){var e,n;return e=t.node,n=t.data,e.innerText=n.name}},project:{key:function(t){return t.slug},list:function(){return o.prjs},init:function(t){var e,n,i,a;return e=t.node,n=t.local,i=t.data,a=e,e.classList.remove("d-none"),n.view=new ldView({initRender:!1,root:e,context:i,action:{click:{option:function(t){var e,r,i,a,c;return e=t.node,r=t.context,i=e.getAttribute("data-name"),((a=o.data.prj)[c=r.slug]||(a[c]={})).value=i,n.view.render(),o.getProgress(),o.view.local.render(["progress"]),o.update({debounced:10})},detail:function(t){return t.node,t.context,o.ldcv.detail.toggle()},comment:function(t){var e,n,i;return t.node,e=t.context,o.active=e,r.get("comment").value=((n=o.data.prj)[i=o.active.slug]||(n[i]={})).comment||"",o.ldcv.comment.toggle(),o.view.local.render("comment-name")},name:function(t){var e;return t.node,e=t.context,r.get("iframe").setAttribute("src","/prj/"+e.slug+"?simple"),r.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=a,this.activeNode.classList.add("active")}}},text:{name:function(t){return t.context.name||""},ownername:function(t){var e;return(e=t.context).info.teamname||e.ownername||""},key:function(t){return t.context.key||""},budget:function(t){var e,n,r;return e=t.context,(n=e.info.budget)?(r=(n.self||0)+(n.subsidy||0),Math.round(r/1e4)+"萬"):""},subsidy:function(t){var e,n,r;return e=t.context,(n=e.info.budget)?(r=n.subsidy||0,Math.round(r/1e4)+"萬"):""}},handler:{"show-budget":function(t){var e;return t.node.classList.toggle("d-none",!((e=o.grpinfo.form).purpose||(e.purpose={})).budget)},"has-comment":function(t){var e,n,r,i;return e=t.node,n=t.context,e.classList.toggle("invisible",!((r=o.data.prj)[i=n.slug]||(r[i]={})).comment)},option:function(t){var e,n,r,i,a,c,u;return e=t.node,t.local,n=t.context,r=e.getAttribute("data-name"),i={accept:"bg-success",pending:"bg-warning",reject:"bg-danger"}[r],a=((c=o.data.prj)[u=n.slug]||(c[u]={})).value===r?"add":"remove",e.classList[a].apply(e.classList,[i,"text-white"])}}})},handler:function(t){var e,n;return t.node,e=t.local,n=t.data,e.view.setContext(n),o.getState(n),e.view.render()}}}}),this},o.prototype=import$(import$({},e.prototype),{opsIn:function(t){var e,n;if(e=t.data,t.ops,!t.source)return this.data=JSON.parse(JSON.stringify(e)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.getProgress(),this.view.base.render(),this.view.local.render()},init:function(){var t=this;return Promise.resolve().then(function(){return t.auth()}).then(function(){return t.initView()}).then(function(){return t.user=t.global.user}).then(function(){return t.fetchInfo()}).then(function(){return t.fetchPrjs()}).then(function(){return t.sharedb()}).then(function(){return t.getdoc()}).then(function(){return t.sort("name",null,!1)}).then(function(){return console.log("initied.")}).catch(n)},getState:function(t){var e=this;return t.state=this.criteria.reduce(function(n,r){var o,i,a,c;return o=((i=(a=e.data.prj)[c=t.slug]||(a[c]={})).value||(i.value={}))[r.key],Math.max(n,null!=o?o:1)},0)},getProgress:function(){var t,e=this;return this.progress=t={done:0,accept:0,pending:0,reject:0,total:this.prjs.length||1},this.prjs.map(function(n){var r,o,i;if(r=((o=e.data.prj)[i=n.slug]||(o[i]={})).value)return t[r]++}),t.done=t.accept+t.pending+t.reject||0}}),new o({root:document.body}).init()});