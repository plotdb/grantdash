function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}ldc.register("judgePrimaryUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,n,r,o,i,a,c;return e.notify,t=e.judgeBase,n=e.error,e.loader,e.auth,r=e.ldcvmgr,e.sdbAdapter,o={0:"accept",1:"pending",2:"reject"},i={0:"bg-success",1:"bg-warning",2:"bg-danger"},a=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],function(e,t){var n,r;return n=a[t],(r=Array.from(e.classList)).length&&e.classList.remove.apply(e.classList,r),e.classList.add.apply(e.classList,n)},c=function(e){var n,r,a=this;return import$(this,new t(e)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0),escape:!1}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},n=debounce(function(){return a.view.local.render({name:"project",key:a.active.slug})}),this.view.local=r=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(e){var t,r,o;if(t=e.node,a.active)return((r=a.data.prj)[o=a.active.key]||(r[o]={})).comment=t.value,a.update({debounced:1e3}),n()}},click:{detail:function(e){return e.node,a.ldcv.detail.toggle()},criteria:function(e){return e.node,a.ldcv.criteria.toggle()},sort:function(e){var t;return t=e.node,a.sort(t.getAttribute("data-name"),t.getAttribute("data-value"))}}},text:{count:function(e){var t;return t=e.node,a.progress[o[+t.getAttribute("data-name")]]||0}},handler:{option:function(e){var t,n,r,o,i,c;return t=e.node,n=t.getAttribute("data-value"),r=(o=(i=a.grpinfo).judge||(i.judge={})).primary||(o.primary={})||{},c=r["option-type"],t.classList.toggle("d-none","1"===n&&"2way"===c)},"show-budget":function(e){var t,n;return e.node.classList.toggle("d-none",!((t=(n=a.grpinfo).form||(n.form={})).purpose||(t.purpose={})).budget)},"comment-name":function(e){var t;if(t=e.node,a.active)return t.innerText=a.active.name||""},progress:function(e){var t,n,r,i;return t=e.node,n=e.names,r=a.progress,in$("progress-bar",n)?(i=o[+t.getAttribute("data-name")],t.style.width=100*r[i]/r.total+"%"):in$("progress-percent",n)?t.innerText=Math.round(100*r.done/r.total):void 0},"header-criteria":{list:function(){return a.criteria},action:{click:function(e){var t;return e.node,t=e.data,a.sort("criteria",t.key)}},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.name}},project:{key:function(e){return e.key},list:function(){return a.prjs},init:function(e){var t,n,o,c;return t=e.node,n=e.local,o=e.data,c=t,t.classList.remove("d-none"),n.view=new ldView({initRender:!1,root:t,context:o,action:{click:{option:function(e){var t,r,o,i,c;return t=e.node,r=e.context,o=+t.getAttribute("data-name"),((i=a.data.prj)[c=r.key]||(i[c]={})).v=o,n.view.render(),a.getProgress(),a.view.local.render(["progress"]),a.update({debounced:10})},detail:function(e){return e.node,e.context,a.ldcv.detail.toggle()},comment:function(e){var t,n,o;return e.node,t=e.context,a.active=t,r.get("comment").value=((n=a.data.prj)[o=a.active.key]||(n[o]={})).comment||"",a.ldcv.comment.toggle(),a.view.local.render("comment-name")},name:function(e){var t;return e.node,t=e.context,r.get("iframe").setAttribute("src","/dash/prj/"+t.slug+"?simple"),r.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=c,this.activeNode.classList.add("active")}}},text:{name:function(e){return e.context.name||"(未命名)"},ownername:function(e){var t;return((t=e.context).info||(t.info={})).teamname||t.ownername||""},key:function(e){return e.context.key||""},budget:function(e){var t,n,r;return t=e.context,(n=(t.info||(t.info={})).budget)?(r=(n.self||0)+(n.subsidy||0),Math.round(r/1e4)+"萬"):""},subsidy:function(e){var t,n,r;return t=e.context,(n=(t.info||(t.info={})).budget)?(r=n.subsidy||0,Math.round(r/1e4)+"萬"):""}},handler:{"show-budget":function(e){var t,n;return e.node.classList.toggle("d-none",!((t=(n=a.grpinfo).form||(n.form={})).purpose||(t.purpose={})).budget)},"has-comment":function(e){var t,n,r,o;return t=e.node,n=e.context,t.classList.toggle("text-primary",!!((r=a.data.prj)[o=n.key]||(r[o]={})).comment)},option:function(e){var t,n,r,o,c,d,s,u;return t=e.node,e.local,n=e.context,r=+t.getAttribute("data-name"),o=i[r],1===r&&t.classList.toggle("d-none","2way"===((c=(d=a.grpinfo).judge||(d.judge={})).primary||(c.primary={}))["option-type"]),s=((c=a.data.prj)[u=n.key]||(c[u]={})).v===r?"add":"remove",t.classList[s].apply(t.classList,[o,"text-white"])}}})},handler:function(e){var t,n;return e.node,t=e.local,n=e.data,t.view.setContext(n),t.view.render()}}}}),this},c.prototype=import$(import$({},t.prototype),{opsIn:function(e){var t,n;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.getProgress(),this.view.base.render(),this.view.local.render()},reconnect:function(){var e=this;return this.getdoc().then(function(){return e.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var e=this;return Promise.resolve().then(function(){return e.auth()}).then(function(){return e.initView()}).then(function(){return e.user=e.global.user}).then(function(){return e.fetchInfo()}).then(function(){return e.fetchPrjs()}).then(function(){return e.sharedb()}).then(function(){return e.reconnect()}).catch(function(e){return 1012===ldError.id(e)||"forbidden"===e.message?r.toggle("access-denied"):n()(e)})},getProgress:function(){var e,t=this;return this.progress=e={done:0,accept:0,pending:0,reject:0,total:this.prjs.length||1},this.prjs.map(function(n){var r,i,a;if(null!=(r=((i=t.data.prj)[a=n.key]||(i[a]={})).v))return e[o[r]]++}),e.done=e.accept+e.pending+e.reject||0}}),new c({root:document.body}).init()});