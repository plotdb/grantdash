function import$(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}ldc.register("judgePrimaryUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){e.notify;var t=e.judgeBase,n=e.error,r=(e.loader,e.auth,e.ldcvmgr),a=(e.sdbAdapter,{0:"accept",1:"pending",2:"reject"}),c={0:"bg-success",1:"bg-warning",2:"bg-danger"},e=function(e){var r,o,i=this;return import$(this,new t(e)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0),escape:!1}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},r=debounce(function(){return i.view.local.render({name:"project",key:i.active.slug})}),this.view.local=o=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(e){var t,n=e.node;if(i.active)return((t=i.data.prj)[e=i.active.key]||(t[e]={})).comment=n.value,i.update({debounced:1e3}),r()}},click:{detail:function(e){e.node;return i.ldcv.detail.toggle()},criteria:function(e){e.node;return i.ldcv.criteria.toggle()},sort:function(e){e=e.node;return i.sort(e.getAttribute("data-name"),e.getAttribute("data-value"))}}},text:{count:function(e){e=e.node;return i.progress[a[+e.getAttribute("data-name")]]||0}},handler:{option:function(e){var t=e.node,n=t.getAttribute("data-value"),e=((e=(e=i.grpinfo).judge||(e.judge={})).primary||(e.primary={})||{})["option-type"];return t.classList.toggle("d-none","1"===n&&"2way"===e)},"show-budget":function(e){return e.node.classList.toggle("d-none",!((e=(e=i.grpinfo).form||(e.form={})).purpose||(e.purpose={})).budget)},"comment-name":function(e){e=e.node;if(i.active)return e.innerText=i.active.name||""},progress:function(e){var t=e.node,n=e.names,r=i.progress;return in$("progress-bar",n)?(e=a[+t.getAttribute("data-name")],t.style.width=100*r[e]/r.total+"%"):in$("progress-percent",n)?t.innerText=Math.round(100*r.done/r.total):void 0},"header-criteria":{list:function(){return i.criteria},action:{click:function(e){e.node;e=e.data;return i.sort("criteria",e.key)}},handler:function(e){var t=e.node,e=e.data;return t.innerText=e.name}},project:{key:function(e){return e.key},list:function(){return i.prjs},init:function(e){var t=e.node,r=e.local,e=e.data,n=t;return t.classList.remove("d-none"),r.view=new ldView({initRender:!1,root:t,context:e,action:{click:{option:function(e){var t=e.node,n=e.context,e=+t.getAttribute("data-name");return((t=i.data.prj)[n=n.key]||(t[n]={})).v=e,r.view.render(),i.getProgress(),i.view.local.render(["progress"]),i.update({debounced:10})},detail:function(e){e.node,e.context;return i.ldcv.detail.toggle()},comment:function(e){e.node;var t=e.context;return i.active=t,o.get("comment").value=((e=i.data.prj)[t=i.active.key]||(e[t]={})).comment||"",i.ldcv.comment.toggle(),i.view.local.render("comment-name")},name:function(e){e.node;e=e.context;return o.get("iframe").setAttribute("src","/dash/prj/"+e.slug+"?simple"),o.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=n,this.activeNode.classList.add("active")}}},text:{name:function(e){return e.context.name||"(未命名)"},ownername:function(e){var t=e.context,e=(e=t.detail||(t.detail={})).custom||(e.custom={});return(e=(e=(e=e.open||e.basic||{})["applicant-zh"]||e["單位名稱"])&&"object"==typeof e?e.v:e)||(t.info||(t.info={})).teamname||t.ownername||""},key:function(e){return e.context.key||""},budget:function(e){var e=e.context;return(e=(e.info||(e.info={})).budget)?(e=(e.self||0)+(e.subsidy||0),Math.round(e/1e4)+"萬"):""},subsidy:function(e){var e=e.context;return(e=(e.info||(e.info={})).budget)?(e=e.subsidy||0,Math.round(e/1e4)+"萬"):""}},handler:{"show-budget":function(e){return e.node.classList.toggle("d-none",!((e=(e=i.grpinfo).form||(e.form={})).purpose||(e.purpose={})).budget)},"has-comment":function(e){var t=e.node,e=e.context;return t.classList.toggle("text-primary",!!((t=i.data.prj)[e=e.key]||(t[e]={})).comment)},option:function(e){var t,n=e.node,r=(e.local,e.context),o=+n.getAttribute("data-name"),e=c[o];return 1==o&&n.classList.toggle("d-none","2way"===((t=(t=i.grpinfo).judge||(t.judge={})).primary||(t.primary={}))["option-type"]),o=((t=i.data.prj)[r=r.key]||(t[r]={})).v===o?"add":"remove",n.classList[o].apply(n.classList,[e,"text-white"])}}})},handler:function(e){e.node;var t=e.local,e=e.data;return t.view.setContext(e),t.view.render()}}}}),this};return e.prototype=import$(import$({},t.prototype),{opsIn:function(e){var t=e.data;e.ops;if(!e.source)return this.data=JSON.parse(JSON.stringify(t)),(t=this.data).prj||(t.prj={}),this.render()},render:function(){return this.getProgress(),this.view.base.render(),this.view.local.render()},reconnect:function(){var e=this;return this.getdoc().then(function(){return e.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var e=this;return Promise.resolve().then(function(){return e.auth()}).then(function(){return e.initView()}).then(function(){return e.user=e.global.user}).then(function(){return e.fetchInfo()}).then(function(){return e.fetchPrjs()}).then(function(){return e.sharedb()}).then(function(){return e.reconnect()}).catch(function(e){return 1012===ldError.id(e)||"forbidden"===e.message?r.toggle("access-denied"):n()(e)})},getProgress:function(){var n,r=this;return this.progress=n={done:0,accept:0,pending:0,reject:0,total:this.prjs.length||1},this.prjs.map(function(e){var t;if(null!=(e=((t=r.data.prj)[e=e.key]||(t[e]={})).v))return n[a[e]]++}),n.done=n.accept+n.pending+n.reject||0}}),new e({root:document.body}).init()});