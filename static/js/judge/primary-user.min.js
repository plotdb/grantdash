function import$(e,t){var r={}.hasOwnProperty;for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e}function in$(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}ldc.register("judgePrimaryUser",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(e){var t,r,n,i,a,o,c;return t=e.notify,r=e.judgeBase,n=e.error,i=e.loader,e.auth,e.ldcvmgr,e.sdbAdapter,a=[["i-check","text-success"],["i-circle","text-secondary"],["i-close","text-danger"]],function(e,t){var r,n;return r=a[t],(n=Array.from(e.classList)).length&&e.classList.remove.apply(e.classList,n),e.classList.add.apply(e.classList,r)},o=function(e){var t,n=this;return import$(this,new r(e)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},this.view=t=new ldView({initRender:!1,root:this.root,action:{input:{comment:function(e){var t,r,i;if(t=e.node,n.active)return((r=n.data.prj)[i=n.active.slug]||(r[i]={})).comment=t.value,n.update({debounced:300}),n.view.render({name:"project",key:n.active.slug})}},click:{detail:function(e){return e.node,n.ldcv.detail.toggle()},criteria:function(e){return e.node,n.ldcv.criteria.toggle()},sort:function(e){var t;return t=e.node,n.sort(t.getAttribute("data-name"),t.getAttribute("data-value"))}}},text:{count:function(e){var t;return t=e.node,n.progress[t.getAttribute("data-name")]||0},reviewer:function(e){if(e.node,n.user)return n.user.displayname},"grp-name":function(e){return e.node,n.brdinfo.name+" / "+n.grpinfo.info.name}},handler:{"comment-name":function(e){var t;if(t=e.node,n.active)return t.innerText=n.active.name||""},progress:function(e){var t,r,i,a;return t=e.node,r=e.names,i=n.progress,in$("progress-bar",r)?(a=t.getAttribute("data-name"),t.style.width=100*i[a]/i.total+"%"):in$("progress-percent",r)?t.innerText=Math.round(100*i.done/i.total):void 0},"header-criteria":{list:function(){return n.criteria},action:{click:function(e){var t;return e.node,t=e.data,n.sort("criteria",t.key)}},handler:function(e){var t,r;return t=e.node,r=e.data,t.innerText=r.name}},project:{key:function(e){return e.slug},list:function(){return n.prjs},init:function(e){var r,i,a,o;return r=e.node,i=e.local,a=e.data,o=r,r.classList.remove("d-none"),i.view=new ldView({initRender:!1,root:r,context:a,action:{click:{option:function(e){var t,r,a,o,c;return t=e.node,r=e.context,a=t.getAttribute("data-name"),((o=n.data.prj)[c=r.slug]||(o[c]={})).value=a,i.view.render(),n.getProgress(),n.view.render(["progress"]),n.update({debounced:10})},detail:function(e){return e.node,e.context,n.ldcv.detail.toggle()},comment:function(e){var r,i,a;return e.node,r=e.context,n.active=r,t.get("comment").value=((i=n.data.prj)[a=n.active.slug]||(i[a]={})).comment||"",n.ldcv.comment.toggle(),n.view.render("comment-name")},name:function(e){var r;return e.node,r=e.context,t.get("iframe").setAttribute("src","/prj/"+r.slug+"?simple"),t.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=o,this.activeNode.classList.add("active")}}},handler:{"has-comment":function(e){var t,r,i,a;return t=e.node,r=e.context,t.classList.toggle("invisible",!((i=n.data.prj)[a=r.slug]||(i[a]={})).comment)},name:function(e){var t,r;return t=e.node,r=e.context,t.innerText=r.name},key:function(e){var t,r;return t=e.node,r=e.context,t.innerText=r.key||""},option:function(e){var t,r,i,a,o,c,s;return t=e.node,e.local,r=e.context,i=t.getAttribute("data-name"),a={accept:"bg-success",pending:"bg-warning",reject:"bg-danger"}[i],o=((c=n.data.prj)[s=r.slug]||(c[s]={})).value===i?"add":"remove",t.classList[o].apply(t.classList,[a,"text-white"])}}})},handler:function(e){var t,r;return e.node,t=e.local,r=e.data,t.view.setContext(r),n.getState(r),t.view.render()}}}}),this},o.prototype=import$(import$({},r.prototype),{opsIn:function(e){var t,r;if(t=e.data,e.ops,!e.source)return this.data=JSON.parse(JSON.stringify(t)),(r=this.data).prj||(r.prj={}),this.render()},render:function(){return this.getProgress(),this.view.render()},fetchInfo:function(){var e=this;return console.log("fetch info ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/info",{method:"POST"},{json:{fields:["criteria"]},type:"json"}).then(function(t){return e.brdinfo=t.brd,e.grpinfo=t.grp,e.criteria=t.grp.criteria.entries})},init:function(){var e=this;return Promise.resolve().then(function(){return c.auth()}).then(function(){return e.user=e.global.user}).then(function(){return c.fetchInfo()}).then(function(){return c.fetchPrjs()}).then(function(){return c.sharedb()}).then(function(){return c.getdoc()}).then(function(){return e.sort("name",null,!1)}).then(function(){return console.log("initied.")}).catch(n)},sort:function(e,r,n){var a,o,c,s=this;return null==n&&(n=!0),n&&i.on(),a=e+""+(null!=r?"-"+r:""),this.sort.inversed||(this.sort.inversed={}),o=this.sort.inversed[a]?1:-1,c={name:r||{name:"名稱",state:"狀態",comment:"評論長度"}[e],dir:o>0?"順向":"逆向"},"count"===e?c.name={accept:"通過",pending:"待審",reject:"不符"}[r]+"的數量":"primary"===e&&(c.name={accept:"通過",pending:"待審",reject:"不符"}[r]+" 的結果"),n&&t.send("success","重新將表格依 "+c.name+" 做 "+c.dir+" 排序"),debounce(100).then(function(){var t;return s.sort.inversed[a]=!s.sort.inversed[a],t=[2,0,1],"state"===e?s.prjs.sort(function(e,r){return o*(t[e.state]-t[r.state])}):"name"===e?s.prjs.sort(function(e,t){return o*(e.name>t.name?1:e.name<t.name?-1:0)}):"comment"===e?s.prjs.sort(function(e,t){var r,n;return o*((((r=s.data.prj)[n=e.slug]||(r[n]={})).comment||"").length-(((r=s.data.prj)[n=t.slug]||(r[n]={})).comment||"").length)}):"criteria"===e?s.prjs.sort(function(e,n){var i,a,c;return e=((i=(a=s.data.prj)[c=e.slug]||(a[c]={})).value||(i.value={}))[r],n=((i=(a=s.data.prj)[c=n.slug]||(a[c]={})).value||(i.value={}))[r],e=null!=e?e:1,n=null!=n?n:1,o*(t[e]-t[n])}):"primary"===e&&s.prjs.sort(function(e,t){var n,i,a;return e=((n=(i=s.data.prj)[a=e.slug]||(i[a]={})).value||(n.value={}))===r?1:0,t=((n=(i=s.data.prj)[a=t.slug]||(i[a]={})).value||(n.value={}))===r?1:0,o*(e-t)}),n&&i.off(),s.render()})},getState:function(e){var t=this;return e.state=this.criteria.reduce(function(r,n){var i,a,o,c;return i=((a=(o=t.data.prj)[c=e.slug]||(o[c]={})).value||(a.value={}))[n.key],Math.max(r,null!=i?i:1)},0)},getProgress:function(){var e,t=this;return this.progress=e={done:0,accept:0,pending:0,reject:0,total:this.prjs.length||1},this.prjs.map(function(r){var n,i,a;if(n=((i=t.data.prj)[a=r.slug]||(i[a]={})).value)return e[n]++}),e.done=e.accept+e.pending+e.reject||0}}),(c=new o({root:document.body})).init()});