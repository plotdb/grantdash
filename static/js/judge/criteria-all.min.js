function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}ldc.register("judgeCriteriaAll",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(t){var e,n,r,i,o,a;return e=t.notify,n=t.judgeBase,r=t.error,i=t.loader,t.auth,t.ldcvmgr,t.sdbAdapter,o=function(t){var e,r=this;return import$(this,new n(t)),this.data={prj:{}},this.active=null,this.ldcv={comment:new ldCover({root:ld$.find(this.root,"[ld=comment-ldcv]",0)}),detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},this.view=e=new ldView({initRender:!1,root:this.root,action:{click:{detail:function(t){return t.node,r.ldcv.detail.toggle()},criteria:function(t){return t.node,r.ldcv.criteria.toggle()},sort:function(t){var e;return e=t.node,r.sort(e.getAttribute("data-name"),e.getAttribute("data-value"))}}},text:{"grp-name":function(t){return t.node,r.brdinfo.name+" / "+r.grpinfo.info.name},count:function(t){var e;return e=t.node,r.progress[e.getAttribute("data-name")]||0}},handler:{"comment-name":function(t){var e;if(e=t.node,r.active)return e.innerText=r.active.name||""},progress:function(t){var e,n,i,o;return e=t.node,n=t.names,i=r.progress,in$("progress-bar",n)?(o=e.getAttribute("data-name"),e.style.width=100*i[o]/i.total+"%"):in$("progress-percent",n)?e.innerText=Math.round(100*i.done/i.total):void 0},project:{key:function(t){return t.slug},list:function(){return r.prjs},init:function(t){var n,i,o,a;return n=t.node,i=t.local,o=t.data,a=n,n.classList.remove("d-none"),i.view=new ldView({initRender:!1,root:n,context:o,action:{click:{detail:function(t){return t.node,t.context,r.ldcv.detail.toggle()},comment:function(t){var n,i,o;return t.node,n=t.context,r.active=n,e.get("comment").value=((i=r.data.prj)[o=r.active.slug]||(i[o]={})).comment||"",r.ldcv.comment.toggle(),r.view.render("comment-name")},name:function(t){var n;return t.node,n=t.context,e.get("iframe").setAttribute("src","/prj/"+n.slug+"?simple"),e.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=a,this.activeNode.classList.add("active")}}},handler:{count:function(t){var e,n,r,i;return e=t.node,n=t.context,r=e.getAttribute("data-name"),e.innerHTML=function(){var t,e,o,a=[];for(t=0,o=(e=n.count[r]).length;t<o;++t)i=e[t],a.push('<div style="width:.3em;display:inline-block">\n<div class="rounded-circle bg-cover bg-portrait bg-dark border border-light"\nstyle="width:1.5em;height:1.5em;margin-left:-.6em;background-image:url(/s/avatar/'+i+'.png);">\n</div></div>');return a}().join("")},"has-comment":function(t){var e,n,i,o;return e=t.node,n=t.context,e.classList.toggle("invisible",!((i=r.data.prj)[o=n.slug]||(i[o]={})).comment)},state:function(t){var e,n,r,i,o,a;return e=t.node,n=t.context,r=ld$.find(e,"span",0),i=ld$.find(e,"i",0),o=n.state,i.classList.remove.apply(i.classList,i.classList),i.classList.add(["i-check","i-circle","i-close"][o]),e.classList.remove.apply(e.classList,e.classList),a=[["bg-success","text-white"],["bg-light","text-secondary"],["bg-danger","text-white"]],e.classList.add.apply(e.classList,a[o].concat(["rounded"])),r.innerText=["通過","待查","不符"][o]},name:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.name},key:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.key||""}}})},handler:function(t){var e,n;return t.node,e=t.local,n=t.data,e.view.setContext(n),r.getCount(n),e.view.render()}}}}),this},o.prototype=import$(import$({},n.prototype),{opsIn:function(t){var e,n;if(e=t.data,t.ops,!t.source)return this.data=JSON.parse(JSON.stringify(e)),(n=this.data).prj||(n.prj={}),this.render()},render:function(){return this.getProgress(),this.view.render()},fetchInfo:function(){var t=this;return console.log("fetch info ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/info",{method:"POST"},{json:{fields:["criteria"]},type:"json"}).then(function(e){return t.brdinfo=e.brd,t.grpinfo=e.grp,t.criteria=e.grp.criteria.entries})},init:function(){var t=this;return Promise.resolve().then(function(){return a.auth()}).then(function(){return a.fetchInfo()}).then(function(){return a.fetchPrjs()}).then(function(){return a.sharedb()}).then(function(){return a.getdoc()}).then(function(){return t.sort("name",null,!1)}).then(function(){return console.log("initied.")}).catch(r)},sort:function(t,n,r){var o,a,s,c=this;return null==r&&(r=!0),r&&i.on(),o=t+""+(null!=n?"-"+n:""),this.sort.inversed||(this.sort.inversed={}),a=this.sort.inversed[o]?1:-1,s={name:{name:"名稱",state:"狀態",comment:"評論長度"}[t]||n,dir:a>0?"順向":"逆向"},"count"===t&&(s.name={accept:"通過",pending:"待審",reject:"不符"}[n]+"的數量"),r&&e.send("success","重新將表格依 "+s.name+" 做 "+s.dir+" 排序"),debounce(100).then(function(){var e;return c.sort.inversed[o]=!c.sort.inversed[o],e=[2,0,1],"state"===t?c.prjs.sort(function(t,n){return a*(e[t.state]-e[n.state])}):"name"===t?c.prjs.sort(function(t,e){return a*(t.name>e.name?1:t.name<e.name?-1:0)}):"comment"===t?c.prjs.sort(function(t,e){var n,r;return a*((((n=c.data.prj)[r=t.slug]||(n[r]={})).comment||"").length-(((n=c.data.prj)[r=e.slug]||(n[r]={})).comment||"").length)}):"criteria"===t?c.prjs.sort(function(t,r){var i,o,s;return t=((i=(o=c.data.prj)[s=t.slug]||(o[s]={})).value||(i.value={}))[n],r=((i=(o=c.data.prj)[s=r.slug]||(o[s]={})).value||(i.value={}))[n],t=null!=t?t:1,r=null!=r?r:1,a*(e[t]-e[r])}):"count"===t&&c.prjs.sort(function(t,e){var r;return a*(((r=t.count)[n]||(r[n]=[])).length-((r=e.count)[n]||(r[n]=[])).length)}),r&&i.off(),c.render()})},getCount:function(t){var e,n,r,i,o,a=[];t.count=e={accept:[],pending:[],reject:[]};for(n in r=(i=this.data).user||(i.user={}))o=r[n],e[["accept","pending","reject"][this.criteria.reduce(function(e,n){var r,i,a,s;return r=((i=(a=o.prj)[s=t.slug]||(a[s]={})).value||(i.value={}))[n.key],Math.max(e,null!=r?r:1)},0)]].push(n),a.push(t.state=e.reject.length?2:e.pending.length?1:0);return a},getProgress:function(){var t,e=this;return t={0:0,1:0,2:0},this.prjs.map(function(n){return null==n.state&&e.getCount(n),t[n.state]++}),this.progress={accept:t[0],pending:t[1],reject:t[2],done:t[0]+t[2],total:this.prjs.length||1}}}),(a=new o({root:document.body})).init()});