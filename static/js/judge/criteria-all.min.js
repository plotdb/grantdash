function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}ldc.register("judgeCriteriaAll",["notify","judgeBase","error","loader","auth","ldcvmgr","sdbAdapter"],function(t){var e,n,r,i;return t.notify,e=t.judgeBase,n=t.error,t.loader,t.auth,r=t.ldcvmgr,t.sdbAdapter,i=function(t){var i,a=this;return import$(this,new e(t)),this.data={prj:{}},this.active=null,this.ldcv={detail:new ldCover({root:ld$.find(this.root,"[ld=detail-ldcv]",0)}),criteria:new ldCover({root:ld$.find(this.root,"[ld=criteria-ldcv]",0)})},this.view.local=i=new ldView({initRender:!1,root:this.root,action:{click:{criteria:function(t){return t.node,a.ldcv.criteria.toggle()},sort:function(t){var e;return e=t.node,a.sort(e.getAttribute("data-name"),e.getAttribute("data-value"))},publish:function(t){return t.node,r.get("confirm-publish").then(function(t){var e;if("yes"===t)return e={prjs:a.prjs.filter(function(t){return 0===t.state}).map(function(t){return t.key})},ld$.fetch("/dash/api/brd/"+a.brd+"/grp/"+a.grp+"/judge/"+a.type+"/publish",{method:"POST"},{json:e}).then(function(){return r.toggle("published",!0)}).then(function(){return debounce(1500)}).then(function(){return r.toggle("published",!1)})}).catch(n())}}},text:{count:function(t){var e;return e=t.node,a.progress[e.getAttribute("data-name")]||0}},handler:{"comment-name":function(t){var e;if(e=t.node,a.active)return e.innerText=a.active.name||""},progress:function(t){var e,n,r,i;return e=t.node,n=t.names,r=a.progress,in$("progress-bar",n)?(i=e.getAttribute("data-name"),e.style.width=100*r[i]/r.total+"%"):in$("progress-percent",n)?e.innerText=Math.round(100*r.done/r.total):void 0},detail:{list:function(){var t,e,n,r,i,o,c;if(!a.prj)return[];t=[];for(e in n=a.data.user)r=n[e],i=(o=r.prj)[c=a.prj.key]||(o[c]={}),t.push({user:e,name:a.usermap[e].displayname,comment:i.comment||"",criteria:a.criteria.map(function(t){return{name:t.name,value:null!=(i.v||(i.v={}))[t.key]?i.v[t.key]:1}})});return t.sort(function(t,e){return(null!=e.comment?e.comment.length:0)-(null!=t.comment?t.comment.length:0)})},init:function(t){var e,n,r;return e=t.node,n=t.local,r=t.data,n.view=new ldView({root:e,context:r,text:{name:function(t){return t.context.name}},handler:{comment:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.comment||"( 沒有評論 )",e.classList.toggle("text-muted",!n.comment)},avatar:function(t){var e,n;return e=t.node,n=t.context,e.style.backgroundImage="url(/dash/s/avatar/"+n.user+".png)"},criteria:{list:function(t){return t.context.criteria},handler:function(t){var e,n,r,i;return e=t.node,n=t.data,ld$.find(e,"[ld=name]",0).innerText=n.name,r=ld$.find(e,"[ld=value]",0),i=ld$.find(r,"i",0),r.classList.remove("text-success","text-secondary","text-danger"),r.classList.add(["text-success","text-secondary","text-danger"][n.value]),i.classList.remove("i-close","i-circle","i-check"),i.classList.add(["i-check","i-circle","i-close"][n.value])}}}})}},project:{key:function(t){return t.slug},list:function(){return a.prjs},init:function(t){var e,n,r,o;return e=t.node,n=t.local,r=t.data,o=e,e.classList.remove("d-none"),n.view=new ldView({initRender:!1,root:e,context:r,action:{click:{detail:function(t){var e;return t.node,e=t.context,a.prj=e,a.view.local.render("comment"),a.view.local.render("detail"),a.ldcv.detail.toggle()},name:function(t){var e;return t.node,e=t.context,i.get("iframe").setAttribute("src","/dash/prj/"+e.slug+"?simple"),i.get("iframe-placeholder").classList.add("d-none"),this.activeNode&&this.activeNode.classList.remove("active"),this.activeNode=o,this.activeNode.classList.add("active")}}},handler:{count:function(t){var e,n,r,i,o,c,s,u,d;for(e=t.node,n=t.context,r=e.getAttribute("data-name"),i="",o=0,s=(c=n.count[r]).length;o<s;++o)i+='<div style="width:.3em;display:inline-block">\n<div class="rounded-circle bg-cover bg-portrait bg-dark border border-light has-tips"\nstyle="width:1.5em;height:1.5em;margin-left:-.6em;background-image:url(/dash/s/avatar/'+(u=c[o])+'.png);">\n<div class="hover-tip bottom tip-sm">'+(a.usermap?((d=a.usermap)[u]||(d[u]={})).displayname:"")+"</div>\n</div></div>";return e.innerHTML=i},detail:function(t){var e,n,r,i,a,o;if(e=t.node,n=t.context,r=function(){var t,e=[];for(i in t=n.comments)a=t[i],e.push(a);return e}().filter(function(t){return t}).length,o=ld$.find(e,"i",0))return o.classList.toggle("text-primary",r),o.classList.toggle("text-secondary",!r)},state:function(t){var e,n,r,i,a,o;return e=t.node,n=t.context,r=ld$.find(e,"span",0),i=ld$.find(e,"i",0),a=null!=n.state?n.state:1,i.classList.remove.apply(i.classList,i.classList),i.classList.add(["i-check","i-circle","i-close"][a]),e.classList.remove.apply(e.classList,e.classList),o=[["bg-success","text-white"],["bg-light","text-secondary"],["bg-danger","text-white"]],e.classList.add.apply(e.classList,(o[a]||[]).concat(["rounded"])),r.innerText=["通過","待查","不符"][a]},name:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.name},key:function(t){var e,n;return e=t.node,n=t.context,e.innerText=n.key||""}}})},handler:function(t){var e,n;return t.node,e=t.local,n=t.data,e.view.setContext(n),a.getCount(n),e.view.render()}}}}),this},i.prototype=import$(import$({},e.prototype),{opsIn:function(t){var e,n,r,i,a,o=this;if(e=t.data,t.ops,!t.source){this.data=JSON.parse(JSON.stringify(e)),r=[];for(i in(a=this.data).user||(a.user={}))r.push(i);return n=r,this.getDisplayname(n).then(function(){return o.prjs.map(function(t){var e,n,r,i,a,c,s=[];t.comments={};for(e in n=(r=o.data).user||(r.user={}))i=n[e],s.push(t.comments[e]=((r=(c=i||{}).prj||(c.prj={}))[a=t.key]||(r[a]={})).comment||"");return s}),o.render()})}},render:function(){return this.getProgress(),this.view.base.render(),this.view.local.render()},reconnect:function(){var t=this;return this.getdoc().then(function(){return t.sort("name",null,!1)}).then(function(){return console.log("initied.")})},init:function(){var t=this;return Promise.resolve().then(function(){return t.auth()}).then(function(){return t.initView()}).then(function(){return t.fetchInfo()}).then(function(){return t.fetchPrjs()}).then(function(){return t.sharedb()}).then(function(){return t.reconnect()}).catch(n())},getCount:function(t){var e,n,r,i,a,o=[];t.count=e={accept:[],pending:[],reject:[]};for(n in r=(i=this.data).user||(i.user={}))a=r[n],e[["accept","pending","reject"][this.criteria.reduce(function(e,n){var r,i,o,c;return r=((i=(o=a.prj)[c=t.key]||(o[c]={})).v||(i.v={}))[n.key],Math.max(e,null!=r?r:1)},0)]].push(n),o.push(t.state=e.reject.length?2:e.accept.length?0:1);return o},getProgress:function(){var t,e=this;return t={0:0,1:0,2:0},this.prjs.map(function(n){return null==n.state&&e.getCount(n),t[n.state]++}),this.progress={accept:t[0],pending:t[1],reject:t[2],done:t[0]+t[2],total:this.prjs.length||1}}}),new i({root:document.body}).init()});