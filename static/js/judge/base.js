// Generated by LiveScript 1.3.0
ldc.register('judgeBase', ['notify', 'error', 'loader', 'auth', 'ldcvmgr', 'sdbAdapter'], function(arg$){
  var notify, error, loader, auth, ldcvmgr, sdbAdapter, Ctrl;
  notify = arg$.notify, error = arg$.error, loader = arg$.loader, auth = arg$.auth, ldcvmgr = arg$.ldcvmgr, sdbAdapter = arg$.sdbAdapter;
  Ctrl = function(opt){
    var ret, ref$, brd, grp, type, lv, root;
    this.loader = loader;
    this.brd = opt.brd;
    this.grp = opt.grp;
    this.user = opt.user;
    ret = /brd\/([^/]+)\/grp\/([^/]+)\/judge\/([^/]+)\/([^/]+)$/.exec(window.location.href);
    if (!ret) {
      throw new ldError(1015);
    }
    ref$ = ret.slice(1), brd = ref$[0], grp = ref$[1], type = ref$[2], lv = ref$[3];
    if (!((type === 'criteria' || type === 'primary' || type === 'final') && (lv === 'user' || lv === 'all'))) {
      throw new ldError(1015);
    }
    this.brd = brd;
    this.grp = grp;
    this.type = type;
    this.lv = lv;
    this.root = root = typeof opt.root === 'string'
      ? document.querySelector(opt.root)
      : opt.root;
    this.prjs = [];
    this.data = {};
    this.view = {};
    return this;
  };
  Ctrl.prototype = import$(import$(Object.create(Object.prototype), sdbAdapter['interface']), {
    init: function(){},
    render: function(){},
    initView: function(){
      var this$ = this;
      return this.view.base = new ldView({
        initRender: false,
        root: this.root,
        text: {
          reviewer: function(arg$){
            var node;
            node = arg$.node;
            if (this$.user) {
              return this$.user.displayname;
            }
          },
          "grp-name": function(arg$){
            var node;
            node = arg$.node;
            return this$.brdinfo.name + " / " + this$.grpinfo.info.name;
          }
        }
      });
    },
    _update: function(){
      var this$ = this;
      return this.opsOut(function(){
        return this$.data;
      });
    },
    update: function(opt){
      var this$ = this;
      opt == null && (opt = {});
      if (!opt.debounced) {
        return this._update();
      } else {
        return debounce(opt.debounced).then(function(){
          return this$._update();
        });
      }
    },
    fetchPrjs: function(){
      var this$ = this;
      console.log("fetch prjs ... ");
      return ld$.fetch("/dash/api/brd/" + this.brd + "/grp/" + this.grp + "/judge-list", {
        method: 'GET'
      }, {
        type: 'json'
      }).then(function(it){
        return this$.prjs = it;
      });
    },
    fetchInfo: function(){
      var this$ = this;
      console.log("fetch info ... ");
      return ld$.fetch("/dash/api/brd/" + this.brd + "/grp/" + this.grp + "/info", {
        method: 'POST'
      }, {
        json: {
          fields: ['criteria']
        },
        type: 'json'
      }).then(function(ret){
        this$.brdinfo = ret.brd;
        this$.grpinfo = ret.grp;
        return this$.criteria = ret.grp.criteria.entries;
      });
    },
    sharedb: function(){
      var sdb, this$ = this;
      console.log("prepare sharedb ...");
      this.sdb = sdb = new sharedbWrapper({
        url: {
          scheme: window.location.protocol.replace(':', ''),
          domain: window.location.host
        },
        path: '/dash/ws'
      });
      this.hub = new Hub({
        sdb: sdb
      });
      sdb.on('error', function(){
        return ldcvmgr.toggle('not-sync');
      });
      sdb.on('close', function(){
        ldcvmgr.toggle('offline-retry', true);
        return sdb.reconnect().then(function(){
          return this$.getdoc();
        }).then(function(){
          return this$.adapt({
            hub: this$.hub,
            path: []
          });
        }).then(function(){
          return console.log("reinitialized.");
        }).then(function(){
          return ldcvmgr.toggle('offline-retry', false);
        });
      });
      return sdb.ready();
    },
    getdoc: function(){
      var this$ = this;
      console.log("get judge document ... ");
      this.hub.doc = null;
      return this.sdb.get({
        id: "brd/" + this.brd + "/grp/" + this.grp + "/judge/" + this.type,
        watch: function(ops, source){
          return this$.hub.fire('change', {
            ops: ops,
            source: source
          });
        },
        create: function(){
          return {};
        }
      }).then(function(doc){
        this$.hub.doc = doc;
        return this$.adapt({
          hub: this$.hub,
          path: this$.user
            ? ['user', this$.user]
            : []
        });
      });
    },
    opsIn: function(){},
    auth: function(){
      var this$ = this;
      console.log("get user auth info ...");
      return auth.get().then(function(g){
        return this$.global = g;
      });
    },
    sort: function(name, value, hint){
      var n, dir, verbose, this$ = this;
      hint == null && (hint = true);
      if (hint) {
        loader.on();
      }
      n = name + "" + (value != null ? '-' + value : '');
      if (!this.sort.inversed) {
        this.sort.inversed = {};
      }
      dir = this.sort.inversed[n]
        ? 1
        : -1;
      verbose = {
        name: {
          name: "名稱",
          state: "狀態",
          comment: "評論長度",
          shortlist: "入選標記"
        }[name] || value,
        dir: dir > 0 ? "順向" : "逆向"
      };
      if (name === 'count') {
        verbose.name = {
          accept: "通過",
          pending: "待審",
          reject: "不符"
        }[value] + "的數量";
      } else if (name === 'primary' || name === 'primary-all') {
        verbose.name = {
          accept: "推薦",
          pending: "待審",
          reject: "汰除"
        }[value] + " 的結果";
      }
      if (hint) {
        notify.send('success', "重新將表格依 " + verbose.name + " 做 " + verbose.dir + " 排序");
      }
      return debounce(100).then(function(){
        var statemap;
        this$.sort.inversed[n] = !this$.sort.inversed[n];
        statemap = [2, 0, 1];
        if (name === 'state') {
          this$.prjs.sort(function(a, b){
            return dir * (statemap[a.state] - statemap[b.state]);
          });
        } else if (name === 'name') {
          this$.prjs.sort(function(a, b){
            return dir * (a.name > b.name
              ? 1
              : a.name < b.name ? -1 : 0);
          });
        } else if (name === 'comment') {
          this$.prjs.sort(function(a, b){
            var ref$, key$;
            return dir * ((((ref$ = this$.data.prj)[key$ = a.slug] || (ref$[key$] = {})).comment || '').length - (((ref$ = this$.data.prj)[key$ = b.slug] || (ref$[key$] = {})).comment || '').length);
          });
        } else if (name === 'criteria') {
          this$.prjs.sort(function(a, b){
            var ref$, ref1$, key$;
            a = ((ref$ = (ref1$ = this$.data.prj)[key$ = a.slug] || (ref1$[key$] = {})).value || (ref$.value = {}))[value];
            b = ((ref$ = (ref1$ = this$.data.prj)[key$ = b.slug] || (ref1$[key$] = {})).value || (ref$.value = {}))[value];
            a = a != null ? a : 1;
            b = b != null ? b : 1;
            return dir * (statemap[a] - statemap[b]);
          });
        } else if (name === 'primary-all') {
          this$.prjs.sort(function(a, b){
            return dir * (a.count[value] || 0) - (b.count[value] || 0);
          });
        } else if (name === 'primary') {
          this$.prjs.sort(function(a, b){
            var ref$, key$;
            a = ((ref$ = this$.data.prj)[key$ = a.slug] || (ref$[key$] = {})).value === value ? 1 : 0;
            b = ((ref$ = this$.data.prj)[key$ = b.slug] || (ref$[key$] = {})).value === value ? 1 : 0;
            return dir * (a - b);
          });
        } else if (name === 'count') {
          this$.prjs.sort(function(a, b){
            var ref$;
            return dir * (((ref$ = a.count)[value] || (ref$[value] = [])).length - ((ref$ = b.count)[value] || (ref$[value] = [])).length);
          });
        } else if (name === 'shortlist') {
          this$.prjs.sort(function(a, b){
            var ref$, key$;
            a = ((ref$ = this$.data.prj)[key$ = a.slug] || (ref$[key$] = {})).picked ? 1 : 0;
            b = ((ref$ = this$.data.prj)[key$ = b.slug] || (ref$[key$] = {})).picked ? 1 : 0;
            return dir * (a - b);
          });
        }
        if (hint) {
          loader.off();
        }
        return this$.render();
      });
    }
  });
  return Ctrl;
});
function import$(obj, src){
  var own = {}.hasOwnProperty;
  for (var key in src) if (own.call(src, key)) obj[key] = src[key];
  return obj;
}