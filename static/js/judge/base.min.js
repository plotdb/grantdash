function import$(r,t){var e={}.hasOwnProperty;for(var n in t)e.call(t,n)&&(r[n]=t[n]);return r}ldc.register("judgeBase",["notify","error","loader","auth","ldcvmgr","sdbAdapter"],function(r){var t,e,n,i,o,s,u;return t=r.notify,e=r.error,n=r.loader,i=r.auth,o=r.ldcvmgr,s=r.sdbAdapter,u=function(r){var t,e,i,o,s,u,a,c;if(this.loader=n,this.brd=r.brd,this.grp=r.grp,this.slug=r.slug,this.lv=r.lv,this.round=r.round,this.type=r.type,this.user=r.user,t=r.brd,e=r.grp,i=r.slug,o=r.lv,s=r.round,u=r.type,r.user,(a=/brd\/([^/]+)\/grp\/([^/]+)\/judge\/custom\/([^/]+)\/([^/]+)(?:\/round\/([^/]+))?$/.exec(window.location.href))?(t=(c=a.slice(1))[0],e=c[1],i=c[2],o=c[3],s=c[4],u="custom"):(a=/brd\/([^/]+)\/grp\/([^/]+)\/judge\/([^/]+)\/([^/]+)(?:\/round\/([^/]+))?$/.exec(window.location.href))&&(t=(c=a.slice(1))[0],e=c[1],u=c[2],o=c[3],s=c[4]),"custom"!==u&&"criteria"!==u&&"primary"!==u&&"final"!==u||"user"!==o&&"all"!==o)throw new ldError(1015);return this.brd=t,this.grp=e,this.type=u,this.lv=o,this.round=s,this.slug=i,this.root="string"==typeof r.root?document.querySelector(r.root):r.root,this.prjs=[],this.prjkeymap={},this.data={},this.view={},this},u.prototype=import$(import$(Object.create(Object.prototype),s.interface),{init:function(){},render:function(){},initView:function(){var r=this;return this.view.base=new ldView({initRender:!1,root:this.root,text:{reviewer:function(t){if(t.node,r.user)return r.user.displayname},"grp-name":function(t){return t.node,r.brdinfo.name+" / "+r.grpinfo.info.name}}})},update:function(r){var t=this;return null==r&&(r={}),this._update||(this._update=debounce(function(r){return r.ops?t.opsOut(r.ops):t.opsOut(function(){return t.data})})),r.debounced?this._update.delay(r.debounced)(r):this._update(r).now()},fetchPrjs:function(){var r=this;return console.log("fetch prjs ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/judge-list/"+this.type,{method:"GET"},{type:"json"}).then(function(t){var e,n,i,o,s,u;return r.prjs=t,e="custom"===r.type?((n=(i=(o=r.grpinfo).judge||(o.judge={})).custom||(i.custom={})).entries||(n.entries=[])).filter(function(t){return t.slug===r.slug})[0]||{}:(n=(i=r.grpinfo).judge||(i.judge={}))[s=r.type]||(n[s]={})||{},u=[],(e["filter-criteria"]||"criteria"===e.filter)&&u.push("criteria"),(e["filter-primary"]||"primary"===e.filter)&&u.push("shortlist"),(e["filter-shortlist"]||"shortlist"===e.filter)&&u.push("shortlist"),(e["filter-finalist"]||"finalist"===e.filter)&&u.push("finalist"),(e["filter-winner"]||"winner"===e.filter)&&u.push("winner"),u.length&&(r.prjs=(r.prjs||[]).filter(function(r){return u.reduce(function(t,e){var n;return t&&((n=r.system||(r.system={})).badge||(n.badge={}))[e]},!0)})),r.prjs.map(function(t){if(r.prjkeymap[t.key]=t,t.name.length>25)return t.name=t.name.substring(0,25)+"..."}),r.prjs.sort(function(r,t){return r.key-t.key})})},fetchInfo:function(){var r=this;return console.log("fetch info ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/info",{method:"POST"},{json:{fields:["criteria","grade","judge","form","judgePerm"]},type:"json"}).then(function(t){return r.brdinfo=t.brd,r.grpinfo=t.grp,t.grp.criteria?r.criteria=t.grp.criteria.entries:o.get("judge-criteria-missing")})},sharedb:function(){var r,t=this;return console.log("prepare sharedb ..."),this.sdb=r=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hub=new Hub({sdb:r}),r.on("error",function(){return o.toggle("not-sync")}),r.on("close",function(){return o.toggle("offline-retry",!0),r.reconnect().then(function(){return t.reconnect()}).then(function(){return console.log("reinitialized.")}).then(function(){return o.toggle("offline-retry",!1)})}),r.ready()},getdoc:function(){var r,t=this;return console.log("get judge document ... "),this.hub.doc=null,r="brd/"+this.brd+"/grp/"+this.grp+"/judge/"+this.type+"/",this.slug&&(r=r+"slug/"+this.slug),this.round&&(r=r+"round/"+this.round),this.sdb.get({id:r,watch:function(r,e){return t.hub.fire("change",{ops:r,source:e})},create:function(){return{}}}).then(function(r){return t.hub.doc=r,t.adapt({hub:t.hub,path:t.user?["user",t.user.key]:[]})})},opsIn:function(){},auth:function(){var r=this;return console.log("get user auth info ..."),i.get().then(function(t){return r.global=t})},getDisplayname:function(r){var t,n=this;return this.usermap&&!r.filter(function(r){return!n.usermap[r]}).length?Promise.resolve():(t={userkeys:r},ld$.fetch("/dash/api/usermap/",{method:"PUT"},{json:t,type:"json"}).then(function(r){return null==r&&(r=[]),n.usermap={},r.map(function(r){return n.usermap[r.key]=r})}).catch(e()))},sort:function(r,e,i){var o,s,u,a,c=this;return null==i&&(i=!0),i&&n.on(),o="criteria"===r?r+"-"+e.key:r+""+(null!=e?"-"+e:""),this.sort.inversed||(this.sort.inversed={}),s=this.sort.inversed[o]?1:-1,u={name:"名稱",state:"狀態",comment:"評論長度",comments:"評論長度",shortlist:"入選標記",budget:"預算",total:"總分",rank:"排名","criteria-result":"審查結果","judge-rank":"評審排名","judge-score":"評審分數",rate:"比例"},a={name:u[r]||e,dir:s>0?"順向":"逆向"},"count"===r?a.name={accept:"通過",pending:"待審",reject:"不符"}[e]+"的數量":"primary"===r||"primary-all"===r?(e=+e,a.name={0:"推薦",1:"待審",2:"汰除"}[+e]+" 的結果"):"criteria"===r?a.name=e.name:"grade"===r&&(a.name=e.name),i&&t.send("success","重新將表格依 "+a.name+" 做 "+a.dir+" 排序"),debounce(100).then(function(){var t,u;return c.sort.inversed[o]=!c.sort.inversed[o],t=[2,0,1],"state"===r?c.prjs.sort(function(r,e){return s*(t[r.state]-t[e.state])}):"name"===r?c.prjs.sort(function(r,t){return s*(r.name>t.name?1:r.name<t.name?-1:0)}):"budget"===r?c.prjs.sort(function(r,t){return s*(r.info.budget-t.info.budget)}):"comments"===r?c.prjs.sort(function(r,t){return s*JSON.stringify(r.comments||{}).length-JSON.stringify(t.comments||{}).length}):"comment"===r?c.prjs.sort(function(r,t){var e,n;return s*((((e=c.data.prj)[n=r.key]||(e[n]={})).comment||"").length-(((e=c.data.prj)[n=t.key]||(e[n]={})).comment||"").length)}):"criteria-result"===r?c.prjs.sort(function(r,t){return s*(t.criteria[0]-t.criteria[2]-(r.criteria[0]-r.criteria[2]))}):"criteria"===r?c.prjs.sort(function(r,n){var i,o,u;return r=((i=(o=c.data.prj)[u=r.key]||(o[u]={})).value||(i.value={}))[e.key],n=((i=(o=c.data.prj)[u=n.key]||(o[u]={})).value||(i.value={}))[e.key],r=null!=r?r:1,n=null!=n?n:1,s*(t[r]-t[n])}):"grade"===r?c.prjs.sort(function(r,t){var n,i,o;return r=((n=(i=c.data.prj)[o=r.key]||(i[o]={})).v||(n.v={}))[e.key],t=((n=(i=c.data.prj)[o=t.key]||(i[o]={})).v||(n.v={}))[e.key],r=null!=r?r:0,t=null!=t?t:0,s*(t-r)}):"rate"===r?c.prjs.sort(function(r,t){return s*(t.rate-r.rate)}):"primary-all"===r?(u={0:"accept",1:"pending",2:"reject"}[e],c.prjs.sort(function(r,t){return s*(r.count[u]||0)-(t.count[u]||0)})):"primary"===r?c.prjs.sort(function(r,t){var n,i;return r=((n=c.data.prj)[i=r.key]||(n[i]={})).v===e?1:0,t=((n=c.data.prj)[i=t.key]||(n[i]={})).v===e?1:0,s*(r-t)}):"count"===r?c.prjs.sort(function(r,t){var n;return s*(((n=r.count)[e]||(n[e]=[])).length-((n=t.count)[e]||(n[e]=[])).length)}):"shortlist"===r?c.prjs.sort(function(r,t){var e,n;return r=((e=c.data.prj)[n=r.key]||(e[n]={})).picked?1:0,t=((e=c.data.prj)[n=t.key]||(e[n]={})).picked?1:0,s*(r-t)}):"total"===r?c.prjs.sort(function(r,t){return s*(r.total-t.total)}):"rank"===r?c.prjs.sort(function(r,t){return s*(r.rank-t.rank)}):"judge-score"===r?c.prjs.sort(function(r,t){return s*(((e.score||(e.score={}))[t.key]||0)-((e.score||(e.score={}))[r.key]||0))}):"judge-rank"===r&&c.prjs.sort(function(r,t){return s*(((e.rank||(e.rank={}))[t.key]||0)-((e.rank||(e.rank={}))[r.key]||0))}),i&&n.off(),c.render()})}}),u});