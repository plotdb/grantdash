function import$(t,r){var e={}.hasOwnProperty;for(var n in r)e.call(r,n)&&(t[n]=r[n]);return t}ldc.register("judgeBase",["notify","error","loader","auth","ldcvmgr","sdbAdapter"],function(t){var r,e,n,o,i,u;return r=t.notify,t.error,e=t.loader,n=t.auth,o=t.ldcvmgr,i=t.sdbAdapter,u=function(t){var r,n,o,i,u,a;if(this.loader=e,this.brd=t.brd,this.grp=t.grp,this.user=t.user,!(r=/brd\/([^/]+)\/grp\/([^/]+)\/judge\/([^/]+)\/([^/]+)$/.exec(window.location.href)))throw new ldError(1015);if(n=r.slice(1),o=n[0],i=n[1],u=n[2],a=n[3],"criteria"!==u&&"primary"!==u&&"final"!==u||"user"!==a&&"all"!==a)throw new ldError(1015);return this.brd=o,this.grp=i,this.type=u,this.lv=a,this.root="string"==typeof t.root?document.querySelector(t.root):t.root,this.prjs=[],this.data={},this.view={},this},u.prototype=import$(import$(Object.create(Object.prototype),i.interface),{init:function(){},render:function(){},initView:function(){var t=this;return this.view.base=new ldView({initRender:!1,root:this.root,text:{reviewer:function(r){if(r.node,t.user)return t.user.displayname},"grp-name":function(r){return r.node,t.brdinfo.name+" / "+t.grpinfo.info.name}}})},update:function(t){var r=this;return null==t&&(t={}),this._update||(this._update=debounce(function(){return r.opsOut(function(){return r.data})})),t.debounced?this._update.delay(t.debounced)():this._update().now()},fetchPrjs:function(){var t=this;return console.log("fetch prjs ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/judge-list",{method:"GET"},{type:"json"}).then(function(r){return t.prjs=r,t.prjs.map(function(t){if(t.name.length>25)return t.name=t.name.substring(0,25)+"..."})})},fetchInfo:function(){var t=this;return console.log("fetch info ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/info",{method:"POST"},{json:{fields:["criteria","grade","form"]},type:"json"}).then(function(r){return t.brdinfo=r.brd,t.grpinfo=r.grp,t.criteria=r.grp.criteria.entries})},sharedb:function(){var t,r=this;return console.log("prepare sharedb ..."),this.sdb=t=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hub=new Hub({sdb:t}),t.on("error",function(){return o.toggle("not-sync")}),t.on("close",function(){return o.toggle("offline-retry",!0),t.reconnect().then(function(){return r.getdoc()}).then(function(){return r.adapt({hub:r.hub,path:[]})}).then(function(){return console.log("reinitialized.")}).then(function(){return o.toggle("offline-retry",!1)})}),t.ready()},getdoc:function(){var t,r=this;return console.log("get judge document ... "),this.hub.doc=null,t="brd/"+this.brd+"/grp/"+this.grp+"/judge/"+this.type+"/",this.sdb.get({id:t,watch:function(t,e){return r.hub.fire("change",{ops:t,source:e})},create:function(){return{}}}).then(function(t){return r.hub.doc=t,r.adapt({hub:r.hub,path:r.user?["user",r.user.key]:[]})})},opsIn:function(){},auth:function(){var t=this;return console.log("get user auth info ..."),n.get().then(function(r){return t.global=r})},sort:function(t,n,o){var i,u,a,s=this;return null==o&&(o=!0),o&&e.on(),i="criteria"===t?t+"-"+n.key:t+""+(null!=n?"-"+n:""),this.sort.inversed||(this.sort.inversed={}),u=this.sort.inversed[i]?1:-1,a={name:{name:"名稱",state:"狀態",comment:"評論長度",shortlist:"入選標記",budget:"預算"}[t]||n,dir:u>0?"順向":"逆向"},"count"===t?a.name={accept:"通過",pending:"待審",reject:"不符"}[n]+"的數量":"primary"===t||"primary-all"===t?a.name={accept:"推薦",pending:"待審",reject:"汰除"}[n]+" 的結果":"criteria"===t&&(a.name=n.name),o&&r.send("success","重新將表格依 "+a.name+" 做 "+a.dir+" 排序"),debounce(100).then(function(){var r;return s.sort.inversed[i]=!s.sort.inversed[i],r=[2,0,1],"state"===t?s.prjs.sort(function(t,e){return u*(r[t.state]-r[e.state])}):"name"===t?s.prjs.sort(function(t,r){return u*(t.name>r.name?1:t.name<r.name?-1:0)}):"budget"===t?s.prjs.sort(function(t,r){return u*(t.info.budget-r.info.budget)}):"comment"===t?s.prjs.sort(function(t,r){var e,n;return u*((((e=s.data.prj)[n=t.key]||(e[n]={})).comment||"").length-(((e=s.data.prj)[n=r.key]||(e[n]={})).comment||"").length)}):"criteria"===t?s.prjs.sort(function(t,e){var o,i,a;return t=((o=(i=s.data.prj)[a=t.key]||(i[a]={})).value||(o.value={}))[n.key],e=((o=(i=s.data.prj)[a=e.key]||(i[a]={})).value||(o.value={}))[n.key],t=null!=t?t:1,e=null!=e?e:1,u*(r[t]-r[e])}):"primary-all"===t?s.prjs.sort(function(t,r){return u*(t.count[n]||0)-(r.count[n]||0)}):"primary"===t?s.prjs.sort(function(t,r){var e,o;return t=((e=s.data.prj)[o=t.key]||(e[o]={})).value===n?1:0,r=((e=s.data.prj)[o=r.key]||(e[o]={})).value===n?1:0,u*(t-r)}):"count"===t?s.prjs.sort(function(t,r){var e;return u*(((e=t.count)[n]||(e[n]=[])).length-((e=r.count)[n]||(e[n]=[])).length)}):"shortlist"===t&&s.prjs.sort(function(t,r){var e,n;return t=((e=s.data.prj)[n=t.key]||(e[n]={})).picked?1:0,r=((e=s.data.prj)[n=r.key]||(e[n]={})).picked?1:0,u*(t-r)}),o&&e.off(),s.render()})}}),u});