function import$(r,t){var e,n={}.hasOwnProperty;for(e in t)n.call(t,e)&&(r[e]=t[e]);return r}ldc.register("judgeBase",["notify","error","loader","auth","ldcvmgr","sdbAdapter"],function(r){var i=r.notify,e=r.error,c=r.loader,n=r.auth,o=r.ldcvmgr,t=r.sdbAdapter,r=function(r){var t,e,n,i,o,s,u,a;if(this.loader=c,this.brd=r.brd,this.grp=r.grp,this.slug=r.slug,this.lv=r.lv,this.round=r.round,this.type=r.type,this.user=r.user,t=r.brd,e=r.grp,n=r.slug,i=r.lv,o=r.round,s=r.type,r.user,(u=/brd\/([^/]+)\/grp\/([^/]+)\/judge\/custom\/([^/]+)\/([^/]+)(?:\/round\/([^/]+))?$/.exec(window.location.href))?(t=(a=u.slice(1))[0],e=a[1],n=a[2],i=a[3],o=a[4],s="custom"):(u=/brd\/([^/]+)\/grp\/([^/]+)\/judge\/([^/]+)\/([^/]+)(?:\/round\/([^/]+))?$/.exec(window.location.href))&&(t=(a=u.slice(1))[0],e=a[1],s=a[2],i=a[3],o=a[4]),"custom"!==s&&"criteria"!==s&&"primary"!==s&&"final"!==s||"user"!==i&&"all"!==i)throw new ldError(1015);return this.brd=t,this.grp=e,this.type=s,this.lv=i,this.round=o,this.slug=n,this.root="string"==typeof r.root?document.querySelector(r.root):r.root,this.prjs=[],this.prjkeymap={},this.data={},this.view={},this};return r.prototype=import$(import$(Object.create(Object.prototype),t.interface),{init:function(){},render:function(){},initView:function(){var t=this;return(this.view||(this.view={})).base=new ldView({initRender:!1,root:this.root,text:{t:function(r){r=r.node;return i18next.t(r.innerText)},reviewer:function(r){r.node;return t.user?t.user.displayname:t.userLocal?t.userLocal.displayname:void 0},"grp-name":function(r){r.node;return t.brdinfo.name+" / "+t.grpinfo.info.name}}})},update:function(r){var t=this;return null==r&&(r={}),this._update||(this._update=debounce(function(r){return r.ops?t.opsOut(r.ops):t.dataAll?t.opsOut(function(){return t.dataAll}):t.opsOut(function(){return t.data})})),r.debounced?this._update.delay(r.debounced)(r):this._update(r).now()},fetchPrjs:function(){var o=this;return console.log("fetch prjs ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/judge-list/"+this.type,{method:"GET"},{type:"json"}).then(function(r){var t,e,n,i;return o.prjs=r,((n="custom"===o.type?((e=(t=(e=o.grpinfo).judge||(e.judge={})).custom||(t.custom={})).entries||(e.entries=[])).filter(function(r){return r.slug===o.slug})[0]||{}:(e=(t=o.grpinfo).judge||(t.judge={}))[n=o.type]||(e[n]={})||{}).config||(n.config={}))["include-draft"]||(o.prjs=o.prjs.filter(function(r){return"active"===r.state})),i=[],!n["filter-criteria"]&&"criteria"!==n.filter||i.push("criteria"),!n["filter-primary"]&&"primary"!==(e=n.filter)&&"shortlist"!==e||i.push("shortlist"),!n["filter-finalist"]&&"finalist"!==n.filter||i.push("finalist"),!n["filter-winner"]&&"winner"!==n.filter||i.push("winner"),i.length&&(o.prjs=(o.prjs||[]).filter(function(e){return i.reduce(function(r,t){return r&&((r=e.system||(e.system={})).badge||(r.badge={}))[t]},!0)})),o.prjs.map(function(r){return o.prjkeymap[r.key]=r}),o.prjs.sort(function(r,t){return r.key-t.key})})},fetchInfo:function(){var t=this;return console.log("fetch info ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/info",{method:"POST"},{json:{fields:["criteria","grade","judge","form","judgePerm"]},type:"json"}).then(function(r){return t.brdinfo=r.brd,t.grpinfo=r.grp,r.grp.criteria?t.criteria=r.grp.criteria.entries:o.get("judge-criteria-missing")})},sharedb:function(){var r,t=this;return console.log("prepare sharedb ..."),this.sdb=r=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hub=new Hub({sdb:r}),r.on("error",function(r){throw o.toggle("not-sync"),r}),r.on("close",function(){return o.toggle("offline-retry",!0),r.reconnect().then(function(){return t.reconnect()}).then(function(){return console.log("reinitialized.")}).then(function(){return o.toggle("offline-retry",!1)})}),r.ready()},getdoc:function(){var r,e=this;return console.log("get judge document ... "),this.hub.doc=null,r="brd/"+this.brd+"/grp/"+this.grp+"/judge/"+this.type+"/",this.slug&&(r=r+"slug/"+this.slug),this.round&&(r=r+"round/"+this.round),this.sdb.get({id:r,watch:function(r,t){return e.hub.fire("change",{ops:r,source:t})},create:function(){return{}}}).then(function(r){return e.hub.doc=r,e.adapt({hub:e.hub,path:e.user&&!e.commonForm?["user",e.user.key]:[]})})},opsIn:function(){},auth:function(){var t=this;return console.log("get user auth info ..."),n.get().then(function(r){return t.global=r})},getDisplayname:function(r){var t=this;return this.usermap&&!r.filter(function(r){return!t.usermap[r]}).length?Promise.resolve():ld$.fetch("/dash/api/usermap/",{method:"PUT"},{json:{userkeys:r},type:"json"}).then(function(r){return null==r&&(r=[]),t.usermap={},r.map(function(r){return t.usermap[r.key]=r})}).catch(e())},sort:function(r,s,t){var n,u,e,a=this;return(t=null==t?!0:t)&&c.on(),n="criteria"===r?r+"-"+s.key:r+""+(null!=s?"-"+s:""),this.sort.inversed||(this.sort.inversed={}),u=this.sort.inversed[n]?1:-1,e={name:{name:"名稱",state:"狀態",comment:"評論長度",comments:"評論長度",shortlist:"入選標記",budget:"預算",total:"總分",rank:"排名","criteria-result":"審查結果","judge-rank":"評審排名","judge-score":"評審分數",rate:"比例"}[r]||s,dir:0<u?"順向":"逆向"},"count"===r?e.name={accept:"通過",pending:"待審",reject:"不符"}[s]+"的數量":"primary"===r||"primary-all"===r?(s=+s,e.name={0:"推薦",1:"待審",2:"汰除"}[+s]+" 的結果"):"criteria"!==r&&"grade"!==r||(e.name=s.name),t&&i.send("success","重新將表格依 "+e.name+" 做 "+e.dir+" 排序"),debounce(100).then(function(){var o,e;return a.sort.inversed[n]=!a.sort.inversed[n],o=[2,0,1],"state"===r?a.prjs.sort(function(r,t){return u*(o[r.state]-o[t.state])}):"name"===r?a.prjs.sort(function(r,t){return u*(r.name>t.name?1:r.name<t.name?-1:0)}):"budget"===r?a.prjs.sort(function(r,t){return u*(r.info.budget-t.info.budget)}):"comments"===r?a.prjs.sort(function(r,t){return u*JSON.stringify(r.comments||{}).length-JSON.stringify(t.comments||{}).length}):"comment"===r?a.prjs.sort(function(r,t){var e;return u*((((e=a.data.prj)[r=r.key]||(e[r]={})).comment||"").length-(((e=a.data.prj)[r=t.key]||(e[r]={})).comment||"").length)}):"criteria-result"===r?a.prjs.sort(function(r,t){return u*(t.criteria[0]-t.criteria[2]-(r.criteria[0]-r.criteria[2]))}):"criteria"===r?a.prjs.sort(function(r,t){var e,n,i;return r=((e=(n=a.data.prj)[i=r.key]||(n[i]={})).value||(e.value={}))[s.key],t=((e=(n=a.data.prj)[i=t.key]||(n[i]={})).value||(e.value={}))[s.key],u*(o[r=null!=r?r:1]-o[t=null!=t?t:1])}):"grade"===r?a.prjs.sort(function(r,t){var e,n,i;return r=((e=(n=a.data.prj)[i=r.key]||(n[i]={})).v||(e.v={}))[s.key],t=((e=(n=a.data.prj)[i=t.key]||(n[i]={})).v||(e.v={}))[s.key],u*((t=null!=t?t:0)-(r=null!=r?r:0))}):"rate"===r?a.prjs.sort(function(r,t){return u*(t.rate-r.rate)}):"primary-all"===r?(e={0:"accept",1:"pending",2:"reject"}[s],a.prjs.sort(function(r,t){return u*(r.count[e]||0)-(t.count[e]||0)})):"primary"===r?a.prjs.sort(function(r,t){var e,n;return r=((e=a.data.prj)[n=r.key]||(e[n]={})).v===s?1:0,t=((e=a.data.prj)[n=t.key]||(e[n]={})).v===s?1:0,u*(r-t)}):"count"===r?a.prjs.sort(function(r,t){return u*(((r=r.count)[s]||(r[s]=[])).length-((r=t.count)[s]||(r[s]=[])).length)}):"shortlist"===r?a.prjs.sort(function(r,t){var e,n;return r=((e=a.data.prj)[n=r.key]||(e[n]={})).picked?1:0,t=((e=a.data.prj)[n=t.key]||(e[n]={})).picked?1:0,u*(r-t)}):"total"===r?a.prjs.sort(function(r,t){return u*(r.total-t.total)}):"rank"===r?a.prjs.sort(function(r,t){return u*(r.rank-t.rank)}):"judge-score"===r?a.prjs.sort(function(r,t){return u*(((s.score||(s.score={}))[t.key]||0)-((s.score||(s.score={}))[r.key]||0))}):"judge-rank"===r&&a.prjs.sort(function(r,t){return u*(((s.rank||(s.rank={}))[t.key]||0)-((s.rank||(s.rank={}))[r.key]||0))}),t&&c.off(),a.render()})}}),r});