function import$(r,t){var e={}.hasOwnProperty;for(var n in t)e.call(t,n)&&(r[n]=t[n]);return r}ldc.register("judgeBase",["notify","error","loader","auth","ldcvmgr","sdbAdapter"],function(r){var t,e,n,o,i,s;return t=r.notify,r.error,e=r.loader,n=r.auth,o=r.ldcvmgr,i=r.sdbAdapter,s=function(r){var t,n,o,i,s,u;if(this.loader=e,this.brd=r.brd,this.grp=r.grp,this.user=r.user,!(t=/brd\/([^/]+)\/grp\/([^/]+)\/judge\/([^/]+)\/([^/]+)$/.exec(window.location.href)))throw new ldError(1015);if(n=t.slice(1),o=n[0],i=n[1],s=n[2],u=n[3],"criteria"!==s&&"primary"!==s&&"final"!==s||"user"!==u&&"all"!==u)throw new ldError(1015);return this.brd=o,this.grp=i,this.type=s,this.lv=u,this.root="string"==typeof r.root?document.querySelector(r.root):r.root,this.prjs=[],this.data={},this.view={},this},s.prototype=import$(import$(Object.create(Object.prototype),i.interface),{init:function(){},render:function(){},initView:function(){var r=this;return this.view.base=new ldView({initRender:!1,root:this.root,text:{reviewer:function(t){if(t.node,r.user)return r.user.displayname},"grp-name":function(t){return t.node,r.brdinfo.name+" / "+r.grpinfo.info.name}}})},update:function(r){var t=this;return null==r&&(r={}),this._update||(this._update=debounce(function(){return t.opsOut(function(){return t.data})})),r.debounced?this._update.delay(r.debounced)():this._update().now()},fetchPrjs:function(){var r=this;return console.log("fetch prjs ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/judge-list",{method:"GET"},{type:"json"}).then(function(t){return r.prjs=t,r.prjs.map(function(r){if(r.name.length>25)return r.name=r.name.substring(0,25)+"..."})})},fetchInfo:function(){var r=this;return console.log("fetch info ... "),ld$.fetch("/dash/api/brd/"+this.brd+"/grp/"+this.grp+"/info",{method:"POST"},{json:{fields:["criteria","grade","form"]},type:"json"}).then(function(t){return r.brdinfo=t.brd,r.grpinfo=t.grp,t.grp.criteria?r.criteria=t.grp.criteria.entries:o.get("judge-criteria-missing")})},sharedb:function(){var r,t=this;return console.log("prepare sharedb ..."),this.sdb=r=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hub=new Hub({sdb:r}),r.on("error",function(){return o.toggle("not-sync")}),r.on("close",function(){return o.toggle("offline-retry",!0),r.reconnect().then(function(){return t.reconnect()}).then(function(){return console.log("reinitialized.")}).then(function(){return o.toggle("offline-retry",!1)})}),r.ready()},getdoc:function(){var r,t=this;return console.log("get judge document ... "),this.hub.doc=null,r="brd/"+this.brd+"/grp/"+this.grp+"/judge/"+this.type+"/",this.sdb.get({id:r,watch:function(r,e){return t.hub.fire("change",{ops:r,source:e})},create:function(){return{}}}).then(function(r){return t.hub.doc=r,t.adapt({hub:t.hub,path:t.user?["user",t.user.key]:[]})})},opsIn:function(){},auth:function(){var r=this;return console.log("get user auth info ..."),n.get().then(function(t){return r.global=t})},sort:function(r,n,o){var i,s,u,a=this;return null==o&&(o=!0),o&&e.on(),i="criteria"===r?r+"-"+n.key:r+""+(null!=n?"-"+n:""),this.sort.inversed||(this.sort.inversed={}),s=this.sort.inversed[i]?1:-1,u={name:{name:"名稱",state:"狀態",comment:"評論長度",comments:"評論長度",shortlist:"入選標記",budget:"預算"}[r]||n,dir:s>0?"順向":"逆向"},"count"===r?u.name={accept:"通過",pending:"待審",reject:"不符"}[n]+"的數量":"primary"===r||"primary-all"===r?(n=+n,u.name={0:"推薦",1:"待審",2:"汰除"}[+n]+" 的結果"):"criteria"===r&&(u.name=n.name),o&&t.send("success","重新將表格依 "+u.name+" 做 "+u.dir+" 排序"),debounce(100).then(function(){var t;return a.sort.inversed[i]=!a.sort.inversed[i],t=[2,0,1],"state"===r?a.prjs.sort(function(r,e){return s*(t[r.state]-t[e.state])}):"name"===r?a.prjs.sort(function(r,t){return s*(r.name>t.name?1:r.name<t.name?-1:0)}):"budget"===r?a.prjs.sort(function(r,t){return s*(r.info.budget-t.info.budget)}):"comments"===r?a.prjs.sort(function(r,t){return s*JSON.stringify(r.comments||{}).length-JSON.stringify(t.comments||{}).length}):"comment"===r?a.prjs.sort(function(r,t){var e,n;return s*((((e=a.data.prj)[n=r.key]||(e[n]={})).comment||"").length-(((e=a.data.prj)[n=t.key]||(e[n]={})).comment||"").length)}):"criteria"===r?a.prjs.sort(function(r,e){var o,i,u;return r=((o=(i=a.data.prj)[u=r.key]||(i[u]={})).value||(o.value={}))[n.key],e=((o=(i=a.data.prj)[u=e.key]||(i[u]={})).value||(o.value={}))[n.key],r=null!=r?r:1,e=null!=e?e:1,s*(t[r]-t[e])}):"primary-all"===r?a.prjs.sort(function(r,t){return s*(r.count[n]||0)-(t.count[n]||0)}):"primary"===r?a.prjs.sort(function(r,t){var e,o;return r=((e=a.data.prj)[o=r.key]||(e[o]={})).v===n?1:0,t=((e=a.data.prj)[o=t.key]||(e[o]={})).v===n?1:0,s*(r-t)}):"count"===r?a.prjs.sort(function(r,t){var e;return s*(((e=r.count)[n]||(e[n]=[])).length-((e=t.count)[n]||(e[n]=[])).length)}):"shortlist"===r&&a.prjs.sort(function(r,t){var e,n;return r=((e=a.data.prj)[n=r.key]||(e[n]={})).picked?1:0,t=((e=a.data.prj)[n=t.key]||(e[n]={})).picked?1:0,s*(r-t)}),o&&e.off(),a.render()})}}),s});