function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}ldc.register("adminPerm",["ldcvmgr","sdbAdapter","userSearch","error"],function(e){var t,n,r,o,i;return t=e.ldcvmgr,n=e.sdbAdapter,r=e.userSearch,o=e.error,i=function(e){var n,i,a,l,c,s,u,d,f=this;return this.opt=e,this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.ctrl={search:new r({root:ld$.find(this.root,"[ld-scope=user-search]",0)})},this.ctrl.search.init(),n={type:"list"},this.obj=i={idx:-1,cfg:{roles:[]}},a=function(){var e,t,r,o;return e=i.cfg.roles[t=i.idx],r=e?e.name:"",o=~t?"role":"list",n.idx=t,n.role=e,n.name=r,n.type=o,n},this.updateView=l=function(){return a(),d.render()},c={root:this.root,action:{click:{},keyup:{}},handler:{}},import$(c.action.click,{roles:function(e){var t;return e.node,t=e.evt,i.idx=i.cfg.roles.map(function(e){return e.name}).indexOf(t.target.getAttribute("data-name")),u(),l()},"new-role":function(e){var t,n,r,o,a;for(e.node,t=e.evt,n=i.cfg.roles.map(function(e){return e.name}),r=1;r<100&&(o=r,~n.indexOf("角色"+o));++r);return a="角色"+(o<100?o:Math.round(100*Math.random())+100),i.cfg.roles.push({name:a,desc:"自訂角色",list:[]}),i.idx=i.cfg.roles.length-1,u(),l(),t.stopPropagation()},"delete-role":function(){return i.cfg.roles.length<=1?alert("最少要有一個角色"):~i.idx?(i.cfg.roles.splice(i.idx,1),i.idx=-1,u(),l()):void 0}}),import$(c.action.keyup,{"role-name":function(e){var t,r,o;if(t=e.node,n.role){if(r=t.value,o=~i.cfg.roles.map(function(e){return e.name}).indexOf(r)&&n.name!==r,t.classList.toggle("is-invalid",o),o)return;return n.role.name=t.value,u(),l()}}}),import$(c.handler,{"list-view":function(e){return e.node.classList.toggle("d-none","list"!==n.type)},"role-view":function(e){return e.node.classList.toggle("d-none","role"!==n.type)},role:{list:function(){return i.cfg.roles},handler:function(e){var t,r,o;return t=e.node,r=e.data,(o=ld$.find(t,".nav-link",0)).classList.toggle("active",r.name===n.name),o.setAttribute("data-name",r.name),o.setAttribute("data-type","role"),o.innerText=r.name}},"role-name":function(e){var t,r;return(t=e.node).classList.toggle("d-none",!~i.idx),t.value=n.role?t.value=n.name:"",r=t.value,t.classList.toggle("is-invalid",~i.cfg.roles.map(function(e){return e.name}).indexOf(r)&&n.name!==r)},"role-desc":{list:function(){return i.cfg.roles},action:{keyup:function(e){var t,n;return t=e.node,n=e.data,n.desc=editableInput(t),u(!0)}},handler:function(e){var t,r;return t=e.node,r=e.data,t.innerText=r.desc||"",t.setAttribute("data-name",r.name),t.classList.toggle("d-none",r.name!==n.name)}},"role-all":function(e){return e.node.classList.toggle("active","list"===n.type)},"role-desc-all":function(e){return e.node.classList.toggle("d-none","list"!==n.type)}}),import$(c.action.click,{switch:function(e){var t,n,r;if(t=e.node,e.evt,t.classList.toggle("on"),n=(r=i.cfg.roles[i.idx]).config||(r.config={}))return n[t.getAttribute("data-name")]=t.classList.contains("on"),u()}}),import$(c.handler,{switch:function(e){var t,r;if(t=e.node,n.role)return t.classList.toggle("on",!!((r=n.role).config||(r.config={}))[t.getAttribute("data-name")])}}),import$(c.handler,{user:{list:function(){return n.role?(n.role.list||[]).map(function(e){return e.perm=n.role.name,e}):i.cfg.roles.map(function(e){return e.list.map(function(t){return t.perm=e.name,t})}).reduce(function(e,t){return e.concat(t)},[])},handler:function(e){var t,n,r;if(t=e.node,n=e.data,ld$.find(t,"b",0).innerText=n.displayname,r=ld$.find(t,".text-muted",0))return r.innerText=n.perm},action:{click:function(e){var t,n,r;if(e.node,t=e.data,e.evt.target.classList.contains("i-close")&&~(n=i.cfg.roles.map(function(e){return e.name}).indexOf(t.perm))&&~(r=i.cfg.roles[n].list).indexOf(t))return r.splice(r.indexOf(t),1),u(),l()}}}}),import$(c.action.click,{"newuser-toggle":function(e){return e.node,d.getAll("newuser").map(function(e){return e.classList.toggle("d-none")})},"newtoken-add":function(e){var r;return e.node,r=("list"===n.type?n.pickedRole:n.role)||i.cfg.roles[0]||{name:""},ld$.fetch("/dash/api/token",{method:"POST"},{type:"json"}).then(function(e){var n,o;return null==e&&(e={}),e.id&&e.token?(n={key:e.id,displayname:e.id,type:"token"},i.cfg.roles.map(function(e){return e.list}).reduce(function(e,t){return e.concat(t)},[]).filter(function(e){return e.type===n.type&&e.key===n.key}).length?alert("user already exist"):(n.perm=r.name,o=n,r.list.push(o),u(),l(),t.getdom("token-link").then(function(n){return ld$.find(n,"[ld=token-link]",0).innerText="https://"+window.location.hostname+"/dash/token/"+e.token,t.toggle("token-link")}))):Promise.reject(new ldError(400))}).catch(o())},"newuser-add":function(e){var t,r,o;if(e.node,e.evt,t=("list"===n.type?n.pickedRole:n.role)||i.cfg.roles[0]||{name:""},r=f.ctrl.search.get())return i.cfg.roles.map(function(e){return e.list}).reduce(function(e,t){return e.concat(t)},[]).filter(function(e){return e.type===r.type&&e.key===r.key}).length?alert("user already exist"):(r.perm=t.name,o=r,t.list.push(o),f.ctrl.search.clear(),u(),l())}}),import$(c.handler,{"newuser-role-picked":function(e){var t;if(t=e.node,n.pickedRole||(n.pickedRole=i.cfg.roles[0]),n.pickedRole)return t.innerText=n.pickedRole.name},"newuser-role-option":{list:function(){return i.cfg.roles},action:{click:function(e){var t;return e.node,t=e.data,n.pickedRole=t,d.render("newuser-role-picked")}},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.name}}}),s=debounce(500,function(){return u()}),u=function(e){return e?s():f.opsOut(function(){return f.obj.cfg})},d=new ldView(c),this},i.prototype=import$(import$(Object.create(Object.prototype),n.interface),{opsIn:function(e){var t;if(t=e.data,e.ops,!e.source)return this.obj.cfg=JSON.parse(JSON.stringify(t||{})),this.obj.cfg.roles||(this.obj.cfg.roles=[]),this.updateView()}}),i});