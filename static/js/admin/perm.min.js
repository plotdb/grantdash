function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}ldc.register("adminPerm",["ldcvmgr","auth","sdbAdapter","userSearch","error"],function(e){var t,n,r,o,i,a;return t=e.ldcvmgr,n=e.auth,r=e.sdbAdapter,o=e.userSearch,i=e.error,a=function(e){var r,a,c,l,u,s,d,f,p,g=this;return this.opt=e,this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.ctrl={search:new o({root:ld$.find(this.root,"[ld-scope=user-search]",0)})},this.toc=e.toc,this.org=e.org,this.brd=e.brd,this.ctrl.search.init(),r={type:"list"},this.obj=a={idx:-1,cfg:{roles:[]}},c=function(){var e,t,n,o;return e=a.cfg.roles[t=a.idx],n=e?e.name:"",o=~t?"role":"list",r.idx=t,r.role=e,r.name=n,r.type=o,r},l=function(e,t){var n,o;return null==t&&(t=!0),n=("list"===r.type?r.pickedRole:r.role)||a.cfg.roles[0]||{name:""},!a.cfg.roles.map(function(e){return e.list}).reduce(function(e,t){return e.concat(t)},[]).filter(function(t){return t.type===e.type&&t.key===e.key}).length&&(e.perm=n.name,o=e,n.list.push(o),g.ctrl.search.clear(),t&&(f(),u()),!0)},this.updateView=u=function(){return c(),p.render()},s={root:this.root,action:{click:{},keyup:{}},handler:{}},import$(s.action.click,{roles:function(e){var t;return e.node,t=e.evt,a.idx=a.cfg.roles.map(function(e){return e.name}).indexOf(t.target.getAttribute("data-name")),f(),u()},"new-role":function(e){var t,n,r,o,i;for(e.node,t=e.evt,n=a.cfg.roles.map(function(e){return e.name}),r=1;r<100&&(o=r,~n.indexOf("角色"+o));++r);return i="角色"+(o<100?o:Math.round(100*Math.random())+100),a.cfg.roles.push({name:i,desc:"自訂角色",list:[],key:suuid()}),a.idx=a.cfg.roles.length-1,f(),u(),t.stopPropagation()},"delete-role":function(){return a.cfg.roles.length<=1?alert("最少要有一個角色"):~a.idx?(a.cfg.roles.splice(a.idx,1),a.idx=-1,f(),u()):void 0}}),import$(s.action.keyup,{"role-name":function(e){var t,n,o;if(t=e.node,r.role){if(n=t.value,o=~a.cfg.roles.map(function(e){return e.name}).indexOf(n)&&r.name!==n,t.classList.toggle("is-invalid",o),o)return;return r.role.name=t.value,f(),u()}}}),import$(s.handler,{"list-view":function(e){return e.node.classList.toggle("d-none","list"!==r.type)},"role-view":function(e){return e.node.classList.toggle("d-none","role"!==r.type)},role:{list:function(){return a.cfg.roles},handler:function(e){var t,n,o;return t=e.node,n=e.data,(o=ld$.find(t,".nav-link",0)).classList.toggle("active",n.name===r.name),o.setAttribute("data-name",n.name),o.setAttribute("data-type","role"),o.innerText=n.name}},"role-name":function(e){var t,n;return(t=e.node).classList.toggle("d-none",!~a.idx),t.value=r.role?t.value=r.name:"",n=t.value,t.classList.toggle("is-invalid",~a.cfg.roles.map(function(e){return e.name}).indexOf(n)&&r.name!==n)},"role-desc":{list:function(){return a.cfg.roles},action:{keyup:function(e){var t,n;return t=e.node,n=e.data,n.desc=editableInput(t),f(!0)}},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.desc||"",t.setAttribute("data-name",n.name),t.classList.toggle("d-none",n.name!==r.name)}},"role-all":function(e){return e.node.classList.toggle("active","list"===r.type)},"role-desc-all":function(e){return e.node.classList.toggle("d-none","list"!==r.type)}}),import$(s.action.click,{switch:function(e){var t,n,r;if(t=e.node,e.evt,t.classList.toggle("on"),n=(r=a.cfg.roles[a.idx]).config||(r.config={}))return n[t.getAttribute("data-name")]=t.classList.contains("on"),f()}}),import$(s.handler,{switch:function(e){var t,n;if(t=e.node,r.role)return t.classList.toggle("on",!!((n=r.role).config||(n.config={}))[t.getAttribute("data-name")])}}),import$(s.handler,{user:{list:function(){return r.role?(r.role.list||[]).map(function(e){return e.perm=r.role.name,e}):a.cfg.roles.map(function(e){return e.list.map(function(t){return t.perm=e.name,t})}).reduce(function(e,t){return e.concat(t)},[])},init:function(e){var t,n,r;return t=e.node,n=e.local,r=e.data,n.view=new ldView({root:t,context:r,action:{click:{delete:function(){var e,t;if(~(e=a.cfg.roles.map(function(e){return e.name}).indexOf(r.perm))&&~(t=a.cfg.roles[e].list).indexOf(r))return t.splice(t.indexOf(r),1),f(),u()}}},text:{name:function(e){return e.context.displayname},key:function(e){var t;return"user"===(t=e.context).type?"用戶代碼: "+t.key:"email"===t.type?"郵件位址: "+t.key:"token"===t.type?t.key:""},role:function(e){return e.context.perm}},handler:{avatar:function(e){var t,n;if(t=e.node,"user"===(n=e.context).type)return t.style.backgroundImage="url(/dash/s/avatar/"+n.key+".png)"}}})},handler:function(e){var t,n;return e.node,t=e.local,n=e.data,t.view.setContext(n),t.view.render()}}}),import$(s.action.click,{"newuser-toggle":function(e){return e.node,p.getAll("newuser").map(function(e){return e.classList.toggle("d-none")})},"batch-add":function(e){var n,r,o;return e.node,n=e.local,r=function(){return n.view.get("list").value="",t.toggle("batch-add-user",!1)},o=function(){return(n.view.get("list").value||"").split(/\s|,/).map(function(e){return e.trim()}),(n.view.get("list").value||"").split(/\s|,/).map(function(e){return e.trim()}).filter(function(e){return e&&isEmail(e)}).map(function(e){return l({type:"email",displayname:e,key:e},!1)}).filter(function(e){return!e}).length&&alert("some email already exist"),f(),u(),t.toggle("batch-add-user",!1)},Promise.resolve().then(function(){if(!n.view)return t.getdom("batch-add-user").then(function(e){return n.view=new ldView({root:e,action:{click:{cancel:function(){return r()},add:function(){return o()}}}})})}).then(function(){return t.toggle("batch-add-user",!0)})},"newtoken-add":function(e){var o,c;if(e.node,o=("list"===r.type?r.pickedRole:r.role)||a.cfg.roles[0])return c={role:o.key},g.org&&(c.org=g.org.slug),g.brd&&(c.brd=g.brd.slug),n.recaptcha.get().then(function(e){return c.recaptcha=e,ld$.fetch("/dash/api/token",{method:"POST"},{json:c,type:"json"})}).then(function(e){var n,r,i;return null==e&&(e={}),e.id&&e.token?(n=e.id+":1",r={key:n,displayname:"連結邀請碼",type:"token"},a.cfg.roles.map(function(e){return e.list}).reduce(function(e,t){return e.concat(t)},[]).filter(function(e){return e.type===r.type&&e.key===r.key}).length?alert("user already exist"):(r.perm=o.name,i=r,o.list.push(i),f(),u(),t.getdom("token-link").then(function(n){return ld$.find(n,"[ld=token-link]",0).innerText="https://"+window.location.hostname+"/dash/token/"+e.token,t.toggle("token-link")}))):Promise.reject(new ldError(400))}).catch(i())},"newuser-add":function(e){var t;if(e.node,e.evt,t=g.ctrl.search.get())return l(t)}}),import$(s.handler,{"newuser-role-picked":function(e){var t;if(t=e.node,r.pickedRole||(r.pickedRole=a.cfg.roles[0]),r.pickedRole)return t.innerText=r.pickedRole.name},"newuser-role-option":{list:function(){return a.cfg.roles},action:{click:function(e){var t;return e.node,t=e.data,r.pickedRole=t,p.render("newuser-role-picked")}},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.name}}}),d=debounce(500,function(){return f()}),f=function(e){return e?d():g.opsOut(function(){return g.obj.cfg})},p=new ldView(s),this},a.prototype=import$(import$(Object.create(Object.prototype),r.interface),{opsIn:function(e){var t;if(t=e.data,e.ops,!e.source)return this.obj.cfg=JSON.parse(JSON.stringify(t||{})),this.obj.cfg.roles||(this.obj.cfg.roles=[]),this.obj.cfg.roles.map(function(e){if(!e.key)return e.key=suuid()}),this.updateView()}}),a});