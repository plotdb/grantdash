function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}ldc.register("adminPerm",["sdbAdapter","userSearch"],function(e){var t,n,r;return t=e.sdbAdapter,n=e.userSearch,r=function(e){var t,r,o,i,a,c,l,s,u=this;return this.opt=e,this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.ctrl={search:new n({root:ld$.find(this.root,"[ld-scope=user-search]",0)})},this.ctrl.search.init(),t={type:"list"},this.obj=r={idx:-1,cfg:{roles:[]}},o=function(){var e,n,o,i;return e=r.cfg.roles[n=r.idx],o=e?e.name:"",i=~n?"role":"list",t.idx=n,t.role=e,t.name=o,t.type=i,t},this.updateView=i=function(){return o(),s.render()},a={root:this.root,action:{click:{},keyup:{}},handler:{}},import$(a.action.click,{roles:function(e){var t;return e.node,t=e.evt,r.idx=r.cfg.roles.map(function(e){return e.name}).indexOf(t.target.getAttribute("data-name")),l(),i()},"new-role":function(e){var t,n,o,a,c;for(e.node,t=e.evt,n=r.cfg.roles.map(function(e){return e.name}),o=1;o<100&&(a=o,~n.indexOf("角色"+a));++o);return c="角色"+(a<100?a:Math.round(100*Math.random())+100),r.cfg.roles.push({name:c,desc:"自訂角色",list:[]}),r.idx=r.cfg.roles.length-1,l(),i(),t.stopPropagation()},"delete-role":function(){return r.cfg.roles.length<=1?alert("最少要有一個角色"):~r.idx?(r.cfg.roles.splice(r.idx,1),r.idx=-1,l(),i()):void 0}}),import$(a.action.keyup,{"role-name":function(e){var n,o,a;if(n=e.node,t.role){if(o=n.value,a=~r.cfg.roles.map(function(e){return e.name}).indexOf(o)&&t.name!==o,n.classList.toggle("is-invalid",a),a)return;return t.role.name=n.value,l(),i()}}}),import$(a.handler,{"list-view":function(e){return e.node.classList.toggle("d-none","list"!==t.type)},"role-view":function(e){return e.node.classList.toggle("d-none","role"!==t.type)},role:{list:function(){return r.cfg.roles},handler:function(e){var n,r,o;return n=e.node,r=e.data,(o=ld$.find(n,".nav-link",0)).classList.toggle("active",r.name===t.name),o.setAttribute("data-name",r.name),o.setAttribute("data-type","role"),o.innerText=r.name}},"role-name":function(e){var n,o;return(n=e.node).classList.toggle("d-none",!~r.idx),n.value=t.role?n.value=t.name:"",o=n.value,n.classList.toggle("is-invalid",~r.cfg.roles.map(function(e){return e.name}).indexOf(o)&&t.name!==o)},"role-desc":{list:function(){return r.cfg.roles},action:{keyup:function(e){var t,n;return t=e.node,n=e.data,n.desc=editableInput(t),l(!0)}},handler:function(e){var n,r;return n=e.node,r=e.data,n.innerText=r.desc||"",n.setAttribute("data-name",r.name),n.classList.toggle("d-none",r.name!==t.name)}},"role-all":function(e){return e.node.classList.toggle("active","list"===t.type)},"role-desc-all":function(e){return e.node.classList.toggle("d-none","list"!==t.type)}}),import$(a.action.click,{switch:function(e){var t,n,o;if(t=e.node,e.evt,t.classList.toggle("on"),n=(o=r.cfg.roles[r.idx]).config||(o.config={}))return n[t.getAttribute("data-name")]=t.classList.contains("on"),l()}}),import$(a.handler,{switch:function(e){var n,r;if(n=e.node,t.role)return n.classList.toggle("on",!!((r=t.role).config||(r.config={}))[n.getAttribute("data-name")])}}),import$(a.handler,{user:{list:function(){return t.role?(t.role.list||[]).map(function(e){return e.perm=t.role.name,e}):r.cfg.roles.map(function(e){return e.list.map(function(t){return t.perm=e.name,t})}).reduce(function(e,t){return e.concat(t)},[])},handler:function(e){var t,n,r;if(t=e.node,n=e.data,ld$.find(t,"b",0).innerText=n.displayname,r=ld$.find(t,".text-muted",0))return r.innerText=n.perm},action:{click:function(e){var t,n,o;if(e.node,t=e.data,e.evt.target.classList.contains("i-close")&&~(n=r.cfg.roles.map(function(e){return e.name}).indexOf(t.perm))&&~(o=r.cfg.roles[n].list).indexOf(t))return o.splice(o.indexOf(t),1),l(),i()}}}}),import$(a.action.click,{"newuser-toggle":function(e){return e.node,s.getAll("newuser").map(function(e){return e.classList.toggle("d-none")})},"newuser-add":function(e){var n,o,a;if(e.node,e.evt,n=("list"===t.type?t.pickedRole:t.role)||r.cfg.roles[0]||{name:""},o=u.ctrl.search.get())return r.cfg.roles.map(function(e){return e.list}).reduce(function(e,t){return e.concat(t)},[]).filter(function(e){return e.type===o.type&&e.key===o.key}).length?alert("user already exist"):(o.perm=n.name,a=o,"email"===o.type&&(o.config={invited:!1,pending:!0}),n.list.push(a),u.ctrl.search.clear(),l(),i())}}),import$(a.handler,{"newuser-role-picked":function(e){var n;if(n=e.node,t.pickedRole||(t.pickedRole=r.cfg.roles[0]),t.pickedRole)return n.innerText=t.pickedRole.name},"newuser-role-option":{list:function(){return r.cfg.roles},action:{click:function(e){var n;return e.node,n=e.data,t.pickedRole=n,s.render("newuser-role-picked")}},handler:function(e){var t,n;return t=e.node,n=e.data,t.innerText=n.name}}}),c=debounce(500,function(){return l()}),l=function(e){return e?c():u.opsOut(function(){return u.obj.cfg})},s=new ldView(a),this},r.prototype=import$(import$(Object.create(Object.prototype),t.interface),{opsIn:function(e){var t;if(t=e.data,e.ops,!e.source)return this.obj.cfg=JSON.parse(JSON.stringify(t||{})),this.obj.cfg.roles||(this.obj.cfg.roles=[]),this.updateView()}}),r});