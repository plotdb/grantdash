function import$(e,n){var t={}.hasOwnProperty;for(var r in n)t.call(n,r)&&(e[r]=n[r]);return e}ldc.register("adminPerm",["sdbAdapter","userSearch"],function(e){var n,t,r;return n=e.sdbAdapter,t=e.userSearch,r=function(e){var n,r,o,i,a,c,l,s,u=this;return this.opt=e,this.root="string"==typeof e.root?document.querySelector(e.root):e.root,this.ctrl={search:new t({root:ld$.find(this.root,"[ld-scope=user-search]",0)})},this.ctrl.search.init(),n={type:"list"},this.obj=r={idx:-1,cfg:{roles:[]}},o=function(){var e,t,o,i;return e=r.cfg.roles[t=r.idx],o=e?e.name:"",i=~t?"role":"list",n.idx=t,n.role=e,n.name=o,n.type=i,n},this.updateView=i=function(){return o(),s.render()},a={root:this.root,action:{click:{},keyup:{}},handler:{}},import$(a.action.click,{roles:function(e){var n;return e.node,n=e.evt,r.idx=r.cfg.roles.map(function(e){return e.name}).indexOf(n.target.getAttribute("data-name")),l(),i()},"new-role":function(e){var n,t,o,a,c;for(e.node,n=e.evt,t=r.cfg.roles.map(function(e){return e.name}),o=1;o<100&&(a=o,~t.indexOf("角色"+a));++o);return c="角色"+(a<100?a:Math.round(100*Math.random())+100),r.cfg.roles.push({name:c,desc:"自訂角色",list:[]}),r.idx=r.cfg.roles.length-1,l(),i(),n.stopPropagation()},"delete-role":function(){return r.cfg.roles.length<=1?alert("最少要有一個角色"):~r.idx?(r.cfg.roles.splice(r.idx,1),r.idx=-1,l(),i()):void 0}}),import$(a.action.keyup,{"role-name":function(e){var t,o,a;if(t=e.node,n.role){if(o=t.value,a=~r.cfg.roles.map(function(e){return e.name}).indexOf(o)&&n.name!==o,t.classList.toggle("is-invalid",a),a)return;return n.role.name=t.value,l(),i()}}}),import$(a.handler,{"list-view":function(e){return e.node.classList.toggle("d-none","list"!==n.type)},"role-view":function(e){return e.node.classList.toggle("d-none","role"!==n.type)},role:{list:function(){return r.cfg.roles},handler:function(e){var t,r,o;return t=e.node,r=e.data,(o=ld$.find(t,".nav-link",0)).classList.toggle("active",r.name===n.name),o.setAttribute("data-name",r.name),o.setAttribute("data-type","role"),o.innerText=r.name}},"role-name":function(e){var t,o;return(t=e.node).classList.toggle("d-none",!~r.idx),t.value=n.role?t.value=n.name:"",o=t.value,t.classList.toggle("is-invalid",~r.cfg.roles.map(function(e){return e.name}).indexOf(o)&&n.name!==o)},"role-desc":{list:function(){return r.cfg.roles},action:{keyup:function(e){var n,t;return n=e.node,t=e.data,t.desc=n.innerText,l(!0)}},handler:function(e){var t,r;return t=e.node,r=e.data,t.innerText=r.desc||"",t.setAttribute("data-name",r.name),t.classList.toggle("d-none",r.name!==n.name)}},"role-all":function(e){return e.node.classList.toggle("active","list"===n.type)},"role-desc-all":function(e){return e.node.classList.toggle("d-none","list"!==n.type)}}),import$(a.action.click,{switch:function(e){var n,t,o;if(n=e.node,e.evt,n.classList.toggle("on"),t=(o=r.cfg.roles[r.idx]).config||(o.config={}))return t[n.getAttribute("data-name")]=n.classList.contains("on"),l()}}),import$(a.handler,{switch:function(e){var t,r;if(t=e.node,n.role)return t.classList.toggle("on",!!((r=n.role).config||(r.config={}))[t.getAttribute("data-name")])}}),import$(a.handler,{user:{list:function(){return n.role?(n.role.list||[]).map(function(e){return e.perm=n.role.name,e}):r.cfg.roles.map(function(e){return e.list.map(function(n){return n.perm=e.name,n})}).reduce(function(e,n){return e.concat(n)},[])},handler:function(e){var n,t,r;if(n=e.node,t=e.data,ld$.find(n,"b",0).innerText=t.displayname,r=ld$.find(n,".text-muted",0))return r.innerText=t.perm},action:{click:function(e){var n,t,o;if(e.node,n=e.data,e.evt.target.classList.contains("i-close")&&~(t=r.cfg.roles.map(function(e){return e.name}).indexOf(n.perm))&&~(o=r.cfg.roles[t].list).indexOf(n))return o.splice(o.indexOf(n),1),l(),i()}}}}),import$(a.action.click,{"newuser-toggle":function(e){return e.node,s.getAll("newuser").map(function(e){return e.classList.toggle("d-none")})},"newuser-add":function(e){var t,o,a;if(e.node,e.evt,t=("list"===n.type?n.pickedRole:n.role)||r.cfg.roles[0]||{name:""},o=u.ctrl.search.get())return~r.cfg.roles.map(function(e){return e.list}).reduce(function(e,n){return e.concat(n)},[]).map(function(e){return e.key}).indexOf(o.key)?alert("user already exist"):(t.list.push((a={perm:t.name},a.key=o.key,a.displayname=o.displayname,a)),u.ctrl.search.clear(),l(),i())}}),import$(a.handler,{"newuser-role-picked":function(e){var t;if(t=e.node,n.pickedRole||(n.pickedRole=r.cfg.roles[0]),n.pickedRole)return t.innerText=n.pickedRole.name},"newuser-role-option":{list:function(){return r.cfg.roles},action:{click:function(e){var t;return e.node,t=e.data,n.pickedRole=t,s.render("newuser-role-picked")}},handler:function(e){var n,t;return n=e.node,t=e.data,n.innerText=t.name}}}),c=debounce(500,function(){return l()}),l=function(e){return e?c():u.opsOut(function(){return u.obj.cfg})},s=new ldView(a),this},r.prototype=import$(import$(Object.create(Object.prototype),n.interface),{opsIn:function(e){var n;if(n=e.data,e.ops,!e.source)return this.obj.cfg=JSON.parse(JSON.stringify(n||{})),this.obj.cfg.roles||(this.obj.cfg.roles=[]),this.updateView()}}),r});