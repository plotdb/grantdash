// Generated by LiveScript 1.3.0
(function(){
  ldc.register('admin', ['viewLocals', 'orgInfo', 'orgPerm', 'brdInfo', 'prjInfo', 'loader'], function(arg$){
    var viewLocals, orgInfo, orgPerm, brdInfo, prjInfo, loader, lc, sdb, watch, ret, id, init, prjgView, watchBoard, initBoard;
    viewLocals = arg$.viewLocals, orgInfo = arg$.orgInfo, orgPerm = arg$.orgPerm, brdInfo = arg$.brdInfo, prjInfo = arg$.prjInfo, loader = arg$.loader;
    loader.on();
    lc = {};
    sdb = new sharedbWrapper({
      url: {
        scheme: window.location.protocol.replace(':', ''),
        domain: window.location.host
      }
    });
    sdb.on('close', function(){
      loader.on();
      return sdb.reconnect().then(function(){
        return init();
      }).then(function(){
        return loader.off();
      });
    });
    watch = function(ops, source){
      orgInfo.watch({
        ops: ops,
        source: source
      });
      return orgPerm.watch({
        ops: ops,
        source: source
      });
    };
    ret = /o\/([0-9]+)/.exec(window.location.pathname);
    if (ret) {
      id = "org-" + (ret ? ret[1] : 'demo');
      init = function(){
        loader.on();
        return sdb.get({
          id: id,
          watch: watch
        }).then(function(doc){
          lc.doc = doc;
          console.log(doc.data);
          orgInfo.init({
            doc: doc,
            sdb: sdb
          });
          orgPerm.init({
            doc: doc,
            sdb: sdb
          });
          return loader.off();
        });
      };
      init();
    }
    prjgView = new ldView({
      initRender: false,
      root: ".project-groups",
      action: {
        click: {
          "project-group-add": function(arg$){
            var node, data, ops;
            node = arg$.node;
            data = JSON.parse(JSON.stringify(lc.docbrd.data));
            (data.group || (data.group = [])).push({
              key: (data.group || (data.group = [])).length + 1,
              name: "新分組"
            });
            ops = sdb.json.diff(lc.docbrd.data, data);
            lc.docbrd.submitOp(ops);
            return prjgView.render();
          }
        }
      },
      handler: {
        "project-group": {
          list: function(){
            return lc.docbrd.data.group || [];
          },
          handler: function(arg$){
            var node, data, n;
            node = arg$.node, data = arg$.data;
            n = ld$.find(node, '[ld=name]', 0);
            n.innerText = data.name;
            new ldui.Folder({
              root: node
            });
            return new ldui.Nav(node);
          }
        }
      }
    });
    watchBoard = function(ops, source){
      brdInfo.watch({
        ops: ops,
        source: source
      });
      return prjInfo.watch({
        ops: ops,
        source: source
      });
    };
    ret = /b\/([0-9]+)/.exec(window.location.pathname);
    if (ret) {
      id = "board-" + (ret ? ret[1] : 'demo');
      initBoard = function(){
        loader.on();
        return sdb.get({
          id: id,
          watch: watchBoard
        }).then(function(doc){
          lc.docbrd = doc;
          brdInfo.init({
            doc: lc.docbrd,
            sdb: sdb
          });
          prjInfo.init({
            doc: lc.docbrd,
            sdb: sdb
          });
          prjgView.render();
          return loader.off();
        });
      };
      initBoard();
    }
    return loader.off();
  });
  return ldc.app('admin');
})();