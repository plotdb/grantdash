var slice$=[].slice;function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}function import$(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}ldc.register("adminPrjList",["error","loader","notify","ldcvmgr","auth","sdbAdapter","adminPanel"],function(t){var r=t.error,a=t.loader,u=t.notify,o=t.ldcvmgr,s=(t.auth,t.sdbAdapter,t.adminPanel),t=function(t){var e,n,P=this;return this.toc=t.toc,this.evtHandler={},this.data=[],this.filter={badge:""},s.on("active",function(t){t.nav;var e=t.name;t.panel;if("grp-list"===e)return ld$.fetch("/dash/api/brd/"+P.toc.brd.slug+"/list",{method:"GET"},{params:{grp:P.grp.key},type:"json"}).then(function(t){return P.data=t,P.data.map(function(t){return t.info=t.detail.info}),P.view.render()}).catch(r())}),e={},debounce(function(){return P.view.render("prj")}),n=function(){var t=P.data.filter(function(t){return(!P.filter.badge||(t.system||(t.system={})).badge&&t.system.badge[P.filter.badge])&&t.slug&&(!e.keyword||~[t.name,(t.info||(t.info={})).teamname,t.username,t.ownername].filter(function(t){return t}).join(" ").indexOf(e.keyword))});return t.sort(function(t,e){var n=(t.system||(t.system={})).idx,r=(e.system||(e.system={})).idx;return null==n||null==r?e.key-t.key:null==n?1:null==r?-1:n-r}),t},this.view=new ldView({root:t.root,action:{input:{"search-input":function(t){t=t.node;return e.keyword=t.value}},keypress:{"search-input":function(t){t.node;if(13===t.evt.keyCode)return P.view.render()}},click:{search:function(){return P.view.render()},"search-filter":function(t){t=t.node;return P.filter.badge=t.getAttribute("data-name"),P.view.render()},download:function(t){var t=t.node,L=t.getAttribute("data-name"),O=t.getAttribute("data-type")||"active";return ld$.fetch("/dash/api/brd/"+P.toc.brd.slug+"/grp/"+P.grp.key+"/prjs",{method:"GET"},{type:"json"}).then(function(a){var r,t,e,l,d,n,o,i,u,s,c,f,m,p,g,h,v,b,y,w,x;if(null==a&&(a={}),console.log(a),O&&"all"!==O&&(a=a.filter(function(t){return!t.deleted}).filter(function(t){return"active"===O?"active"===t.state:((t=t.system||(t.system={})).badge||(t.badge={}))[O]})),"custom"===L)return window.adminExtension=null,r=P.hubs.brd.doc.data.info.view,new Promise(function(i,t){var e,n=function(){var o,t,e,n,r;if(a[0]&&((n=(n=a[0]).detail||(n.detail={})).custom||(n.custom={})).open){for(e in o={},a.map(function(t){var e,n,r=[];for(e in n=(t=(t=t.detail||(t.detail={})).custom||(t.custom={})).open||(t.open={}))n[e],r.push(o[e]=1);return r}),t=[],o)t.push(e);return n=(o=t).map(function(t){return'"'+(""+t).replace(/"/g,"'")+'"'}),r=a.map(function(n){return o.map(function(t){var e;return((e=(e=n.detail||(n.detail={})).custom||(e.custom={})).open||(e.open={}))[t]||""}).map(function(t){return"object"!=typeof t?t:t?null!=t.v?t.v:null!=t.list||null!=t.other&&null!=t.other.text?(t.list||[]).concat([t.other&&t.other.enabled&&t.other.text||""]).filter(function(t){return null!=t&&""!==t}):JSON.stringify(t):""}).map(function(t){return'"'+(""+t).replace(/"/g,"'")+'"'})}),{blob:r=csv4xls.toBlob([n].concat(r)),name:P.toc.brd.name+"-"+P.grp.info.name+".csv"}}return r=new Blob([JSON.stringify(a)],{type:"application/json"}),i({blob:r,name:"projects.json"})};return r?((e=document.createElement("script")).src="/dash/js/view/"+r+"/admin.js?v="+Math.random().toString(36).substring(2),e.onload=function(){var t=(adminExtension||{}).downloadProjects;return i(t?t({prjs:a,toc:P.toc,grp:P.grp}):n())},e.onerror=function(){return i(n())},document.body.appendChild(e)):i(n())});if("csv"!==L)return"mail"===L&&(a=a.map(function(t){return{username:t.username,name:t.name}})),{blob:new Blob([JSON.stringify(a)],{type:"application/json"}),name:"projects-"+L+".json"};if(P.grp.form)t=P.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t){return t.title}),e=a.map(function(n){return P.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t,e){t=n.detail.answer[t.key];return t?t.content||(t.list?(t.list||[]).concat(t.other?[t.otherValue]:[]).join(","):""):""})});else{for(l={},d=function(t,e,n){var r,o,i,a,u,s,c=[];if(null==n&&(n={}),Array.isArray(t)){for(r=0,o=t.length;r<o;++r)i=r,c.push(d(t[i],e.concat([i+1]),n));return c}if("object"!=typeof t)return s=e.join("-"),l[s]=!0,n[s]=null!=t?t:"";for(a in t)u=t[a],c.push(d(u,e.concat([a]),n));return c},n=[],o=[],a.sort(function(t,e){var n=(t.system||(t.system={})).idx,r=(e.system||(e.system={})).idx;return null==n||null==r?e.key-t.key:null==n?1:null==r?-1:n-r}),i=0,u=a.length;i<u;++i)s=a[i],n.push(c=[]),o.push([null!=s.system.idx?s.system.idx:""].concat(["criteria","shortlist","winner","special"].map(j))),d((f=s.detail||(s.detail={})).custom||(f.custom={}),[],c);for(p in m=[],l)m.push(p+""||"");for(e=[],g=(t=l=m).filter(function(t){return(t+"").trim()}),h=Math.max.apply(Math,g.map(function(t){return(t+""||"").length})),i=0;i<h;++i)if(v=i,b=g[0].substring(0,v),g.filter(k).length){t=t.map($);break}for(i=0,y=n.length;i<y;++i)w=n[v=i],x=o[v].concat(l.map(A)),e.push(x);t=["idx","資格審查","通過初選","獲獎","特別獎"].concat(t)}return{blob:csv4xls.toBlob([t].concat(e)),name:P.toc.brd.name+"-"+P.grp.info.name+".csv"};function j(t){var e;return((e=s.system||(s.system={})).badge||(e.badge={}))[t]?"O":""}function k(t){return!t.startsWith(b)}function $(t){return t.substring(0<(t=v-1)?t:0)}function A(t){return null!=w[t]?w[t]:""}}).then(function(t){var e=t.blob,t=t.name,e=URL.createObjectURL(e),t=ld$.create({name:"a",attr:{href:e,download:t}});return document.body.appendChild(t),t.click(),document.body.removeChild(t),t.remove()}).catch(r())}}},init:{"download-dropdown":function(t){t=t.node;return new Dropdown(t)}},text:{"prj-count":function(t){t.node;return n().length}},handler:{"search-filter":function(t){t=t.node;return t.classList.toggle("active",t.getAttribute("data-name")===P.filter.badge||"")},empty:function(t){return t.node.classList.toggle("d-none",P.data.filter(function(t){return t.slug}).length)},prj:{list:n,handler:function(t){var e,n=t.node,r=t.local,t=t.data;return r.view.setContext(t),r.view.render(),"active"===t.state?(e=n.style).color="auto":(e=n.style).color="rgba(0,0,0,.6)",e},init:function(t){var e=t.node,i=t.local,t=t.data;return i.view=new ldView({context:t,root:e,action:{click:{"set-state":function(t){var e=t.node,n=t.context,r=e.getAttribute("data-name"),o={value:r};return a.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+n.slug+"/state",{method:"PUT"},{type:"json",json:o})}).finally(function(){return a.off()}).then(function(){return u.send("success","更新成功"),n.state=r,i.view.render("state")}).catch(function(){return u.send("danger","更新失敗")})},"set-badge":function(t){var e=t.node,n=t.context,r=(t=n.system||(n.system={})).badge||(t.badge={}),o=e.getAttribute("data-name");return r[o]=!r[o],a.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+n.slug+"/badge",{method:"PUT"},{type:"json",json:r})}).finally(function(){return a.off()}).then(function(){return u.send("success","更新成功"),i.view.render("badge-state")}).catch(function(){return u.send("danger","更新失敗"),r[o]=!r[o],i.view.render("badge-state")})},delete:function(t){var e=t.node,n=t.context;if(!e.classList.contains("running"))return o.get("confirm-deletion").then(function(t){if("yes"===t)return e.classList.toggle("running",!0),ld$.fetch("/dash/api/prj/"+n.slug,{method:"delete"},{type:"json"}).finally(function(){return e.classList.toggle("running",!1)}).then(function(){var t;return u.send("success","成功刪除了「"+n.name+"」提案"),~(t=P.data.indexOf(n))&&P.data.splice(t,1),P.view.render()}).catch(r())})},name:function(t){t.node;t=t.context;return s.toggle({nav:"main",name:"grp-detail"}),P.setPrj(t)}}},init:{state:function(t){t=t.node;return new Dropdown(t.parentNode)},"badge-chooser":function(t){t=t.node;return new Dropdown(t.parentNode)}},text:{name:function(t){return t.context.name||"(未命名的提案)"},state:function(t){return"active"===t.context.state?"已送件":"編輯中"},ownername:function(t){t=t.context;return(t.info||(t.info={})).teamname||t.ownername||""},username:function(t){return t.context.ownername||""},index:function(t){t.node;t=t.context;return(t.system||(t.system={})).idx||"-"},key:function(t){t.node;return t.context.key}},handler:{edit:function(t){var e=t.node,t=t.context;return e.setAttribute("href","/dash/prj/"+t.slug+"/edit")},"badge-state":function(t){var e=t.node,n=t.context,t=(n.system||(n.system={})).badge||{},n=e.getAttribute("data-name");return e.classList.toggle("on",!!t[n])},state:function(t){var e=t.node,t=t.context;return e.classList.toggle("text-success","active"===t.state),e.classList.toggle("text-warning","active"!==t.state)},"budget-consume":function(t){t.node;t.context},"budget-detail":function(t){t.node;t.context},avatar:function(t){var e=t.node,t=t.context;return e.style.background="url(/s/avatar/"+t.owner+".png)"}}})}}}}),this};return t.prototype=import$(Object.create(Object.prototype),{setHub:function(t){return this.hubs=t},setData:function(t){return this.grp=t},setPrj:function(t){return this.fire("set-prj",t)},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,r=[],o=slice$.call(arguments,1),i=0,a=(e=this.evtHandler[t]||[]).length;i<a;++i)n=e[i],r.push(n.apply(this,o));return r}}),t});