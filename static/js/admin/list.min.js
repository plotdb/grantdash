var slice$=[].slice;function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}function import$(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}ldc.register("adminPrjList",["error","loader","notify","ldcvmgr","auth","sdbAdapter","adminPanel"],function(t){var r=t.error,i=t.loader,u=t.notify,o=t.ldcvmgr,c=(t.auth,t.sdbAdapter,t.adminPanel),t=function(t){var e,n,k=this;return this.toc=t.toc,this.evtHandler={},this.data=[],this.filter={badge:""},c.on("active",function(t){t.nav;var e=t.name;t.panel;if("grp-list"===e)return ld$.fetch("/dash/api/brd/"+k.toc.brd.slug+"/list",{method:"GET"},{params:{grp:k.grp.key},type:"json"}).then(function(t){return k.data=t,k.data.map(function(t){return t.info=t.detail.info}),k.view.render()}).catch(r())}),e={},debounce(function(){return k.view.render("prj")}),n=function(){return k.data.filter(function(t){return(!k.filter.badge||(t.system||(t.system={})).badge&&t.system.badge[k.filter.badge])&&t.slug&&(!e.keyword||~[t.name,(t.info||(t.info={})).teamname,t.username,t.ownername].filter(function(t){return t}).join(" ").indexOf(e.keyword))})},this.view=new ldView({root:t.root,action:{input:{"search-input":function(t){t=t.node;return e.keyword=t.value}},keypress:{"search-input":function(t){t.node;if(13===t.evt.keyCode)return k.view.render()}},click:{search:function(){return k.view.render()},"search-filter":function(t){t=t.node;return k.filter.badge=t.getAttribute("data-name"),k.view.render()},download:function(t){var t=t.node,j=t.getAttribute("data-name"),x=t.getAttribute("data-type")||"active";return ld$.fetch("/dash/api/brd/"+k.toc.brd.slug+"/grp/"+k.grp.key+"/prjs",{method:"GET"},{type:"json"}).then(function(i){var r,t,e,d,l,n,o,a,u,c,s,f,p,m,g,h,v;if(null==i&&(i={}),console.log(i),x&&"all"!==x&&(i=i.filter(function(t){return!t.deleted}).filter(function(t){return"active"===x?"active"===t.state:((t=t.system||(t.system={})).badge||(t.badge={}))[x]})),"custom"===j)return window.adminExtension=null,r=k.hubs.brd.doc.data.info.view,new Promise(function(a,t){var e,n=function(){var o,t,e,n,r;if(i[0]&&((n=(n=i[0]).detail||(n.detail={})).custom||(n.custom={})).open){for(e in o={},i.map(function(t){var e,n,r=[];for(e in n=(t=(t=t.detail||(t.detail={})).custom||(t.custom={})).open||(t.open={}))n[e],r.push(o[e]=1);return r}),t=[],o)t.push(e);return n=(o=t).map(function(t){return'"'+(""+t).replace(/"/g,"'")+'"'}),r=i.map(function(n){return o.map(function(t){var e;return((e=(e=n.detail||(n.detail={})).custom||(e.custom={})).open||(e.open={}))[t]||""}).map(function(t){return"object"!=typeof t?t:t?null!=t.v?t.v:null!=t.list||null!=t.other&&null!=t.other.text?(t.list||[]).concat([t.other&&t.other.enabled&&t.other.text||""]).filter(function(t){return null!=t&&""!==t}):JSON.stringify(t):""}).map(function(t){return'"'+(""+t).replace(/"/g,"'")+'"'})}),{blob:r=csv4xls.toBlob([n].concat(r)),name:k.toc.brd.name+"-"+k.grp.info.name+".csv"}}return r=new Blob([JSON.stringify(i)],{type:"application/json"}),a({blob:r,name:"projects.json"})};return r?((e=document.createElement("script")).src="/dash/js/view/"+r+"/admin.js?v="+Math.random().toString(36).substring(2),e.onload=function(){var t=(adminExtension||{}).downloadProjects;return a(t?t({prjs:i,toc:k.toc,grp:k.grp}):n())},e.onerror=function(){return a(n())},document.body.appendChild(e)):a(n())});if("csv"!==j)return"mail"===j&&(i=i.map(function(t){return{username:t.username,name:t.name}})),{blob:new Blob([JSON.stringify(i)],{type:"application/json"}),name:"projects-"+j+".json"};if(k.grp.form)t=k.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t){return t.title}),e=i.map(function(n){return k.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t,e){t=n.detail.answer[t.key];return t?t.content||(t.list?(t.list||[]).concat(t.other?[t.otherValue]:[]).join(","):""):""})});else{for(d={},l=function(t,e,n){var r,o,a,i,u,c,s=[];if(null==n&&(n={}),Array.isArray(t)){for(r=0,o=t.length;r<o;++r)a=r,s.push(l(t[a],e.concat([a+1]),n));return s}if("object"!=typeof t)return c=e.join("-"),d[c]=!0,console.log(typeof t,t),n[c]=null!=t?t:"";for(i in t)u=t[i],s.push(l(u,e.concat([i]),n));return s},n=[],o=0,a=i.length;o<a;++o)c=i[o],n.push(u=[]),l((c=c.detail||(c.detail={})).custom||(c.custom={}),[],u);for(f in s=[],d)s.push(f);for(e=[],p=(t=d=s)[o=0].length;o<p;++o)if(m=o,g=t[0].substring(0,m),console.log(g),d.filter(b).length){t=t.map(y);break}for(e.push(t),o=0,a=n.length;o<a;++o)h=n[o],v=d.map(w),e.push(v)}return{blob:csv4xls.toBlob([t].concat(e)),name:k.toc.brd.name+"-"+k.grp.info.name+".csv"};function b(t){return!t.startsWith(g)}function y(t){return t.substring(0<(t=m-1)?t:0)}function w(t){return null!=h[t]?h[t]:""}}).then(function(t){var e=t.blob,t=t.name,e=URL.createObjectURL(e),t=ld$.create({name:"a",attr:{href:e,download:t}});return document.body.appendChild(t),t.click(),document.body.removeChild(t),t.remove()}).catch(r())}}},init:{"download-dropdown":function(t){t=t.node;return new Dropdown(t)}},text:{"prj-count":function(t){t.node;return n().length}},handler:{"search-filter":function(t){t=t.node;return t.classList.toggle("active",t.getAttribute("data-name")===k.filter.badge||"")},empty:function(t){return t.node.classList.toggle("d-none",k.data.filter(function(t){return t.slug}).length)},prj:{list:n,handler:function(t){var e,n=t.node,r=t.local,t=t.data;return r.view.setContext(t),r.view.render(),"active"===t.state?(e=n.style).color="auto":(e=n.style).color="rgba(0,0,0,.6)",e},init:function(t){var e=t.node,a=t.local,t=t.data;return a.view=new ldView({context:t,root:e,action:{click:{"set-state":function(t){var e=t.node,n=t.context,r=e.getAttribute("data-name"),o={value:r};return i.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+n.slug+"/state",{method:"PUT"},{type:"json",json:o})}).finally(function(){return i.off()}).then(function(){return u.send("success","更新成功"),n.state=r,a.view.render("state")}).catch(function(){return u.send("danger","更新失敗")})},"set-badge":function(t){var e=t.node,n=t.context,r=(t=n.system||(n.system={})).badge||(t.badge={}),o=e.getAttribute("data-name");return r[o]=!r[o],i.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+n.slug+"/badge",{method:"PUT"},{type:"json",json:r})}).finally(function(){return i.off()}).then(function(){return u.send("success","更新成功"),a.view.render("badge-state")}).catch(function(){return u.send("danger","更新失敗"),r[o]=!r[o],a.view.render("badge-state")})},delete:function(t){var e=t.node,n=t.context;if(!e.classList.contains("running"))return o.get("confirm-deletion").then(function(t){if("yes"===t)return e.classList.toggle("running",!0),ld$.fetch("/dash/api/prj/"+n.slug,{method:"delete"},{type:"json"}).finally(function(){return e.classList.toggle("running",!1)}).then(function(){var t;return u.send("success","成功刪除了「"+n.name+"」提案"),~(t=k.data.indexOf(n))&&k.data.splice(t,1),k.view.render()}).catch(r())})},name:function(t){t.node;t=t.context;return c.toggle({nav:"main",name:"grp-detail"}),k.setPrj(t)}}},init:{state:function(t){t=t.node;return new Dropdown(t.parentNode)},"badge-chooser":function(t){t=t.node;return new Dropdown(t.parentNode)}},text:{name:function(t){return t.context.name||"(未命名的提案)"},index:function(t){return t.context.key},state:function(t){return"active"===t.context.state?"已送件":"編輯中"},ownername:function(t){t=t.context;return(t.info||(t.info={})).teamname||t.ownername||""},username:function(t){return t.context.ownername||""}},handler:{edit:function(t){var e=t.node,t=t.context;return e.setAttribute("href","/dash/prj/"+t.slug+"/edit")},"badge-state":function(t){var e=t.node,n=t.context,t=(n.system||(n.system={})).badge||{},n=e.getAttribute("data-name");return e.classList.toggle("on",!!t[n])},state:function(t){var e=t.node,t=t.context;return e.classList.toggle("text-success","active"===t.state),e.classList.toggle("text-warning","active"!==t.state)},"budget-consume":function(t){t.node;t.context},"budget-detail":function(t){t.node;t.context},avatar:function(t){var e=t.node,t=t.context;return e.style.background="url(/s/avatar/"+t.owner+".png)"}}})}}}}),this};return t.prototype=import$(Object.create(Object.prototype),{setHub:function(t){return this.hubs=t},setData:function(t){return this.grp=t},setPrj:function(t){return this.fire("set-prj",t)},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,r=[],o=slice$.call(arguments,1),a=0,i=(e=this.evtHandler[t]||[]).length;a<i;++a)n=e[a],r.push(n.apply(this,o));return r}}),t});