function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}var slice$=[].slice;ldc.register("adminPrjList",["error","loader","notify","ldcvmgr","auth","sdbAdapter","adminPanel"],function(t){var e,n,r,a,o,i;return e=t.error,n=t.loader,r=t.notify,a=t.ldcvmgr,t.auth,t.sdbAdapter,o=t.adminPanel,i=function(t){var i,u=this;return this.toc=t.toc,this.evtHandler={},this.data=[],this.filter={badge:""},o.on("active",function(t){var n;if(t.nav,n=t.name,t.panel,"grp-list"===n)return ld$.fetch("/dash/api/brd/"+u.toc.brd.slug+"/list",{method:"GET"},{params:{grp:u.grp.key},type:"json"}).then(function(t){return u.data=t,u.data.map(function(t){return t.info=t.detail.info}),u.view.render()}).catch(e())}),i={},debounce(function(){return u.view.render("prj")}),this.view=new ldView({root:t.root,action:{input:{"search-input":function(t){var e;return e=t.node,i.keyword=e.value}},keypress:{"search-input":function(t){if(t.node,13===t.evt.keyCode)return u.view.render()}},click:{search:function(){return u.view.render()},"search-filter":function(t){var e;return e=t.node,u.filter.badge=e.getAttribute("data-name"),u.view.render()},download:function(t){var n,r,a;return n=t.node,r=n.getAttribute("data-name"),a=n.getAttribute("data-type")||"active",ld$.fetch("/dash/api/brd/"+u.toc.brd.slug+"/grp/"+u.grp.key+"/prjs",{method:"GET"},{type:"json"}).then(function(t){var e,n,o,i,c;return null==t&&(t={}),a&&"all"!==a&&(t=t.filter(function(t){return!t.deleted}).filter(function(t){var e;return"active"===a?"active"===t.state:((e=t.system||(t.system={})).badge||(e.badge={}))[a]})),"custom"===r?(window.adminExtension=null,e=u.hubs.brd.doc.data.custom,new Promise(function(n,r){var a,o;return a=function(){var e,r;return e=new Blob([JSON.stringify(t)],{type:"application/json"}),r="projects.json",n({blob:e,name:r})},e&&e.view?(o=document.createElement("script"),o.src="/dash/js/view/"+e.view+"/admin.js?v="+Math.random().toString(36).substring(2),o.onload=function(){var e;return e=(adminExtension||{}).downloadProjects,n(e?e({prjs:t}):a())},o.onerror=function(){return n(a())},document.body.appendChild(o)):n(a())})):"csv"===r?(n=u.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t){return t.title}),o=t.map(function(t){return u.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(e,n){var r;return(r=t.detail.answer[e.key])?r.content?r.content:r.list?(r.list||[]).concat(r.other?[r.otherValue]:[]).join(","):"":""})}),i=csv4xls.toBlob([n].concat(o)),c=u.toc.brd.name+"-"+u.grp.info.name+".csv",{blob:i,name:c}):("mail"===r&&(t=t.map(function(t){return{username:t.username,name:t.name}})),i=new Blob([JSON.stringify(t)],{type:"application/json"}),c="projects-"+r+".json",{blob:i,name:c})}).then(function(t){var e,n,r,a;return e=t.blob,n=t.name,r=URL.createObjectURL(e),a=ld$.create({name:"a",attr:{href:r,download:n}}),document.body.appendChild(a),a.click(),document.body.removeChild(a),a.remove()}).catch(e())}}},init:{"download-dropdown":function(t){var e;return e=t.node,new Dropdown(e)}},handler:{"search-filter":function(t){var e;return(e=t.node).classList.toggle("active",e.getAttribute("data-name")===u.filter.badge||"")},empty:function(t){return t.node.classList.toggle("d-none",u.data.filter(function(t){return t.slug}).length)},prj:{list:function(){return u.data.filter(function(t){return(!u.filter.badge||t.system.badge[u.filter.badge])&&t.slug&&(!i.keyword||~[t.name,(t.info||(t.info={})).teamname,t.username,t.ownername].filter(function(t){return t}).join(" ").indexOf(i.keyword))})},handler:function(t){var e,n,r,a;return e=t.node,n=t.local,r=t.data,n.view.setContext(r),n.view.render(),"active"===r.state?(a=e.style,a.color="auto",a):(a=e.style,a.color="rgba(0,0,0,.6)",a)},init:function(t){var i,c,s;return i=t.node,c=t.local,s=t.data,c.view=new ldView({context:s,root:i,action:{click:{"set-state":function(t){var e,a,o,i;return e=t.node,a=t.context,o=e.getAttribute("data-name"),i={value:o},n.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+a.slug+"/state",{method:"PUT"},{type:"json",json:i})}).finally(function(){return n.off()}).then(function(){return r.send("success","更新成功"),a.state=o,c.view.render("state")}).catch(function(){return r.send("danger","更新失敗")})},"set-badge":function(t){var e,a,o,i,u;return e=t.node,a=t.context,o=(i=a.system||(a.system={})).badge||(i.badge={}),u=e.getAttribute("data-name"),o[u]=!o[u],n.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+a.slug+"/badge",{method:"PUT"},{type:"json",json:o})}).finally(function(){return n.off()}).then(function(){return r.send("success","更新成功"),c.view.render("badge-state")}).catch(function(){return r.send("danger","更新失敗"),o[u]=!o[u],c.view.render("badge-state")})},delete:function(t){var n,o;if(n=t.node,o=t.context,!n.classList.contains("running"))return a.get("confirm-deletion").then(function(t){if("yes"===t)return n.classList.toggle("running",!0),ld$.fetch("/dash/api/prj/"+o.slug,{method:"delete"},{type:"json"}).finally(function(){return n.classList.toggle("running",!1)}).then(function(){var t;return r.send("success","成功刪除了「"+o.name+"」提案"),~(t=u.data.indexOf(o))&&u.data.splice(t,1),u.view.render()}).catch(e())})},name:function(t){var e;return t.node,e=t.context,o.toggle({nav:"main",name:"grp-detail"}),u.setPrj(e)}}},init:{state:function(t){var e;return e=t.node,new Dropdown(e.parentNode)},"badge-chooser":function(t){var e;return e=t.node,new Dropdown(e.parentNode)}},text:{name:function(t){return t.context.name||"(未命名的提案)"},index:function(t){return t.context.key},state:function(t){return"active"===t.context.state?"已送件":"編輯中"},ownername:function(t){var e;return((e=t.context).info||(e.info={})).teamname||e.ownername||""},username:function(t){return t.context.ownername||""}},handler:{edit:function(t){var e,n;return e=t.node,n=t.context,e.setAttribute("href","/dash/prj/"+n.slug+"/edit")},"badge-state":function(t){var e,n,r,a;return e=t.node,n=t.context,r=(n.system||(n.system={})).badge||{},a=e.getAttribute("data-name"),e.classList.toggle("on",!!r[a])},state:function(t){var e,n;return e=t.node,n=t.context,e.classList.toggle("text-success","active"===n.state),e.classList.toggle("text-warning","active"!==n.state)},"budget-consume":function(t){t.node,t.context},"budget-detail":function(t){t.node,t.context},avatar:function(t){var e,n;return e=t.node,n=t.context,e.style.background="url(/s/avatar/"+n.owner+".png)"}}})}}}}),this},i.prototype=import$(Object.create(Object.prototype),{setHub:function(t){return this.hubs=t},setData:function(t){return this.grp=t},setPrj:function(t){return this.fire("set-prj",t)},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){var e,n,r,a,o,i=[];for(e=slice$.call(arguments,1),n=0,a=(r=this.evtHandler[t]||[]).length;n<a;++n)o=r[n],i.push(o.apply(this,e));return i}}),i});