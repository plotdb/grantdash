var slice$=[].slice;function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}function import$(t,e){var n,r={}.hasOwnProperty;for(n in e)r.call(e,n)&&(t[n]=e[n]);return t}ldc.register("adminPrjList",["error","loader","notify","ldcvmgr","auth","sdbAdapter","adminPanel"],function(t){var r=t.error,i=t.loader,u=t.notify,o=t.ldcvmgr,c=(t.auth,t.sdbAdapter,t.adminPanel),t=function(t){var e,n,L=this;return this.toc=t.toc,this.evtHandler={},this.data=[],this.filter={badge:""},c.on("active",function(t){t.nav;var e=t.name;t.panel;if("grp-list"===e)return ld$.fetch("/dash/api/brd/"+L.toc.brd.slug+"/list",{method:"GET"},{params:{grp:L.grp.key},type:"json"}).then(function(t){return L.data=t,L.data.map(function(t){return t.info=t.detail.info}),L.view.render()}).catch(r())}),e={},debounce(function(){return L.view.render("prj")}),n=function(){return L.data.filter(function(t){return(!L.filter.badge||(t.system||(t.system={})).badge&&t.system.badge[L.filter.badge])&&t.slug&&(!e.keyword||~[t.name,(t.info||(t.info={})).teamname,t.username,t.ownername].filter(function(t){return t}).join(" ").indexOf(e.keyword))})},this.view=new ldView({root:t.root,action:{input:{"search-input":function(t){t=t.node;return e.keyword=t.value}},keypress:{"search-input":function(t){t.node;if(13===t.evt.keyCode)return L.view.render()}},click:{search:function(){return L.view.render()},"search-filter":function(t){t=t.node;return L.filter.badge=t.getAttribute("data-name"),L.view.render()},download:function(t){var t=t.node,$=t.getAttribute("data-name"),A=t.getAttribute("data-type")||"active";return ld$.fetch("/dash/api/brd/"+L.toc.brd.slug+"/grp/"+L.grp.key+"/prjs",{method:"GET"},{type:"json"}).then(function(i){var r,t,e,d,l,n,o,a,u,c,s,f,m,p,g,h,b,v,y;if(null==i&&(i={}),console.log(i),A&&"all"!==A&&(i=i.filter(function(t){return!t.deleted}).filter(function(t){return"active"===A?"active"===t.state:((t=t.system||(t.system={})).badge||(t.badge={}))[A]})),"custom"===$)return window.adminExtension=null,r=L.hubs.brd.doc.data.info.view,new Promise(function(a,t){var e,n=function(){var o,t,e,n,r;if(i[0]&&((n=(n=i[0]).detail||(n.detail={})).custom||(n.custom={})).open){for(e in o={},i.map(function(t){var e,n,r=[];for(e in n=(t=(t=t.detail||(t.detail={})).custom||(t.custom={})).open||(t.open={}))n[e],r.push(o[e]=1);return r}),t=[],o)t.push(e);return n=(o=t).map(function(t){return'"'+(""+t).replace(/"/g,"'")+'"'}),r=i.map(function(n){return o.map(function(t){var e;return((e=(e=n.detail||(n.detail={})).custom||(e.custom={})).open||(e.open={}))[t]||""}).map(function(t){return"object"!=typeof t?t:t?null!=t.v?t.v:null!=t.list||null!=t.other&&null!=t.other.text?(t.list||[]).concat([t.other&&t.other.enabled&&t.other.text||""]).filter(function(t){return null!=t&&""!==t}):JSON.stringify(t):""}).map(function(t){return'"'+(""+t).replace(/"/g,"'")+'"'})}),{blob:r=csv4xls.toBlob([n].concat(r)),name:L.toc.brd.name+"-"+L.grp.info.name+".csv"}}return r=new Blob([JSON.stringify(i)],{type:"application/json"}),a({blob:r,name:"projects.json"})};return r?((e=document.createElement("script")).src="/dash/js/view/"+r+"/admin.js?v="+Math.random().toString(36).substring(2),e.onload=function(){var t=(adminExtension||{}).downloadProjects;return a(t?t({prjs:i,toc:L.toc,grp:L.grp}):n())},e.onerror=function(){return a(n())},document.body.appendChild(e)):a(n())});if("csv"!==$)return"mail"===$&&(i=i.map(function(t){return{username:t.username,name:t.name}})),{blob:new Blob([JSON.stringify(i)],{type:"application/json"}),name:"projects-"+$+".json"};if(L.grp.form)t=L.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t){return t.title}),e=i.map(function(n){return L.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t,e){t=n.detail.answer[t.key];return t?t.content||(t.list?(t.list||[]).concat(t.other?[t.otherValue]:[]).join(","):""):""})});else{for(d={},l=function(t,e,n){var r,o,a,i,u,c,s=[];if(null==n&&(n={}),Array.isArray(t)){for(r=0,o=t.length;r<o;++r)a=r,s.push(l(t[a],e.concat([a+1]),n));return s}if("object"!=typeof t)return c=e.join("-"),d[c]=!0,n[c]=null!=t?t:"";for(i in t)u=t[i],s.push(l(u,e.concat([i]),n));return s},n=[],o=[],a=0,u=i.length;a<u;++a)c=i[a],n.push(s=[]),o.push([null!=c.system.idx?c.system.idx:""].concat(["criteria","shortlist","winner","special"].map(w))),l((f=c.detail||(c.detail={})).custom||(f.custom={}),[],s);for(p in m=[],d)m.push(p);for(e=[],g=(t=d=m)[a=0].length;a<g;++a)if(h=a,b=t[0].substring(0,h),d.filter(j).length){t=t.map(x);break}for(a=0,g=n.length;a<g;++a)v=n[h=a],y=o[h].concat(d.map(k)),e.push(y);t=["idx","資格審查","通過初選","獲獎","特別獎"].concat(t)}return{blob:csv4xls.toBlob([t].concat(e)),name:L.toc.brd.name+"-"+L.grp.info.name+".csv"};function w(t){return c.system.badge[t]?"O":""}function j(t){return!t.startsWith(b)}function x(t){return t.substring(0<(t=h-1)?t:0)}function k(t){return null!=v[t]?v[t]:""}}).then(function(t){var e=t.blob,t=t.name,e=URL.createObjectURL(e),t=ld$.create({name:"a",attr:{href:e,download:t}});return document.body.appendChild(t),t.click(),document.body.removeChild(t),t.remove()}).catch(r())}}},init:{"download-dropdown":function(t){t=t.node;return new Dropdown(t)}},text:{"prj-count":function(t){t.node;return n().length}},handler:{"search-filter":function(t){t=t.node;return t.classList.toggle("active",t.getAttribute("data-name")===L.filter.badge||"")},empty:function(t){return t.node.classList.toggle("d-none",L.data.filter(function(t){return t.slug}).length)},prj:{list:n,handler:function(t){var e,n=t.node,r=t.local,t=t.data;return r.view.setContext(t),r.view.render(),"active"===t.state?(e=n.style).color="auto":(e=n.style).color="rgba(0,0,0,.6)",e},init:function(t){var e=t.node,a=t.local,t=t.data;return a.view=new ldView({context:t,root:e,action:{click:{"set-state":function(t){var e=t.node,n=t.context,r=e.getAttribute("data-name"),o={value:r};return i.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+n.slug+"/state",{method:"PUT"},{type:"json",json:o})}).finally(function(){return i.off()}).then(function(){return u.send("success","更新成功"),n.state=r,a.view.render("state")}).catch(function(){return u.send("danger","更新失敗")})},"set-badge":function(t){var e=t.node,n=t.context,r=(t=n.system||(n.system={})).badge||(t.badge={}),o=e.getAttribute("data-name");return r[o]=!r[o],i.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+n.slug+"/badge",{method:"PUT"},{type:"json",json:r})}).finally(function(){return i.off()}).then(function(){return u.send("success","更新成功"),a.view.render("badge-state")}).catch(function(){return u.send("danger","更新失敗"),r[o]=!r[o],a.view.render("badge-state")})},delete:function(t){var e=t.node,n=t.context;if(!e.classList.contains("running"))return o.get("confirm-deletion").then(function(t){if("yes"===t)return e.classList.toggle("running",!0),ld$.fetch("/dash/api/prj/"+n.slug,{method:"delete"},{type:"json"}).finally(function(){return e.classList.toggle("running",!1)}).then(function(){var t;return u.send("success","成功刪除了「"+n.name+"」提案"),~(t=L.data.indexOf(n))&&L.data.splice(t,1),L.view.render()}).catch(r())})},name:function(t){t.node;t=t.context;return c.toggle({nav:"main",name:"grp-detail"}),L.setPrj(t)}}},init:{state:function(t){t=t.node;return new Dropdown(t.parentNode)},"badge-chooser":function(t){t=t.node;return new Dropdown(t.parentNode)}},text:{name:function(t){return t.context.name||"(未命名的提案)"},index:function(t){return t.context.key},state:function(t){return"active"===t.context.state?"已送件":"編輯中"},ownername:function(t){t=t.context;return(t.info||(t.info={})).teamname||t.ownername||""},username:function(t){return t.context.ownername||""}},handler:{edit:function(t){var e=t.node,t=t.context;return e.setAttribute("href","/dash/prj/"+t.slug+"/edit")},"badge-state":function(t){var e=t.node,n=t.context,t=(n.system||(n.system={})).badge||{},n=e.getAttribute("data-name");return e.classList.toggle("on",!!t[n])},state:function(t){var e=t.node,t=t.context;return e.classList.toggle("text-success","active"===t.state),e.classList.toggle("text-warning","active"!==t.state)},"budget-consume":function(t){t.node;t.context},"budget-detail":function(t){t.node;t.context},avatar:function(t){var e=t.node,t=t.context;return e.style.background="url(/s/avatar/"+t.owner+".png)"}}})}}}}),this};return t.prototype=import$(Object.create(Object.prototype),{setHub:function(t){return this.hubs=t},setData:function(t){return this.grp=t},setPrj:function(t){return this.fire("set-prj",t)},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){for(var e,n,r=[],o=slice$.call(arguments,1),a=0,i=(e=this.evtHandler[t]||[]).length;a<i;++a)n=e[a],r.push(n.apply(this,o));return r}}),t});