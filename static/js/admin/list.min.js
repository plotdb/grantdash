function import$(t,n){var e={}.hasOwnProperty;for(var r in n)e.call(n,r)&&(t[r]=n[r]);return t}var slice$=[].slice;ldc.register("adminPrjList",["error","loader","notify","ldcvmgr","auth","sdbAdapter","adminPanel"],function(t){var n,e,r,o,a,i;return n=t.error,e=t.loader,r=t.notify,o=t.ldcvmgr,t.auth,t.sdbAdapter,a=t.adminPanel,i=function(t){var i,u=this;return this.toc=t.toc,this.evtHandler={},this.data=[],a.on("active",function(t){var e;if(t.nav,e=t.name,t.panel,"grp-list"===e)return ld$.fetch("/dash/api/brd/"+u.toc.brd.slug+"/list",{method:"GET"},{params:{grp:u.grp.key},type:"json"}).then(function(t){return u.data=t,u.data.map(function(t){return t.info=t.detail.info}),u.view.render()}).catch(n())}),i={},debounce(function(){return u.view.render("prj")}),this.view=new ldView({root:t.root,action:{input:{"search-input":function(t){var n;return n=t.node,i.keyword=n.value}},keypress:{"search-input":function(t){if(t.node,13===t.evt.keyCode)return u.view.render()}},click:{search:function(){return u.view.render()},download:function(t){var e,r,o;return e=t.node,r=e.getAttribute("data-name"),o=e.getAttribute("data-type"),ld$.fetch("/dash/api/brd/"+u.toc.brd.slug+"/grp/"+u.grp.key+"/prjs",{method:"GET"},{type:"json"}).then(function(t){var n,e,a;return null==t&&(t={}),o&&"all"!==o&&(t=t.filter(function(t){var n;return"active"===o?"active"===t.state:((n=t.system||(t.system={})).badge||(n.badge={}))[o]})),"custom"===r?(window.adminExtension=null,n=u.hubs.brd.doc.data.custom,new Promise(function(e,r){var o,a;return o=function(){var n,r;return n=new Blob([JSON.stringify(t)],{type:"application/json"}),r="projects.json",e({blob:n,name:r})},n&&n.view?(a=document.createElement("script"),a.src="/dash/js/view/"+n.view+"/admin.js?v="+Math.random().toString(36).substring(2),a.onload=function(){var n;return n=(adminExtension||{}).downloadProjects,e(n?n({prjs:t}):o())},a.onerror=function(){return e(o())},document.body.appendChild(a)):e(o())})):("mail"===r&&(t=t.map(function(t){return{username:t.username,name:t.name}})),e=new Blob([JSON.stringify(t)],{type:"application/json"}),a="projects-"+r+".json",{blob:e,name:a})}).then(function(t){var n,e,r,o;return n=t.blob,e=t.name,r=URL.createObjectURL(n),o=ld$.create({name:"a",attr:{href:r,download:e}}),document.body.appendChild(o),o.click(),document.body.removeChild(o),o.remove()}).catch(n())}}},init:{"download-dropdown":function(t){var n;return n=t.node,new Dropdown(n)}},handler:{empty:function(t){return t.node.classList.toggle("d-none",u.data.filter(function(t){return t.slug}).length)},prj:{list:function(){return u.data.filter(function(t){return t.slug&&(!i.keyword||~[t.name,(t.info||(t.info={})).teamname,t.username,t.ownername].filter(function(t){return t}).join(" ").indexOf(i.keyword))})},handler:function(t){var n,e,r,o;return n=t.node,e=t.local,r=t.data,e.view.setContext(r),e.view.render(),"active"===r.state?(o=n.style,o.color="auto",o):(o=n.style,o.color="rgba(0,0,0,.6)",o)},init:function(t){var i,c,s;return i=t.node,c=t.local,s=t.data,c.view=new ldView({context:s,root:i,action:{click:{"set-state":function(t){var n,o,a,i;return n=t.node,o=t.context,a=n.getAttribute("data-name"),i={value:a},e.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+o.slug+"/state",{method:"PUT"},{type:"json",json:i})}).finally(function(){return e.off()}).then(function(){return r.send("success","更新成功"),o.state=a,c.view.render("state")}).catch(function(){return r.send("danger","更新失敗")})},delete:function(t){var e,a;if(e=t.node,a=t.context,!e.classList.contains("running"))return o.get("confirm-deletion").then(function(t){if("yes"===t)return e.classList.toggle("running",!0),ld$.fetch("/dash/api/prj/"+a.slug,{method:"delete"},{type:"json"}).finally(function(){return e.classList.toggle("running",!1)}).then(function(){var t;return r.send("success","成功刪除了「"+a.name+"」提案"),~(t=u.data.indexOf(a))&&u.data.splice(t,1),u.view.render()}).catch(n())})},name:function(t){var n;return t.node,n=t.context,a.toggle({nav:"main",name:"grp-detail"}),u.setPrj(n)}}},init:{state:function(t){var n;return n=t.node,new Dropdown(n.parentNode)}},text:{name:function(t){return t.context.name||"(未命名的提案)"},index:function(t){return t.context.key},state:function(t){return"active"===t.context.state?"已送件":"編輯中"},ownername:function(t){var n;return((n=t.context).info||(n.info={})).teamname||n.ownername||""},username:function(t){return t.context.ownername||""}},handler:{edit:function(t){var n,e;return n=t.node,e=t.context,n.setAttribute("href","/dash/prj/"+e.slug+"/edit")},state:function(t){var n,e;return n=t.node,e=t.context,n.classList.toggle("text-success","active"===e.state),n.classList.toggle("text-warning","active"!==e.state)},"budget-consume":function(t){t.node,t.context},"budget-detail":function(t){t.node,t.context},avatar:function(t){var n,e;return n=t.node,e=t.context,n.style.background="url(/s/avatar/"+e.owner+".png)"}}})}}}}),this},i.prototype=import$(Object.create(Object.prototype),{setHub:function(t){return this.hubs=t},setData:function(t){return this.grp=t},setPrj:function(t){return this.fire("set-prj",t)},on:function(t,n){var e;return((e=this.evtHandler)[t]||(e[t]=[])).push(n)},fire:function(t){var n,e,r,o,a,i=[];for(n=slice$.call(arguments,1),e=0,o=(r=this.evtHandler[t]||[]).length;e<o;++e)a=r[e],i.push(a.apply(this,n));return i}}),i});