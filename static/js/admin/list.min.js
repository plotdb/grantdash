function in$(t,e){for(var n=-1,r=e.length>>>0;++n<r;)if(t===e[n])return!0;return!1}function import$(t,e){var n={}.hasOwnProperty;for(var r in e)n.call(e,r)&&(t[r]=e[r]);return t}var slice$=[].slice;ldc.register("adminPrjList",["error","loader","notify","ldcvmgr","auth","sdbAdapter","adminPanel"],function(t){var e,n,r,o,a,i;return e=t.error,n=t.loader,r=t.notify,o=t.ldcvmgr,t.auth,t.sdbAdapter,a=t.adminPanel,i=function(t){var i,u,c=this;return this.toc=t.toc,this.evtHandler={},this.data=[],this.filter={badge:""},a.on("active",function(t){var n;if(t.nav,n=t.name,t.panel,"grp-list"===n)return ld$.fetch("/dash/api/brd/"+c.toc.brd.slug+"/list",{method:"GET"},{params:{grp:c.grp.key},type:"json"}).then(function(t){return c.data=t,c.data.map(function(t){return t.info=t.detail.info}),c.view.render()}).catch(e())}),i={},debounce(function(){return c.view.render("prj")}),u=function(){return c.data.filter(function(t){return(!c.filter.badge||t.system.badge[c.filter.badge])&&t.slug&&(!i.keyword||~[t.name,(t.info||(t.info={})).teamname,t.username,t.ownername].filter(function(t){return t}).join(" ").indexOf(i.keyword))})},this.view=new ldView({root:t.root,action:{input:{"search-input":function(t){var e;return e=t.node,i.keyword=e.value}},keypress:{"search-input":function(t){if(t.node,13===t.evt.keyCode)return c.view.render()}},click:{search:function(){return c.view.render()},"search-filter":function(t){var e;return e=t.node,c.filter.badge=e.getAttribute("data-name"),c.view.render()},download:function(t){var n,r,o;return n=t.node,r=n.getAttribute("data-name"),o=n.getAttribute("data-type")||"active",ld$.fetch("/dash/api/brd/"+c.toc.brd.slug+"/grp/"+c.grp.key+"/prjs",{method:"GET"},{type:"json"}).then(function(t){var e,n,a,i,u;return null==t&&(t={}),o&&"all"!==o&&(t=t.filter(function(t){return!t.deleted}).filter(function(t){var e;return"active"===o?"active"===t.state:((e=t.system||(t.system={})).badge||(e.badge={}))[o]})),"custom"===r?(window.adminExtension=null,e=c.hubs.brd.doc.data.custom,new Promise(function(n,r){var o,a;return o=function(){var e;return e=new Blob([JSON.stringify(t)],{type:"application/json"}),"projects.json",n({blob:e,name:"projects.json"})},e&&e.view?(a=document.createElement("script"),a.src="/dash/js/view/"+e.view+"/admin.js?v="+Math.random().toString(36).substring(2),a.onload=function(){var e;return e=(adminExtension||{}).downloadProjects,n(e?e({prjs:t}):o())},a.onerror=function(){return n(o())},document.body.appendChild(a)):n(o())})):"csv"===r?(n=c.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(t){return t.title}),a=t.map(function(t){return c.grp.form.list.filter(function(t){return!in$(t.name,["form-file"])}).map(function(e,n){var r;return(r=t.detail.answer[e.key])?r.content?r.content:r.list?(r.list||[]).concat(r.other?[r.otherValue]:[]).join(","):"":""})}),i=csv4xls.toBlob([n].concat(a)),u=c.toc.brd.name+"-"+c.grp.info.name+".csv",{blob:i,name:u}):("mail"===r&&(t=t.map(function(t){return{username:t.username,name:t.name}})),i=new Blob([JSON.stringify(t)],{type:"application/json"}),u="projects-"+r+".json",{blob:i,name:u})}).then(function(t){var e,n,r,o;return e=t.blob,n=t.name,r=URL.createObjectURL(e),o=ld$.create({name:"a",attr:{href:r,download:n}}),document.body.appendChild(o),o.click(),document.body.removeChild(o),o.remove()}).catch(e())}}},init:{"download-dropdown":function(t){var e;return e=t.node,new Dropdown(e)}},text:{"prj-count":function(t){return t.node,u().length}},handler:{"search-filter":function(t){var e;return(e=t.node).classList.toggle("active",e.getAttribute("data-name")===c.filter.badge||"")},empty:function(t){return t.node.classList.toggle("d-none",c.data.filter(function(t){return t.slug}).length)},prj:{list:function(){return u()},handler:function(t){var e,n,r,o;return e=t.node,n=t.local,r=t.data,n.view.setContext(r),n.view.render(),"active"===r.state?(o=e.style,o.color="auto",o):(o=e.style,o.color="rgba(0,0,0,.6)",o)},init:function(t){var i,u,s;return i=t.node,u=t.local,s=t.data,u.view=new ldView({context:s,root:i,action:{click:{"set-state":function(t){var e,o,a,i;return e=t.node,o=t.context,a=e.getAttribute("data-name"),i={value:a},n.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+o.slug+"/state",{method:"PUT"},{type:"json",json:i})}).finally(function(){return n.off()}).then(function(){return r.send("success","更新成功"),o.state=a,u.view.render("state")}).catch(function(){return r.send("danger","更新失敗")})},"set-badge":function(t){var e,o,a,i,c;return e=t.node,o=t.context,a=(i=o.system||(o.system={})).badge||(i.badge={}),c=e.getAttribute("data-name"),a[c]=!a[c],n.on(),debounce(500).then(function(){return ld$.fetch("/dash/api/prj/"+o.slug+"/badge",{method:"PUT"},{type:"json",json:a})}).finally(function(){return n.off()}).then(function(){return r.send("success","更新成功"),u.view.render("badge-state")}).catch(function(){return r.send("danger","更新失敗"),a[c]=!a[c],u.view.render("badge-state")})},delete:function(t){var n,a;if(n=t.node,a=t.context,!n.classList.contains("running"))return o.get("confirm-deletion").then(function(t){if("yes"===t)return n.classList.toggle("running",!0),ld$.fetch("/dash/api/prj/"+a.slug,{method:"delete"},{type:"json"}).finally(function(){return n.classList.toggle("running",!1)}).then(function(){var t;return r.send("success","成功刪除了「"+a.name+"」提案"),~(t=c.data.indexOf(a))&&c.data.splice(t,1),c.view.render()}).catch(e())})},name:function(t){var e;return t.node,e=t.context,a.toggle({nav:"main",name:"grp-detail"}),c.setPrj(e)}}},init:{state:function(t){var e;return e=t.node,new Dropdown(e.parentNode)},"badge-chooser":function(t){var e;return e=t.node,new Dropdown(e.parentNode)}},text:{name:function(t){return t.context.name||"(未命名的提案)"},index:function(t){return t.context.key},state:function(t){return"active"===t.context.state?"已送件":"編輯中"},ownername:function(t){var e;return((e=t.context).info||(e.info={})).teamname||e.ownername||""},username:function(t){return t.context.ownername||""}},handler:{edit:function(t){var e,n;return e=t.node,n=t.context,e.setAttribute("href","/dash/prj/"+n.slug+"/edit")},"badge-state":function(t){var e,n,r,o;return e=t.node,n=t.context,r=(n.system||(n.system={})).badge||{},o=e.getAttribute("data-name"),e.classList.toggle("on",!!r[o])},state:function(t){var e,n;return e=t.node,n=t.context,e.classList.toggle("text-success","active"===n.state),e.classList.toggle("text-warning","active"!==n.state)},"budget-consume":function(t){t.node,t.context},"budget-detail":function(t){t.node,t.context},avatar:function(t){var e,n;return e=t.node,n=t.context,e.style.background="url(/s/avatar/"+n.owner+".png)"}}})}}}}),this},i.prototype=import$(Object.create(Object.prototype),{setHub:function(t){return this.hubs=t},setData:function(t){return this.grp=t},setPrj:function(t){return this.fire("set-prj",t)},on:function(t,e){var n;return((n=this.evtHandler)[t]||(n[t]=[])).push(e)},fire:function(t){var e,n,r,o,a,i=[];for(e=slice$.call(arguments,1),n=0,o=(r=this.evtHandler[t]||[]).length;n<o;++n)a=r[n],i.push(a.apply(this,e));return i}}),i});