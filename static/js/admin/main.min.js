function import$(r,t){var e={}.hasOwnProperty;for(var n in t)e.call(t,n)&&(r[n]=t[n]);return r}ldc.register("adminGuard",["ldcvmgr","auth","loader","sdbAdapter","error","adminMenu","adminPanel","adminInfo","adminStage","adminPerm","adminNavbar","prjForm","adminEntry"],function(r){var t,e,n,o,i,a,d,c,u,l,s,p,h;return t=r.ldcvmgr,e=r.auth,n=r.loader,r.sdbAdapter,o=r.error,i=r.adminMenu,r.adminPanel,a=r.adminInfo,d=r.adminStage,c=r.adminPerm,u=r.adminNavbar,l=r.prjForm,s=r.adminEntry,p=function(){var r=this;return this.loader=n,this.hubs=null,this.ctrl={org:{},brd:{},grp:{}},this.modify={org:{},brd:{}},this.view=new ldView({global:!0,initRender:!1,root:"[ld-scope=admin]",action:{click:{"publish-modification":function(){return r.publish()}}},handler:{"brd-list":function(t){var e;if(e=t.node,!r.toc.brd.key&&e.folder)return e.folder.toggle(!0)},"brd-menu":function(t){return t.node.classList.toggle("d-none",!r.toc.brd.key)},"modified-warning":function(t){var e,n;return e=t.node,n=["brd","org"].map(function(t){return r.modify[t].dirty=r.toc[t].key&&r.hubs[t].doc&&r.hubs[t].doc.data&&JSON.stringify(r.hubs[t].doc.data||{})!==(r.modify[t].data||"{}")}),e.classList.toggle("d-none",!(n[0]||n[1]))}}}),this},p.prototype=import$(Object.create(Object.prototype),{render:function(){return this.view.render()},fetch:function(){var r,t,n,o,i=this;return r=/^\/([ob])\/([^/]+)\/admin/.exec(window.location.pathname)||[],r[0],t=r[1],n=r[2],o=import$({},t?"o"===t?{org:n}:{brd:n}:{}),console.log("fetch auth data ..."),e.fetch().catch(function(r){return Promise.reject(new ldError({id:1007,e:r}))}).then(function(r){return r.user.key?(console.log("fetch toc information ... "),ld$.fetch("/d/toc/",{method:"POST"},{json:o,type:"json"})):Promise.reject(new ldError({id:1e3}))}).then(function(r){return["org","brd","brds","brdsFiltered","grps"].map(function(t){return r[t]=r[t]||[]}),r.brdsFiltered=r.brds||[],i.toc=r,i.modify.org.data=JSON.stringify(i.toc.org.detail||{}),i.modify.brd.data=JSON.stringify(i.toc.brd.detail||{}),console.log("toc information: ",r)}).catch(function(r){return Promise.reject(ldError.id(r)?r:new ldError({id:1012,e:r}))})},sharedb:function(){var r,t=this;return console.log("prepare sharedb ..."),this.sdb=r=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host}}),this.hubs={org:new Hub({sdb:r}),brd:new Hub({sdb:r})},r.on("close",function(){return t.loader.on(),r.reconnect().then(function(){return t.getdoc()}).then(function(){return t.loader.off()})})},getdoc:function(){var r=this;return Promise.resolve().then(function(){var t;return t=["org","brd"].map(function(t){if(r.toc[t].key)return console.log("prepare "+t+" document ..."),r.sdb.get({id:t+"-"+r.toc[t].key,watch:function(e,n){return r.hubs[t].fire("change",{ops:e,source:n})},create:function(){return r.toc[t].detail}}).then(function(e){if(r.hubs[t].doc=e)return e.on("op",function(){return r.render()})})}),Promise.all(t)}).then(function(){return r.render()})},setGroup:function(r){var t,e=this;return function(){var r=[];for(t in this.ctrl.grp)r.push(t);return r}.call(this).map(function(t){var n;return n=["group",r.key,t],e.ctrl.grp[t].adapted()?e.ctrl.grp[t].setPath(n):e.ctrl.grp[t].adapt({hub:e.hubs.brd,path:n})})},initCtrl:function(){var r,t,e,n,o,p,h,f,g=this;return r=this.hubs,t=r.org,e=r.brd,n=function(r){return g.setGroup(r)},o=this.toc,p=this.ctrl.org,p.info=new a({root:"[ld-scope=org-info]",type:"org"}),p.info.adapt({hub:t,path:["info"]}),p.navbar=new u({toc:o,root:"[data-name=org-navbar] [ld-scope=navbar-editor]"}),p.navbar.adapt({hub:t,path:["page","navbar"]}),h=this.ctrl.brd,h.group=new i({toc:this.toc,setGroup:n}),h.group.adapt({hub:e,path:["group"]}),h.info=new a({root:"[ld-scope=brd-info]",type:"brd"}),h.info.adapt({hub:e,path:["info"]}),h.stage=new d({toc:o,root:"[ld-scope=brd-stage]"}),h.stage.adapt({hub:e,path:["stage"]}),h.perm=new c({toc:o,root:"[data-nav=brd-config] [ld-scope=perm-panel]"}),h.perm.adapt({hub:e,path:["perm"]}),h.navbar=new u({toc:o,root:"[data-name=brd-navbar] [ld-scope=navbar-editor]"}),h.navbar.adapt({hub:e,path:["page","navbar"]}),f=this.ctrl.grp,f.form=new l({toc:o,root:"[ld-scope=grp-form]",viewMode:!1}),f.info=new a({root:"[ld-scope=grp-info-panel]",type:"grp",setGroup:n}),f.perm=new c({toc:o,root:"[data-nav=grp-config] [ld-scope=perm-panel]"}),f.grade=new s({root:"[ld-scope=grade-panel]"}),f.criteria=new s({root:"[ld-scope=criteria-panel]"}),f},publish:function(){var r=this;return t.toggle("publishing",!0),Promise.resolve().then(function(){var t;return t=["brd","org"].map(function(r){return Promise.resolve()}).then(function(){var t;if(r.toc[type].key&&r.modify[type].dirty)return t=r.hubs[type].doc.data,ld$.fetch("/d/detail/",{method:"PUT"},{json:{payload:t,key:r.toc[type].key,type:type},type:"json"})}).then(function(){var t;return r.toc[type].detail=payload,t=r.modify[type],t.data=JSON.stringify(payload),t.dirty=!1,t}),Promise.all(t)}).then(function(){return r.render()}).then(function(){return t.toggle("publishing",!1),t.toggle("published",!0),debounce(2e3)}).then(function(){return t.toggle("published",!1)}).finally(function(){return t.toggle("publishing",!1)}).catch(o())}}),n.on(),(h=new p).fetch().then(function(){return h.sharedb()}).then(function(){return h.getdoc()}).then(function(){return h.initCtrl()}).then(function(){return console.log("admin initialized.")}).finally(function(){return n.off()}).catch(function(r){return console.log("[Admin Error] Code: ",r.id),console.log("Error Object: ",r.e||r),1012===r.id?t.toggle("error-403"):1e3===r.id?t.toggle("auth-required"):1007===r.id?t.toggle("server-down"):o()(r)})}),ldc.app("adminGuard");