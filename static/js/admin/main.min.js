function import$(r,t){var e={}.hasOwnProperty;for(var n in t)e.call(t,n)&&(r[n]=t[n]);return r}ldc.register("adminGuard",["navtop","ldcvmgr","auth","loader","sdbAdapter","error","adminMenu","adminPanel","adminInfo","adminStage","adminPerm","adminNavbar","adminPrjList","prjForm","adminEntry","adminWelcome","adminPage","adminPrjDetail","adminPostList","adminJudgePerm","adminJudgeCriteria","adminJudgePrimary","adminJudgeFinal","adminDev","adminJudgeCustom"],function(r){var t,e,n,o,a,i,d,c,u,s,l,p,g,h,f,m,b,w,v,y,j,P,J,G;return r.navtop,t=r.ldcvmgr,e=r.auth,n=r.loader,r.sdbAdapter,o=r.error,a=r.adminMenu,r.adminPanel,i=r.adminInfo,d=r.adminStage,c=r.adminPerm,u=r.adminNavbar,s=r.adminPrjList,l=r.prjForm,p=r.adminEntry,g=r.adminWelcome,h=r.adminPage,f=r.adminPrjDetail,m=r.adminPostList,b=r.adminJudgePerm,w=r.adminJudgeCriteria,v=r.adminJudgePrimary,y=r.adminJudgeFinal,j=r.adminDev,P=r.adminJudgeCustom,J=function(){var r=this;return this.loader=n,this.hubs=null,this.ctrl={org:{},brd:{},grp:{},prj:{}},this.modify={org:{},brd:{}},this.view=new ldView({global:!0,initRender:!1,root:"[ld-scope=admin]",action:{click:{"publish-modification":function(){return r.publish()}}},handler:{"init-loader":function(r){var t;return(t=r.node).classList.add("ld","ld-fade-out","xp35"),setTimeout(function(){return t.classList.add("d-none")},350)},"brd-menu":function(t){return t.node.classList.toggle("d-none",!r.toc.brd.key)},"modified-warning":function(t){var e,n;return e=t.node,n=["brd","org"].map(function(t){return r.modify[t].dirty=r.toc[t].key&&r.hubs[t].doc&&r.hubs[t].doc.data&&JSON.stringify(r.hubs[t].doc.data||{})!==(r.modify[t].data||"{}")}),e.classList.toggle("d-none",!(n[0]||n[1]))}}}),this},J.prototype=import$(Object.create(Object.prototype),{render:function(){return this.view.render()},fetch:function(){var r,t,n,o,a=this;return r=/^\/(?:dash\/)?([^/]+)\/([^/]+)\/admin/.exec(window.location.pathname)||[],r[0],t=r[1],n=r[2],"org"===(r=!t)||"brd"===r?Promise.reject(new ldError(1015)):(o={},o[t]=n,console.log("fetch auth data ..."),e.fetch().catch(function(r){return Promise.reject(new ldError({id:1007,e:r}))}).then(function(r){return r.user.key?(console.log("fetch toc information ... "),ld$.fetch("/dash/api/toc/",{method:"POST"},{json:o,type:"json"})):Promise.reject(new ldError({id:1e3}))}).then(function(r){return["org","brd","brds","brdsFiltered","grps"].map(function(t){return r[t]=r[t]||[]}),r.brdsFiltered=r.brds||[],a.toc=r,a.modify.org.data=JSON.stringify(a.toc.org.detail||{}),a.modify.brd.data=JSON.stringify(a.toc.brd.detail||{}),console.log("toc information: ",r)}).catch(function(r){return Promise.reject(ldError.id(r)?r:new ldError({id:1012,e:r}))}))},sharedb:function(){var r,e=this;return console.log("prepare sharedb ..."),this.sdb=r=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hubs={org:new Hub({sdb:r}),brd:new Hub({sdb:r})},r.on("error",function(){return t.toggle("not-sync")}),r.on("close",function(){return t.toggle("offline-retry",!0),r.reconnect().then(function(){return e.getdoc()}).then(function(){return e.adapt()}).then(function(){return console.log("admin initialized.")}).then(function(){return t.toggle("offline-retry",!1)})}),this.sdb.ready()},getdoc:function(){var r=this;return Promise.resolve().then(function(){var t;return t=function(t){return new Promise(function(e,n){return r.toc[t].key?(console.log("prepare "+t+" document ( id: "+t+"/"+r.toc[t].slug+" ) ..."),r.hubs[t].doc=null,r.sdb.get({id:t+"/"+r.toc[t].slug,watch:function(e,n){return r.hubs[t].fire("change",{ops:e,source:n})},create:function(){return r.toc[t].detail}}).then(function(o){return(r.hubs[t].doc=o)?(o.on("op",function(){return r.render()}),e()):n()}).catch(function(r){return console.log("getdoc "+t+" failed.",r)}),r.hubs[t].doc):e()})},Promise.all([t("org"),t("brd")])}).then(function(){if(!r.hubs.org.doc&&!r.hubs.brd.doc)return Promise.reject(new ldError(1012))}).then(function(){return r.render()})},setGroup:function(r,t){var e,n,o=this;return null==t&&(t=!1),e=0,this.grp=r,this.hubs.brd.doc.data.group.map(function(t,n){if(t.key===r.key)return e=n}),function(){var r=[];for(n in this.ctrl.grp)r.push(n);return r}.call(this).map(function(r){var n,a;if(o.ctrl.grp[r].setData&&o.ctrl.grp[r].setData(o.grp),o.ctrl.grp[r].adapt)return n=["group",e],n=n.concat((a=o.ctrl.grp[r].path)?a:[r]),!o.ctrl.grp[r].adapted()||t?o.ctrl.grp[r].adapt({hub:o.hubs.brd,path:n}):o.ctrl.grp[r].setPath(n)})},adapt:function(){var r,t,e,n,o,a;if(r=this.hubs,t=r.org,e=r.brd,this.ctrl.dev.adapt({hub:e,path:[]}),(n=this.ctrl.org).info.adapt({hub:t,path:["info"]}),n.navbar.adapt({hub:t,path:["page","navbar"]}),n.perm.adapt({hub:t,path:["perm"]}),n.page.adapt({hub:t,path:["page","info"]}),(o=this.ctrl.brd).info.adapt({hub:e,path:["info"]}),o.group.adapt({hub:e,path:["group"],type:"array"}),o.stage.adapt({hub:e,path:["stage"]}),o.perm.adapt({hub:e,path:["perm"]}),o.navbar.adapt({hub:e,path:["page","navbar"]}),o.page.adapt({hub:e,path:["page","info"]}),this.ctrl.grp.list.setHub({brd:e}),a=this.grp)return this.setGroup(a,!0)},initCtrl:function(){var r,t,e,n,o,J,G,E,k,C=this;return r=this.hubs,r.org,r.brd,t=function(r){return C.setGroup(r)},e=this.toc,n=function(r){return C.ctrl.brd.group.deleteGroup(r)},o=function(r){return C.ctrl.brd.group.cloneGroup(r)},this.ctrl.dev=new j({}),this.ctrl.welcome=new g({root:"[ld-scope=admin-welcome]",toc:e}),this.ctrl.posts=new m({root:"[ld-scope=admin-post-list]",brd:e.brd}),J=this.ctrl.org,J.info=new i({root:"[ld-scope=org-info]",type:"org",data:e.org,toc:e}),J.navbar=new u({toc:e,root:"[data-name=org-navbar] [ld-scope=navbar-editor]"}),J.perm=new c({toc:e,root:"[data-nav=org-config] [ld-scope=perm-panel]",org:e.org}),J.page=new h({toc:e,type:"org",root:"[data-name=org-page-info] [ld-scope=page-info]"}),G=this.ctrl.brd,G.info=new i({root:"[ld-scope=brd-info]",type:"brd",data:e.brd,toc:e}),G.group=new a({toc:this.toc,setGroup:t}),G.stage=new d({toc:e,root:"[ld-scope=brd-stage]"}),G.perm=new c({toc:e,root:"[data-nav=brd-config] [ld-scope=perm-panel]",brd:e.brd}),G.navbar=new u({toc:e,root:"[data-name=brd-navbar] [ld-scope=navbar-editor]"}),G.page=new h({toc:e,type:"brd",root:"[data-name=brd-page-info] [ld-scope=page-info]"}),E=this.ctrl.grp,E.form=new l({toc:e,root:"[ld-scope=grp-form]",viewMode:!1}),E.info=new i({root:"[ld-scope=grp-info-panel]",type:"grp",setGroup:t,deleteGroup:n,cloneGroup:o}),E.grade=new p({root:"[ld-scope=grade-panel]"}),E.criteria=new p({root:"[ld-scope=criteria-panel]"}),E.list=new s({root:"[ld-scope=prj-list]",toc:e}),E.judgePerm=new b({root:"[ld-scope=judge-perm]",toc:e,brd:e.brd}),E.judgeCriteria=new w({root:"[ld-scope=judge-criteria]",toc:e,brd:e.brd,path:["judge","criteria"]}),E.judgePrimary=new v({root:"[ld-scope=judge-primary]",toc:e,brd:e.brd,path:["judge","primary"]}),E.judgeFinal=new y({root:"[ld-scope=judge-final]",toc:e,brd:e.brd,path:["judge","final"]}),E.judgeCustom=new P({root:"[ld-scope=judge-custom]",toc:e,brd:e.brd,path:["judge","custom"]}),k=this.ctrl.prj,k.main=new f({root:"[ld-scope=prj-detail]"}),this.ctrl.grp.list.on("set-prj",function(r){return C.ctrl.prj.main.setPrj(r)})},publish:function(){var r=this;return t.toggle("publishing",!0),Promise.resolve().then(function(){var t;return t=["brd","org"].map(function(t){var n;return r.toc[t].key&&r.modify[t].dirty?(n=r.hubs[t].doc.data,e.recaptcha.get().then(function(e){var o;return o={payload:n,slug:r.toc[t].slug,type:t,recaptcha:e},ld$.fetch("/dash/api/detail/",{method:"PUT"},{json:o,type:"json"})}).then(function(){var e;return r.toc[t].detail=n,e=r.modify[t],e.data=JSON.stringify(n),e.dirty=!1,e})):Promise.resolve()}),Promise.all(t)}).then(function(){return r.render()}).then(function(){return t.toggle("publishing",!1),t.toggle("published",!0),debounce(2e3)}).then(function(){return t.toggle("published",!1)}).finally(function(){return t.toggle("publishing",!1)}).catch(o())}}),(G=new J).fetch().then(function(){return G.sharedb()}).then(function(){return G.getdoc()}).then(function(){return G.initCtrl()}).then(function(){return G.adapt()}).then(function(){return console.log("admin initialized.")}).finally(function(){return n.off()}).catch(function(r){var e;if(console.log("[Admin Error] Code: ",r?r.id:r),console.log("Error Object: ",r&&r.e||r),1e3===r.id?t.toggle("auth-required"):1007===r.id?t.toggle("server-down"):t.toggle("access-denied"),e=r.stack)return console.log(e)}).then(function(){return G.render()})}),ldc.app("adminGuard");