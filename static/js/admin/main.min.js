function import$(r,t){var e,n={}.hasOwnProperty;for(e in t)n.call(t,e)&&(r[e]=t[e]);return r}ldc.register("adminGuard",["navtop","ldcvmgr","auth","loader","sdbAdapter","error","adminMenu","adminPanel","adminInfo","adminStage","adminPerm","adminNavbar","adminPrjList","prjForm","adminEntry","adminWelcome","adminPage","adminBrdExport","adminPrjDetail","adminPostList","adminJudgePerm","adminJudgeCriteria","adminJudgePrimary","adminJudgeFinal","adminDev","adminJudgeCustom"],function(r){r.navtop;var t,e=r.ldcvmgr,a=r.auth,n=r.loader,o=(r.sdbAdapter,r.error),i=r.adminMenu,d=(r.adminPanel,r.adminInfo),c=r.adminStage,u=r.adminPerm,s=r.adminNavbar,l=r.adminPrjList,p=r.prjForm,g=r.adminEntry,h=r.adminWelcome,f=r.adminPage,m=r.adminBrdExport,b=r.adminPrjDetail,w=r.adminPostList,y=r.adminJudgePerm,v=r.adminJudgeCriteria,j=r.adminJudgePrimary,P=r.adminJudgeFinal,J=r.adminDev,E=r.adminJudgeCustom,r=function(){var e=this;return this.loader=n,this.hubs=null,this.ctrl={org:{},brd:{},grp:{},prj:{}},this.modify={org:{},brd:{}},this.view=new ldView({global:!0,initRender:!1,root:"[ld-scope=admin]",action:{click:{"publish-modification":function(){return e.publish()}}},handler:{"init-loader":function(r){var t=r.node;return t.classList.add("ld","ld-fade-out","xp35"),setTimeout(function(){return t.classList.add("d-none")},350)},"brd-menu":function(r){return r.node.classList.toggle("d-none",!e.toc.brd.key)},"modified-warning":function(r){var t=r.node,r=["brd","org"].map(function(r){return e.modify[r].dirty=e.toc[r].key&&e.hubs[r].doc&&e.hubs[r].doc.data&&JSON.stringify(e.hubs[r].doc.data||{})!==(e.modify[r].data||"{}")});return t.classList.toggle("d-none",!(r[0]||r[1]))}}}),this};return r.prototype=import$(Object.create(Object.prototype),{render:function(){return this.view.render()},fetch:function(){var t,r=this,e=/^\/(?:dash\/)?([^/]+)\/([^/]+)\/admin/.exec(window.location.pathname)||[],n=(e[0],e[1]),o=e[2];return"org"===(e=!n)||"brd"===e?Promise.reject(new ldError(1015)):((t={})[n]=o,console.log("fetch auth data ..."),a.fetch().catch(function(r){return Promise.reject(new ldError({id:1007,e:r}))}).then(function(r){return r.user.key?(console.log("fetch toc information ... "),ld$.fetch("/dash/api/toc/",{method:"POST"},{json:t,type:"json"})):Promise.reject(new ldError({id:1e3}))}).then(function(t){return["org","brd","brds","brdsFiltered","grps"].map(function(r){return t[r]=t[r]||[]}),t.brdsFiltered=t.brds||[],r.toc=t,r.modify.org.data=JSON.stringify(r.toc.org.detail||{}),r.modify.brd.data=JSON.stringify(r.toc.brd.detail||{}),console.log("toc information: ",t)}).catch(function(r){return Promise.reject(ldError.id(r)?r:new ldError({id:1012,e:r}))}))},sharedb:function(){var r,t=this;return console.log("prepare sharedb ..."),this.sdb=r=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host},path:"/dash/ws"}),this.hubs={org:new Hub({sdb:r}),brd:new Hub({sdb:r})},r.on("error",function(){return e.toggle("not-sync")}),r.on("close",function(){return e.toggle("offline-retry",!0),r.reconnect().then(function(){return t.getdoc()}).then(function(){return t.adapt()}).then(function(){return console.log("admin initialized.")}).then(function(){return e.toggle("offline-retry",!1)})}),this.sdb.ready()},getdoc:function(){var o=this;return Promise.resolve().then(function(){var r=function(n){return new Promise(function(t,e){return o.toc[n].key?(console.log("prepare "+n+" document ( id: "+n+"/"+o.toc[n].slug+" ) ..."),o.hubs[n].doc=null,o.sdb.get({id:n+"/"+o.toc[n].slug,watch:function(r,t){return o.hubs[n].fire("change",{ops:r,source:t})},create:function(){return o.toc[n].detail}}).then(function(r){return(o.hubs[n].doc=r)?(r.on("op",function(){return o.render()}),t()):e()}).catch(function(r){return console.log("getdoc "+n+" failed.",r)}),o.hubs[n].doc):t()})};return Promise.all([r("org"),r("brd")])}).then(function(){if(!o.hubs.org.doc&&!o.hubs.brd.doc)return Promise.reject(new ldError(1012))}).then(function(){return o.render()})},setGroup:function(e,n){var o,t,a=this;return null==n&&(n=!1),o=0,this.grp=e,this.hubs.brd.doc.data.group.map(function(r,t){if(r.key===e.key)return o=t}),function(){var r=[];for(t in this.ctrl.grp)r.push(t);return r}.call(this).map(function(r){var t,e;if(a.ctrl.grp[r].setData&&a.ctrl.grp[r].setData(a.grp),a.ctrl.grp[r].adapt)return t=(t=["group",o]).concat((e=a.ctrl.grp[r].path)?e:[r]),!a.ctrl.grp[r].adapted()||n?a.ctrl.grp[r].adapt({hub:a.hubs.brd,path:t}):a.ctrl.grp[r].setPath(t)})},adapt:function(){var r=this.hubs,t=r.org,e=r.brd;if(this.ctrl.dev.adapt({hub:e,path:[]}),(r=this.ctrl.org).info.adapt({hub:t,path:["info"]}),r.navbar.adapt({hub:t,path:["page","navbar"]}),r.perm.adapt({hub:t,path:["perm"]}),r.page.adapt({hub:t,path:["page","info"]}),(t=this.ctrl.brd).info.adapt({hub:e,path:["info"]}),t.group.adapt({hub:e,path:["group"],type:"array"}),t.stage.adapt({hub:e,path:["stage"]}),t.perm.adapt({hub:e,path:["perm"]}),t.navbar.adapt({hub:e,path:["page","navbar"]}),t.page.adapt({hub:e,path:["page","info"]}),t.export.adapt({hub:e,path:["export"]}),this.ctrl.grp.list.setHub({brd:e}),e=this.grp)return this.setGroup(e,!0)},initCtrl:function(){var t=this,r=this.hubs,e=(r.org,r.brd,function(r){return t.setGroup(r)}),n=this.toc,o=function(r){return t.ctrl.brd.group.deleteGroup(r)},a=function(r){return t.ctrl.brd.group.cloneGroup(r)};return this.ctrl.dev=new J({}),this.ctrl.welcome=new h({root:"[ld-scope=admin-welcome]",toc:n}),this.ctrl.posts=new w({root:"[ld-scope=admin-post-list]",brd:n.brd}),(r=this.ctrl.org).info=new d({root:"[ld-scope=org-info]",type:"org",data:n.org,toc:n}),r.navbar=new s({toc:n,root:"[data-name=org-navbar] [ld-scope=navbar-editor]"}),r.perm=new u({toc:n,root:"[data-nav=org-config] [ld-scope=perm-panel]",org:n.org}),r.page=new f({toc:n,type:"org",root:"[data-name=org-page-info] [ld-scope=page-info]"}),(r=this.ctrl.brd).info=new d({root:"[ld-scope=brd-info]",type:"brd",data:n.brd,toc:n}),r.group=new i({toc:this.toc,setGroup:e}),r.stage=new c({toc:n,root:"[ld-scope=brd-stage]"}),r.perm=new u({toc:n,root:"[data-nav=brd-config] [ld-scope=perm-panel]",brd:n.brd}),r.navbar=new s({toc:n,root:"[data-name=brd-navbar] [ld-scope=navbar-editor]"}),r.page=new f({toc:n,type:"brd",root:"[data-name=brd-page-info] [ld-scope=page-info]"}),r.export=new m({root:"[ld-scope=brd-export]",toc:n}),(r=this.ctrl.grp).form=new p({toc:n,root:"[ld-scope=grp-form]",viewMode:!1}),r.info=new d({root:"[ld-scope=grp-info-panel]",type:"grp",setGroup:e,deleteGroup:o,cloneGroup:a}),r.grade=new g({root:"[ld-scope=grade-panel]"}),r.criteria=new g({root:"[ld-scope=criteria-panel]"}),r.list=new l({root:"[ld-scope=prj-list]",toc:n}),r.judgePerm=new y({root:"[ld-scope=judge-perm]",toc:n,brd:n.brd}),r.judgeCriteria=new v({root:"[ld-scope=judge-criteria]",toc:n,brd:n.brd,path:["judge","criteria"]}),r.judgePrimary=new j({root:"[ld-scope=judge-primary]",toc:n,brd:n.brd,path:["judge","primary"]}),r.judgeFinal=new P({root:"[ld-scope=judge-final]",toc:n,brd:n.brd,path:["judge","final"]}),r.judgeCustom=new E({root:"[ld-scope=judge-custom]",toc:n,brd:n.brd,path:["judge","custom"]}),this.ctrl.prj.main=new b({root:"[ld-scope=prj-detail]"}),this.ctrl.grp.list.on("set-prj",function(r){return t.ctrl.prj.main.setPrj(r)})},publish:function(){var n=this;return e.toggle("publishing",!0),Promise.resolve().then(function(){var r=["brd","org"].map(function(t){var e;return n.toc[t].key&&n.modify[t].dirty?(e=n.hubs[t].doc.data,a.recaptcha.get().then(function(r){r={payload:e,slug:n.toc[t].slug,type:t,recaptcha:r};return ld$.fetch("/dash/api/detail/",{method:"PUT"},{json:r,type:"json"})}).then(function(){var r;return n.toc[t].detail=e,(r=n.modify[t]).data=JSON.stringify(e),r.dirty=!1,r})):Promise.resolve()});return Promise.all(r)}).then(function(){return n.render()}).then(function(){return e.toggle("publishing",!1),e.toggle("published",!0),debounce(2e3)}).then(function(){return e.toggle("published",!1)}).finally(function(){return e.toggle("publishing",!1)}).catch(o())}}),(t=new r).fetch().then(function(){return t.sharedb()}).then(function(){return t.getdoc()}).then(function(){return t.initCtrl()}).then(function(){return t.adapt()}).then(function(){return console.log("admin initialized.")}).finally(function(){return n.off()}).catch(function(r){if(console.log("[Admin Error] Code: ",r&&r.id),console.log("Error Object: ",r&&r.e||r),1e3===r.id?e.toggle("auth-required"):1007===r.id?e.toggle("server-down"):e.toggle("access-denied"),r=r.stack)return console.log(r)}).then(function(){return t.render()})}),ldc.app("adminGuard");