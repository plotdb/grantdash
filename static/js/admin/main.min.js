function import$(r,n){var o={}.hasOwnProperty;for(var e in n)o.call(n,e)&&(r[e]=n[e]);return r}ldc.register("adminGuard",["ldcvmgr","auth","loader","sdbAdapter","error","adminMenu","adminPanel","adminInfo","adminStage","adminPerm","adminNavbar","prjForm","adminEntry"],function(r){var n,o,e,t,a,d,i,c,u,p,g,l,f;return n=r.ldcvmgr,o=r.auth,e=r.loader,r.sdbAdapter,t=r.error,a=r.adminMenu,r.adminPanel,d=r.adminInfo,i=r.adminStage,c=r.adminPerm,u=r.adminNavbar,p=r.prjForm,g=r.adminEntry,e.on(),console.log("fetch auth data ..."),o.fetch().then(function(r){var n,o,e,t;return n=/^\/([ob])\/([^/]+)\/admin/.exec(window.location.pathname)||[],n[0],o=n[1],e=n[2],t=import$({},o?"o"===o?{org:e}:{brd:e}:{}),console.log("fetch sidemenu information ... "),ld$.fetch("/d/toc/",{method:"POST"},{json:t,type:"json"}).then(function(r){return console.log("initialization ..."),l(r).catch(function(r){return console.log("admin init error",r),lda.ldcvmgr.toggle("error")})}).catch(function(){return lda.ldcvmgr.lock("create-brd-now")})}).catch(function(){return lda.ldcvmgr.toggle("auth-required")}).then(function(){return e.off()}),l=function(r){var n,o,e;return r.doc={},["org","brd","brds","brdsFiltered","grps"].map(function(n){return r[n]=r[n]||[]}),r.brdsFiltered=r.brds||[],console.log("sidemenu information: ",r),n={},o={org:{},brd:{},grp:{}},e=function(r){var e;return function(){var r=[];for(e in grp)r.push(e);return r}().map(function(e){var t;return t=["group",r.key,e],o.grp[e].adapted()?o.grp[e].setPath(t):o.grp[e].adapt({hub:n.brd,path:t})})},f(r).then(function(t){var l,f,s,h;return l=t.org,f=t.brd,n.org=l,n.brd=f,o.org.info=new d({root:"[ld-scope=org-info]",type:"org"}),o.org.info.adapt({hub:l,path:["info"]}),new a({toc:r,setGroup:e}).adapt({hub:f,path:["group"]}),new d({root:"[ld-scope=brd-info]",type:"brd"}).adapt({hub:f,path:["info"]}),new i({toc:r,root:"[ld-scope=brd-stage]"}).adapt({hub:f,path:["stage"]}),new c({toc:r,root:"[data-nav=brd-config] [ld-scope=perm-panel]"}).adapt({hub:f,path:["perm"]}),(s={brd:new u({toc:r,root:"[data-name=brd-navbar] [ld-scope=navbar-editor]"}),org:new u({toc:r,root:"[data-name=org-navbar] [ld-scope=navbar-editor]"})}).brd.adapt({hub:f,path:["page","navbar"]}),s.org.adapt({hub:l,path:["page","navbar"]}),h=o.grp,h.form=new p({toc:r,root:"[ld-scope=grp-form]",viewMode:!1}),h.info=new d({root:"[ld-scope=grp-info-panel]",type:"grp",setGroup:e}),h.perm=new c({toc:r,root:"[data-nav=grp-config] [ld-scope=perm-panel]"}),h.grade=new g({root:"[ld-scope=grade-panel]"}),h.criteria=new g({root:"[ld-scope=criteria-panel]"}),h})},f=function(r){var o,a,d,i,c,u,p;return console.log("prepare sharedb ..."),(o=o=new sharedbWrapper({url:{scheme:window.location.protocol.replace(":",""),domain:window.location.host}})).on("close",function(){return e.on(),o.reconnect().then(function(){return p()}).then(function(){return e.off()})}),a=debounce(500,function(){return c.render()}),d={org:{},brd:{}},i=function(){return n.toggle("publishing",!0),Promise.resolve().then(function(){var n;return n=["brd","org"].map(function(n){return Promise.resolve().then(function(){var o;if(r[n].key&&d[n].dirty)return o=u[n].doc.data,ld$.fetch("/d/detail/",{method:"PUT"},{json:{payload:o,key:r[n].key,type:n},type:"json"}).then(function(){var e;return r[n].detail=o,e=d[n],e.data=JSON.stringify(o),e.dirty=!1,e})})}),Promise.all(n)}).then(function(){return a()}).then(function(){return n.toggle("publishing",!1),n.toggle("published",!0),debounce(2e3)}).then(function(){return n.toggle("published",!1)}).finally(function(){return n.toggle("publishing",!1)}).catch(t())},c=new ldView({initRender:!1,root:"[ld-scope=admin]",action:{click:{"publish-modification":function(){return i()}}},handler:{"modified-warning":function(n){var o,e;return o=n.node,e=["brd","org"].map(function(n){return d[n].dirty=r[n].key&&u[n].doc&&JSON.stringify(u[n].doc.data||{})!==(d[n].data||"{}")}),o.classList.toggle("d-none",!(e[0]||e[1]))}}}),u={org:new Hub({sdb:o}),brd:new Hub({sdb:o})},(p=function(){return console.log("preparing sharedb document (org) ... "),o.get({id:"org-"+r.org.key,watch:function(r,n){return u.org.fire("change",{ops:r,source:n})}}).then(function(r){return u.org.doc=r}).then(function(){return console.log("preparing sharedb document (brd) ... ")}).then(function(){return o.get({id:"brd-"+r.brd.key,watch:function(r,n){return u.brd.fire("change",{ops:r,source:n})}})}).then(function(r){return u.brd.doc=r}).then(function(){return d.org.data=JSON.stringify(r.org.detail||{}),d.brd.data=JSON.stringify(r.brd.detail||{}),u.org.doc.on("op",function(){return a()}),u.brd.doc.on("op",function(){return a()}),c.render(),u}).catch(function(){return lda.ldcvmgr.toggle("error")})})()}}),ldc.app("adminGuard");