function import$(e,n){var t={}.hasOwnProperty;for(var r in n)t.call(n,r)&&(e[r]=n[r]);return e}ldc.register("permctrl",[],function(){var e;return e=function(e){var n,t,r,o,i,a,l,c,u;return n={type:"list"},t={idx:-1,cfg:{roles:[]}},r=function(){var e,r,o,i;return e=t.cfg.roles[r=t.idx],o=e?e.name:"",i=~r?"role":"list",n.idx=r,n.role=e,n.name=o,n.type=i,n},o=function(){return r(),a.render()},i={root:e.root,action:{click:{},keyup:{}},handler:{}},import$(i.action.click,{roles:function(e){var n;return e.node,n=e.evt,t.idx=t.cfg.roles.map(function(e){return e.name}).indexOf(n.target.getAttribute("data-name")),u(),o()},"new-role":function(e){var n,r,i,a,l;for(e.node,n=e.evt,r=t.cfg.roles.map(function(e){return e.name}),i=1;i<100&&(a=i,~r.indexOf("角色"+a));++i);return l="角色"+(a<100?a:Math.round(100*Math.random())+100),t.cfg.roles.push({name:l,desc:"自訂角色",list:[]}),t.idx=t.cfg.roles.length-1,u(),o(),n.stopPropagation()},"delete-role":function(){return t.cfg.roles.length<=1?alert("最少要有一個角色"):~t.idx?(t.cfg.roles.splice(t.idx,1),t.idx=-1,u(),o()):void 0}}),import$(i.action.keyup,{"role-name":function(e){var r,i,a;if(r=e.node,n.role){if(i=r.value,a=~t.cfg.roles.map(function(e){return e.name}).indexOf(i)&&n.name!==i,r.classList.toggle("is-invalid",a),a)return;return n.role.name=r.value,u(),o()}}}),import$(i.handler,{"list-view":function(e){return e.node.classList.toggle("d-none","list"!==n.type)},"role-view":function(e){return e.node.classList.toggle("d-none","role"!==n.type)},role:{list:function(){return t.cfg.roles},handler:function(e){var t,r,o;return t=e.node,r=e.data,(o=ld$.find(t,".nav-link",0)).classList.toggle("active",r.name===n.name),o.setAttribute("data-name",r.name),o.setAttribute("data-type","role"),o.innerText=r.name}},"role-name":function(e){var r,o;return(r=e.node).classList.toggle("d-none",!~t.idx),r.value=n.role?r.value=n.name:"",o=r.value,r.classList.toggle("is-invalid",~t.cfg.roles.map(function(e){return e.name}).indexOf(o)&&n.name!==o)},"role-desc":{list:function(){return t.cfg.roles},action:{keyup:function(e){var n,t;return n=e.node,t=e.data,t.desc=n.innerText,u(!0)}},handler:function(e){var t,r;return t=e.node,r=e.data,t.innerText=r.desc||"",t.setAttribute("data-name",r.name),t.classList.toggle("d-none",r.name!==n.name)}},"role-all":function(e){return e.node.classList.toggle("active","list"===n.type)},"role-desc-all":function(e){return e.node.classList.toggle("d-none","list"!==n.type)}}),import$(i.action.click,{switch:function(e){var n,r,o;if(n=e.node,e.evt,n.classList.toggle("on"),r=(o=t.cfg.roles[t.idx]).config||(o.config={}))return r[n.getAttribute("data-name")]=n.classList.contains("on"),u()}}),import$(i.handler,{switch:function(e){var t,r;if(t=e.node,n.role)return t.classList.toggle("on",!!((r=n.role).config||(r.config={}))[t.getAttribute("data-name")])}}),import$(i.handler,{user:{list:function(){return n.role?(n.role.list||[]).map(function(e){return e.perm=n.role.name,e}):t.cfg.roles.map(function(e){return e.list.map(function(n){return n.perm=e.name,n})}).reduce(function(e,n){return e.concat(n)},[])},handler:function(e){var n,t,r;if(n=e.node,t=e.data,ld$.find(n,"b",0).innerText=t.name,r=ld$.find(n,".text-muted",0))return r.innerText=t.perm},action:{click:function(e){var n,r,i;if(e.node,n=e.data,e.evt.target.classList.contains("i-close")&&~(r=t.cfg.roles.map(function(e){return e.name}).indexOf(n.perm))&&~(i=t.cfg.roles[r].list).indexOf(n))return i.splice(i.indexOf(n),1),u(),o()}}}}),import$(i.action.click,{"newuser-toggle":function(e){return e.node,a.getAll("newuser").map(function(e){return e.classList.toggle("d-none")})},"newuser-add":function(e){var r,i;return e.node,e.evt,r=("list"===n.type?n.pickedRole:n.role)||t.cfg.roles[0]||{name:""},i=a.get("newuser-name").value,~t.cfg.roles.map(function(e){return e.list}).reduce(function(e,n){return e.concat(n)},[]).map(function(e){return e.name}).indexOf(i)?alert("user already exist"):(r.list.push({name:i,perm:r.name}),a.get("newuser-name").value="",u(),o())}}),import$(i.handler,{"newuser-role-picked":function(e){var r;if(r=e.node,n.pickedRole||(n.pickedRole=t.cfg.roles[0]),n.pickedRole)return r.innerText=n.pickedRole.name},"newuser-role-option":{list:function(){return t.cfg.roles},action:{click:function(e){var t;return e.node,t=e.data,n.pickedRole=t,a.render("newuser-role-picked")}},handler:function(e){var n,t;return n=e.node,t=e.data,n.innerText=t.name}}}),a=new ldView(i),(l=new Adopter({path:e.path})).on("change",function(e){if(e.ops,!e.source)return t.cfg=l.data?JSON.parse(JSON.stringify(l.data)):{},t.cfg.roles||(t.cfg.roles=[]),o()}),c=debounce(500,function(){return u()}),u=function(e){return e?c():l.update(function(){return JSON.parse(JSON.stringify(t.cfg))})},l},{prepare:e}});