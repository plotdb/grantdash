ldc.register("change-password",["error","auth","notify"],function(e){var n,t;return e.error,n=e.auth,t=e.notify,{},n.get({authed:!0}).then(function(e){var r,a,i;return e,r=new ldForm({root:".form[data-name=passwd]",submit:".btn[ld=update-password]",afterCheck:function(e){var n,t,r,a,i,s,o,d,u,c;if(n=[this.fields.newpasswd1.value,this.fields.newpasswd2.value],t=n[0],r=n[1],1!==e.newpasswd1&&t.length<6&&(e.newpasswd1=2,e.newpasswd2=1),t!==r&&(1!==e.newpasswd2||r&&0===e.newpasswd1)&&(e.newpasswd2=2),a=ld$.find(this.root,"[data-node]",0),1!==e.newpasswd1)return i=Math.round(t.length),s=i<8?"不妙":i<10?"還好":"不錯",o=100*(i<12?i:12)/12,d=i<8?"danger":i<10?"warning":"success",ld$.find(a,"label",0).textContent="長度: "+s,u=ld$.find(a,".progress-bar",0),u.style.width=o+"%",c=u.getAttribute("class"),c=c.replace(/bg-\S+/,"").trim()+" bg-"+d,u.setAttribute("class",c)}}),a=ld$.find(document,".form[data-name=passwd] .btn[ld=update-password]",0),i=new ldLoader({root:a}),a.addEventListener("click",function(){var e;if(!a.classList.contains("disabled"))return i.on(),e=r.values(),n.recaptcha.get().then(function(n){var t;return t={o:e.oldpasswd,n:e.newpasswd1,recaptcha:n},ld$.fetch("/dash/api/me/passwd/",{method:"put",headers:{"Content-Type":"application/json; charset=UTF-8"}},{json:t})}).finally(function(){return i.off()}).then(function(){return t.send("success","密碼更新完成"),r.reset()}).catch(function(){return t.send("danger","密碼更新失敗")})})})}),ldc.register(["error","auth","ldcvmgr","change-password","notify"],function(e){var n,t,r,a,i;return n=e.error,t=e.auth,r=e.ldcvmgr,e.changePassword,a=e.notify,i={},t.get({authed:!0}).catch(function(){return r.toggle("auth-required")}).then(function(e){return i.g=e,t.userinfo(e.user)}).then(function(e){var s;return i.user=e,s=new ldForm({root:".form[data-name=basic]",submit:".btn[ld=updateBasicData]",afterCheck:function(e){if(e.description=0,e.title=0,e.tags=0,this.fields.displayname.value)return e.displayname=0}}),new Tagify(s.fields.tags,{originalInputValueFormat:function(e){return e.map(function(e){return e.value}).join(",")},delimiters:/[,.:;，。：；]/}),new ldView({root:document.body,action:{change:{avatar:function(e){var r,a,i,s;if(r=e.node,(a=ld$.parent(r,".bg"))&&(i=ld$.parent(r,".btn"))&&r.files.length)return i.classList.toggle("running",!0),(s=new FormData).append("avatar",r.files[0]),t.recaptcha.get().then(function(e){return s.append("recaptcha",e),ld$.fetch("/dash/api/user/avatar",{method:"POST",body:s},{type:"json"})}).finally(function(){return debounce(1e3).then(function(){return i.classList.toggle("running",!1)})}).then(function(){return ldFile.fromFile(r.files[0],"dataurl")}).then(function(e){return a.style.backgroundImage="url("+e.result+")"}).finally(function(){return r.value=""}).catch(n())}}},handler:{updateBasicData:function(e){var n,o;return n=e.node,o=new ldLoader({root:n}),n.addEventListener("click",function(){var e;return o.on(),e=s.values(),t.recaptcha.get().then(function(n){var t,r;return null==n&&(n=""),r={recaptcha:n},r.description=e.description,r.displayname=e.displayname,r.title=e.title,r.tags=e.tags,t=r,ld$.fetch("/dash/api/user/"+((r=i.g).user||(r.user={})).key,{method:"PUT"},{json:t,type:"text"})}).catch(function(e){return r.toggle("error"),console.log(e)}).then(function(){return t.fetch({renew:!0})}).then(function(){return debounce(500)}).then(function(){return a.send("success","更新完成")}).then(function(){return debounce(500)}).then(function(){return o.off()})})},mailVerify:function(e){var n,t;return n=e.node,t=new ldLoader({root:n}),i.user.verified?n.innerText="已於 "+moment(i.user.verified.date).format("YYYY/MM/DD")+" 驗證":n.addEventListener("click",function(){if(t.on(),!n.classList.contains("disabled"))return ld$.fetch("/dash/api/me/mail/verify",{method:"POST"}).catch(function(){return r.toggle("error")}).then(function(){return debounce(1e3)}).then(function(){return t.off()}).then(function(){return r.toggle("verification-mail-sent")})})},sendResetLink:function(e){var n;return(n=e.node).addEventListener("click",function(){if(!n.classList.contains("disabled"))return ld$.fetch("/dash/api/me/passwd/reset",{method:"POST",body:JSON.stringify({email:i.g.user.username}),headers:{"Content-Type":"application/json; charset=UTF-8"}},{}).then(function(){return n.innerHTML='連結已寄出 <i class="i-check"></i>',n.classList.add("disabled")})})},copyUid:function(e){var n;return n=e.node,new ClipboardJS(n).on("success",function(){return n.classList.add("tip-on"),debounce(2e3).then(function(){return n.classList.remove("tip-on")})})}}})})});