ldc.register("change-password",["error","auth","notify"],function(e){var n,t;return e.error,n=e.auth,t=e.notify,{},n.get({authed:!0}).then(function(e){var n,r,a;return e,n=new ldForm({root:".form[data-name=passwd]",submit:".btn[ld=update-password]",afterCheck:function(e){var n,t,r,a,s,i,o,d,u,c;if(n=[this.fields.newpasswd1.value,this.fields.newpasswd2.value],t=n[0],r=n[1],1!==e.newpasswd1&&t.length<6&&(e.newpasswd1=2,e.newpasswd2=1),t!==r&&(1!==e.newpasswd2||r&&0===e.newpasswd1)&&(e.newpasswd2=2),a=ld$.find(this.root,"[data-node]",0),1!==e.newpasswd1)return s=Math.round(t.length),i=s<8?"不妙":s<10?"還好":"不錯",o=100*(s<12?s:12)/12,d=s<8?"danger":s<10?"warning":"success",ld$.find(a,"label",0).textContent="長度: "+i,u=ld$.find(a,".progress-bar",0),u.style.width=o+"%",c=u.getAttribute("class"),c=c.replace(/bg-\S+/,"").trim()+" bg-"+d,u.setAttribute("class",c)}}),r=ld$.find(document,".form[data-name=passwd] .btn[ld=update-password]",0),a=new ldLoader({root:r}),r.addEventListener("click",function(){var e;if(!r.classList.contains("disabled"))return a.on(),e=n.values(),ld$.fetch("/dash/api/me/passwd/",{method:"put",body:JSON.stringify({o:e.oldpasswd,n:e.newpasswd1}),headers:{"Content-Type":"application/json; charset=UTF-8"}},{}).finally(function(){return a.off()}).then(function(){return t.send("success","Password updated."),n.reset()}).catch(function(){return t.send("danger","Update password failed.")})})})}),ldc.register(["auth","ldcvmgr","change-password","notify"],function(e){var n,t,r,a;return n=e.auth,t=e.ldcvmgr,e.changePassword,r=e.notify,a={},n.get({authed:!0}).catch(function(){return t.toggle("auth-required")}).then(function(e){return a.g=e,n.userinfo(e.user)}).then(function(e){var s;return a.user=e,s=new ldForm({root:".form[data-name=basic]",submit:".btn[ld=updateBasicData]",afterCheck:function(e){if(e.description=0,e.title=0,e.tags=0,this.fields.displayname.value)return e.displayname=0}}),new Tagify(s.fields.tags,{originalInputValueFormat:function(e){return e.map(function(e){return e.value}).join(",")},delimiters:/[,.:;，。：； ]/}),new ldView({root:document.body,action:{change:{avatar:function(e){var n,t,r,a;if(n=e.node,(t=ld$.parent(n,".bg"))&&(r=ld$.parent(n,".btn"))&&n.files.length)return ldFile.fromFile(n.files[0],"dataurl").then(function(e){return t.style.backgroundImage="url("+e.result+")"}),r.classList.toggle("running",!0),(a=new FormData).append("avatar",n.files[0]),ld$.fetch("/dash/api/user/avatar",{method:"POST",body:a},{type:"json"}).finally(function(){return debounce(1e3).then(function(){return r.classList.toggle("running",!1)}),n.value=""}).then(function(e){return n.value="",console.log("uploaded",e)}).catch(function(e){return console.log(e),error()(e)})}}},handler:{updateBasicData:function(e){var i,o;return i=e.node,o=new ldLoader({root:i}),i.addEventListener("click",function(){var e,i;return o.on(),e=s.values(),ld$.fetch("/dash/api/user/"+((i=a.g).user||(i.user={})).key,{method:"PUT"},{json:{description:e.description,displayname:e.displayname,title:e.title,tags:e.tags},type:"text"}).catch(function(e){return t.toggle("error"),console.log(e)}).then(function(){return n.fetch({renew:!0})}).then(function(){return debounce(500)}).then(function(){return r.send("success","updated.")}).then(function(){return debounce(500)}).then(function(){return o.off()})})},mailVerify:function(e){var n,r;return n=e.node,r=new ldLoader({root:n}),a.user.verified?n.innerText="已於 "+moment(a.user.verified.date).format("YYYY/MM/DD")+" 驗證":n.addEventListener("click",function(){if(r.on(),!n.classList.contains("disabled"))return ld$.fetch("/dash/api/me/mail/verify",{method:"POST"}).catch(function(){return t.toggle("error")}).then(function(){return debounce(1e3)}).then(function(){return r.off()}).then(function(){return t.toggle("verification-mail-sent")})})},sendResetLink:function(e){var n;return(n=e.node).addEventListener("click",function(){if(!n.classList.contains("disabled"))return ld$.fetch("/dash/api/me/passwd/reset",{method:"POST",body:JSON.stringify({email:a.g.user.username}),headers:{"Content-Type":"application/json; charset=UTF-8"}},{}).then(function(){return n.innerHTML='Link Sent.<i class="i-check"></i>',n.classList.add("disabled")})})},copyUid:function(e){var n;return n=e.node,new ClipboardJS(n).on("success",function(){return n.classList.add("tip-on"),debounce(2e3).then(function(){return n.classList.remove("tip-on")})})}}})})});