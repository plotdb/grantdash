function import$(e,t){var r={}.hasOwnProperty;for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e}function repeatString$(e,t){for(var r="";t>0;(t>>=1)&&(e+=e))1&t&&(r+=e);return r}function in$(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}ldc.register("flagship-form",["auth","error","viewLocals"],function(e){var t,r,n,u,i;return t=e.auth,r=e.error,n=e.viewLocals,u=n||{},console.log(u),i=function(e){var r,n,i,a,o,l,c,f,d,s,g;return r=e.global,n={},i={form:{},file:{plan:{}},list:{"past-sub":[],perform:[]}},a=debounce(function(){return i.form=g.values(),window.localStorage.setItem("taicca-flagship-form-snapshot-"+r.user.key,JSON.stringify(i)),i}),o=function(){return Promise.resolve().then(function(){var e,t;if(t=((e=u.prj||(u.prj={})).detail||(e.detail={}))&&u.prj.detail.custom?u.prj.detail.custom:JSON.parse(window.localStorage.getItem("taicca-flagship-form-snapshot-"+r.user.key)))return import$(i,t),g.values(i.form),s.render(),g.checkAll()})},l=function(e){return null==e&&(e={}),ld$.fetch("/dash/api/flagship/upload",{method:"POST"},{json:e,type:"json"})},c=function(e){var t,r;return t=e.file,r=e.infoNode,"application/pdf"!==t.type?Promise.reject(new ldError(1020)):l({filename:t.name,size:t.size}).then(function(e){var n,u;return n=e.signedUrl,u=e.id,ld$.xhr(n,{method:"PUT",body:t,headers:{"Content-Type":t.type}},{noDefaultHeaders:!0,progress:function(e){if(r)return r.innerText="上傳中 / "+Math.floor(1e4*e.percent)/100+"%",r.removeAttribute("href")}}).then(function(){return console.log("done"),{filename:t.name,size:t.size,id:u}})})},f={state:!1,check:function(){return f.get()},get:debounce(function(){var e;return e=function(){var e,t,r,u,a;for(e in t=n)if(!t[e].ready())return!1;if(!g.ready())return!1;if(d(),!i.budget.ready)return!1;for(r=0,u=(t=["plan"]).length;r<u;++r)if(a=t[r],!i.file[a]||!i.file[a].id)return!1;return!0},f.state=e(),s.render("ready-state"),s.render("submit"),f.state})},d=function(){var e,t,r,n,u,a,o;if(e=((t=i.list).budget||(t.budget=[])).map(function(e){return e.value.price*e.value.count}).reduce(function(e,t){return e+ +t},0),r=((t=i.list).budget||(t.budget=[])).map(function(e){return e.value.self}).reduce(function(e,t){return e+ +t},0),n=e-r,u={self:r/(e||1),subsidy:(e-r)/(e||1)},t=i.budget||(i.budget={}),t.total=e,t.subsidy=n,t.self=r,t.percent=u,a=!(i.budget.total>5e6||i.budget.percent.subsidy>.49),o=i.budget.ready,i.budget.ready=a,o!==a)return f.check()},s=new ldView({root:document.body,action:{change:{"file-upload":function(e){var t,r,n;return t=e.node,e.evt,r=t.getAttribute("data-name"),n=s.getAll("file-uploaded").filter(function(e){return e.getAttribute("data-name")===r})[0],(t.files&&t.files.length?c({file:t.files[0],infoNode:n}).then(function(e){return i.file[r]=e}):Promise.resolve().then(function(){return i.file[r]=null})).then(function(){return a(),f.check(),s.render("file-uploaded")}).catch(function(e){return 1020===ldError.id(e)?alert("不支援此種檔案類型，請用 PDF 檔."):alert("上傳失敗。請晚點再試一次")})}},click:{"add-column":function(e){var t,r,n;return t=e.node,((r=i.list)[n=t.getAttribute("data-name")]||(r[n]=[])).push({}),s.render("column")},submit:function(){return f.get().then(function(e){if(e)return a(),t.recaptcha.get().then(function(e){var t,r;return t={key:((r=u||{}).prj||(r.prj={})).key,recaptcha:e,detail:i,name:i.form.name,description:(i.form["abs-item"]||"").substring(0,200),brd:"flagship-2"},ld$.fetch("/dash/api/flagship/prj",{method:"POST"},{json:t,type:"json"}).then(function(){return console.log("done.")})})})}}},text:{fill:function(e){var t,r,n,a,o,l,c,f,d,s;if(t=e.node,r=t.getAttribute("data-name"),g)return n=g.values(),(a=n[r])?a:"doc-year"===r?(new Date).getYear()-11:"doc-month"===r?(new Date).getMonth()+1:"doc-day"===r?(new Date).getDate():(o=/^budget-(self|subsidy)(-percent)?$/.exec(r))?(l=((c=i.list).budget||(c.budget=[])).map(function(e){return e.value.price*e.value.count}).reduce(function(e,t){return e+ +t},0),f=((c=i.list).budget||(c.budget=[])).map(function(e){return e.value.self}).reduce(function(e,t){return e+ +t},0),o[2]?"self"===o[1]?Math.floor(1e4*f/(l||1))/100:Math.ceil(1e4*(l-f)/(l||1))/100:"self"===o[1]?f:l-f):(d={"文化內容開發組":"01","內容產業領航行動組":"02"}[n.group],"docid"===r?(s=(c=u.prj.slug.split("-"))[c.length-1],"109-"+d+"-"+(repeatString$("0",3-(s+"").length)+s)):"")}},handler:{"budget-limit":function(e){var t;return t=e.node,d(),t.classList.toggle("d-none",i.budget.ready)},submit:function(e){return e.node.classList.toggle("disabled",!f.state)},"ready-state":function(e){return e.node.classList.toggle("d-none",f.state)},"file-uploaded":function(e){var t,r,n;return t=e.node,r=t.getAttribute("data-name"),t.removeAttribute("href"),t.classList.remove("text-danger"),(n=i.file[r])?(t.innerText=n.filename+" / size: "+Math.round(n.size/1024)+"KB",t.setAttribute("href","/dash/flagship/upload/"+n.id)):(t.classList.add("text-danger"),t.innerText="尚未上傳檔案")},toggler:function(e){var t,r,n;if(t=e.node,g)return r=g.values(),n=t.getAttribute("data-name"),t.classList.toggle("d-none","1"!==r[n])},column:{list:function(e){var t,r,n;return t=e.node,(r=i.list)[n=t.getAttribute("data-name")]||(r[n]=[])},action:{click:function(e){var t,r,n,u,a;if(t=e.node,r=e.evt,n=e.data,r.target&&r.target.classList&&r.target.classList.contains("i-close")&&(u=i.list[t.getAttribute("data-name")],~(a=u.indexOf(n))))return u.splice(a,1),s.render("column")}},init:function(e){var t,r,u,i,o,l;return t=e.node,r=e.data,u=e.local,i=t.getAttribute("data-name"),o=function(){return r.value||(r.value={}),ld$.find(t,"[name]").map(function(e){return r.value[e.getAttribute("name")]=e.value}),a()},ld$.find(t,"input,textarea,select").map(function(e){return e.addEventListener("input",function(){return o()}),e.addEventListener("change",function(){return o()})}),u.ldform=n[i]=l=new ldForm({root:t,verify:function(e,t){var r,n,u;if("perform"===i){if("brief"===e&&t.length>=200)return 2;if("result"===e&&t.length>=100)return 2}if("budget"===i){if("comment"===e)return 0;if(r=l.values(),n=+r.price*+r.count,u=n-+r.self,l.fields.subsidy.value=u,l.fields.total.value=n,"self"===e&&u<0)return 2;s.render("fill"),s.render("budget-limit")}return t?0:2}}),l.on("readystatechange",function(){return f.check()})},handler:function(e){var t,r,n;return t=e.node,r=e.data,n=e.local,ld$.find(t,"input,textarea,select").map(function(e){return e.value=(r.value||(r.value={}))[e.getAttribute("name")]||""}),n.ldform.checkAll()}}}}),(g=new ldForm({root:ld$.find("form",0),afterCheck:function(){if(a(),s&&s.render("toggler"),s)return s.render()},verify:function(e,t,r){var n,u,i,a;if(n=t||"","group1-category"===e&&g.check({n:"group1-category-other"}),"group2-category"===e&&g.check({n:"group2-category-other"}),"brief"===e&&(n.length<300||n.length>500))return 2;if("uid"===e)return/[a-zA-Z][0-9]{9}/.exec(n)?0:2;if("found-reason"===e)return n.length>100?2:0;if("comment"===e)return 0;if("consent"===e)return r.checked?0:2;if("group"===e)g.check([{n:"group1-category"},{n:"group2-category"}]);else if("has-other-sub"===e)g.check([{n:"other-sub-name"},{n:"other-sub-amount"}]);else{if(u=/^group([12])-category$/.exec(e))return i={1:"文化內容開發組",2:"內容產業領航行動組"}[u[1]],a=g.values().group,n&&n.length||i!==a?0:2;if(u=/^group([12])-category-other$/.exec(e))return i={1:"文化內容開發組",2:"內容產業領航行動組"}[u[1]],a=g.values().group,in$("其它",g.values()[e.replace("-other","")]||[])&&i===a&&!n?2:0;if(/^other-sub-/.exec(e)){if("0"===g.values()["has-other-sub"])return 0;if(!n)return 2}else if("abs-item"===e||"abs-method"===e||"abs-timeline"===e||"abs-outcome"===e){if(!(n&&n.length<200))return 2}else if(!n||Array.isArray(n)&&!n.length)return 2}return 0}})).on("readystatechange",function(){return f.check()}),o()},t.ensure().then(function(e){return i({global:e})}).catch(r())}),ldc.app("flagship-form");