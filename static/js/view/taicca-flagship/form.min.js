function import$(e,t){var n={}.hasOwnProperty;for(var r in t)n.call(t,r)&&(e[r]=t[r]);return e}function repeatString$(e,t){for(var n="";t>0;(t>>=1)&&(e+=e))1&t&&(n+=e);return n}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return!0;return!1}ldc.register("flagship-form",["auth","error","viewLocals","ldcvmgr"],function(e){var t,n,r,a,i,u,o;return t=e.auth,n=e.error,r=e.viewLocals,a=e.ldcvmgr,i={},u=r||{},console.log(u),o=function(e){var r,o,l,d,s,c,f,g,h,p,m,v,b;return r=e.global,o={},l={form:{},file:{plan:{}},list:{"past-sub":[],perform:[]}},d=function(){var e;return e=(u.prj||(u.prj={})).slug,"taicca-flagship-form-snapshot-"+("/"+r.user.key+"/"+(e||"(n-a)"))},s=debounce(function(){return l.form=b.values(),window.localStorage.setItem(d(),JSON.stringify(l)),l}),c=function(){return window.localStorage.setItem(d(),null)},f=function(){return Promise.resolve().then(function(){var e,t;if(t=((e=u.prj||(u.prj={})).detail||(e.detail={}))&&u.prj.detail.custom?u.prj.detail.custom:JSON.parse(window.localStorage.getItem(d())))return import$(l,t),b.values(l.form),v.render(),b.checkAll()})},g=function(e){return null==e&&(e={}),ld$.fetch("/dash/api/flagship/upload",{method:"POST"},{json:e,type:"json"})},h=function(e){var t,n;return t=e.file,n=e.infoNode,"application/pdf"!==t.type?Promise.reject(new ldError(1020)):g({filename:t.name,size:t.size}).then(function(e){var r,a;return r=e.signedUrl,a=e.id,ld$.xhr(r,{method:"PUT",body:t,headers:{"Content-Type":t.type}},{noDefaultHeaders:!0,progress:function(e){if(n)return n.innerText="上傳中 / "+Math.floor(1e4*e.percent)/100+"%",n.removeAttribute("href")}}).then(function(){return console.log("done"),{filename:t.name,size:t.size,id:a}})})},p={state:!1,check:function(){return p.get()},get:debounce(function(){var e;return e=function(){var e,t,n,r,a,i;for(e in t=o)n=t[e],o[e]=n.filter(function(e){return e.root.parentNode});for(e in t=o)for(r=0,a=(n=t[e]).length;r<a;++r)if(!n[r].ready())return!1;if(!b.ready())return!1;if(m(),!l.budget.ready)return!1;for(r=0,a=(t=["plan"]).length;r<a;++r)if(i=t[r],!l.file[i]||!l.file[i].id)return!1;return!0},p.state=e(),v.render(["ready-state","submit","download"]),p.state})},m=function(){var e,t,n,r,a,i,u;if(e=((t=l.list).budget||(t.budget=[])).map(function(e){return e.value.price*e.value.count}).reduce(function(e,t){return e+ +t},0),n=((t=l.list).budget||(t.budget=[])).map(function(e){return e.value.self}).reduce(function(e,t){return e+ +t},0),r=e-n,a={self:n/(e||1),subsidy:(e-n)/(e||1)},t=l.budget||(l.budget={}),t.total=e,t.subsidy=r,t.self=n,t.percent=a,i=l.budget.total&&l.budget.total>0&&l.budget.total<=5e6&&l.budget.percent.subsidy<=.49,u=l.budget.ready,l.budget.ready=i,u!==i)return p.check()},v=new ldView({initRender:!1,root:document.body,action:{change:{"file-upload":function(e){var t,n,r;return t=e.node,e.evt,n=t.getAttribute("data-name"),r=v.getAll("file-uploaded").filter(function(e){return e.getAttribute("data-name")===n})[0],(t.files&&t.files.length?h({file:t.files[0],infoNode:r}).then(function(e){return l.file[n]=e}):Promise.resolve().then(function(){return l.file[n]=null})).then(function(){return s(),p.check(),v.render("file-uploaded")}).catch(function(e){return 1020===ldError.id(e)?alert("不支援此種檔案類型，請用 PDF 檔."):alert("上傳失敗。請晚點再試一次")})}},click:{"add-column":function(e){var t,n,r;return t=e.node,((n=l.list)[r=t.getAttribute("data-name")]||(n[r]=[])).push({}),v.render("column"),p.check(),s()},download:function(){return p.get().then(function(e){var r,u;if(e&&!i.downloading)return i.downloading=!0,v.getAll("download").map(function(e){return ld$.find(e.parent,".ld-ext-right",0).classList.add("running")}),ld$.find(document.body,"._preview").map(function(e){return e.parentNode.removeChild(e)}),ld$.find("select,textarea,input").map(function(e){var t,n,r,a;return t=e.getAttribute("type"),n=e.nodeName.toLowerCase(),t?e.checked?e.setAttribute("checked",""):e.removeAttribute("checked"):(r=Array.from(e.classList).filter(function(e){return!("is-valid"===e||"is-invalid"===e)}).concat(["_preview"]),e.setAttribute("value",e.value),a=ld$.create({name:"div",className:r,style:e.style}),"textarea"===n&&(a.style.height="auto"),a.innerText=e.value,e.parentNode.insertBefore(a,e))}),r='<link rel="stylesheet" type="text/css"\nhref="https://dash.taicca.tw/dash/assets/lib/bootstrap/4.3.1/css/bootstrap.min.css">\n<link rel="stylesheet" type="text/css" href="https://dash.taicca.tw/dash/assets/lib/ldui/ldui.min.css">\n<link rel="stylesheet" type="text/css" href="https://dash.taicca.tw/dash/css/index.css">\n<style type="text/css"> '+ld$.find("style",0).innerText+" </style>",u='<html>\n<head><meta charset="utf-8">'+r+'</head>\n<body><div class="typeset heading-contrast">\n'+ld$.find("#form",0).innerHTML+"\n</div></body>\n</html>",t.recaptcha.get().then(function(e){return ld$.fetch("/dash/api/flagship/download",{method:"POST"},{json:{html:u,recaptcha:e},type:"blob",timeout:6e4})}).then(function(e){var t,n;return t=URL.createObjectURL(e),n=ld$.create({name:"a",attr:{href:t,download:"form.pdf"}}),document.body.appendChild(n),n.click(),document.body.removeChild(n)}).finally(function(){return v.getAll("download").map(function(e){return e.classList.remove("running")}),a.toggle("flagship-submitted",!1),i.downloading=!1}).catch(function(e){return 1006===ldError.id(e)?a.toggle("flagship-print-timeout"):n()(e)})})},submit:function(e){var r,i,o;return r=e.node,i="submit"===r.getAttribute("data-type"),o=i?["submitting","submitted"]:["saving","saved"],(i?p.get():Promise.resolve(!0)).then(function(e){if(e)return s(),a.toggle("flagship-"+o[0],!0),t.recaptcha.get()}).then(function(e){var t,n;return t={key:((n=u||{}).prj||(n.prj={})).key,recaptcha:e,detail:l,name:l.form.name,description:(l.form["abs-item"]||"").substring(0,200),submit:!1},ld$.fetch("/dash/api/flagship/prj",{method:"POST"},{json:t,type:"json"})}).then(function(e){return c(),e&&e.slug&&((u.prj||(u.prj={})).slug=e.slug,v.render("fill")),a.toggle("flagship-"+o[1],!0)}).finally(function(){return a.toggle("flagship-"+o[0],!1)}).catch(n())}}},text:{fill:function(e){var t,n,r,a,i,o,d,s,c,f,g;if(t=e.node,n=t.getAttribute("data-name"),b)return r=b.values(),(a=r[n])?a:"doc-year"===n?(new Date).getYear()-11:"doc-month"===n?(new Date).getMonth()+1:"doc-day"===n?(new Date).getDate():"budget"===n?i=((o=l.list).budget||(o.budget=[])).map(function(e){return(e.value||(e.value={})).price*(e.value||(e.value={})).count}).reduce(function(e,t){return e+ +t},0):(d=/^budget-(self|subsidy)(-percent)?$/.exec(n))?(i=((o=l.list).budget||(o.budget=[])).map(function(e){return(e.value||(e.value={})).price*(e.value||(e.value={})).count}).reduce(function(e,t){return e+ +t},0),s=((o=l.list).budget||(o.budget=[])).map(function(e){return(e.value||(e.value={})).self}).reduce(function(e,t){return e+ +t},0),d[2]?"self"===d[1]?Math.floor(1e4*s/(i||1))/100:Math.ceil(1e4*(i-s)/(i||1))/100:"self"===d[1]?s:i-s):"docid"===n?(c={"文化內容開發組":"01","內容產業領航行動組":"02"}[r.group],(f=(u.prj||(u.prj={})).slug)?(g=(o=f.split("-"))[o.length-1],"109-"+c+"-"+(repeatString$("0",3-(g+"").length)+g)):"尚未送件"):""}},handler:{"budget-limit":function(e){var t;return t=e.node,m(),t.classList.toggle("d-none",l.budget.ready)},download:function(e){return e.node.classList.toggle("disabled",!p.state)},submit:function(e){return e.node.classList.toggle("disabled",!p.state)},"ready-state":function(e){return e.node.classList.toggle("d-none",p.state)},"file-uploaded":function(e){var t,n,r;return t=e.node,n=t.getAttribute("data-name"),t.removeAttribute("href"),t.classList.remove("text-danger"),(r=l.file[n])&&l.file[n].id?(t.innerText=r.filename+" / size: "+Math.round(r.size/1024)+"KB",t.setAttribute("href","/dash/flagship/upload/"+r.id)):(t.classList.add("text-danger"),t.innerText="尚未上傳檔案")},toggler:function(e){var t,n,r;if(t=e.node,b)return n=b.values(),r=t.getAttribute("data-name"),t.classList.toggle("d-none","1"!==n[r])},column:{list:function(e){var t,n,r;return t=e.node,(n=l.list)[r=t.getAttribute("data-name")]||(n[r]=[])},action:{click:function(e){var t,n,r,a,i;if(t=e.node,n=e.evt,r=e.data,n.target&&n.target.classList&&n.target.classList.contains("i-close")&&(a=l.list[t.getAttribute("data-name")],~(i=a.indexOf(r))))return a.splice(i,1),v.render("column"),p.check(),s()}},init:function(e){var t,n,r,a,i,u;return t=e.node,n=e.data,r=e.local,a=t.getAttribute("data-name"),i=function(){return n.value||(n.value={}),ld$.find(t,"[name]").map(function(e){return n.value[e.getAttribute("name")]=e.value}),s()},ld$.find(t,"input,textarea,select").map(function(e){return e.addEventListener("input",function(){return i()}),e.addEventListener("change",function(){return i()})}),r.ldform=u=new ldForm({root:t,verify:function(e,t){var n,r,i;if("perform"===a){if("brief"===e&&t.length>=200)return 2;if("result"===e&&t.length>=100)return 2}if("budget"===a){if("comment"===e)return 0;if(n=u.values(),r=+n.price*+n.count,i=r-+n.self,u.fields.subsidy.value=i,u.fields.total.value=r,"self"===e&&i<0)return 2;v.render("fill"),v.render("budget-limit")}return t?0:2}}),(o[a]||(o[a]=[])).push(u),u.on("readystatechange",function(){return p.check()})},handler:function(e){var t,n,r;return t=e.node,n=e.data,r=e.local,ld$.find(t,"input,textarea,select").map(function(e){return e.value=(n.value||(n.value={}))[e.getAttribute("name")]||""}),r.ldform.checkAll()}}}}),(b=new ldForm({root:ld$.find("form",0),afterCheck:function(){if(s(),v&&v.render("toggler"),v)return v.render()},verify:function(e,t,n){var r,a,i,u;if(r=t||"","group1-category"===e&&b.check({n:"group1-category-other"}),"group2-category"===e&&b.check({n:"group2-category-other"}),"brief"===e&&(r.length<300||r.length>500))return 2;if("uid"===e)return/[a-zA-Z][0-9]{9}/.exec(r)?0:2;if("found-reason"===e)return r.length>100?2:0;if("comment"===e)return 0;if("consent"===e)return n.checked?0:2;if("group"===e)b.check([{n:"group1-category"},{n:"group2-category"}]);else if("has-other-sub"===e)b.check([{n:"other-sub-name"},{n:"other-sub-amount"}]);else{if(a=/^group([12])-category$/.exec(e))return i={1:"文化內容開發組",2:"內容產業領航行動組"}[a[1]],u=b.values().group,r&&r.length||i!==u?0:2;if(a=/^group([12])-category-other$/.exec(e))return i={1:"文化內容開發組",2:"內容產業領航行動組"}[a[1]],u=b.values().group,in$("其它",b.values()[e.replace("-other","")]||[])&&i===u&&!r?2:0;if(/^other-sub-/.exec(e)){if("0"===b.values()["has-other-sub"])return 0;if(!r)return 2}else if("abs-item"===e||"abs-method"===e||"abs-timeline"===e||"abs-outcome"===e){if(!(r&&r.length<200))return 2}else if(!r||Array.isArray(r)&&!r.length)return 2}return 0}})).on("readystatechange",function(){return p.check()}),v.render(),f()},t.ensure().then(function(e){return o({global:e})}).catch(n())}),ldc.app("flagship-form");