function import$(e,t){var r={}.hasOwnProperty;for(var n in t)r.call(t,n)&&(e[n]=t[n]);return e}function in$(e,t){for(var r=-1,n=t.length>>>0;++r<n;)if(e===t[r])return!0;return!1}function repeatString$(e,t){for(var r="";t>0;(t>>=1)&&(e+=e))1&t&&(r+=e);return r}ldc.register("flagship-form",["loader","auth","error","viewLocals","ldcvmgr"],function(e){var t,r,n,i,a,o,u,l,s,d;return t=e.loader,r=e.auth,n=e.error,i=e.viewLocals,a=e.ldcvmgr,t.on(),o={},u=i||{},console.log(u),l=/simple/.exec(window.location.search),s=debounce(100,function(e){var t;return e=null!=e?!!e:!!l||"active"===(u.prj||(u.prj={})).state,t=ld$.find("#flagship-form",0),ld$.find(t,".btn").map(function(t,r){return t.classList.toggle("disabled",e)}),ld$.find(t,"textarea,input,select").map(function(t,r){if("-1"!==t.getAttribute("tabindex"))return e?(t.setAttribute("disabled",""),t.setAttribute("readonly","")):(t.removeAttribute("disabled"),t.removeAttribute("readonly"))})}),d=function(e){var i,d,c,f,g,p,h,m,b,v,y,j,$,w;return i=e.global,d={},c={form:{},file:{plan:{}},list:{"past-sub":[],perform:[]}},f=function(){var e;return e=(u.prj||(u.prj={})).slug,"taicca-flagship-form-snapshot-"+("/"+i.user.key+"/"+(e||"(n-a)"))},g=debounce(function(){return"active"===(u.prj||(u.prj={})).state?c:(c.form=w.values(),c)}),p=function(){return window.localStorage.setItem(f(),null)},h=function(){return Promise.resolve().then(function(){var e,t;if(((e=u.prj||(u.prj={})).detail||(e.detail={}))&&u.prj.detail.custom&&(t=u.prj.detail.custom),t)return import$(c,t),w.values(c.form),$.render(),w.checkAll()})},m=function(e){return null==e&&(e={}),ld$.fetch("/dash/api/flagship/upload",{method:"POST"},{json:e,type:"json"})},b=function(e){var t,r;return t=e.file,r=e.infoNode,"active"===(u.prj||(u.prj={})).state?Promise.reject(new ldError(1012)):"application/pdf"!==t.type?Promise.reject(new ldError(1020)):m({filename:t.name,size:t.size}).then(function(e){var n,i;return n=e.signedUrl,i=e.id,ld$.xhr(n,{method:"PUT",body:t,headers:{"Content-Type":t.type}},{noDefaultHeaders:!0,progress:function(e){if(r)return r.innerText="上傳中 / "+Math.floor(1e4*e.percent)/100+"%",r.removeAttribute("href")}}).then(function(){return{filename:t.name,size:t.size,id:i,modifiedtime:t.lastModified}})})},v={state:!1,get:debounce(function(){var e;return e=function(){var e,t,r,n,i,a,o;for(e in t=d)r=t[e],d[e]=r.filter(function(e){return e.root.parentNode});n={"past-sub":"has-sub",perform:"has-perform"};for(e in t=d)if(r=t[e],null==n[e]||"1"===c.form[n[e]])for(i=0,a=r.length;i<a;++i)if(!r[i].ready())return!1;if(!w.ready())return!1;if(y(),!c.budget.ready)return!1;for(i=0,a=(t=["plan"]).length;i<a;++i)if(o=t[i],!c.file[o]||!c.file[o].id)return!1;return!0},v.state=e(),$.render(["ready-state","submit","download"]),v.state})},y=function(){var e,t,r,n,i,a,o;if(e=((t=c.list).budget||(t.budget=[])).map(function(e){return+(e.value.price||0)*+(e.value.count||0)}).reduce(function(e,t){return e+ +t},0),r=((t=c.list).budget||(t.budget=[])).map(function(e){return+(e.value.self||0)}).reduce(function(e,t){return e+ +t},0),n=e-r,i={self:r/(e||1),subsidy:(e-r)/(e||1)},t=c.budget||(c.budget={}),t.total=e,t.subsidy=n,t.self=r,t.percent=i,a=c.budget.total&&c.budget.total>0&&c.budget.subsidy<=5e6&&c.budget.percent.subsidy<=.49,o=c.budget.ready,c.budget.ready=a,o!==a)return v.get()},j=debounce(100,function(){return $.render("fill"),$.render("budget-limit")}),$=new ldView({initRender:!1,root:document.body,action:{change:{"file-upload":function(e){var t,r,n,i;return t=e.node,e.evt,r=t.getAttribute("data-name"),(n=ld$.parent(t,".btn"))&&n.classList.toggle("running",!0),i=$.getAll("file-uploaded").filter(function(e){return e.classList.contains("no-print")}).filter(function(e){return e.getAttribute("data-name")===r})[0],(t.files&&t.files.length?b({file:t.files[0],infoNode:i}).then(function(e){return c.file[r]=e}):Promise.resolve().then(function(){return c.file[r]=null})).finally(function(){return n&&n.classList.toggle("running",!1),t.value=null}).then(function(){return g(),v.get(),$.render("file-uploaded")}).catch(function(e){return 1020===ldError.id(e)?alert("不支援此種檔案類型，請用 PDF 檔."):alert("上傳失敗。請晚點再試一次")})}},click:{"add-column":function(e){var t,r,n;if(t=e.node,"active"!==(u.prj||(u.prj={})).state)return((r=c.list)[n=t.getAttribute("data-name")]||(r[n]=[])).push({}),$.render("column"),v.get(),g()},download:function(){return $.getAll("download").map(function(e){return ld$.find(e.parentNode,".ld-ext-right",0).classList.add("running")}),v.get().then(function(e){var t,i,u;if(e&&!o.downloading)return o.downloading=!0,ld$.find(document.body,"._preview").map(function(e){return e.parentNode.removeChild(e)}),ld$.find(ld$.find("#flagship-form",0),"select,textarea,input").map(function(e){var t,r,n,i;return t=e.getAttribute("type"),r=e.nodeName.toLowerCase(),t?e.checked?e.setAttribute("checked",""):e.removeAttribute("checked"):(n=Array.from(e.classList).filter(function(e){return!("is-valid"===e||"is-invalid"===e)}).concat(["_preview"]),e.setAttribute("value",e.value),(i=ld$.create({name:"div",className:n})).setAttribute("style",e.getAttribute("style")),"textarea"===r&&(i.style.height="auto"),i.innerText=e.value,e.parentNode.insertBefore(i,e))}),s(!1),t=ld$.find("style#flagship",0).innerText,i='<link rel="stylesheet" type="text/css"\nhref="https://dash.taicca.tw/dash/assets/lib/bootstrap/4.3.1/css/bootstrap.min.css">\n<link rel="stylesheet" type="text/css" href="https://dash.taicca.tw/dash/assets/lib/ldui/ldui.min.css">\n<link rel="stylesheet" type="text/css" href="https://dash.taicca.tw/dash/css/index.css">\n<style type="text/css">\n'+t+"\n</style>",u='<html>\n<head>\n<meta charset="utf-8">\n'+i+'\n</head>\n<body><div class="typeset heading-contrast"><form id="flagship-form">\n'+ld$.find("#flagship-form",0).innerHTML+"\n</form></div></body>\n</html>",s(),r.recaptcha.get().then(function(e){return ld$.fetch("/dash/api/flagship/download",{method:"POST"},{json:{html:u,recaptcha:e},type:"blob",timeout:6e4})}).then(function(e){var t,r;return t=URL.createObjectURL(e),r=ld$.create({name:"a",attr:{href:t,download:"form.pdf"}}),document.body.appendChild(r),r.click(),document.body.removeChild(r)}).finally(function(){return a.toggle("flagship-submitted",!1),o.downloading=!1}).catch(function(e){return 1006===ldError.id(e)?a.toggle("flagship-print-timeout"):n()(e)})}).then(function(e){return $.getAll("download").map(function(e){return ld$.find(e.parentNode,".ld-ext-right",0).classList.remove("running")})})},submit:function(e){var t,i,o;return e.node,t=e.names,i=!in$("save",t),o=i?["submitting","submitted"]:["saving","saved"],(i?v.get():Promise.resolve(!0)).then(function(e){return e?"active"===(u.prj||(u.prj={})).state?Promise.reject(new ldError(999)):(a.toggle("flagship-"+o[0],!0),g()):Promise.reject(new ldError(999))}).then(function(){return r.recaptcha.get()}).then(function(e){var t,r;return t={key:((r=u||{}).prj||(r.prj={})).key,recaptcha:e,detail:c,name:c.form.name,description:(c.form["abs-item"]||"").substring(0,200),submit:i},ld$.fetch("/dash/api/flagship/prj",{method:"POST"},{json:t,type:"json"})}).then(function(e){return p(),import$(u.prj||(u.prj={}),e),$.render(),a.toggle("flagship-"+o[1],!0)}).finally(function(){return a.toggle("flagship-"+o[0],!1)}).catch(n())}}},text:{fill:function(e){var t,r,n,i,a,o,l,s,d,f;if(t=e.node,r=t.getAttribute("data-name"),w)return n=w.values(),(i=n[r])?i:"doc-year"===r?(new Date).getYear()-11:"doc-month"===r?(new Date).getMonth()+1:"doc-day"===r?(new Date).getDate():"budget"===r?a=((o=c.list).budget||(o.budget=[])).map(function(e){return+((e.value||(e.value={})).price||0)*+((e.value||(e.value={})).count||0)}).reduce(function(e,t){return e+ +t},0):(l=/^budget-(self|subsidy)(-percent)?$/.exec(r))?(a=((o=c.list).budget||(o.budget=[])).map(function(e){return+((e.value||(e.value={})).price||0)*+((e.value||(e.value={})).count||0)}).reduce(function(e,t){return e+ +t},0),s=((o=c.list).budget||(o.budget=[])).map(function(e){return+((e.value||(e.value={})).self||0)}).reduce(function(e,t){return e+ +t},0),l[2]?"self"===l[1]?Math.floor(1e4*s/(a||1))/100:Math.ceil(1e4*(a-s)/(a||1))/100:"self"===l[1]?s:a-s):"docid"===r?(d={"文化內容開發組":"01","內容產業領航行動組":"02"}[n.group],(f=+((o=u.prj||(u.prj={})).system||(o.system={})).idx)?"109-"+d+"-"+(repeatString$("0",3-(f+"").length)+f):"尚未送件"):""}},handler:{"editmode-only":function(e){return e.node.classList.toggle("d-none",l)},"budget-limit":function(e){var t;return t=e.node,y(),t.classList.toggle("d-none",c.budget.ready)},download:function(e){return e.node.classList.toggle("disabled",!v.state)},submitted:function(e){var t,r,n;return t=e.node,r=e.names,n="active"===(u.prj||(u.prj={})).state,in$("not",r)&&(n=!n),t.classList.toggle("d-none",!n)},submit:function(e){var t,r;return t=e.node,r=e.names,in$("save",r)?t.classList.toggle("disabled","active"===(u.prj||(u.prj={})).state):t.classList.toggle("disabled",!v.state||"active"===(u.prj||(u.prj={})).state)},"ready-state":function(e){return e.node.classList.toggle("d-none",v.state)},"file-uploaded":function(e){var t,r,n,i;return t=e.node,r=t.getAttribute("data-name"),t.removeAttribute("href"),t.classList.remove("text-danger"),(n=c.file[r])&&c.file[r].id?(t.classList.contains("no-print")?(i=n.modifiedtime?"/ 檔案修改時間: "+moment(n.modifiedtime).tz("Asia/Taipei").format("YYYY-MM-DD hh:mm:ss"):"",t.innerText=n.filename+" / size: "+Math.round(n.size/1024)+"KB "+i+" ( 點擊下載文件 )"):t.innerText="計畫書已上傳",t.setAttribute("href","/dash/flagship/upload/"+n.id)):(t.classList.add("text-danger"),t.innerText="尚未上傳檔案")},toggler:function(e){var t,r,n;if(t=e.node,w)return r=w.values(),n=t.getAttribute("data-name"),t.classList.toggle("d-none","1"!==r[n])},column:{list:function(e){var t,r,n;return t=e.node,(r=c.list)[n=t.getAttribute("data-name")]||(r[n]=[])},action:{click:function(e){var t,r,n,i,a;if(t=e.node,r=e.evt,n=e.data,r.target&&r.target.classList&&r.target.classList.contains("i-close")&&"active"!==(u.prj||(u.prj={})).state&&(i=c.list[t.getAttribute("data-name")],~(a=i.indexOf(n))))return i.splice(a,1),$.render("column"),v.get(),g()}},init:function(e){var t,r,n,i,a,o,u;return t=e.node,r=e.data,n=e.local,i=t.getAttribute("data-name"),a=function(){return r.value||(r.value={}),ld$.find(t,"[name]").map(function(e){return r.value[e.getAttribute("name")]=e.value}),g()},o=debounce(100,function(){return a(),j()}),ld$.find(t,"input,textarea,select").map(function(e){return e.addEventListener("input",function(){return a()}),e.addEventListener("change",function(){return a()})}),n.ldform=u=new ldForm({root:t,verify:function(e,t){var r,n,a;if("perform"===i){if("brief"===e&&t.length>=200)return 2;if("result"===e&&t.length>=100)return 2}if("budget"===i){if("comment"===e)return 0;if(r=u.values(),/^[0-9]+$/.exec(r.price)||(r.price=u.fields.price.value=r.price.replace(/[^0-9]/g,""),o()),n=+r.price*+r.count,a=n-+r.self,u.fields.subsidy.value=a,u.fields.total.value=n,"self"===e&&a<0)return 2;j()}return t?0:2}}),(d[i]||(d[i]=[])).push(u),u.on("readystatechange",function(){return v.get()})},handler:function(e){var t,r,n;return t=e.node,r=e.data,n=e.local,ld$.find(t,"input,textarea,select").map(function(e){return e.value=(r.value||(r.value={}))[e.getAttribute("name")]||""}),n.ldform.checkAll()}}}}),w=new ldForm({root:ld$.find("#flagship-form",0),afterCheck:function(e,t){var r;return g(),$&&$.render(),r=w.values(),["has-perform","has-other-sub","has-sub","group"].map(function(t){return e[t]=null!=r[t]?0:2}),["other-sub-amount","other-sub-name"].map(function(t){return"1"!==r["has-other-sub"]||r[t]?e[t]=0:e[t]=2}),v.get()},verify:function(e,t,r){var n,i,a,o;if(n=t||"","group1-category"===e&&w.check({n:"group1-category-other"}),"group2-category"===e&&w.check({n:"group2-category-other"}),"brief"===e&&(n.length<300||n.length>500))return 2;if("uid"===e)return/^[a-zA-Z][0-9]{9}$/.exec(n)?0:2;if("vatid"===e)return/^[0-9]{8}$/.exec(n)?0:2;if("found-reason"===e)return n.length>100?2:0;if("comment"===e)return 0;if("consent"===e)return r.checked?0:2;if("group"===e)w.check([{n:"group1-category"},{n:"group2-category"}]);else if("has-other-sub"===e)w.check([{n:"other-sub-name"},{n:"other-sub-amount"}]);else{if(i=/^group([12])-category$/.exec(e))return a={1:"文化內容開發組",2:"內容產業領航行動組"}[i[1]],o=w.values().group,n&&n.length||a!==o?0:2;if(i=/^group([12])-category-other$/.exec(e))return a={1:"文化內容開發組",2:"內容產業領航行動組"}[i[1]],o=w.values().group,in$("其它",w.values()[e.replace("-other","")]||[])&&a===o&&!n?2:0;if(/^other-sub-/.exec(e)){if("0"===w.values()["has-other-sub"])return 0;if(!n)return 2}else if("abs-item"===e||"abs-method"===e||"abs-timeline"===e||"abs-outcome"===e){if(!(n&&n.length<200))return 2}else if(!n||Array.isArray(n)&&!n.length)return 2}return 0}}),["group1-category","group2-category","group1-category-other","group2-category-other"].map(function(e){return w.check({n:e,now:!0})}),$.on("afterRender",function(){return s()}),w.on("readystatechange",function(){return v.get()}),$.render(),h(),s(),t.off(),new IntersectionObserver(function(e){if(e[0]&&e[0].isIntersecting)return w.checkAll()},{threshold:1}).observe(ld$.find("#check-all",0))},r.ensure().then(function(e){return d({global:e})}).catch(n())}),ldc.app("flagship-form");